# 1.11 Recording Server

## 試験ガイド対応: Objective 4.1.11

> **Identify use cases for Horizon Recording Server**
> **Identify the prerequisites for Recording Server deployment.**
> **Evaluate the criteria to record (local session, remote session, groups to record)**
> **Deploy and configure a Recording Server**

---

## Horizon Recording Serverのユースケースの特定

### Recording Serverとは

Horizon Recording Serverは、ユーザーのデスクトップ・アプリケーションセッションの画面操作を録画する機能を提供するコンポーネントである。セキュリティ監査・コンプライアンス・内部統制のために、特定のユーザーやグループのセッション内容を記録・保存・再生できる。

### ユースケース一覧

| ユースケース | 説明 | 業界例 |
|---|---|---|
| **コンプライアンス要件** | 規制によりユーザー操作の記録が義務付けられている環境 | 金融（取引操作）、医療（患者情報アクセス）、政府機関（機密情報） |
| **セキュリティ監査** | 不正アクセスの検出・インシデント調査のための証拠保全 | 全業界（特権ユーザーの監視） |
| **インサイダー脅威対策** | 内部不正行為の抑止・検出 | 知的財産を扱う企業、防衛関連 |
| **トレーニング・サポート** | ユーザー操作の記録によるトレーニング素材作成・問題再現 | IT部門、ヘルプデスク |
| **フォレンジック調査** | セキュリティインシデント発生時の操作内容の証拠保全 | 法務・セキュリティ部門 |

### 判断フレームワーク: Recording Serverが必要か

```
規制要件でセッション記録が義務付けられているか？
├─ Yes → Recording Server必須
└─ No
    ├─ 特権ユーザーのアクセス監視が必要か？
    │   ├─ Yes → Recording Server推奨
    │   └─ No → 不要（Event Databaseで十分）
    └─ フォレンジック/法的証拠保全が必要か？
        ├─ Yes → Recording Server推奨
        └─ No → 不要
```

---

## Recording Serverデプロイメントの前提条件の特定

### システム要件

| 要件 | 詳細 |
|---|---|
| **OS** | Windows Server 2016 / 2019 / 2022 |
| **ドメイン参加** | Active Directoryドメインへの参加が必要 |
| **CPU** | 最小4 vCPU（推奨8 vCPU以上） |
| **メモリ** | 最小8 GB RAM（推奨16 GB以上） |
| **ディスク** | OS用50 GB + 録画データ用（要件に応じてサイジング） |
| **ネットワーク** | 1 Gbps NIC |

### ネットワーク要件・ポート

| ポート | プロトコル | 方向 | 用途 |
|---|---|---|---|
| **9443** | TCP (HTTPS) | Recording Server ← 管理者 | 管理コンソールアクセス（`https://<FQDN>:9443/`） |
| **9443** | TCP | Horizon Recording Agent → Recording Server | セッション録画データストリーミング |
| **9443** | TCP | Recording Server ↔ Recording Server | 設定インポート（RS間） |
| **1433** | TCP | Recording Server → Database | Microsoft SQL Server / PostgreSQL |
| **445** | TCP | Recording Server → File Shares | 録画データストレージ |

> **重要**: Recording AgentからRecording Serverへの通信はTCP 9443を使用する（TCP 9427ではない）。TCP 9427はCDR/MMR/Teams最適化等のHorizon Agent機能のポート。

### ソフトウェア前提条件

| 前提条件 | 説明 |
|---|---|
| **Horizon Connection Server** | Recording Serverの登録・管理に必要 |
| **Horizon Agent** | 録画対象のVMにインストール済みであること。録画機能はAgentのオプション機能（カスタムインストールで選択） |
| **データベース** | Microsoft SQL Server または PostgreSQL（録画メタデータの保存用） |
| **ファイル共有** | 録画データの保存先（SMB、TCP 445） |
| **TLS証明書** | Recording ServerにCA署名付き証明書を推奨 |
| **サービスアカウント** | Recording Server用のドメインサービスアカウント |

### ストレージサイジング

録画データのストレージ要件はセッション数・録画時間・品質に大きく依存する。

**サイジング計算式:**

```
必要ストレージ (GB) = 同時録画セッション数 × 平均セッション時間(時間)
                     × データレート (GB/時) × 保持日数
```

**データレートの目安:**

| 品質設定 | データレート | 1セッション8時間あたり |
|---|---|---|
| 低品質 | 約 50-100 MB/時 | 400-800 MB |
| 中品質 | 約 100-200 MB/時 | 800 MB - 1.6 GB |
| 高品質 | 約 200-500 MB/時 | 1.6 - 4 GB |

> **注意**: データレートは画面変更頻度に大きく依存する。CAD操作やビデオ再生のようなグラフィックス集約型操作は通常のオフィス作業より大幅にデータ量が増加する。

**サイジング例:**
- 同時録画セッション: 50
- 平均セッション時間: 8時間
- データレート: 150 MB/時（中品質）
- 保持期間: 90日
- 必要ストレージ = 50 × 8 × 0.15 GB × 90 = **5,400 GB (約5.4 TB)**

---

## 記録基準の評価（ローカルセッション、リモートセッション、グループで記録）

### 記録基準の種類

Recording Serverでは、以下の基準で記録対象を制御できる。

#### 1. セッションタイプによる記録

| セッションタイプ | 説明 | 設定 |
|---|---|---|
| **ローカルセッション (Local Session)** | 内部ネットワークからの直接接続セッション | 個別に有効/無効 |
| **リモートセッション (Remote Session)** | UAG経由の外部ネットワークからのセッション | 個別に有効/無効 |
| **すべてのセッション (All Sessions)** | ローカル・リモート両方 | 両方有効 |

#### 2. ユーザー/グループによる記録

| 記録対象 | 説明 |
|---|---|
| **ADグループ単位** | 特定のADセキュリティグループに属するユーザーのセッションを記録 |
| **個別ユーザー単位** | 特定ユーザーのセッションのみを記録 |
| **デスクトッププール単位** | 特定のプールへの接続を記録 |

#### 3. その他の記録基準

| 基準 | 説明 |
|---|---|
| **スケジュール** | 特定の時間帯のみ記録を有効化 |
| **条件付き記録** | 特定条件（プール、接続元ネットワーク等）に基づく記録 |

### 判断フレームワーク: 何を記録すべきか

| シナリオ | 推奨記録基準 |
|---|---|
| **全社コンプライアンス** | 全ユーザー × 全セッション |
| **特権ユーザー監視** | 管理者ADグループ × 全セッション |
| **外部アクセス監視** | 全ユーザー × リモートセッションのみ |
| **特定部門のコンプライアンス** | 対象部門のADグループ × 全セッション |
| **トレーニング目的** | 対象ユーザー × ローカルセッションのみ |

### 記録ポリシー設定

Horizon Consoleでの記録ポリシーの設定:

| 設定項目 | 説明 | 設定値の例 |
|---|---|---|
| **Recording Policy Name** | ポリシーの識別名 | `Compliance-Finance-Policy` |
| **Target** | 記録対象（ユーザー/グループ/プール） | AD Group: `Finance-Users` |
| **Session Type** | ローカル/リモート/すべて | `All Sessions` |
| **Recording State** | 有効/無効 | `Enabled` |

---

## Recording Serverのデプロイと設定

### デプロイ手順

#### Step 1: Recording Serverのインストール

1. Horizon Recording Serverインストーラーをダウンロード
2. Windows Serverにインストーラーを実行
3. インストールウィザードで以下を設定:
   - インストールディレクトリ
   - サービスアカウント
   - TLS証明書の選択
   - 録画データの保存先ディレクトリ

#### Step 2: Connection Serverへの登録

1. Horizon Console → **Settings** → **Servers** → **Recording Servers**
2. **Add** をクリック
3. Recording ServerのFQDNを入力
4. 接続テストを実行
5. 登録を完了

#### Step 3: 録画ポリシーの作成

1. Horizon Console → **Settings** → **Recording Policies**
2. **Add** をクリック
3. ポリシー設定を構成:
   - ポリシー名
   - 記録対象（ユーザー/グループ）
   - セッションタイプ（ローカル/リモート/すべて）
   - 有効/無効
4. ポリシーを保存

#### Step 4: Horizon Agentの録画機能有効化

録画対象のゴールデンイメージで、Horizon Agentインストール時に **Session Recording** オプションを有効にする（カスタムインストール → Session Recording Agent を選択）。

### ロードバランサーの使用（複数Recording Server構成）

大規模環境では、複数のRecording Serverをロードバランサーの背後に配置してスケーラビリティを確保できる。

| 設定項目 | 詳細 |
|---|---|
| **LBヘルスチェック** | TCP 9443への接続確認 |
| **セッションアフィニティ** | Source IPベースのアフィニティが必要 |
| **設定の一貫性** | 1台目のRecording Serverの設定を2台目にインポート可能（TCP 9443経由） |

### 運用設定

#### 録画データの管理

| 設定項目 | 説明 | 推奨値 |
|---|---|---|
| **保持期間** | 録画データを保持する日数 | 規制要件に準拠（例: 90日、1年、7年） |
| **自動削除** | 保持期間超過の録画を自動削除 | 有効 |
| **アーカイブ** | 長期保存が必要な録画を別ストレージに移動 | 必要に応じて構成 |

#### 録画データの検索と再生

| 検索条件 | 説明 |
|---|---|
| ユーザー名 | 特定ユーザーの録画を検索 |
| 日時範囲 | 期間を指定して検索 |
| セッションID | 特定セッションの録画を検索 |
| マシン名 | 特定VMでの録画を検索 |

#### アクセス制御

| ロール | 権限 |
|---|---|
| **Recording Administrator** | 録画ポリシーの作成・変更・削除、Recording Serverの管理 |
| **Recording Reviewer** | 録画の検索・再生（読み取り専用） |
| **Horizon Administrator** | 全権限 |

---

## ベストプラクティスとアンチパターン

### ベストプラクティス

| # | プラクティス |
|---|---|
| 1 | 録画データのストレージを事前に十分にサイジングする |
| 2 | ADグループベースの記録ポリシーを使用する（個別ユーザー指定は管理が煩雑） |
| 3 | 保持期間は規制要件に合わせて設定し、自動削除を有効にする |
| 4 | Recording Serverは専用のWindows Serverに配置する |
| 5 | 録画データの暗号化とアクセス制御を適切に構成する |
| 6 | 録画の再生権限はRBACで必要最小限のユーザーに限定する |

### アンチパターン

| # | アンチパターン | リスク |
|---|---|---|
| 1 | ストレージサイジングなしでデプロイ | ディスクフル→録画停止 |
| 2 | 全ユーザーの全セッションを無条件に記録 | ストレージ肥大化、パフォーマンス低下 |
| 3 | 保持期間の未設定 | ストレージ無限増加 |
| 4 | 録画データへのアクセス制御なし | プライバシー/セキュリティ違反 |

---

## 理解度チェックリスト

- [ ] Recording Serverの主要ユースケース（コンプライアンス、セキュリティ監査、フォレンジック等）を説明できる
- [ ] Recording Serverデプロイの前提条件（OS、ドメイン、ポート、Horizon Agent設定）を列挙できる
- [ ] ストレージサイジングの計算方法を理解し、具体的な環境に対して算出できる
- [ ] ローカルセッション/リモートセッション/グループベースの記録基準の違いを説明でき、環境に応じた適切な基準を選択できる
- [ ] Recording Serverのデプロイ手順（インストール→CS登録→ポリシー作成→Agent設定）を説明できる
- [ ] 録画データの保持期間・自動削除・アーカイブの設定方法を理解している
- [ ] RBACによる録画データのアクセス制御を構成できる
