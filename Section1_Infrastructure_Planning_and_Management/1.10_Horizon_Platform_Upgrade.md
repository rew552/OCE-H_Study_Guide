# 1.10 Horizon Platform Upgrade

## 試験ガイド対応: Objective 4.1.10

> **Evaluate dependencies and order in upgrading Horizon components and the underlying hypervisor setup.**
> **Upgrade Agents (Horizon, App Volumes, DEM) in correct order.**
> **Identify the scenarios where maintenance window is required (mandatory) for the upgrade.**
> **Evaluate to back up relevant information before the upgrade.**

---

## Horizonコンポーネントと基盤ハイパーバイザーのアップグレード依存関係と順序の評価

### アップグレード順序チャート

Horizon環境のアップグレードは、以下の順序で実行する必要がある。順序を誤ると互換性の問題が発生する。

```
[Step 1] サポート終了機能のアンインストール
    │     (Security Server, JMP Server, View Composer)
    ▼
[Step 2] Horizon Client のアップグレード
    │     (エンドユーザー側)
    ▼
[Step 3] Connection Server のバックアップ・準備
    │     (Horizon LDAP, 設定, 証明書)
    ▼
[Step 4] Connection Server のアップグレード
    │     (レプリカグループ内で順次)
    ▼
[Step 5] GPO テンプレートの更新
    │     (ADMX/ADML ファイル)
    ▼
[Step 6] vCenter Server のアップグレード
    │     (既存セッションは切断されない)
    ▼
[Step 7] ESXi Host のアップグレード
    │     (vMotionでゼロダウンタイム可能)
    ▼
[Step 8] Horizon Agent のアップグレード
    │     (テンプレートVM → プール再作成)
    ▼
[Step 9] App Volumes Agent のアップグレード
    ▼
[Step 10] DEM Agent / Management Console のアップグレード
    ▼
[Step 11] CPA環境の場合：CPA環境のアップグレード
```

### 依存関係の重要なルール

| ルール | 説明 |
|---|---|
| **CS ≧ Agent** | Connection Serverは常にHorizon Agent以上のバージョンであること。新しいCSは古いAgentをサポートするが、逆は不可 |
| **CS = Enrollment Server** | 登録サーバはConnection Serverと同じバージョンにする |
| **vCenter / ESXi互換性** | Omnissa製品相互運用性マトリックス（interopmatrix.omnissa.com）で確認必須 |
| **非FIPSからFIPSへ不可** | 非FIPSインストールをFIPSインストールにアップグレードすることはできない |

### バージョン互換性マトリックス

| Connection Server (旧ver) | Enrollment Server (旧ver) | Agent (旧ver) | Client (旧ver) |
|---|---|---|---|
| **新 CS** | — | アップグレード時のみ互換 | 非互換 |
| **新 Enrollment Server** | 非互換 | — | 互換あり |
| **新 Agent** | アップグレード時のみ互換 | 互換あり | — |
| **新 Client** | 互換あり | 互換あり | 互換あり |

> **ESB (Extended Service Branch)**: 2312 ESB以降、ESBサーバは将来のCurrent Release (CR) Agentもサポートする（新しいESBリリースが利用可能になるまで）。

### サポートされるアップグレードパス

- **Horizon 8.x → Horizon 8.x**: ソースバージョンのリリース日以降にターゲットバージョンがリリースされている場合に可能
- **Horizon 7.13.x → Horizon 8 2303以降**: サポートされる
- **Horizon 8 2406以前 → Horizon 8 2412以降**: 特別な注意事項あり（KB6000681参照 — Omnissaリブランディングによるパス・レジストリ変更）

### Horizon 2412以降へのアップグレード時の注意

バージョン2412以降では、Omnissaリブランディングに伴い以下が変更される:
- **フォルダ構造・ファイルパス**: `C:\Program Files\VMware\` → `C:\Program Files\Omnissa\`
- **レジストリキー**: `HKLM\SOFTWARE\VMware, Inc.\` → `HKLM\SOFTWARE\Omnissa\`
- **ADMXテンプレート**: `vmware-view-*.admx` → `omnissa-view-*.admx`（Central Store内の更新が必要）
- **GPOパス**: `Administrative Templates > VMware View` → `Administrative Templates > Omnissa`
- **API・ADAM (AD LDS) データベース**
- **SDK**
- **サービス名**: `VMware Horizon *` → `Omnissa Horizon *`

**事前にUAT環境でアップグレードを検証すること**（Omnissa推奨、KB6000681参照）。

> **試験ポイント**: 2412以降へのアップグレードでは、カスタムスクリプトやサードパーティ製品がVMwareパスやレジストリキーを参照している場合、それらの更新も必要。GPOのADMXテンプレートは自動更新されないため、手動でCentral Storeを更新する必要がある。

### Horizon 2412の主要な新機能

| 新機能 | 概要 |
|---|---|
| **Automated Keylogger Policy** | Keylogger保護がAgent側で有効化時に自動起動 |
| **Display Insights in Helpdesk Tool** | Horizon Consoleからディスプレイスケーリングデータを直接確認可能 |
| **Scanner Redirection on Chrome** | Chromeクライアントでスキャナーリダイレクションをサポート |
| **FIDO2 WebAuthn on Linux Client** | LinuxクライアントでFIDO2リダイレクションをサポート |
| **Omnissa Licensing Module** | 新形式のライセンスキー（60日猶予期間内に移行） |

---

## エージェントのアップグレード順序（Horizon, App Volumes, DEM）

### 正しいアップグレード順序

```
1. Horizon Agent      ← 基盤となるエージェント
2. App Volumes Agent  ← Horizon Agentに依存
3. DEM Agent          ← Horizon Agent / App Volumes Agentと連携
```

### Horizon Agentのアップグレード方法

| 方式 | 説明 | 適用場面 |
|---|---|---|
| **手動アップグレード** | テンプレートVMでインストーラーを実行 → スナップショット → プール再構成 | インスタントクローン環境 |
| **自動アップグレード (Agent Auto Update)** | Horizon Consoleからエージェントの自動アップグレードを設定 | Horizon 8 2306以降。フルクローン・手動プール環境 |

**Agent Auto Update の動作:**
- Horizon Consoleで対象プール/マシンを選択してアップグレードをスケジュール
- Horizon Agent、App Volumes Agent、DEM Agentなどのサポート対象エージェントを一括アップグレード可能
- アップグレード中にマシンは再起動される

### インスタントクローン環境でのエージェントアップグレード手順

1. ゴールデンイメージ（テンプレートVM）を起動
2. Horizon Agentインストーラーの新バージョンを実行（既存バージョンの自動検出→アップグレード）
3. App Volumes Agentインストーラーの新バージョンを実行
4. DEM FlexEngineインストーラーの新バージョンを実行
5. テンプレートVMをシャットダウン → スナップショット取得
6. Horizon Consoleでプールの「Base Image」を新スナップショットに変更 → Push Image

---

## メンテナンスウィンドウが必要な（必須の）アップグレードシナリオの特定

### メンテナンスウィンドウが必須のシナリオ

| コンポーネント | 理由 | 影響 |
|---|---|---|
| **Connection Server** | サービス停止が必要。アップグレード中は当該CSへの新規接続不可 | ロードバランサーから除外して順次実施 |
| **vCenter Server** | アップグレード中にプロビジョニング操作が停止。新規デスクトップの起動不可 | 既存セッションは影響なし |
| **ESXi Host（非クラスタ）** | ホスト上のVM全停止が必要 | クラスタ環境ではvMotionで回避可 |
| **インスタントクローンのPush Image** | プール内の全VMが入れ替わる | ユーザーは新VMにログインし直す |

### メンテナンスウィンドウなしで実行可能なシナリオ

| コンポーネント | 方法 |
|---|---|
| **UAG** | Quiesceモード → ローリングアップグレード（ゼロダウンタイム） |
| **ESXi Host（クラスタ環境）** | vMotionで仮想マシンを別ホストに移行後にアップグレード |
| **Horizon Client** | エンドユーザー側で任意のタイミングでアップグレード |
| **GPOテンプレート** | AD上でのファイル置き換えのみ |

### Connection Serverアップグレード時のローリングアップグレード手順

1. ロードバランサーからCS01を除外（ドレイン or 無効化）
2. CS01のバックアップ取得（後述）
3. CS01でHorizon Connection Serverインストーラーの新バージョンを実行
4. サービス起動・検証
5. CS01をロードバランサーに復帰
6. CS02以降について同様に繰り返す

> **重要**: アップグレード後のダウングレードは不可。レプリカグループ内のすべてのCSをアップグレードした後、古いバージョンのCSを追加することもできない。

### 並行アップグレード (Horizon 2406以降)

Horizon LCM (Lifecycle Management) APIを使用して、複数のConnection Serverのアップグレードを自動化できる。

- `[POST] /config/v1/connection-servers/action/upgrade-connection-server`
- WinRM構成が前提条件
- 事前チェックAPI（`validate-system-requirements`, `validate-ad-requirements`, `validate-ldap-requirements`）で前提条件を検証

---

## アップグレード前の関連情報のバックアップ評価

### バックアップ対象一覧

| バックアップ対象 | 方法 | 保存場所 |
|---|---|---|
| **Horizon LDAP構成** | 自動バックアップ（デフォルト有効）または `vdmexport` コマンド | `%ProgramData%\Omnissa\Horizon\backups` |
| **Data Recoveryパスワード** | 初回インストール時に設定。Horizon Consoleで変更可能 | 安全な場所に記録 |
| **TLS証明書** | Windows証明書ストアからエクスポート | PFXファイルとして保存 |
| **Connection Server VM** | vSphereスナップショット | ESXiデータストア |
| **vCenter Server** | vCSAバックアップ | バックアップストレージ |
| **App Volumes Manager DB** | SQL Server / PostgreSQLバックアップ | DB バックアップストレージ |
| **DEM設定** | ファイル共有上の設定ファイルコピー | バックアップストレージ |
| **Event Database** | SQL Server / PostgreSQLバックアップ | DB バックアップストレージ |
| **GPOテンプレート** | ADMXファイルのコピー | ファイルサーバ |

### Horizon LDAP構成のバックアップとリストア

**バックアップ（エクスポート）:**

```
vdmexport -f exported_config.LDF
```

- 暗号化されたLDIFデータとしてエクスポートされる
- リストア時にData Recoveryパスワードが必要（1〜128文字）

**リストア（インポート）:**

```
vdmimport -f exported_config.LDF -p <data_recovery_password>
```

### アップグレード前の準備チェック（Connection Server）

PDFに記載されている準備手順:

| # | 準備項目 |
|---|---|
| 1 | 有効なライセンスの確認（無期限ライセンスの場合、Horizon 8 2006以降用の新キーが必要） |
| 2 | 管理者権限を持つドメインユーザーアカウントの確認 |
| 3 | Horizon LDAP構成のバックアップ |
| 4 | Connection Server VMのスナップショット取得 |
| 5 | TLS証明書の確認（CA署名付き証明書 → アップグレード時にWindows証明書ストアへ自動インポート） |
| 6 | 証明書失効リスト(CRL)が含まれていることの確認 |
| 7 | プロキシ設定（インターネットアクセスにプロキシを使用する場合） |
| 8 | vSphere互換性の確認（ESXi/vCenter ServerがTLS 1.1/1.2/1.3をサポートすること） |
| 9 | 製品相互運用性マトリックスの確認（interopmatrix.omnissa.com） |

---

## ベストプラクティスとアンチパターン

### ベストプラクティス

| # | プラクティス |
|---|---|
| 1 | UAT環境でアップグレードを事前検証する |
| 2 | アップグレード前にConnection Server VMのスナップショットを取得する |
| 3 | Horizon LDAP構成をvdmexportでバックアップする |
| 4 | Connection Serverのアップグレードはロードバランサーから除外して順次実施する |
| 5 | 最初のメンテナンスウィンドウですべてのサーバコンポーネントをアップグレードする（Omnissa推奨） |
| 6 | Horizon AgentはConnection Serverと同じバージョンにできるだけ早くアップグレードする |
| 7 | Horizon 2412以降へのアップグレード前にKB6000681の注意事項を確認する |

### アンチパターン

| # | アンチパターン | リスク |
|---|---|---|
| 1 | バックアップなしでアップグレードを実行 | 障害時に復旧不可 |
| 2 | Agentを先にアップグレードしてCSを後にする | 互換性問題 |
| 3 | すべてのCSを同時にアップグレード | サービス全断 |
| 4 | 製品相互運用性マトリックスを確認せずにvSphereをアップグレード | CSとの互換性喪失 |
| 5 | 非FIPSインストール環境でFIPSモードへの「アップグレード」を試みる | 不可（新規インストールが必要） |

---

## 理解度チェックリスト

- [ ] Horizon環境のアップグレード順序（11ステップ）を正しく説明できる
- [ ] Connection Server ≧ Agentのバージョンルールを理解している
- [ ] ESBとCRの関係、およびESBサーバとCR Agentの互換性を説明できる
- [ ] エージェントの正しいアップグレード順序（Horizon → App Volumes → DEM）を説明できる
- [ ] インスタントクローン環境でのエージェントアップグレード手順を説明できる
- [ ] メンテナンスウィンドウが必須のシナリオと不要なシナリオを区別できる
- [ ] Connection Serverのローリングアップグレード手順を説明できる
- [ ] `vdmexport` / `vdmimport` によるHorizon LDAP構成のバックアップ・リストア手順を説明できる
- [ ] アップグレード前のバックアップ対象を漏れなく列挙できる
- [ ] Horizon 2412以降へのアップグレード時の特別な注意事項（リブランディング）を理解している
