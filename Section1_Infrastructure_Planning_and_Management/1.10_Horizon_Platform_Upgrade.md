# 1.10 Horizon Platform Upgrade

## 概要

Horizonプラットフォームのアップグレードは、新機能の利用とセキュリティの向上に重要です。OCE-Hレベルでは、依存関係と順序の評価、エージェントのアップグレード順序、メンテナンスウィンドウの特定、バックアップの評価が求められます。

## 学習目標

このセクションを学習することで、以下のことができるようになります：

- Horizonコンポーネントと基盤ハイパーバイザーセットアップのアップグレード依存関係と順序を評価できる
- エージェントのアップグレード順序を理解している
- メンテナンスウィンドウを特定できる
- バックアップの重要性を評価できる

## 関連リソース

- [クイックリファレンス](../../00_Quick_Reference.md) - ポート番号、設定値、制限値
- [用語集](../../README.md#用語集) - 関連用語の定義
- [1.1 Connection Servers](1.1_Connection_Servers_Enrollment_Access_Connectors.md) - Connection Server設定
- [6.3 Disaster Recovery and Business Continuity](../../Section6_Scale_and_Recovery/6.3_Disaster_Recovery_Business_Continuity.md) - 災害復旧
- [実環境シナリオ](../../00_Scenarios/Section1_Scenarios.md) - 実環境でのシナリオ例

## Horizonコンポーネントと基盤ハイパーバイザーセットアップのアップグレード依存関係と順序の評価

### アップグレード順序

**推奨順序**:
1. vCenter ServerとESXi Hosts
2. Connection Server
3. UAG
4. App Volumes Manager
5. DEM Management Console
6. Horizon Agent
7. App Volumes Agent
8. DEM Agent

**依存関係**:
- Connection Serverは、vCenter Serverのバージョンと互換性が必要
- エージェントは、Connection Serverのバージョンと互換性が必要

:::important
アップグレード順序を守ることで、互換性の問題を防ぎます。
:::

## エージェントのアップグレード順序（Horizon、App Volumes、DEM）

### アップグレード順序

**推奨順序**:
1. Horizon Agent
2. App Volumes Agent
3. DEM Agent

**理由**:
- Horizon Agentが基盤となる
- App Volumes AgentとDEM Agentは、Horizon Agentに依存

### アップグレード方法

**手動アップグレード**:
1. エージェントのインストーラーを実行
2. アップグレードオプションを選択
3. インストールを実行

**自動アップグレード**:
- Horizon Consoleから一括アップグレード
- グループごとにアップグレード

:::tip
エージェントのアップグレードは、メンテナンスウィンドウ中に実行することを推奨します。
:::

## メンテナンスウィンドウが必要な（必須の）アップグレードシナリオの特定

### 必須メンテナンスウィンドウ

**シナリオ**:
1. **Connection Serverのアップグレード**
   - サービス停止が必要
   - すべてのConnection Serverを順次アップグレード

2. **データベースのアップグレード**
   - データベースのメンテナンスが必要
   - バックアップとリストアが必要

3. **vCenter Serverのアップグレード**
   - vCenter Serverのメンテナンスが必要
   - 仮想マシンの管理が一時的に停止

### オプショナルメンテナンスウィンドウ

**シナリオ**:
1. **エージェントのアップグレード**
   - ロールリングアップグレードが可能
   - メンテナンスウィンドウは推奨

2. **UAGのアップグレード**
   - ロードバランサーを使用したロールリングアップグレードが可能

:::warning
Connection Serverのアップグレードは、必ずメンテナンスウィンドウ中に実行してください。
:::

## アップグレード前の関連情報のバックアップ評価

### バックアップ対象

**必須バックアップ**:
1. **Connection Server設定**
   - 設定のエクスポート
   - データベースのバックアップ

2. **証明書**
   - SSL証明書
   - 署名証明書

3. **App Volumes設定**
   - データベースのバックアップ
   - ストレージのバックアップ

4. **DEM設定**
   - ファイル共有のバックアップ
   - 設定のエクスポート

### バックアップ手順

**Connection Server設定のエクスポート**:
1. Horizon Console → View Configuration
2. Export Configuration
3. 設定ファイルを保存

**データベースのバックアップ**:
```sql
-- SQL Serverでのバックアップ例
BACKUP DATABASE horizon_config
TO DISK = 'C:\Backup\horizon_config.bak'
WITH FORMAT, INIT, NAME = 'Full Backup of horizon_config';
```

:::caution
アップグレード前のバックアップは必須です。バックアップなしでアップグレードを実行しないでください。
:::

## 詳細なアップグレード手順（ステップバイステップ）

### Connection Serverのアップグレード

**詳細手順**:

1. **アップグレード前の準備**
   - 現在のバージョンを確認
   - バックアップの取得
   - テスト環境での検証

2. **アップグレードの実行**
   - インストーラーを実行
   - アップグレードオプションを選択
   - インストールウィザードの進行

3. **アップグレード後の検証**
   - サービスの起動確認
   - 接続テスト
   - 設定の確認

**レプリケーショングループでのアップグレード**:

1. **最初のConnection Serverのアップグレード**
   - プライマリConnection Serverをアップグレード
   - 検証

2. **残りのConnection Serverのアップグレード**
   - 各Connection Serverを順次アップグレード
   - 各アップグレード後に検証

3. **全体の検証**
   - すべてのConnection Serverが正常に動作することを確認
   - レプリケーションが正常に動作することを確認

### UAGのアップグレード

**詳細手順**:

1. **アップグレード前の準備**
   - 現在のバージョンを確認
   - 設定のエクスポート
   - バックアップの取得

2. **アップグレードの実行**
   - インストーラーを実行
   - アップグレードオプションを選択
   - 設定のインポート

3. **アップグレード後の検証**
   - 接続テスト
   - 設定の確認

**ロードバランサー環境でのアップグレード**:

1. **ロードバランサーからUAGを一時的に削除**
   - メンテナンスモードに設定

2. **UAGのアップグレード**
   - アップグレードを実行
   - 検証

3. **ロードバランサーにUAGを戻す**
   - メンテナンスモードを解除
   - 接続テスト

## ロールバック手順

### ロールバックの準備

**ロールバック計画**:
- バックアップの確認
- ロールバック手順の準備
- ロールバック時間の見積もり

### Connection Serverのロールバック

**手順**:

1. **サービスの停止**
   ```powershell
   Stop-Service "VMware Horizon View Connection Server"
   ```

2. **旧バージョンのインストール**
   - 旧バージョンのインストーラーを実行
   - ダウングレードオプションを選択

3. **データベースのリストア**
   - バックアップからデータベースをリストア
   - 設定の確認

4. **サービスの起動**
   ```powershell
   Start-Service "VMware Horizon View Connection Server"
   ```

5. **検証**
   - 接続テスト
   - 設定の確認

### UAGのロールバック

**手順**:

1. **UAGの停止**
   ```bash
   # SSH経由でUAGに接続
   ssh admin@<UAG IP>
   
   # UAGサービスの停止
   systemctl stop gateway
   ```

2. **旧バージョンのインストール**
   - 旧バージョンのインストーラーを実行
   - 設定のインポート

3. **UAGの起動**
   ```bash
   systemctl start gateway
   ```

4. **検証**
   - 接続テスト
   - 設定の確認

:::warning
ロールバックは、データ損失のリスクがあります。ロールバック前に、必ずバックアップを確認してください。
:::

## アップグレード前後の検証チェックリスト

### アップグレード前のチェックリスト

- [ ] 現在のバージョンを確認
- [ ] バックアップの取得
- [ ] テスト環境での検証
- [ ] メンテナンスウィンドウの計画
- [ ] ロールバック計画の準備
- [ ] 依存関係の確認
- [ ] 互換性マトリックスの確認

### アップグレード後のチェックリスト

- [ ] サービスの起動確認
- [ ] 接続テスト
- [ ] 設定の確認
- [ ] パフォーマンステスト
- [ ] 機能テスト
- [ ] ログファイルの確認
- [ ] ユーザーへの通知

## 互換性マトリックス

### Connection ServerとvCenter Serverの互換性

| Connection Server | vCenter Server | ESXi |
|------------------|----------------|------|
| Horizon 8.0 | vSphere 7.0+ | ESXi 7.0+ |
| Horizon 8.1 | vSphere 7.0+ | ESXi 7.0+ |
| Horizon 8.2 | vSphere 7.0+ | ESXi 7.0+ |

### Connection ServerとAgentの互換性

| Connection Server | Horizon Agent |
|------------------|---------------|
| Horizon 8.0 | Horizon Agent 8.0+ |
| Horizon 8.1 | Horizon Agent 8.1+ |
| Horizon 8.2 | Horizon Agent 8.2+ |

:::important
互換性マトリックスを確認し、すべてのコンポーネントが互換性のあるバージョンであることを確認してください。
:::

## ベストプラクティス

1. **アップグレード計画**
   - アップグレード順序の確認
   - メンテナンスウィンドウの計画

2. **バックアップ**
   - すべての設定とデータのバックアップ
   - バックアップの検証

3. **テスト環境**
   - テスト環境でのアップグレード検証
   - 本番環境への適用

## まとめ

Horizonプラットフォームの適切なアップグレードは、新機能の利用とセキュリティの向上に重要です。依存関係と順序の評価、エージェントのアップグレード順序、メンテナンスウィンドウの特定、バックアップの評価により、安全で効率的なアップグレードを実行できます。
