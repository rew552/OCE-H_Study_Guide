# 1.12 FIPS 140-2 Compliance

## 試験ガイド対応: Objective 4.1.12

> **Evaluate Connection server, UAG using FIPS mode deployment.**

---

## FIPS 140-2の概要

### FIPS 140-2とは

**FIPS 140-2 (Federal Information Processing Standard Publication 140-2)** は、暗号化モジュールのセキュリティ要件を定義する米国連邦標準規格である。暗号化モジュールが使用する暗号化アルゴリズム、鍵管理、物理的セキュリティなどの要件を規定する。

| 項目 | 内容 |
|---|---|
| **発行元** | NIST (National Institute of Standards and Technology) |
| **適用範囲** | 米国連邦政府機関、およびFIPS準拠を要求する規制業界 |
| **セキュリティレベル** | Level 1〜4（Horizon 8はLevel 1の暗号化モジュールを使用） |
| **後継規格** | FIPS 140-3（2026年9月以降は新規認証のみFIPS 140-3。既存のFIPS 140-2認証は有効期限まで有効） |

### 適用が必要な環境

| 環境 | 要件 |
|---|---|
| **米国連邦政府機関** | FISMA (Federal Information Security Management Act) により必須 |
| **DoD (国防総省)** | DISA STIG準拠の一環として必須 |
| **金融機関** | PCI DSSなど一部の規制で推奨/要求 |
| **医療機関** | HIPAA準拠の一環として推奨 |
| **政府請負業者** | FedRAMP認証環境で必須 |

---

## Connection ServerでのFIPSモードデプロイメントの評価

### FIPSモードの有効化 — 重要な制約

> **最重要ポイント**: Horizon 8のFIPSモードは**新規インストール時にのみ**有効化できる。**非FIPSインストールをFIPSインストールにアップグレードすることは不可能**。

これは試験でよく問われるポイントであり、FIPSモードが必要な場合は最初からFIPSモードでインストールする必要がある。

### FIPSモードでのインストール前提条件

#### Windows環境の準備

| 前提条件 | 詳細 |
|---|---|
| **Windows FIPSモード** | WindowsのFIPSアルゴリズムポリシーを有効化する必要がある |
| **レジストリ設定** | `HKLM\SYSTEM\CurrentControlSet\Control\Lsa\FipsAlgorithmPolicy` → `Enabled` = `1` (DWORD) |
| **OS再起動** | レジストリ変更後にOS再起動が必要 |
| **参考** | Microsoft KB811833 参照 |

#### Connection Server固有の前提条件

| 前提条件 | 詳細 |
|---|---|
| **CA署名付きvdm証明書** | FIPS準拠モードの新規インストールでは、CA署名付き証明書が**インストール前に**Windows証明書ストアに配置されている必要がある |
| **証明書のフレンドリ名** | `vdm` または `vdm.ec` |
| **プライベートキー** | エクスポート可能としてマーク |
| **署名アルゴリズム** | SHA384 / SHA512 |
| **サブジェクト名 / SAN** | Connection ServerのFQDNまたは一致するワイルドカード |
| **EKU** | サーバ認証 (Server Authentication) |

> **注意**: vdm証明書が見つからない場合の動作:
> - **バージョン 2209以降**: インストーラーが停止し、証明書が見つからない通知を表示
> - **バージョン 2206以前**: 仮のvdm証明書を自動作成してインストール続行

### FIPSモードのシステム要件

| コンポーネント | 要件 |
|---|---|
| **vSphere** | vCenter Server 6.5以降、ESXi 6.5以降 |
| **暗号化プロトコル** | TLS 1.2のみ（TLS 1.0/1.1は使用不可） |
| **Windows デスクトップ** | FIPS証明書が必要。Horizon Agent FIPS モードオプション選択 |
| **Linux デスクトップ** | RHEL系のみサポート。Horizon Agent `-f yes` オプションで有効化。RHEL 8.xはOS レベルのFIPSモード有効化が必要（`fips-mode-setup --enable`） |
| **Windows Client** | OSレベルのFIPSモード有効化 + Horizon Client FIPSモードオプション選択 |
| **Linux Client** | OSレベルのFIPSモード有効化 |
| **Mac Client** | 構成ファイルでFIPSモード有効化 |

### FIPSモードで承認される暗号化アルゴリズム

| 種類 | 承認アルゴリズム |
|---|---|
| **対称暗号** | AES-128, AES-192, AES-256 |
| **非対称暗号** | RSA 2048ビット以上, ECDSA (P-256, P-384, P-521) |
| **ハッシュ** | SHA-256, SHA-384, SHA-512 |
| **TLS** | TLS 1.2のみ |
| **暗号スイート** | FIPS承認の暗号スイートのみ（RC4, DES, 3DES等は使用不可） |

### FIPSモードの確認方法

FIPSモードが有効かどうかを確認する3つの方法:

| 方法 | 手順 |
|---|---|
| **REST API** | `/rest/config/v3/connection-servers` のレスポンスに `fips_mode_enabled` フィールド（`true`/`false`） |
| **レジストリ** | `HKLM\SOFTWARE\Omnissa\Horizon\FipsMode` → `0` = 非FIPS, `1` = FIPS（2412以降。2406以前は `HKLM\SOFTWARE\VMware, Inc.\VMware VDM\FipsMode`） |
| **CSデバッグログ** | `[MessageFrameWork] KeyVault：FIPSモードで開始しています。` |

> **注意**: Horizon Console上にFIPSモードの有効/無効を示す表示はない。

### FIPSモードでのConnection Serverインストール手順

1. Windows ServerでFIPSアルゴリズムポリシーを有効化 → OS再起動
2. CA署名付き証明書をWindows証明書ストアに配置（フレンドリ名: `vdm`）
3. Connection Serverインストーラーを実行
4. インストールウィザードで **FIPS Mode** オプションを選択
5. レプリカサーバも同様にFIPSモードオプションを選択してインストール

---

## UAGでのFIPSモードデプロイメントの評価

### UAGのFIPSモード

Unified Access GatewayもFIPSモードでのデプロイが可能である。

| 設定方法 | 詳細 |
|---|---|
| **デプロイ時** | OVFデプロイ時のプロパティまたはINI設定ファイルで `fipsEnabled=true` を指定 |
| **REST API** | UAG REST APIでFIPSモードを有効化 |
| **管理コンソール** | `https://<UAG_IP>:9443` → System Configuration → FIPS Mode |

### UAG FIPSモードの影響

| 影響 | 詳細 |
|---|---|
| **暗号化スイート** | FIPS承認の暗号スイートのみ使用（弱い暗号は無効化） |
| **TLS** | TLS 1.2以上のみ |
| **パフォーマンス** | FIPS準拠の暗号化処理はわずかにオーバーヘッドが増加する可能性 |
| **クライアント互換性** | 古いクライアントでFIPS非対応の暗号スイートのみサポートする場合は接続不可 |

---

## FIPSモードの影響評価 — 判断フレームワーク

### 有効化前に評価すべき項目

| 評価項目 | 確認内容 | 影響 |
|---|---|---|
| **機能制限** | FIPSモードで使用できない機能の有無 | 一部の認証方式やプロトコルが制限される可能性 |
| **パフォーマンス** | 暗号化処理のオーバーヘッド | 一般的に5-10%の性能低下。サイジングに余裕を持たせる |
| **クライアント互換性** | すべてのクライアントがFIPS対応暗号をサポートするか | 古いクライアント・シンクライアントの更新が必要な場合あり |
| **証明書要件** | CA署名付き証明書が事前に必要 | 自己署名証明書では不可（CS 2209以降） |
| **アップグレードパス** | 非FIPS→FIPSのアップグレードは不可 | 既存環境のFIPS化には再インストールが必要 |
| **全コンポーネント** | すべてのHorizonコンポーネントでFIPSを有効化 | CS, Agent, Clientすべてで統一的に有効化する必要がある |

### 判断フレームワーク: FIPSモードを有効化すべきか

```
規制要件でFIPS準拠が義務付けられているか？
├─ Yes → FIPSモード必須（新規インストールで有効化）
└─ No
    ├─ 組織のセキュリティポリシーでFIPSが推奨されているか？
    │   ├─ Yes → FIPSモードを検討（影響を評価の上）
    │   └─ No → FIPSモード不要（不要な制約を避ける）
    └─ 将来的にFIPS要件が発生する可能性があるか？
        ├─ Yes → 新規デプロイはFIPSモードで実施を推奨
        └─ No → FIPSモード不要
```

---

## ベストプラクティスとアンチパターン

### ベストプラクティス

| # | プラクティス |
|---|---|
| 1 | FIPS要件がある場合は初回インストール時にFIPSモードを有効化する（後からの変更不可） |
| 2 | すべてのHorizonコンポーネント（CS, Agent, Client）で統一的にFIPSを有効化する |
| 3 | FIPSモードのテスト環境を構築し、機能・パフォーマンス・クライアント互換性を事前検証する |
| 4 | CA署名付き証明書（SHA384/SHA512）をインストール前に準備する |
| 5 | FIPSモードの有効化後、REST APIまたはレジストリで有効化を確認する |
| 6 | クライアントデバイスの棚卸しを行い、FIPS対応状況を確認する |

### アンチパターン

| # | アンチパターン | リスク |
|---|---|---|
| 1 | 既存の非FIPS環境でFIPSへの「アップグレード」を試みる | 不可能。再インストールが必要 |
| 2 | CS のみFIPSモードにしてAgent/Clientは非FIPSのまま | 暗号化の一貫性が失われる |
| 3 | 自己署名証明書でFIPSモードのインストールを試みる（2209以降） | インストーラーが停止する |
| 4 | FIPSモードの影響を評価せずに本番環境で有効化 | クライアント接続不可、機能制限 |
| 5 | 将来のFIPS要件を予見せず非FIPSモードでデプロイ | 後から変更不可のため再デプロイが必要 |

---

## 理解度チェックリスト

- [ ] FIPS 140-2の適用範囲（連邦政府、DoD、FedRAMP等）を説明できる
- [ ] **非FIPSからFIPSへのアップグレードが不可能**であることを理解している
- [ ] Connection ServerのFIPSモードインストール前提条件（Windows FIPSポリシー、CA署名証明書、SHA384/512）を列挙できる
- [ ] vdm証明書の要件（フレンドリ名、SAN、EKU、署名アルゴリズム、キーのエクスポート可能フラグ）を説明できる
- [ ] FIPSモードの確認方法（REST API, レジストリ, デバッグログ）を3つ説明できる
- [ ] FIPSモードで承認される暗号化アルゴリズム（AES, RSA 2048+, SHA-256+, TLS 1.2）を列挙できる
- [ ] UAGでのFIPSモードデプロイメント方法を説明できる
- [ ] FIPSモード有効化の影響（機能制限、パフォーマンス、クライアント互換性）を評価できる
- [ ] すべてのHorizonコンポーネント（CS, Agent, Client）でFIPSを統一的に有効化する必要性を理解している
