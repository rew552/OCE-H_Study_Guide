# 1.9 Resource Allocation and Load Balancing

## 試験ガイド対応: Objective 4.1.9

> **Configure and enable load balancing for Connection Servers**
> **Integrate UAG to Connection Server (Best practice: always maintain 1:1 ratio)**

---

## Connection Serverのロードバランシング設定と有効化

### Horizonプロトコルの理解

ロードバランシングを正しく構成するには、Horizonの2種類のプロトコルを理解する必要がある。

| プロトコル種別 | 説明 | ポート |
|---|---|---|
| **Primary Protocol (XML-API)** | 認証・認可・セッション管理の制御プロトコル。HTTPS上のXMLメッセージ | TCP 443 |
| **Secondary Protocols** | 認証成功後に確立される表示プロトコル群 | 下記参照 |

**Secondary Protocolsの詳細:**

| プロトコル | ポート（TCP） | ポート（UDP） | 用途 |
|---|---|---|---|
| HTTPS Tunnel | 443 | — | RDP, MMR, CDR, Client Framework Channelのカプセル化 |
| Blast Extreme | 443 | 8443 | 表示プロトコル（UDP はオプション） |
| PCoIP | 4172 | 4172 | 表示プロトコル |

> **重要**: Secondary Protocolsは、Primary Protocolがルーティングされたのと**同じUAGアプライアンス**にルーティングされなければならない。異なるUAGにミスルーティングされると、認可されずにセッションがドロップされる。

### ロードバランサーの構成要件

**必須要件:**
- L4（TCP）またはL7（HTTPS）ロードバランシング対応
- Session Affinity（Sticky Session）のサポート
- Health Monitoring機能

**Session Affinityタイムアウト**: ロードバランサーのAffinityタイムアウトは、Horizonのセッションタイムアウト（デフォルト10時間）に合わせて設定する。

### Session Affinity の3つの方式

UAGロードバランシングでは、Secondary ProtocolsがPrimary Protocolと同じUAGに到達することを保証するための3つの方式がある。

#### 比較表

| 項目 | Method 1: Source IP Affinity | Method 2: Multiple Port Groups | Method 3: Multiple VIPs |
|---|---|---|---|
| **仕組み** | クライアントIPアドレスに基づくルーティング | UAGごとに固有ポート番号を割当 | UAGごとに固有VIPを割当 |
| **VIP数** | 1 | 1 | UAG数 + 1 |
| **ポート番号** | 標準 | 非標準（外部向け） | 標準 |
| **Source IP依存** | あり | なし | なし |
| **UAG HA機能との併用** | — | 可能（LB不要） | 可能（LB不要） |
| **推奨ケース** | Source IP Affinityが可能な環境 | Source IPが使えず、VIPを増やしたくない場合 | Source IPが使えず、標準ポートを使いたい場合 |

#### Method 1 — Source IP Affinity

最もシンプルな構成。すべてのUAGで同一のExternal URLを設定する。

**UAG設定例（2台構成）:**

| UAG | 設定項目 | 値 |
|---|---|---|
| UAG01 | tunnelExternalURL | `https://uag.myco.com:443` |
| UAG01 | blastExternalURL | `https://uag.myco.com:443` |
| UAG01 | pcoipExternalURL | `10.20.30.40:4172` |
| UAG02 | tunnelExternalURL | `https://uag.myco.com:443` |
| UAG02 | blastExternalURL | `https://uag.myco.com:443` |
| UAG02 | pcoipExternalURL | `10.20.30.40:4172` |

**制約**: NAT環境やプロキシ環境ではSource IPが変化するため使用不可。

#### Method 2 — Multiple Port Number Groups

UAGごとに固有のポート番号を割り当て、ポート番号でルーティングを区別する。

**UAG設定例:**

| UAG | 設定項目 | 値 |
|---|---|---|
| UAG01 | tunnelExternalURL | `https://uag.myco.com:10143` |
| UAG01 | blastExternalURL | `https://uag.myco.com:10143` |
| UAG01 | pcoipExternalURL | `10.20.30.40:10172` |
| UAG02 | tunnelExternalURL | `https://uag.myco.com:10243` |
| UAG02 | blastExternalURL | `https://uag.myco.com:10243` |
| UAG02 | pcoipExternalURL | `10.20.30.40:10272` |

**ポートマッピングルール（LB設定）:**

| LB Source Port | Protocol | 宛先サーバ | 宛先ポート |
|---|---|---|---|
| 443 | TCP | UAG01 / UAG02（負荷分散） | 443 |
| 10443 | TCP/UDP | UAG01 | 443 / 8443 |
| 10172 | TCP/UDP | UAG01 | 4172 |
| 10243 | TCP/UDP | UAG02 | 443 / 8443 |
| 10272 | TCP/UDP | UAG02 | 4172 |

UAG03以降は同一パターンを拡張（03=103xx, 04=104xx, ...最大99台まで）。

#### Method 3 — Multiple VIPs

UAGごとに個別のVIP（パブリックIP）を割り当てる。標準ポート番号を使用可能。

**UAG設定例:**

| UAG | 設定項目 | 値 |
|---|---|---|
| UAG01 | tunnelExternalURL | `https://uag1.myco.com:443` |
| UAG01 | blastExternalURL | `https://uag1.myco.com:443` |
| UAG01 | pcoipExternalURL | `10.20.30.41:4172` |
| UAG02 | tunnelExternalURL | `https://uag2.myco.com:443` |
| UAG02 | blastExternalURL | `https://uag2.myco.com:443` |
| UAG02 | pcoipExternalURL | `10.20.30.42:4172` |

#### 判断フレームワーク: どの方式を選ぶか

```
Source IP Affinityが可能か？
├─ Yes → Method 1（最もシンプル）
└─ No
     ├─ 追加のパブリックIPを用意できるか？
     │   ├─ Yes → Method 3（標準ポート使用可）
     │   └─ No  → Method 2（非標準ポートを許容）
     └─ UAG HA機能をLBなしで使いたいか？
         └─ Yes → Method 2 または Method 3
```

### Primary Protocol の Affinity 方式

Source IP Affinity（Method 1）以外の場合、Primary Protocol（XML-API）のAffinityには以下の方式を使用する。

| 方式 | 説明 |
|---|---|
| **UAGセッションCookie追跡** | `ACCESSPOINTSESSIONID` Cookieを追跡してAffinityを維持 |
| **LB挿入Cookie** | ロードバランサーが独自Cookieを挿入してAffinityを維持 |

### Health Monitoring

ロードバランサーからUAGのHealth Monitoringを構成する。

| 設定項目 | 推奨値 |
|---|---|
| **監視リクエスト** | `HTTPS GET /favicon.ico` |
| **期待レスポンス** | `HTTP/1.1 200 OK` |
| **ポーリング間隔** | 30秒 |
| **異常時レスポンス** | `HTTP/1.1 503`（Quiesceモード時） |

**Quiesce Mode（静止モード）:**
- UAG管理コンソールから設定
- 新規セッションの受付を停止（LBが503を受信し、新規ルーティングを停止）
- 既存セッションは切断されずに継続（最大セッションタイマー、通常10時間まで）
- ローリングアップグレードに使用 → **ゼロダウンタイムのUAGアップグレードが可能**

### SSL Offloading / SSL Bridging

| 構成 | 説明 | 注意点 |
|---|---|---|
| **SSL Pass-Through** | LBはSSLを終端せず、UAGでTLS終端 | 最もシンプル |
| **SSL Bridging** | LBでTLS終端→再暗号化してUAGへ転送 | LBとUAGに**同一証明書**が必要（サムプリント不一致検出のため） |
| **SSL Offloading** | LBでTLS終端→平文でUAGへ転送 | 非推奨（UAGまでの通信が暗号化されない） |

> **制約**: クライアント証明書認証を使用する場合、LBはTLSを終端できない。L4 TCPロードバランシングが必須。

---

## UAGとConnection Serverの統合（ベストプラクティス: 1:1比率の維持）

### 1:1マッピングの推奨理由

Omnissaのベストプラクティスとして、**各UAGは1つの特定のConnection Serverのみを`proxyDestinationUrl`で指定する**ことが推奨される。これは「1:1比率」と呼ばれるが、UAG台数=CS台数という意味ではなく、各UAGが複数のCSにまたがってアクセスしない構成を指す。例えば、CS 3台に対してUAG 6台を配置し、2台のUAGが各CSを指す（2:1比率）構成もベストプラクティスに準拠する。

| 観点 | 1:1比率の利点 |
|---|---|
| **パフォーマンス** | 単一Connection Serverへの負荷集中を防止 |
| **障害分離** | UAGまたはCSの障害時に影響範囲を限定 |
| **トラブルシューティング** | 問題の切り分けが容易 |
| **スケーラビリティ** | 水平スケーリングが直感的 |
| **セッション管理** | セッションアフィニティの管理が明確 |

### 構成パターン

**推奨構成（1:1）:**

```
外部ネットワーク
  │
  ├─ UAG01 ──→ Connection Server 01
  ├─ UAG02 ──→ Connection Server 02
  └─ UAG03 ──→ Connection Server 03
```

**非推奨構成（UAG-CS間にLBを配置）:**

```
外部ネットワーク
  │
  ├─ UAG01 ─┐
  ├─ UAG02 ─┼→ [LB] → Connection Server 01, 02, 03
  └─ UAG03 ─┘
  （UAGが個別CSの障害を検出できない）
```

### UAGのHorizon Settings設定

UAG管理コンソール（`https://<UAG_IP>:9443`）での設定項目:

| 設定項目 | 説明 | 推奨値 |
|---|---|---|
| **proxyDestinationUrl** | 接続先Connection ServerのURL | `https://cs01.domain.com` |
| **proxyDestinationUrlThumbprints** | CS証明書のサムプリント | CSのTLS証明書SHA-256サムプリント |
| **tunnelExternalUrl** | Tunnel External URL | `https://uag01.domain.com:443` |
| **blastExternalUrl** | Blast External URL | `https://uag01.domain.com:443` |
| **pcoipExternalUrl** | PCoIP External URL | `<Public_IP>:4172` |

### Connection Serverのロードバランシング（内部接続）

内部ユーザー向けにConnection Server間でロードバランシングする場合:

| 設定項目 | 説明 |
|---|---|
| **Horizon Console → Settings → Servers** | 各CSの設定を確認 |
| **ロードバランサーVIP** | 内部LBのVIPを使用してCSクラスタに分散 |
| **ヘルスチェック** | `HTTPS GET /favicon.ico`（TCPポート443）→ HTTP 200 OK |

---

## ベストプラクティスとアンチパターン

### ベストプラクティス

| # | プラクティス |
|---|---|
| 1 | UAGとCSは1:1比率を維持する |
| 2 | Session AffinityのタイムアウトをHorizonセッションタイムアウト（デフォルト10時間）に合わせる |
| 3 | ローリングアップグレードにはQuiesceモードを使用する |
| 4 | Health Monitoringは30秒間隔の`HTTPS GET /favicon.ico`を使用する |
| 5 | SSL Bridging時はLBとUAGに同一証明書を配置する |
| 6 | クライアント証明書認証時はL4 TCPロードバランシングを使用する |

### アンチパターン

| # | アンチパターン | 影響 |
|---|---|---|
| 1 | Session Affinityなしのロードバランシング | Secondary Protocolsのミスルーティングによるセッション失敗 |
| 2 | SSL Bridgingで異なる証明書を使用（サムプリント設定なし） | MITM検出によるクライアント接続エラー |
| 3 | UAGとCSのN:1構成 | 単一CS障害時に全外部接続が影響 |
| 4 | Health Monitoringの未設定 | 障害UAGへのルーティング継続 |

---

## 理解度チェックリスト

- [ ] Primary ProtocolとSecondary Protocolsの違いを説明でき、Session Affinityが必要な理由を理解している
- [ ] 3つのSession Affinity方式（Source IP / Multiple Port Groups / Multiple VIPs）の比較ができ、環境に応じた選択ができる
- [ ] 各方式でのUAG External URL設定値を正しく構成できる
- [ ] Health Monitoring（`/favicon.ico`、200 OK、503）の仕組みを説明できる
- [ ] Quiesceモードを使ったゼロダウンタイムのローリングアップグレード手順を説明できる
- [ ] SSL Offloading / SSL Bridging / SSL Pass-Throughの違いと制約を説明できる
- [ ] UAGとCSの1:1比率が推奨される理由を説明でき、`proxyDestinationUrl`の設定ができる
- [ ] クライアント証明書認証時にL4 TCPが必要な理由を説明できる
