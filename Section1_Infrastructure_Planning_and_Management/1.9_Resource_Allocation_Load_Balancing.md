# 1.9 Resource Allocation and Load Balancing

## 概要

リソース割り当てとロードバランシングは、Horizon環境のパフォーマンスと可用性に重要です。OCE-Hレベルでは、Connection Serverのロードバランシング設定とUAGとの統合が求められます。

## 学習目標

このセクションを学習することで、以下のことができるようになります：

- Connection Serverのロードバランシング設定と有効化ができる
- ロードバランサーの設定方法を理解している
- UAGとの統合方法を説明できる
- セッションアフィニティの設定を理解している

## 関連リソース

- [クイックリファレンス](../../00_Quick_Reference.md) - ポート番号、設定値、制限値
- [用語集](../../README.md#用語集) - 関連用語の定義
- [1.1 Connection Servers](1.1_Connection_Servers_Enrollment_Access_Connectors.md) - Connection Server設定
- [1.4 Unified Access Gateways](1.4_Unified_Access_Gateways.md) - UAG設定
- [実環境シナリオ](../../00_Scenarios/Section1_Scenarios.md) - 実環境でのシナリオ例

## Connection Serverのロードバランシング設定と有効化

### ロードバランシングの設定

**Horizon Consoleでの設定**:
1. View Configuration → Servers
2. 各Connection Serverを選択
3. Load Balancing設定を確認・調整

**設定項目**:
- **Load Balancing**: 有効/無効
- **Maximum Sessions**: 最大セッション数
- **Session Timeout**: セッションタイムアウト

### ロードバランサーの統合

**要件**:
- レイヤー4（L4）またはレイヤー7（L7）ロードバランサー
- セッションアフィニティ（Sticky Session）のサポート
- ヘルスチェック機能

**詳細なロードバランシングアルゴリズム**:

#### Round Robin

**概要**:
- 順番に各Connection Serverに接続を分散
- シンプルな実装

**設定例（F5 BIG-IP）**:
```bash
ltm pool /Common/horizon-pool {
    load-balancing-mode round-robin
    members {
        /Common/10.0.1.10:443 { address 10.0.1.10 }
        /Common/10.0.1.11:443 { address 10.0.1.11 }
        /Common/10.0.1.12:443 { address 10.0.1.12 }
    }
}
```

#### Least Connections

**概要**:
- 接続数が少ないConnection Serverに接続
- より均等な負荷分散

**設定例（F5 BIG-IP）**:
```bash
ltm pool /Common/horizon-pool {
    load-balancing-mode least-connections-member
    members {
        /Common/10.0.1.10:443 { address 10.0.1.10 }
        /Common/10.0.1.11:443 { address 10.0.1.11 }
        /Common/10.0.1.12:443 { address 10.0.1.12 }
    }
}
```

#### Weighted Round Robin

**概要**:
- 各Connection Serverに重みを設定
- 重みに応じて接続を分散

**設定例（F5 BIG-IP）**:
```bash
ltm pool /Common/horizon-pool {
    load-balancing-mode weighted-round-robin
    members {
        /Common/10.0.1.10:443 {
            address 10.0.1.10
            ratio 3
        }
        /Common/10.0.1.11:443 {
            address 10.0.1.11
            ratio 2
        }
        /Common/10.0.1.12:443 {
            address 10.0.1.12
            ratio 1
        }
    }
}
```

**セッションアフィニティの詳細設定**:

#### Cookieベースのセッションアフィニティ

**設定例（F5 BIG-IP）**:
```bash
ltm profile persistence /Common/horizon-cookie {
    default-profile enabled
    cookie-name "BIGipServer"
    cookie-expiration 3600
}
```

#### Source IPベースのセッションアフィニティ

**設定例（F5 BIG-IP）**:
```bash
ltm profile persistence /Common/horizon-source-ip {
    default-profile enabled
    match-across-services enabled
    match-across-virtuals disabled
    timeout 3600
}
```

**ヘルスチェックの詳細設定**:

#### HTTP/HTTPSヘルスチェック

**設定例（F5 BIG-IP）**:
```bash
ltm monitor https /Common/horizon-https-monitor {
    interval 30
    timeout 10
    retries 3
    send "GET /admin HTTP/1.1\r\nHost: horizon.contoso.com\r\n"
    recv "200 OK"
}
```

#### TCPヘルスチェック

**設定例（F5 BIG-IP）**:
```bash
ltm monitor tcp /Common/horizon-tcp-monitor {
    interval 30
    timeout 10
    retries 3
    destination *:443
}
```

**パフォーマンスメトリックの監視**:

**監視すべきメトリック**:
- **接続数**: 各Connection Serverのアクティブ接続数
- **応答時間**: クライアントへの応答時間
- **エラー率**: 接続エラーの割合
- **CPU使用率**: 各Connection ServerのCPU使用率
- **メモリ使用率**: 各Connection Serverのメモリ使用率

**監視スクリプト例**:
```powershell
# Connection Serverのパフォーマンスメトリックを監視
$servers = @("cs1.contoso.com", "cs2.contoso.com", "cs3.contoso.com")
foreach ($server in $servers) {
    $cpu = Get-Counter "\\$server\Processor(_Total)\% Processor Time" -SampleInterval 5 -MaxSamples 1
    $memory = Get-Counter "\\$server\Memory\% Committed Bytes In Use" -SampleInterval 5 -MaxSamples 1
    Write-Host "$server - CPU: $($cpu.CounterSamples[0].CookedValue)%, Memory: $($memory.CounterSamples[0].CookedValue)%"
}
```

> [!IMPORTANT]
> Connection Serverのロードバランシングは、高可用性とパフォーマンスに重要です。適切に設定してください。

## UAGとConnection Serverの統合（ベストプラクティス：1:1比率の維持）

### 1:1比率の推奨

**理由**:
- パフォーマンスの最適化
- 管理の簡素化
- トラブルシューティングの容易化

**構成例**:
- UAG 1 → Connection Server 1
- UAG 2 → Connection Server 2
- UAG 3 → Connection Server 3

### 統合設定

**UAGでの設定**:
1. UAG管理コンソールにアクセス
2. Horizon Settings → Connection Servers
3. Connection Serverを追加
4. 優先順位を設定

**ロードバランシング設定**:
- 各UAGが対応するConnection Serverに接続
- 障害時の自動フェイルオーバー

> [!TIP]
> 1:1比率を維持することで、パフォーマンスと管理性が向上します。

## ベストプラクティス

1. **ロードバランシング**
   - セッションアフィニティの有効化
   - 適切なヘルスチェック設定

2. **UAG統合**
   - 1:1比率の維持
   - 障害時の自動フェイルオーバー

## まとめ

リソース割り当てとロードバランシングの適切な設定は、Horizon環境のパフォーマンスと可用性に重要です。Connection ServerのロードバランシングとUAGとの1:1比率の維持により、効率的で可用性の高いHorizon環境を構築できます。
