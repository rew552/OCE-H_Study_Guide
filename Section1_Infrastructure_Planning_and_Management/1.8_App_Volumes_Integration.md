# 1.8 Integrate and Configure App Volumes

## 試験ガイド対応

> **4.1.8. Integrate and configure App Volumes.**
> - Install App Volumes Manager
> - Install and Register additional App Volumes Manager
> - Configure SQL connection.
> - Configure Active Directory setting for Authentication.
> - Configure Storage and Storage Group
> - Integrate App Volumes to Horizon Connection Server
> - Define Storage Requirement for replication.
> - Configure replication with partner.
> - Configure Storage access mode.

---

## Install App Volumes Manager

### システム要件

| コンポーネント | 要件 |
|---|---|
| **OS** | Windows Server 2016 / 2019 / 2022 / 2025（Datacenter / Standard） |
| **CPU** | 8 vCPU（App Volumes Install Guide要件。Reference Architectureでは2 vCPUで検証） |
| **RAM** | 10 GB（App Volumes Install Guide要件。Reference Architectureでは8 GBで検証） |
| **データベース** | SQL Server 2014 SP1 〜 2022、Azure SQL Database、Azure SQL Managed Instance |
| **ブラウザ** | Microsoft Edge, Google Chrome, Mozilla Firefox, Safari（最新安定版） |
| **Hypervisor** | VMware ESXi / vCenter Server 7.0 以降、Nutanix AHV 10.0 |
| **Directory Service** | Microsoft Active Directory（2003 functional level 以降）、Microsoft Entra ID |
| **File Share（VHD 使用時）** | SMB version 3 |

### ネットワークポート要件

| 通信経路 | ポート | プロトコル |
|---|---|---|
| Agent ↔ Manager | TCP 80 (HTTP) / TCP 443 (HTTPS) | HTTP/HTTPS |
| Agent ↔ File Shares | TCP 445 | SMB（VHDフォーマット使用時） |
| Manager ↔ Manager | TCP 3001, 3002, 3003, 3004 (HTTP), TCP 54311 (HTTPS) | 内部通信 |
| Manager ↔ SQL Database | TCP 1433 | SQL |
| Manager ↔ ESXi | TCP 443 (HTTPS) | HTTPS |
| Manager ↔ vCenter Server | TCP 443 (HTTPS) | HTTPS |
| Manager ↔ File Shares | TCP 445 | SMB（VHDフォーマット使用時） |
| Manager ↔ Active Directory | TCP 389 (LDAP) / TCP 636 (LDAPS) | LDAP/LDAPS |

### インストール手順（GUI インストーラー）

#### Step 1: インストーラーの実行

```
App Volumes Manager (setup.msi) を実行
```

#### Step 2: Database Server の設定

| 設定項目 | 説明 |
|---|---|
| Database Server | SQL Server の FQDN または Always On Availability Group Listener |
| Database Name | 使用する（または新規作成する）データベース名 |
| Authentication | Windows Integrated Authentication または SQL Authentication |

#### Step 3: ネットワークポートの設定

| 設定項目 | デフォルト値 |
|---|---|
| HTTP Port | 80 |
| HTTPS Port | 443 |

#### Step 4: インストール完了

インストーラーが以下を構成:
- IIS Web サービス
- App Volumes Manager サービス
- データベーススキーマ

### サイレントインストール

```bash
msiexec /i "App Volumes Manager.msi" /qn
    DATABASESERVER="sql.domain.com"
    DATABASENAME="appvolumes"
    INSTALLDIR="C:\Program Files\Omnissa\App Volumes Manager"
```

### 初期構成ウィザード

インストール後、ブラウザで `https://<Manager-FQDN>` にアクセスし、初期構成ウィザードを完了する。

1. **ライセンス設定** — ライセンスキーの入力
2. **AD ドメイン登録** — ドメイン名、サービスアカウント
3. **Machine Manager（vCenter）登録** — vCenter Server の URL、認証情報
4. **管理者グループ指定** — AD セキュリティグループ

---

## Install and Register Additional App Volumes Manager

### 追加 Manager の目的

- **高可用性**: Manager 障害時のフェイルオーバー
- **負荷分散**: ロードバランサー経由でリクエストを分散
- **マルチサイト**: サイトごとに Manager を配置

### 追加 Manager のインストール手順

1. 新規サーバーで App Volumes Manager インストーラーを実行
2. Database Server ページで**既存のデータベースを指定**
3. **「Overwrite existing database」チェックボックスを外す**（既存データの保持）
4. 同一データベースを共有する構成が完了

> **重要**: 同一サイト内の複数 Manager は**同一データベース**を指す。

### Manager の登録

追加 Manager をインストール後、既存の Manager コンソールから登録する。

```
App Volumes Manager Console > CONFIGURATION > Managers
→ Register > 追加 Manager の FQDN を入力
```

**Registration Security**:
- 登録時のセキュリティを強化するために `Activate Registration Security` を有効化可能
- 有効化すると、未登録の Manager からの自動登録を防止

### ロードバランサー構成

- Agent の接続先としてロードバランサーの VIP を指定
- ヘルスチェック: `/cv_pad/server/status` エンドポイントに HTTP GET
- セッションアフィニティ: 不要（各リクエストは独立）

---

## Configure SQL Connection

### データベース設計オプション

| オプション | 説明 | 適するケース |
|---|---|---|
| **単一 SQL Server** | 1つの SQL インスタンスを使用 | 小規模、PoC |
| **SQL Always On Availability Groups** | サイト内の高可用性 | 本番環境（推奨） |
| **サイトごとに独立データベース** | マルチサイトで各サイトに個別 DB | マルチサイト展開 |

### SQL Always On Availability Groups 構成手順

#### 前提条件

1. **Windows Server Failover Cluster (WSFC)** の構成（各サイトに2ノード以上）
2. 各ノードに SQL Server Stand-alone をインストール
3. .NET Framework 3.5、Failover Clustering 機能を有効化

#### 構成手順

1. **WSFC クラスターの作成**（各サイト）
2. **SQL Server Stand-alone のインストール**（各ノード）
   - Default Instance: `MSSQLSERVER`
   - Mixed Mode 認証を有効化
   - データディレクトリを適切なドライブに配置
3. **共有フォルダの作成**（レプリケーション用）
   - 1台目の SQL VM に `Replication` フォルダを作成
   - SQL サービスアカウントに Full Control を付与
4. **App Volumes データベースの作成**
5. **Always On Availability Groups の有効化**
   - SQL Server Configuration Manager で有効化
   - 各クラスターでグループを作成
6. **Availability Group の設定**
   - Synchronous Commit: 有効
   - Automatic Failover: 有効
   - Readable Secondary: Primary = No, Secondary = Yes
7. **Cluster Quorum の設定**
   - File Share Witness を使用（奇数投票の確保）
8. **Named Pipes の有効化**
   - SQL Server Configuration Manager → SQL Server Network Configuration → Named Pipes: Enabled
   - SQL Server サービスの再起動

#### App Volumes インストール時の DB 接続

```
Database Server ページ:
→ Server: Availability Group Listener の FQDN
→ Database: 作成済みデータベース名
```

### データベース認証方式

| 方式 | 説明 |
|---|---|
| **Windows Integrated Authentication** | AD アカウントで認証（リモート DB の場合、接続テストを事前実施） |
| **SQL Server Authentication** | SQL ログインアカウントで認証 |

---

## Configure Active Directory Setting for Authentication

### AD ドメインの登録

初期構成ウィザードまたは管理コンソールから AD ドメインを登録する。

```
App Volumes Manager Console > CONFIGURATION > Active Directory
→ 対象ドメインを選択 / 新規追加
```

### サービスアカウント要件

| 要件 | 説明 |
|---|---|
| **AD 読み取りアクセス** | 管理者権限は不要、Read-only で十分 |
| **パスワード無期限** | `Password never expires` を設定 |
| **ASCII 文字のみ** | ユーザー名に ASCII 文字のみ使用 |

### 信頼関係のあるドメイン

一方向または双方向の信頼関係にあるドメインに接続する場合、別途認証情報を設定可能。

### Domain Controller Hosts の設定

特定の Domain Controller を指定して接続を最適化できる。

```
App Volumes Manager Console > CONFIGURATION > Active Directory > DC Hosts
→ Add → DC の FQDN を入力
```

### 管理者グループ（Administrators Group）

初期構成で指定する AD セキュリティグループが App Volumes Manager へのアクセス権を制御する。

**管理者ロール**:
- 組み込みロールに加え、カスタムロールの作成が可能
- ロールをドメイングループにアサイン

### Recovery Administrator

AD 認証に問題が発生した場合の緊急アクセス用ローカル管理者アカウント。

```
App Volumes Manager Console > CONFIGURATION > Settings
→ Recovery Administrator の設定
```

---

## Configure Storage and Storage Group

### ストレージの種類

| ストレージタイプ | 接続方式 | パッケージ形式 |
|---|---|---|
| **vSphere Datastore (VMFS)** | vCenter 経由 | VMDK |
| **vSphere Datastore (vSAN)** | vCenter 経由 | VMDK |
| **NFS Datastore** | vCenter 経由（共有 DS） | VMDK |
| **SMB File Share** | VHD In-Guest | VHD |

### ストレージの設定

```
App Volumes Manager Console > CONFIGURATION > Storage
→ 対象のストレージが一覧表示（Machine Manager で登録した vCenter のデータストア）
→ Rescan で最新のストレージ情報を取得
```

**テンプレートのアップロード**:
- デフォルトテンプレートサイズ: パッケージ = 20 GB、Writable Volume = 10 GB
- テンプレートは thin-provisioned
- VMDK / VHD 形式で提供

### Storage Group の設定

Storage Group は複数のデータストアをグループ化し、パッケージの自動レプリケーションと Writable Volume の自動分散を管理する。

```
App Volumes Manager Console > CONFIGURATION > Storage > Storage Groups
→ Create Storage Group
```

#### Storage Group の設定項目

| 設定項目 | 説明 |
|---|---|
| **Name** | Storage Group の名前 |
| **Member Datastores** | グループに含めるデータストア |
| **Template Storage** | Writable Volume テンプレートの配置場所 |
| **Distribution Strategy** | Writable Volume の分散方法 |
| **Automatically Replicate Application Packages** | パッケージの自動レプリケーション |
| **Automatically Import Application Packages** | パッケージの自動インポート |

#### Writable Volume の分散戦略

| 戦略 | 説明 |
|---|---|
| **Spread** | 空き容量が最も多いストレージに配置 |
| **Round Robin** | 順番に各ストレージに配置 |

### Not Attachable ストレージ

ストレージを **Not Attachable** に設定すると:
- パッケージのレプリケーション先としてのみ使用
- エンドユーザーへのパッケージマウントには使用されない
- マルチサイトでの共有データストア（NFS 等）をレプリケーション中継点として使用する場合に有効

```
CONFIGURATION > Storage > 対象ストレージ > SET NOT ATTACHABLE
```

---

## Integrate App Volumes to Horizon Connection Server

### Machine Manager としての vCenter 登録

App Volumes Manager は vCenter Server を Machine Manager として登録し、vSphere 環境内の VM やデータストアを管理する。

```
App Volumes Manager Console > CONFIGURATION > Machine Managers
→ Add Machine Manager
→ Type: vCenter Server
→ vCenter Server の FQDN、認証情報を入力
```

#### Machine Manager の種類

| タイプ | 説明 |
|---|---|
| **vCenter Server** | vSphere 環境での VMDK マウント |
| **VHD In-Guest** | SMB 共有を使用した VHD マウント（物理 PC、Nutanix AHV 等） |

#### vCenter アカウントの推奨事項

- **ローカル vCenter アカウント**の使用を推奨（AD アカウントよりパフォーマンスが良い）
- 必要な権限は Machine Manager 設定画面の下部に表示される

### Horizon Connection Server との統合

App Volumes と Horizon の統合により、以下が可能になる:
- Horizon Console からの App Volumes アプリケーション管理
- Published Apps on Demand の利用
- RDSH ファームへのパッケージ配信

#### 統合手順

App Volumes Agent を Horizon のゴールデンイメージにインストールし、Agent が App Volumes Manager に接続する構成を作成する。

**App Volumes Agent のインストール（ゴールデンイメージ）**:

```
App Volumes Agent (setup.msi) をゴールデンイメージ VM で実行
→ App Volumes Manager の FQDN（またはロードバランサー VIP）を入力
→ パッケージアクセスモード: Shared Storage
```

**Agent 要件**:
- 64-bit Windows のみ
- 4 GB RAM（最小）
- 2 vCPU（最小）

---

## Define Storage Requirement for Replication

### レプリケーションのストレージ要件

マルチサイト環境でパッケージをレプリケーションする場合のストレージ要件を見積もる。

#### 計算式

```
必要ストレージ = パッケージ数 × 平均パッケージサイズ × レプリケーション先数
```

#### サイジングの考慮事項

| 項目 | ガイドライン |
|---|---|
| **デフォルトパッケージサイズ** | 20 GB テンプレート（thin-provisioned） |
| **実使用量** | アプリケーション内容に依存（通常 2-10 GB） |
| **推奨パッケージ数** | VM あたり最大 25 パッケージ |
| **VMDK vs VHD** | 両形式で提供可能、環境に合わせて選択 |

#### ストレージ配置の推奨事項

| 環境 | 推奨事項 |
|---|---|
| **従来型ストレージ（VMFS/NFS）** | パッケージと VM を同一データストアに配置しない |
| **vSAN** | パッケージと VM の同一データストア配置可 |
| **大規模ユーザー向け** | Storage Group を使用して I/O を複数データストアに分散 |

---

## Configure Replication with Partner

### Multi-Instance Management

App Volumes 4 では、Multi-Instance Management により異なるサイトの App Volumes インスタンス間でパッケージとアサインメントを同期する。

#### Source / Target の関係

| ロール | 説明 |
|---|---|
| **Source Instance** | パッケージの作成元、マスター |
| **Target Instance** | Source からパッケージを受信する側 |

### Target Instance の登録

```
App Volumes Manager Console（Source 側）> CONFIGURATION > Instances
→ Register > Target Instance の FQDN を入力
```

#### 同期オプション

| オプション | 説明 |
|---|---|
| **Application Package Import** | Target にパッケージをインポート |
| **Package Symmetry Assurance** | Source と Target でパッケージの一致を保証 |
| **Synchronize Markers** | CURRENT マーカーの同期 |
| **Synchronize Assignments** | ユーザー/グループへのアサインメントの同期 |

### 共有データストアを使用したレプリケーション構成

マルチサイト間でのパッケージレプリケーションには NFS 共有データストアを使用する方法が推奨される。

#### 構成手順

1. **NFS データストアを vCenter に追加**（両サイト）
2. **App Volumes に NFS データストアを Not Attachable として登録**
3. **Target Instance 側で共有データストアを Read-Only に設定**
4. **Storage Group の作成**（各インスタンス）
   - ローカルのアタッチ可能データストア + 共有 NFS データストアを含める
   - `Automatically Replicate Application Packages` を有効化
   - `Automatically Import Application Packages` は**無効**

#### レプリケーションフロー

```
Source Instance → 共有 NFS DS（Source 側は Read-Write）
                 → 共有 NFS DS（Target 側は Read-Only）
                    → Target Instance のローカル DS に自動レプリケーション
```

> **重要**: Source Instance 側でのみ共有データストアを Read-Write にする。Target 側は必ず Read-Only に設定し、競合を防止する。

---

## Configure Storage Access Mode

### パッケージアクセスモード

App Volumes Agent のインストール時にパッケージアクセスモードを選択する。

| モード | 説明 | 接続要件 |
|---|---|---|
| **Shared Storage** | パッケージは中央ストレージ上に配置。VM がネットワーク経由でマウント | 常時ネットワーク接続 |
| **Local Copy** | MSI-wrapped VHD をエンドポイントにダウンロード。ローカルで仮想化 | 断続的接続可 |

### Shared Storage モード

- VMDK または VHD パッケージを使用
- vCenter 経由の VMDK マウントまたは VHD In-Guest マウント
- **VDI / RDSH 環境で推奨**

### Local Copy モード

- MSI-wrapped VHD パッケージをエンドポイントにダウンロード
- ダウンロード後はオフラインでもアプリケーション利用可能
- **ラップトップ / リモートデバイスで推奨**
- VHD In-Guest Machine Manager 構成時のみ利用可能
- 定期的に App Volumes Manager と同期（アサインメントの更新を取得）

### Local Copy モードの制限

| 制限事項 | 説明 |
|---|---|
| Directory Service | Active Directory のみ（Entra ID 不可） |
| フィードバックダイアログ | 非表示 |
| Multiple Assignment | バージョン選択ウィンドウ非表示 |
| 使用状況トラッキング | Concurrent Usage / Peak Usage 非対応 |
| Published Apps on Demand | 非対応 |

### ストレージの Read-Only 設定

ストレージを Read-Only に設定すると:
- 新規パッケージの書き込みを防止
- 既存パッケージの読み取り（マウント）は継続可能
- マルチサイトレプリケーションの Target 側で使用

```
CONFIGURATION > Storage > 対象ストレージ > MARK READ-ONLY
```

---

## ベストプラクティスとアンチパターン

### ベストプラクティス

| カテゴリ | 推奨事項 |
|---|---|
| Manager インストール | 本番環境では最低2台の Manager + ロードバランサー |
| データベース | SQL Always On Availability Groups で高可用性確保 |
| vCenter アカウント | ローカル vCenter アカウントを使用（AD アカウントより高速） |
| ストレージ | パッケージと VM を別データストアに配置（VMFS/NFS の場合） |
| Storage Group | 大規模環境では Storage Group で I/O 分散 |
| レプリケーション | Source/Target モデルで1方向レプリケーション、共有 DS は Target 側 Read-Only |
| パッケージング | RDSH 用パッケージは RD-Install モードで作成、デスクトップ用と分離 |
| SSL | 自己署名証明書を CA 署名証明書に置き換え |

### アンチパターン

| アンチパターン | リスク |
|---|---|
| 追加 Manager インストール時に「Overwrite existing database」を有効 | 既存データの消失 |
| 共有データストアを両サイトで Read-Write | レプリケーション競合、データ破損 |
| パッケージと VM を同一データストアに配置（VMFS） | I/O 競合、パフォーマンス劣化 |
| Named Pipes 有効化後に SQL サービス再起動を忘れる | Always On 接続失敗 |
| パッケージング VM に Horizon Agent や DEM FlexEngine をインストール | パッケージキャプチャに干渉 |
| デスクトップ OS で作成したパッケージを RDSH に配信 | 互換性問題、動作不良 |

---

## 重要な制限値・サイジング情報

| 項目 | 値 |
|---|---|
| Manager 推奨 CPU | 8 vCPU |
| Manager 推奨 RAM | 10 GB |
| Agent 最小 CPU | 2 vCPU |
| Agent 最小 RAM | 4 GB |
| デフォルトパッケージテンプレート | 20 GB（thin-provisioned） |
| デフォルト Writable Volume テンプレート | 10 GB |
| VM あたり推奨パッケージ数 | 最大 25 |
| PVSCSI の最大仮想ディスク数 | 256（ESXi 6.7 以降） |
| HTTP ポート | TCP 80 |
| HTTPS ポート | TCP 443 |
| SQL ポート | TCP 1433 |

---

## 理解度チェックリスト

### App Volumes Manager
- [ ] Manager のシステム要件（8vCPU / 10GB RAM / Windows Server 2016+）を説明できる
- [ ] GUI インストーラーでの Manager インストール手順を実行できる
- [ ] 追加 Manager のインストール時に「Overwrite existing database」を外す理由を説明できる
- [ ] Manager の登録と Registration Security の設定を実行できる

### SQL 接続
- [ ] SQL Always On Availability Groups の構成手順（WSFC → SQL → AG → Quorum）を説明できる
- [ ] Named Pipes の有効化が必要な理由を説明できる
- [ ] Windows Integrated Authentication と SQL Authentication の選択基準を評価できる

### Active Directory
- [ ] サービスアカウントの要件（Read-only、パスワード無期限、ASCII 文字）を説明できる
- [ ] Recovery Administrator の用途と設定方法を説明できる

### ストレージ
- [ ] Storage Group の作成と Distribution Strategy（Spread / Round Robin）を設定できる
- [ ] Not Attachable ストレージの用途（レプリケーション中継点）を説明できる
- [ ] Shared Storage と Local Copy のアクセスモードの違いとユースケースを評価できる

### 統合とレプリケーション
- [ ] App Volumes Agent のゴールデンイメージへのインストール手順を実行できる
- [ ] Multi-Instance Management の Source/Target 構成を設定できる
- [ ] 共有データストアを使用したレプリケーション構成（Not Attachable + Read-Only）を実装できる
- [ ] ストレージの Read-Only / Read-Write 設定の使い分けを説明できる
