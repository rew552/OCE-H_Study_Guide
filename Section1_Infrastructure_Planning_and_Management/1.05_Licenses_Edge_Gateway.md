# 1.5 Manage Licenses and Deploy Edge Gateway

## 試験ガイド対応

> **4.1.5. Manage licenses and deploy edge gateway.**
> - Evaluate license method (term vs. subscription)
> - Deploy Horizon Edge Gateway (Download, Connectivity with Subscription)

---

## Evaluate License Method (Term vs. Subscription)

### Horizon 8 ライセンスの種類

Horizon 8 では以下の4種類のライセンスが提供されている。

| ライセンスタイプ | 提供形態 | キー管理 | 対象製品 |
|---|---|---|---|
| **Perpetual License** | 永久ライセンス（買い切り） | ライセンスキー手動入力 | Horizon 8 のみ |
| **Term License** | 期間ライセンス（1年/3年） | ライセンスキー手動入力 | Horizon 8 のみ |
| **Plus SaaS Subscription** | SaaS サブスクリプション | Horizon Edge Gateway 経由で自動 | Horizon 8 のみ |
| **Universal SaaS Subscription** | SaaS サブスクリプション | Horizon Edge Gateway 経由で自動 | Horizon 8 + Horizon Cloud on Azure |

### ライセンス使用モデル（Named User vs. Concurrent）

Horizon 8 は使用モデルに関わらず、Named User (NU) と Concurrent Connected User (CCU) の両方をカウントする。

#### Per Named User (NU)

- **対象**: 全従業員が常時アクセスする環境
- **カウント方法**: エンタイトルメントと実際のログインの組み合わせ
  - 個別ユーザーをプールにエンタイトル → 即座にNUカウント増加
  - ADグループをプールにエンタイトル → グループ自体で1NUカウント、ユーザーがログインするたびに増加
  - 1ユーザーが複数プール・アプリケーションを使用 → **1NUとしてカウント**（重複なし）
- Horizon 8 は常に管理者用に1NUを含む

#### Per Concurrent Connection (CCU)

- **対象**: シフトワーカーや学生など、タイムシェア環境
- **カウント方法**: ある時点で接続中のユーザー数
  - VDIデスクトップ: 各接続セッションが1CCU（同一ユーザーが3デスクトップ = 3CCU）
  - RDSH公開デスクトップ/アプリケーション: ユーザー単位でカウント（複数セッションでも1CCU）
  - VDI + RDSHの混合: ユーザー単位で1CCUとしてカウント
- CCUバンドルのコンポーネントはユーザー間で分割不可（例: Horizon接続中は ThinApp も消費扱い）

### Term License vs. Subscription の判断フレームワーク

| 判断基準 | Term License | SaaS Subscription |
|---|---|---|
| **ライセンス管理** | ライセンスキーを手動入力・管理 | Horizon Edge Gateway 経由で自動管理 |
| **有効期限** | 明示的な期限 + 30日猶予期間 | Control Plane と24時間ごとに同期 |
| **Control Plane接続** | 不要 | 必須（Horizon Edge Gateway） |
| **クラウド機能** | 基本機能のみ | Horizon Universal Console、Intelligence等 |
| **マルチクラウド** | Horizon 8 オンプレのみ | Azure含むハイブリッド展開可能（Universal） |
| **初期投資** | 中〜高 | 低（OpEx モデル） |
| **適するケース** | エアギャップ環境、インターネット接続なし | クラウド管理機能が必要、ハイブリッド環境 |

### Term License の有効期限と制限事項

- 有効期限を過ぎると**30日の猶予期間**が付与される
- 猶予期間終了後、Horizon Console は **restricted mode** に移行:
  - 新規プール/ファームの作成不可
  - 既存プール/ファームの拡張不可
  - Push Image のスケジュール不可
  - 既存デスクトップ・アプリケーションは引き続き利用可能
- バンドルに含まれる vSphere for Desktop のライセンスは猶予期間なし（即座に制限モード）

### ライセンスの混在ルール（同一Pod内）

Horizon 8 pod は**1つのライセンスキーまたは1つのサブスクリプションバンドル**のみ受け付ける。

| 混在パターン | 可否 |
|---|---|
| NU + CCU バンドル（同一タイプ） | 例外承認で可 |
| 異なる Term エディション | 例外承認で可 |
| 同一バンドル異なる期間 | 例外承認で可 |
| 異なる SaaS エディション | 一部可（例外承認） |
| **Term + SaaS** | **不可** |
| **Term + Perpetual** | **不可** |
| **Perpetual + SaaS** | **不可** |

### ライセンスの追加・更新手順

```
Horizon Console > Settings > Product Licensing and Usage > Licensing
```

- Perpetual/Term: ライセンスキーを入力（Omnissa Customer Connect ポータルで取得）
- SaaS Subscription: Horizon Edge Gateway または Horizon Cloud Connector で Control Plane に接続
- Horizon 2412 以降: Omnissa ライセンスモジュールの新形式キーが必要（60日猶予期間内に移行）
- Horizon 7 のキーは Horizon 8 では使用不可

### ライセンス使用状況の監視

```
Horizon Console > Settings > Product Licensing and Usage
```

- **Named Users**: カウントのリセット可能（「Reset Named Users Count」）
- **CCU**: Current / Highest のカウント表示。「Reset Highest Count」でリセット可能

---

## Deploy Horizon Edge Gateway

### Horizon Edge Gateway Appliance とは

Horizon Edge Gateway Appliance は、Horizon 8 環境を Horizon Cloud Service（Control Plane）に接続するための仮想アプライアンスである。

**主な機能**:
- サブスクリプションライセンスの管理・有効化
- Horizon Cloud Service の管理機能への接続
- Horizon Universal Console へのアクセス有効化
- Omnissa Intelligence とのデータ連携

**重要**: サブスクリプションライセンスを使用する場合、各Horizon Podに Horizon Edge Gateway Appliance のデプロイが必須。

### デプロイの前提条件

#### ネットワーク要件

| 要件 | 詳細 |
|---|---|
| **ネットワーク配置** | 内部ネットワークセグメント（DMZ・公開ネットワーク不可） |
| **DNS エントリ** | Horizon Connection Server と UAG から解決可能なFQDN |
| **Line-of-sight** | Horizon Cloud Control Plane の DNS エントリへの到達性 |
| **ファイアウォール** | Edge Appliance ↔ Horizon CS、Edge Appliance ↔ Cloud Service 間の通信許可 |

#### OVF デプロイ時に必要な情報

| パラメータ | 説明 |
|---|---|
| Root Password | アプライアンスの root パスワード |
| Connection String / Pairing Key | Horizon Universal Console から取得 |
| POD Network | Kubernetes Pod ネットワーク CIDR |
| Service Network | Kubernetes Service ネットワーク CIDR |
| Default Gateway | デフォルトゲートウェイ |
| Domain Name | ドメイン名 |
| Domain Name Servers | DNS サーバーアドレス |
| Network IP Address | アプライアンスの IP アドレス |
| Network Netmask | サブネットマスク |
| Proxy Details（任意） | Proxy Host / Port / SSL / Username / Password |

### デプロイ手順（4ステップ）

#### Step 1: 環境準備と前提条件の完了

1. **DNS エントリの作成** - Connection Server と UAG から解決可能な A レコード
2. **Cloud Service への Line-of-sight 確認** - Horizon Cloud Control Plane の DNS エントリへの通信テスト
3. **Pod コンポーネントへの Line-of-sight 確認** - Edge Appliance と Horizon CS 間のファイアウォールルール確認

> **ベストプラクティス**: Edge Gateway Appliance を配置するネットワークセグメントと同じ場所から Cloud Service への接続テストを実施する。

#### Step 2: Provider の作成と Edge の構成

1. Horizon Universal Console にログイン（Omnissa Connect アカウント）
2. Provider（vSphere）を設定
3. Horizon Edge を追加し、Pairing Key を取得

**ライセンスタイプ別のオンボーディング**:
- **Horizon Plus**: Horizon Plus Documentation の手順に従う
- **Horizon Universal License**: Onboarding for Horizon Cloud Service – next-gen の手順に従う

#### Step 3: Edge Gateway Appliance のダウンロードとデプロイ

1. Horizon Universal Console から OVA/OVF ファイルをダウンロード
2. vCenter の OVF デプロイインターフェースから仮想アプライアンスをデプロイ
3. 必要なパラメータ（Root Password、Pairing Key、ネットワーク設定等）を入力
4. アプライアンスを起動（全サービスの起動に**最大15分**）
5. Cloud Service への接続成功通知を確認

#### Step 4: Horizon Connection Server への接続

1. Pairing 完了後、Horizon Connection Server の URL を入力
2. Edge Gateway が自動的にサブスクリプションライセンスを構成

> **注意**: 複数の Connection Server がある場合、**プライマリ Connection Server のみ**を指定。Edge Gateway が他の Connection Server を自動検出する。

### トラブルシューティング

Edge Gateway Appliance は **Photon OS** 上で動作し、Kubernetes コンテナで各機能を実行する。

#### コンテナ状態の確認

```bash
kubectl get pods -A
```

確認ポイント:
- `edgedevice-deployment` pod: READY / Running / Restarts なし
- `view-cs-module-deployment` pod: READY / Running / Restarts なし

#### コンテナからのログ取得

```bash
kubectl get pods -A
kubectl -n <namespace> logs <pod-name> > <filename>
```

#### アクセス方法

- SSH（Putty等）でアプライアンスに接続
- OVF デプロイ時に設定した Root Password を使用

---

## ベストプラクティスとアンチパターン

### ベストプラクティス

| カテゴリ | 推奨事項 |
|---|---|
| ライセンス選択 | クラウド管理機能が不要な場合は Term License、ハイブリッド環境では Universal Subscription |
| ライセンス更新 | 期限の30日前に更新手続きを開始（vSphere for Desktop は猶予期間なし） |
| Edge Gateway 配置 | 内部ネットワークセグメントに配置、DMZ には配置しない |
| DNS 構成 | FQDN で解決可能な A レコードを事前に作成 |
| 接続テスト | デプロイ前に Cloud Control Plane への Line-of-sight を確認 |
| 高可用性 | 各 Pod に1つの Edge Gateway Appliance をデプロイ |

### アンチパターン

| アンチパターン | リスク |
|---|---|
| Edge Gateway を DMZ に配置 | セキュリティリスク（内部ネットワーク専用設計） |
| 異なるライセンスタイプの混在（Term + SaaS） | サポート外、機能不全 |
| ライセンス期限後の放置 | restricted mode によるプール管理機能の喪失 |
| Horizon 7 キーの Horizon 8 への流用 | 動作しない |
| Cloud Service との接続なしで Subscription 運用 | 24時間同期が失敗しライセンス失効 |

---

## 重要なポート番号と制限値

| 項目 | 値 |
|---|---|
| Edge Gateway → Cloud Service | TCP 443 (HTTPS) |
| Edge Gateway → Connection Server | TCP 443 (HTTPS) |
| Edge Gateway → Connection Server | TCP 4002 (JMS) |
| Edge Gateway → UAG | TCP 9443 (UAG監視) |
| Edge Gateway → Azure Blob Storage (*.blob.core.windows.net) | TCP 443 |
| Edge Gateway → Azure Container Registry (horizonedgeprod.azurecr.io) | TCP 443 |
| Edge Gateway → Cloud Control Plane (*.azure-devices.net) | TCP 443 |
| Edge Gateway → Intelligence (*.data.workspaceone.com) | TCP 443 |
| Edge Gateway → Software Update (softwareupdate.omnissa.com) | TCP 443 |
| Horizon Agent → Edge Gateway | TCP 31883 (データ収集) |
| サービス起動時間 | 最大15分 |
| ライセンス同期間隔（Subscription） | 24時間 |
| Term License 猶予期間 | 30日 |
| Horizon 2412 以降 キー移行猶予期間 | 60日 |
| 同一 Pod 内のライセンスキー数 | 1つ |

---

## 理解度チェックリスト

### ライセンス管理
- [ ] Perpetual / Term / Plus SaaS / Universal SaaS の4種類の違いを説明できる
- [ ] Named User (NU) と Concurrent Connected User (CCU) のカウント方法を説明できる
- [ ] Term License の猶予期間（30日）と restricted mode の影響を説明できる
- [ ] 同一 Pod 内でのライセンス混在ルールを評価できる
- [ ] Term vs. Subscription の選択基準を判断できる

### Edge Gateway デプロイ
- [ ] Edge Gateway Appliance の役割（Subscription ライセンス管理、Control Plane 接続）を説明できる
- [ ] デプロイの前提条件（DNS、Line-of-sight、ネットワーク配置）を列挙できる
- [ ] OVF デプロイに必要なパラメータ（Pairing Key、ネットワーク設定等）を準備できる
- [ ] 4ステップのデプロイ手順を実行できる
- [ ] kubectl を使用したトラブルシューティング手順を実行できる
