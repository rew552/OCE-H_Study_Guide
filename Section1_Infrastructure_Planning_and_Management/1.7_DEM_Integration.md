# 1.7 Integrate and Configure Dynamic Environment Manager (DEM)

## 試験ガイド対応

> **4.1.7. Integrate and configure Dynamic Environment Manager (DEM).**
> - Configure file shares for DEM deployment.
> - Install DEM Management Console (including NoAD)
> - Identify use cases for Horizon Smart Policies
> - Evaluate creation of condition sets (modular approach)
> - Consider importing ADMX templates in preparation for DEM.

---

## Configure File Shares for DEM Deployment

### DEM のファイル共有アーキテクチャ

DEM はデータベースを使用せず、SMB ファイル共有のみで動作する軽量アーキテクチャを持つ。2種類のファイル共有が必要。

| 共有タイプ | 用途 | アクセスモード | 推奨配置 |
|---|---|---|---|
| **Configuration Share** | IT 管理者が定義するポリシー、Flex Config File、環境設定 | ユーザーは**読み取り専用** | 管理者の近く（書き込み側） |
| **Profile Archive Share** | ユーザー個別のプロファイルアーカイブ（ZIP形式）、バックアップ、ログ | ユーザーは**読み書き** | ユーザーデスクトップの近く |

### Configuration Share の作成

#### NTFS アクセス許可

| プリンシパル | アクセス許可 | 適用先 |
|---|---|---|
| DEM Admins | Full Control | This folder, subfolders, and files |
| SYSTEM | Full Control | This folder, subfolders, and files |
| Authenticated Users | Read & Execute, List, Read | This folder, subfolders, and files |

#### 共有アクセス許可

| プリンシパル | アクセス許可 |
|---|---|
| Everyone | Read |
| DEM Admins | Full Control |

> **注意**: Configuration Share への書き込みは管理者のみ。ユーザーによる書き込みを許可すると、設定の競合やセキュリティリスクが発生する。

### Profile Archive Share の作成

#### NTFS アクセス許可

| プリンシパル | アクセス許可 | 適用先 |
|---|---|---|
| CREATOR OWNER | Full Control | Subfolders and files only |
| SYSTEM | Full Control | This folder, subfolders, and files |
| DEM Admins | Full Control | This folder, subfolders, and files |
| Authenticated Users | Create folders / append data, List folder / read data, Read attributes, Traverse folder / execute file | This folder only |

#### 共有アクセス許可

| プリンシパル | アクセス許可 |
|---|---|
| Everyone | Full Control |

ユーザーは初回ログイン時に自動的にサブフォルダを作成し、CREATOR OWNER として自分のフォルダにのみアクセスできる。

### ファイル共有のサイジング

| 項目 | ガイドライン |
|---|---|
| **Configuration Share** | 5,000 ユーザーあたり約 1 GB |
| **Profile Archive Share** | ユーザーあたり約 100 MB（バックアップ含む） |
| **ファイルサーバー推奨構成** | 4 vCPU / 16 GB RAM（10,000ユーザーあたり） |
| **推奨OS** | Windows Server 2012 以降（SMB 3.0 必須） |

### 高可用性構成

#### DFS-N (Distributed File System Namespace) の使用

**Configuration Share（読み取り専用のため複数アクティブターゲット可能）**:
- DFS-R でレプリケーション
- 複数のファイルサーバーを DFS-N のアクティブターゲットとして設定可能
- Hub and Spoke トポロジが必須（複数の書き込みターゲットは非サポート）
- 管理者はサーバーURL で直接接続し書き込み（DFS-N 経由の書き込みは避ける）

**Profile Archive Share（読み書きのためアクティブターゲットは1つのみ）**:
- DFS-N のアクティブターゲットは**1つのみ**（複数アクティブはデータ破損のリスク）
- パッシブ（非アクティブ）ターゲットを DR 用に設定
- 障害時のフェイルオーバー手順:
  1. アクティブターゲットの DFS-N referral を無効化
  2. パッシブターゲットの DFS-N referral を有効化

#### Windows Server Failover Clustering

- File Server for general use を選択（Scale-Out File Server は DEM 非互換）
- DFS と Clustering の組み合わせも可能

### ネットワークポート要件

| 通信元 | 通信先 | ポート | 用途 |
|---|---|---|---|
| DEM FlexEngine | File Shares | TCP 445 | SMBファイル共有アクセス（Configuration Share / Profile Archive Share） |

> **試験ポイント**: DEMはデータベースを使用せずSMBファイル共有のみで動作するため、DB関連ポートは不要。必要なのはTCP 445（SMB）のみ。

### ベストプラクティス

- Profile Archive Share は既存の Home Drive と分離（ユーザーによる誤削除防止）
- Configuration Share は読み取り最適化ストレージに配置
- Profile Archive Share は読み書き最適化ストレージに配置
- 複数サイト環境では AD サイトごとに近接する Profile Archive Share を使用

---

## Install DEM Management Console (Including NoAD)

### DEM コンポーネントの概要

| コンポーネント | 説明 |
|---|---|
| **FlexEngine** | デスクトップ/RDSH VM 上で動作するエージェント |
| **Management Console** | 管理者がポリシー・設定を管理する GUI ツール |
| **Application Profiler** | アプリケーション設定のキャプチャツール |
| **Helpdesk Support Tool** | プロファイルリセット・復元ツール |
| **Self-Support** | エンドユーザー向けセルフサービスツール |

### 標準インストール（Active Directory 環境）

#### インストール手順

1. **SMB ファイル共有の作成**（Configuration Share + Profile Archive Share）
2. **ADMX テンプレートのインポート**（後述）
3. **GPO の作成・構成**
4. **FlexEngine のインストール**（ゴールデンイメージまたはインスタントクローンの VM に）
5. **Management Console のインストール**（管理サーバーまたはワークステーションに）

#### FlexEngine の GPO 必須設定

```
User Configuration > Administrative Templates > Omnissa DEM > FlexEngine
```

| 設定 | 値 |
|---|---|
| **Flex config files** | Enabled — Configuration Share のパスを指定 |
| **Profile archives** | Enabled — Profile Archive Share のパスを指定 |
| **Configure run FlexEngine at Logon and Logoff Setting** | Enabled |

#### FlexEngine の GPO 推奨設定

| 設定 | 推奨値 |
|---|---|
| **Profile archive backups** | `\\server\ProfileArchiveShare\%username%\Backups`、バックアップ数: 5 |
| **FlexEngine Logging** | `\\server\ProfileArchiveShare\%username%\Logs\FlexEngine.log`、Log level: Warn |

> **重要**: 本番環境ではログレベルを Debug や Info にしない（ログオン遅延とログ肥大化の原因）。個別ユーザーのデバッグは KB 2113514 の方法を使用。

### NoAD モードでのインストール

#### NoAD モードとは

Active Directory の GPO に依存せずに FlexEngine を構成する方法。XML ベースの設定ファイル（`NoAD.xml`）を使用する。

#### ユースケース

| シナリオ | 説明 |
|---|---|
| AD が利用不可 | ワークグループ環境、AD 変更制御が厳格な環境 |
| PoC / テスト環境 | 正式な AD 変更プロセスを経ずに素早く検証 |
| Horizon Cloud on Azure | Azure Marketplace の Import Image ウィザードで自動インストールされた場合 |

#### NoAD インストール手順

```
msiexec /i "Omnissa DEM FlexEngine x64.msi" NOADCONFIGFILEPATH="\\server\DEMConfig\NoAD.xml"
```

- `NOADCONFIGFILEPATH` プロパティで NoAD.xml のパスを指定
- インストール時に Configuration Share のパスを指定する必要がある
- NoAD モードでインストールすると、既存の GPO 設定は無視される
- NoAD モードを解除するには FlexEngine を再インストール（NOADCONFIGFILEPATH プロパティなし）

#### NoAD.xml の必須設定

```xml
<FlexEngine>
  <FlexConfigFiles>\\server\DEMConfig</FlexConfigFiles>
  <ProfileArchives>\\server\DEMProfiles\%username%</ProfileArchives>
  <RunFlexEngineAtLogonAndLogoff>1</RunFlexEngineAtLogonAndLogoff>
</FlexEngine>
```

### Management Console の構成

- 複数のマシンにインストール可能（DR対応）
- Configuration Share を指定して環境に接続
- GPO で Management Console の設定をロックダウン可能（`Lock down access to Omnissa DEM Management Console`）
- 複数環境（開発/テスト/本番）を切り替えて管理可能

### DEM Standard Edition vs. Enterprise Edition

| 機能 | Standard | Enterprise |
|---|---|---|
| User Environment（ドライブマッピング、プリンタマッピング等） | ○ | ○ |
| Computer Environment | × | ○ |
| Personalization | ○ | ○ |
| SyncTool（オフライン対応） | × | ○ |
| Condition Sets | ○ | ○ |
| Application Profiler | ○ | ○ |
| Application Migration | × | ○ |
| **Horizon Smart Policies 連携** | × | ○ |
| **Triggered Tasks** | × | ○ |

---

## Identify Use Cases for Horizon Smart Policies

### Horizon Smart Policies とは

Horizon Smart Policies は DEM と Horizon の統合機能。GPO に依存せず、条件に基づいて Horizon のユーザーエクスペリエンス設定を動的に制御する。

**DEM Enterprise Edition が必要。**

### Smart Policies で制御可能な設定

| カテゴリ | 設定例 |
|---|---|
| **USB Redirection** | Enable / Deny |
| **Printing** | Enable / Deny |
| **Clipboard** | Enable / Deny |
| **Client Drive Redirection** | Enable / Deny |
| **Blast Extreme** | Encoder 設定、帯域幅制御 |
| **HTML Access** | File Transfer 設定 |

Smart Policies はユーザーベースとコンピューターベースの2種類がある。

### Smart Policies のユースケース

#### ユースケース1: 内部/外部接続による制御

| 条件 | 設定 |
|---|---|
| Client Location = External | USB: Deny, Printing: Deny, Clipboard: Deny |
| Client Location = Internal | USB: Enable, Printing: Enable, Clipboard: Enable, CDR: Enable |

#### ユースケース2: ユーザーグループによる制御

| 条件 | 設定 |
|---|---|
| Location = Internal AND Group = Contractor | USB: Deny, Clipboard: Deny, CDR: Deny |
| Location = Internal AND Group = Employee | すべて Enable |

#### ユースケース3: プール/アサインメントによる制御

- Horizon Client Property `Pool Name` で特定プールに接続時のみ設定を適用
- Horizon Client Property `Launch Tags` で詳細な制御（Horizon 8 のみ対応）

### Smart Policies の Triggered Task 連携

セッション再接続時に Smart Policies を再評価する Triggered Task の設定が推奨。

| 設定項目 | 値 |
|---|---|
| **Trigger** | Reconnect Session |
| **Action** | User Environment refresh → Refresh Horizon Policies |

これにより、ユーザーが別の場所から再接続した際に、新しい条件に基づくポリシーが適用される。

---

## Evaluate Creation of Condition Sets (Modular Approach)

### Condition Sets の概要

Condition Sets は、DEM で使用する条件をモジュール化して再利用可能にする機能。同じ条件を複数のアクション（ドライブマッピング、プリンタマッピング、Smart Policies 等）に適用できる。

### Condition Sets を使用するメリット

| メリット | 説明 |
|---|---|
| **再利用性** | 1つの条件セットを複数のアクションにリンク |
| **処理効率** | 条件は1回だけ評価され、結果がキャッシュされる（ログイン高速化） |
| **管理効率** | 条件変更が必要な場合、Condition Set の1箇所を変更するだけ |
| **一貫性** | 同一条件が全アクションで統一的に適用される |

### 利用可能な条件タイプ

| 条件タイプ | 例 |
|---|---|
| **Active Directory Group** | ユーザーが特定のグループのメンバー |
| **Endpoint IP Address** | クライアントの IP アドレス範囲 |
| **Endpoint Name** | クライアントのホスト名パターン |
| **Endpoint Platform** | Windows / macOS / Linux / iOS / Android |
| **Horizon Client Property** | Client Location、Pool Name、Launch Tags |
| **Environment Variable** | 環境変数の値 |
| **Computer OU** | コンピューターアカウントの OU |
| **Date/Time** | 日付・時刻範囲 |

### モジュラーアプローチの設計例

#### 例: ロケーションベースの条件セット

**Condition Set: "Tokyo Office"**
- Endpoint IP Address: 10.1.0.0/16
- OR Endpoint Name: DESKTOP-TYO-*

**Condition Set: "NY Office"**
- Endpoint IP Address: 10.2.0.0/16
- OR Endpoint Name: DESKTOP-NY-*

**適用例**:
- プリンタマッピング: "Tokyo Office" → 東京のプリンタを割り当て
- ドライブマッピング: "Tokyo Office" → 東京のファイルサーバーを割り当て
- Smart Policy: "Tokyo Office" → 帯域幅設定を最適化

#### 例: ユーザーロールベースの条件セット

**Condition Set: "External Contractor"**
- AD Group: Contractors AND Horizon Client Property: Client Location = External

**適用例**:
- Smart Policy: USB/Clipboard Deny
- Application Blocking: cmd.exe、PowerShell をブロック
- ドライブマッピング: 制限された共有のみ

### 条件セットの作成手順

```
DEM Management Console > Conditions > Condition Sets > New Condition Set
→ 名前を入力
→ 条件を追加（AND / OR / NOT の組み合わせ）
→ 保存
```

作成した Condition Set は各アクション（User Environment、Smart Policies、Flex Config File 等）の Conditions タブで選択可能。

---

## Consider Importing ADMX Templates in Preparation for DEM

### ADMX テンプレートの役割

DEM は ADMX テンプレートを使用して FlexEngine の動作を GPO 経由で制御する。

**提供される ADMX テンプレート**:

| テンプレート | 用途 |
|---|---|
| **DEM.admx** | DEM Management Console の設定 |
| **DEM FlexEngine.admx** | FlexEngine エージェントの設定 |

### ADMX テンプレートのインポート手順

#### Step 1: テンプレートファイルの取得

DEM インストールパッケージから以下のファイルを取得:
- `*.admx` ファイル（テンプレート本体）
- `*.adml` ファイル（言語ファイル）

#### Step 2: Central Store へのコピー

```
コピー先: \\<domain>\SYSVOL\<domain>\Policies\PolicyDefinitions\
ADML:    \\<domain>\SYSVOL\<domain>\Policies\PolicyDefinitions\en-US\
```

Central Store が存在しない場合は `PolicyDefinitions` フォルダを作成する。

#### Step 3: GPO Management Console での確認

```
gpmc.msc > 対象 GPO を編集
> User Configuration > Administrative Templates > Omnissa DEM
```

Omnissa DEM のカテゴリが表示されれば成功。

### ADMX テンプレートの主要設定項目

#### FlexEngine 必須設定

| GPO パス | 設定 | 説明 |
|---|---|---|
| `Omnissa DEM > FlexEngine` | Flex config files | Configuration Share パス |
| `Omnissa DEM > FlexEngine` | Profile archives | Profile Archive Share パス |
| `Omnissa DEM > FlexEngine` | Configure run FlexEngine at Logon and Logoff Setting | ログオン/ログオフ時の FlexEngine 実行 |

#### FlexEngine 推奨設定

| GPO パス | 設定 | 推奨値 |
|---|---|---|
| `Omnissa DEM > FlexEngine` | Profile archive backups | 場所 + バックアップ数 5 |
| `Omnissa DEM > FlexEngine` | FlexEngine Logging | Warn レベル |
| `Omnissa DEM > FlexEngine` | Paths unavailable at logon | パス不達時の動作 |

### ADMX インポートの考慮事項

| 考慮事項 | 説明 |
|---|---|
| **GPO の設計** | ループバック処理を使用する場合、Computer Configuration の GPO に注意 |
| **複数環境** | 環境ごとに異なる GPO を作成し、異なる Configuration Share を指定可能 |
| **Always wait for the network** | DEM の GPO 拡張を使用する場合、`Always wait for the network at computer startup and logon` を有効化 |
| **コマンドライン優先** | FlexEngine のコマンドライン引数は GPO 設定を上書きする |
| **バージョンアップ** | DEM バージョンアップ時は ADMX テンプレートも更新が必要 |
| **NoAD との排他** | NoAD モードで FlexEngine をインストールした場合、GPO 設定は無視される |

---

## ベストプラクティスとアンチパターン

### ベストプラクティス

| カテゴリ | 推奨事項 |
|---|---|
| ファイル共有 | 専用共有を使用、Home Drive とは分離 |
| DirectFlex | 可能な限り有効化（ただし OS 設定やミドルウェアアプリには無効） |
| プロファイル | ローカルプロファイル + フォルダリダイレクション（Roaming Profile は非推奨） |
| ドライブ/プリンタマッピング | Run asynchronously を有効化（デフォルト有効） |
| Condition Sets | 同じ条件を複数箇所で使う場合は必ず Condition Set 化 |
| Smart Policies | Reconnect Session トリガーで Horizon Policies を再評価 |
| Management Console | 複数マシンにインストールし DR 対応 |

### アンチパターン

| アンチパターン | リスク |
|---|---|
| Profile Archive Share に複数アクティブターゲット | データ破損 |
| 本番環境で Debug ログレベル | ログオン遅延、ディスク容量逼迫 |
| OS 設定（壁紙、キーボード等）に DirectFlex 適用 | ログオン時に設定が反映されない |
| DEM FlexEngine と Application Profiler の同居 | Profiler の動作に影響 |
| Roaming Profile との併用 | プロファイル破損リスク、ログオン時間増加 |
| ADMX テンプレート未更新でバージョンアップ | 新機能の設定項目が表示されない |

---

## 理解度チェックリスト

### ファイル共有
- [ ] Configuration Share と Profile Archive Share の NTFS / 共有アクセス許可を正確に設定できる
- [ ] DFS-N を使用した高可用性構成（Configuration: 複数アクティブ、Profile Archive: 単一アクティブ）を説明できる
- [ ] ファイルサーバーのサイジング（4vCPU/16GB per 10,000 users）を説明できる

### Management Console
- [ ] 標準インストール手順（共有作成 → ADMX → GPO → FlexEngine → Console）を実行できる
- [ ] NoAD モードのユースケースとインストール手順（NOADCONFIGFILEPATH）を説明できる
- [ ] GPO 必須設定3項目（Flex config files, Profile archives, Run at Logon and Logoff）を構成できる

### Smart Policies
- [ ] Smart Policies のユースケース（内部/外部、グループ、プール別の制御）を特定できる
- [ ] ユーザーベースとコンピューターベースの Smart Policy の違いを説明できる
- [ ] Triggered Task と Smart Policies の連携（Reconnect → Refresh）を構成できる

### Condition Sets
- [ ] モジュラーアプローチのメリット（再利用、キャッシュ、一貫性）を説明できる
- [ ] AND / OR / NOT を組み合わせた Condition Set を設計できる
- [ ] ロケーションベース、ロールベースの条件セットの使い分けを評価できる

### ADMX テンプレート
- [ ] ADMX / ADML ファイルの Central Store へのコピー手順を実行できる
- [ ] ADMX テンプレートから構成する必須 GPO 設定3項目を説明できる
- [ ] ADMX 更新のタイミング（DEM バージョンアップ時）と NoAD との排他関係を理解している
