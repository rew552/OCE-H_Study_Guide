# 1.1 Install/Configure Connection Servers, Enrollment Servers, and Access Connectors

## 試験ガイド対応 (Section 4.1.1)

- Deploy Horizon Connection Servers in a multi-node environment for high availability
- Optimize global settings (load balancing, security protocols, certificates) based on organizational requirements
- Evaluate the impact of Connection Server configurations on desktop pool performance
- Deploy and configure different types of Horizon Servers (Connection Server, Replica, Enrollment)
- Deploy and configure Access Connector

---

## 1. Connection Serverのマルチノード展開と高可用性

### 1.1.1 Connection Serverの基本仕様

Connection Serverは、ユーザー認証のブローカーとして機能し、Active Directoryを通じてユーザーを認証した上で、適切な仮想デスクトップ・RDSHサーバー・物理マシンへの接続を仲介する。

**VMスペック（Reference Architecture準拠）**

| 属性 | 仕様 |
|------|------|
| OS | Windows Server |
| vCPU | 4 |
| vMemory | 12 GB |
| vNIC | 1 (VMXNET3) |
| SCSI Controller | Paravirtual |
| Disk | 100 GB (Thin Provisioning) |

**スケーラビリティの上限値**

| 項目 | 最大値 |
|------|--------|
| 1台あたりの最大セッション数 | 4,000 |
| トンネル接続（BSG/PSG/HTTP(S) Secure Tunnel）有効時 | 2,000 |
| Pod内の最大Connection Server数 | 7 |
| Pod内の最大セッション数 | 20,000 |
| CPA federation内の最大セッション数 | 350,000 |

### 1.1.2 マルチノード環境での展開

#### Pod構成の基本設計

すべてのConnection Serverは同一Pod内に配置され、同一データセンター・同一ブロードキャストドメイン内に存在する必要がある。Podをまたいだ分散配置は不可。

**n+1設計パターン**

可用性を確保するため、必要台数+1台のn+1構成が推奨される。

| 目標CCU | 必要台数（4,000セッション/台） | n+1構成 |
|---------|-------------------------------|---------|
| ~4,000 | 1 | 2台 |
| ~8,000 | 2 | 3台 |
| ~12,000 | 3 | 4台 |
| ~20,000 | 5 | 6台（最大7台） |

> **重要**: Connection Serverのセッション上限が4,000なのは、Secure Gateway/Tunnelを使わない場合。トンネル接続を有効化すると2,000に半減する。外部接続にはUAGを使い、Connection ServerのSecure Gateway機能は無効化するのがベストプラクティス。

#### Standard ServerとReplica Serverのインストール

**Standard Server（最初の1台）**

1. Horizon Connection Serverインストーラーを実行
2. **Horizon Standard Server** ロールを選択
3. 新しい構成でインストール（ADAM/LDS データベースを初期化）
4. データ復旧パスワードを設定

**Replica Server（2台目以降）**

1. 同じインストーラーを実行
2. **Horizon Replica Server** ロールを選択
3. 既存Connection ServerのFQDNを指定
4. ADAM/LDSレプリケーションで構成が自動同期

**レプリケーションに必要なポート（Connection Server間）**

| ポート | プロトコル | 用途 |
|--------|-----------|------|
| 4100 | TCP | JMS（レプリカ間冗長化） |
| 4101 | TCP | JMS SSL（レプリカ間冗長化） |
| 32111 | TCP | レプリカインストール時・クラスターマスターシークレット再鍵時 |
| 135 | TCP | MS-RPC Endpoint Mapper（レプリケーション必須） |
| 49152-65535 | TCP | MS-RPC動的ポート範囲（ADレプリケーション） |
| 389 | TCP | レプリカインストール時のみ |

> **アンチパターン**: 異なるバージョンのConnection Serverを同一Pod内で混在させてはならない。アップグレード時は全台を順次アップグレードする。

### 1.1.3 Connection Serverのロードバランシング

#### 内部接続のLB構成

ロードバランサーを使用して、内部ユーザーに単一のFQDN名前空間を提供する。

**LB要件**

| 要件 | 推奨値 |
|------|--------|
| パーシステンス/アフィニティ | Source IP または Cookie-based |
| ヘルスチェックURL | `GET /favicon.ico` → HTTP 200 OK |
| ヘルスチェック間隔 | 30秒 |
| アフィニティタイムアウト | セッションタイムアウトと一致（デフォルト10時間） |

**Origin Checking の設定**

ロードバランサー経由でアクセスする場合、Origin Checkingを構成する必要がある。ロードバランサーのFQDNとUAGのFQDNをConnection Serverに登録する。

**設定ファイル**: `C:\Program Files\Omnissa\Horizon\Server\sslgateway\conf\locked.properties`

```ini
checkOrigin=false
balancedHost=horizon.example.com
portalHost.1=uag-1.example.com
portalHost.2=uag-2.example.com
```

変更後、Connection Serverサービスを再起動する。

#### UAGとの接続構成

推奨アーキテクチャでは、UAGとConnection Serverの間にロードバランサーを配置しない。各UAGが特定のConnection Serverを直接ターゲットする構成が推奨される。

**推奨構成**: UAG対Connection Server = N:1マッピング

- UAGは個別のConnection Serverを`proxyDestinationUrl`で指定
- UAGがターゲットCSの障害を検出し、外部LBに通知可能
- 障害検出の精度が向上し、トラブルシューティングが容易

**代替構成**: UAGとCSの間にLBを配置する構成も「サポートされる」が、UAGが個別CSの障害を検出できなくなる。

---

## 2. グローバル設定の最適化

### 2.1 セキュリティプロトコルの設定

**Connection Server上のSecure Gateway設定**

UAGを外部接続に使用する場合、Connection Server上のGateway機能は無効化する。

| 設定項目 | 推奨値 | 理由 |
|---------|--------|------|
| HTTP(S) Secure Tunnel | 無効 | UAGがトンネル処理を担当 |
| PCoIP Secure Gateway | 無効 | UAGがPCoIP Gatewayを担当 |
| Blast Secure Gateway | 「Do not use」または「HTML Accessのみ」 | UAGがBlast Gatewayを担当 |

HTML Accessのみ内部で使う場合は、Blast Secure Gatewayを「Use Blast Secure Gateway for only HTML Access connections to machine」に設定し、Blast External URLをConnection ServerのFQDN:8443に設定する。

### 2.2 証明書の管理

**証明書の置換手順（概要）**

1. CSR（Certificate Signing Request）構成ファイルを作成
2. CSRを生成し、CA（内部CA または 公開CA）に提出
3. 署名済み証明書を受領後、Windows証明書ストア（`Cert:\LocalMachine\My`）にインポート
4. Horizon Consoleで証明書を適用

**証明書のフレンドリ名規則**

- Connection Serverの証明書: `vdm` というフレンドリ名を設定
- 証明書ストアパス: `Cert:\LocalMachine\My`

**証明書の種類と選択基準**

| 証明書タイプ | ユースケース | 利点 | 欠点 |
|-------------|-------------|------|------|
| 個別サーバー証明書 | セキュリティ最重視環境 | サーバーごとの識別が可能 | 管理負担大 |
| SAN証明書 | 複数サーバーで共有 | 1枚で複数サーバーをカバー | サーバー追加時に再発行 |
| ワイルドカード証明書 | 管理簡素化 | サーバー追加が容易 | セキュリティポリシーで禁止される場合あり |

### 2.3 SAML認証の構成

Omnissa Access（旧Workspace ONE Access）をSAML Authenticatorとして構成する。

| 設定 | 値 | 説明 |
|------|-----|------|
| Delegation of Authentication | Allowed / Required | Allowedは任意、Requiredは必須 |
| Workspace ONE Mode | 有効 | 直接認証をAccessにリダイレクト |

**Requiredに設定した場合の動作**: Connection Serverへの直接認証試行はすべてOmnissa Accessにリダイレクトされる。

### 2.4 バックアップの構成

各Connection Serverでバックアップスケジュールとロケーションを定義する。ADAM/LDS構成データのエクスポート/インポートにより設定をバックアップ・復元可能。

---

## 3. Connection Server設定がデスクトッププールパフォーマンスに与える影響

### 3.1 セッション管理設定の影響

| 設定項目 | パフォーマンスへの影響 |
|---------|---------------------|
| Session Timeout（デフォルト10時間） | 長すぎるとセッションがConnection Serverリソースを占有し続ける |
| 最大セッション数 | 4,000超で応答劣化、トンネル有効時は2,000超で劣化 |
| Secure Gateway有効化 | セッション上限が半減（4,000→2,000）、CPU/メモリ消費増 |

### 3.2 Secure Gateway設定による影響

**Secure Gatewayを有効にした場合のトレードオフ**

| 状態 | 最大セッション | 用途 |
|------|-------------|------|
| Secure Gateway無効（推奨） | 4,000/CS | 外部接続はUAGが担当 |
| Secure Gateway有効 | 2,000/CS | UAGなしの簡易構成（非推奨） |

Secure Gatewayを有効にすると、プロトコルトラフィックがConnection Serverを経由するため、Connection Server自体がデータパスの一部となり、CPU・メモリ・ネットワーク負荷が増大する。通常、認証完了後のプロトコルセッションはConnection Serverを経由しない構成が推奨される。

### 3.3 JMS通信

Horizon AgentとConnection Server間はJMS（Java Message Service）で通信する。

| ポート | 用途 |
|--------|------|
| TCP 4001 | JMS |
| TCP 4002 | JMS（Enhanced Message Security有効時、デフォルト） |

Enhanced Message Securityがデフォルトで有効であり、TCP 4001とTCP 4002の両方が必要。

### 3.5 Horizon Edge Gateway Appliance との通信

Edge Gateway Applianceを使用している場合、追加のポートが必要となる。

| 通信元 | 通信先 | ポート | 用途 |
|--------|--------|--------|------|
| Edge Gateway Appliance | Connection Server | TCP 443 | Pod統合 |
| Edge Gateway Appliance | Connection Server | TCP 4002 | JMS |
| Edge Gateway Appliance | UAG | TCP 9443 | UAG監視 |
| Horizon Agent | Edge Gateway Appliance | TCP 31883 | Horizon Cloud Service next-gen向けデータ収集 |

### 3.4 vCenter Server接続

Connection Server → vCenter Server: TCP 443（SDK/API）

Instant Clone Smart Provisioningを使用する場合、vCenter Server上でのプロビジョニング操作がパフォーマンスに影響する。vCenter Serverをリソースブロックの区切り（Hypervisor Manager）として使い、単一vCenterに過度の負荷をかけない設計が重要。

---

## 4. Enrollment Serverの展開と構成

### 4.1 Enrollment Serverの役割

Enrollment Serverは **True SSO** 機能を提供する。SAML認証（Omnissa Access経由など）でログインしたユーザーが、AD資格情報を入力せずに仮想デスクトップ・アプリケーションにシングルサインオンできる。

**動作の仕組み**:
1. Connection ServerがCSR（Certificate Signing Request）を生成
2. Enrollment ServerがCSRを受け取り、Microsoft CAに署名を依頼
3. Microsoft CAが短時間有効な証明書を発行
4. その証明書を使用してWindowsにスマートカードログオンと同等の認証を実行

### 4.2 VMスペック

| 属性 | 仕様 |
|------|------|
| OS | Windows Server |
| vCPU | 4 |
| vMemory | 12 GB |
| vNIC | 1 (VMXNET3) |
| Disk | 100 GB |

### 4.3 インストール手順

1. **Horizon Connection Serverインストーラーを実行**し、**Horizon Enrollment Server** ロールを選択
2. **Enrollment Agent (Computer) 証明書を登録**: MMC → Certificates → Personal → Request New Certificate → Enrollment Agent (Computer)
3. **Connection Serverとのペアリング**:
   - Connection Serverから`vdm.ec`フレンドリ名の証明書をエクスポート（秘密鍵なし）
   - Enrollment Serverの`Omnissa Horizon Enrollment Server Trusted Roots`ストアにインポート
4. **ローカルCA優先設定**（CAとESが同一サーバーの場合）:
   - レジストリ: `HKEY_LOCAL_MACHINE\SOFTWARE\Omnissa\Horizon\Enrollment Service`
   - 値: `PreferLocalCa` (REG_SZ) = `1`

### 4.4 Connection Server側の構成（vdmutil）

`C:\Program Files\Omnissa\Horizon\Server\tools\bin\vdmutil.exe` を使用。

**Step 1: Enrollment Serverの追加**

```
vdmutil --authAs administrator --authDomain mydomain --authPassword <Password>
  --truesso --environment --add --enrollmentServer es1.mydomain.com
```

**Step 2: Enrollment Serverの確認**

```
vdmutil --authAs administrator --authDomain mydomain --authPassword <Password>
  --truesso --environment --list --enrollmentServers
```

**Step 3: True SSOコネクタの作成**

```
vdmutil --authAs administrator --authDomain mydomain --authPassword <Password>
  --truesso --create --connector --domain mydomain.com --template TrueSSO
  --primaryEnrollmentServer es1.mydomain.com
  --secondaryEnrollmentServer es2.mydomain.com
  --certificateServer mydomain-CA1,mydomain-CA2 --mode enabled
```

**Step 4: SAML AuthenticatorのTrue SSO有効化**

```
vdmutil --authAs administrator --authDomain mydomain --authPassword <Password>
  --truesso --authenticator --edit --name access.mydomain.com --truessoMode ENABLED
```

### 4.5 ロードバランシング

デフォルトはActive/Failover。2台構成ではRound Robinに変更が推奨される。

**設定方法**: ADSI Editを使用

1. ADSI Edit → `localhost:389` に接続（Distinguished Name: `vdi`）
2. `OU=Properties` → `OU=Global` → `CN=Common`
3. `pae-NameValuePair`属性に値を追加: `cs-view-certsso-enable-es-loadbalance=true`

### 4.6 スケーラビリティ

| 項目 | 値 |
|------|-----|
| 1台のESが処理可能なリクエスト | 1 Pod全体分 |
| 1台のCAが生成可能な証明書 | 約35証明書/秒 |
| 推奨構成 | 2台/Pod（n+1） |

### 4.7 ネットワーク要件

| 通信元 | 通信先 | ポート | 用途 |
|--------|--------|--------|------|
| Connection Server | Enrollment Server | TCP 32111 | Framework Channel |
| Enrollment Server | AD Certificate Services | TCP 135 + RPC動的ポート | 証明書要求 |
| Enrollment Server | AD Domain Controller | 標準ADポート | DC検出・バインド・クエリ |

### 4.8 配置の制約

| 制約 | 詳細 |
|------|------|
| Connection Serverとの同居 | **不可** |
| Microsoft CAとの同居 | **可能**（PreferLocalCa設定推奨） |
| Anti-Affinity | 2台のESが同一ホスト上に配置されないようにルール設定 |

---

## 5. Access Connectorの展開と構成

### 5.1 Access Connectorの役割

Omnissa Access Connector（旧Workspace ONE Access Connector）は、Active DirectoryなどのオンプレミスリソースとOmnissa Accessサービス間のディレクトリ同期・認証を担当する。クラウドベースとオンプレミスの両方のAccess展開で使用可能。

**主な機能**:
- ディレクトリ同期（AD → Omnissa Access）
- Kerberos認証
- ユーザー認証のブリッジ

### 5.2 VMスペック

| 属性 | 仕様 |
|------|------|
| OS | Windows Server |
| vCPU | 4 |
| vMemory | 8 GB |
| vNIC | 1 (VMXNET3) |
| Disk | 100 GB |

### 5.3 ネットワーク要件

| 通信元 | 通信先 | ポート | 用途 |
|--------|--------|--------|------|
| Access Connector | Omnissa Access Appliance | TCP 443 | Connector-Appliance通信 |
| Access Connector | Horizon Connection Server | TCP 443 | Horizon統合 |
| Access Connector | Horizon Connection Server | TCP 389 | LDS同期（エンタイトルメント同期） |
| Access Connector | AD Domain Controller | TCP 389/636 | LDAP/LDAPS |
| Access Connector | AD Domain Controller | TCP 3268/3269 | AD Global Catalog |
| Access Connector | AD Domain Controller | TCP/UDP 88 | Kerberos認証 |
| クライアント | Access Connector | TCP 443 | Inboundモード時のみ（Outbound推奨） |

### 5.4 デプロイモードの判断

| モード | 説明 | 推奨度 |
|--------|------|--------|
| Outbound（推奨） | ConnectorがAccessサービスへの外向き接続を確立 | 高（ファイアウォールのInbound開放不要） |
| Inbound | クライアントがConnectorに直接接続 | Kerberos認証使用時に必要 |

---

## 6. 重要ポート番号まとめ

### Connection Server関連

| 通信元 | 通信先 | ポート | 用途 |
|--------|--------|--------|------|
| Horizon Client | Connection Server | TCP 443 | ログイン（XML-API） |
| Browser | Connection Server | TCP 8443 | HTML Access |
| Horizon Agent | Connection Server | TCP 4001 | JMS |
| Horizon Agent | Connection Server | TCP 4002 | JMS SSL（Enhanced Security） |
| Connection Server | Connection Server | TCP 4100 | JMS（レプリカ間） |
| Connection Server | Connection Server | TCP 4101 | JMS SSL（レプリカ間） |
| Connection Server | Connection Server | TCP 32111 | レプリカインストール |
| Connection Server | Connection Server | TCP 135 | MS-RPC Endpoint Mapper |
| Connection Server | vCenter Server | TCP 443 | SDK/API |
| Connection Server | Events DB | TCP 1433/5432/1521 | SQL/PostgreSQL/Oracle |
| Connection Server | Enrollment Server | TCP 32111 | Framework Channel |
| Connection Server | App Volumes Manager | TCP 443 | 監視・Apps on Demand |
| Horizon Recording Agent | Recording Server | TCP 9443 | セッション録画 |
| Admin Browser | Connection Server | TCP 443 | `https://<FQDN>/admin` |

### CPA（Cloud Pod Architecture）関連

| ポート | 用途 |
|--------|------|
| TCP 22389 | ADLDS Global LDAPレプリケーション |
| TCP 22636 | ADLDS Secure Global LDAPSレプリケーション |
| TCP 8472 | Inter-pod VIPA |

---

## 7. ベストプラクティスとアンチパターン

### ベストプラクティス

| 領域 | ベストプラクティス |
|------|-------------------|
| HA設計 | n+1構成。3台以上推奨（メンテナンス時もサービス継続） |
| Secure Gateway | Connection Server上では無効化し、UAGに委譲 |
| 外部接続 | UAG-CS間にLBを配置しない（UAGが直接CSを指定） |
| 証明書 | 自己署名証明書は非推奨。CA署名証明書を使用 |
| Origin Checking | LB使用時は`locked.properties`でbalancedHost/portalHostを設定 |
| True SSO | 2台のES/Pod（n+1）、Round Robin有効化 |
| Anti-Affinity | CS間・ES間でvSphere Anti-Affinityルールを設定 |

### アンチパターン

| アンチパターン | 正しい設計 |
|---------------|----------|
| 同一Pod内でCSバージョンを混在 | 全台同一バージョンに統一 |
| CSのSecure GatewayとUAGを同時使用 | UAG使用時はCSのGatewayを無効化 |
| Enrollment ServerとConnection Serverを同居 | 別サーバーに配置（CAとの同居は可） |
| ESのロードバランシングをActive/Failoverのまま運用 | 2台構成ではRound Robinに変更 |
| 単一vCenter Serverに過大な負荷 | リソースブロック分割で分散 |

---

## 8. True SSO証明書テンプレートの構成

Microsoft Enterprise CAで作成するテンプレートの設定値（重要）:

| 設定項目 | 値 |
|---------|-----|
| ベーステンプレート | Smartcard Logon（複製） |
| テンプレート表示名 | True SSO |
| テンプレート名 | TrueSSO |
| 有効期間 | 1 hour |
| 更新期間 | 0 hours |
| 目的 | Signature and smartcard logon |
| 秘密鍵のエクスポート | 許可 |
| プロバイダーカテゴリ | Key Storage Provider |
| アルゴリズム | RSA |
| 最小キー長 | 2048 |
| ハッシュ | SHA256 |
| CAデータベースへの保存 | **しない**（Do not store certificates and requests in the CA database） |
| 失効情報の含有 | 含む（De-select "Do not include revocation information"） |
| 署名数 | 1（Application Policy: Certificate Request Agent） |
| セキュリティ | ESコンピューターグループに Read + Enroll |

**CAの最適化コマンド**:

```
certutil -setreg DBFlags +DBFLAGS_ENABLEVOLATILEREQUESTS
certutil -setreg ca\CRLFlags +CRLF_REVCHECK_IGNORE_OFFLINE
sc stop certsvc && sc start certsvc
```

---

## 理解度チェックリスト

### Connection Server
- [ ] 1台あたりの最大セッション数（4,000）とトンネル有効時（2,000）の違いを説明できる
- [ ] Pod内の最大CS数（7台）と最大セッション数（20,000）を把握している
- [ ] Standard ServerとReplica Serverのインストール手順を区別できる
- [ ] レプリケーションに必要なポート（4100, 4101, 32111, 135, 動的ポート）を挙げられる
- [ ] Origin Checking（`locked.properties`）のbalancedHost/portalHostの設定を説明できる
- [ ] Secure Gatewayを無効化する理由（UAG委譲、セッション上限維持）を説明できる

### グローバル設定
- [ ] LBのヘルスチェック（`/favicon.ico` → 200 OK）とアフィニティ設定を説明できる
- [ ] UAG-CS間にLBを配置しない推奨アーキテクチャの利点を説明できる
- [ ] 証明書のフレンドリ名規則（`vdm`）を把握している

### Enrollment Server
- [ ] True SSOの動作メカニズム（CSR→ES→CA→短時間証明書→スマートカードログオン）を説明できる
- [ ] ESのインストールロール選択、証明書ペアリング手順を順序立てて説明できる
- [ ] `vdmutil`コマンドを使ったES登録・コネクタ作成・TrueSSO有効化の手順を把握している
- [ ] Round Robinへの切り替え（ADSI Edit, `cs-view-certsso-enable-es-loadbalance=true`）を説明できる
- [ ] ESの配置制約（CSと同居不可、CAと同居可）を把握している
- [ ] True SSO証明書テンプレートの主要設定値（有効期間1時間、KSP、2048bit RSA等）を把握している

### Access Connector
- [ ] Access Connectorの役割（ディレクトリ同期・認証ブリッジ）を説明できる
- [ ] Outboundモード（推奨）とInboundモードの違い、使い分けを説明できる
- [ ] 必要なネットワークポートを把握している
