# 1.6 Maintain Pod/Farm Architecture

## 試験ガイド対応

> **4.1.6. Maintain pod/farm architecture.**
> - Evaluate options for site preferences in a CPA.
> - Consider upgrade processes and dependencies in a CPA.
> - Consider options to load balance RDSH farms.
> - Evaluate to increase login performance for RDSH-based sessions.
> - Evaluate to limit the number of sessions per RDS host.
> - Evaluate use case for application on demand and configure prerequisites in Horizon UI

---

## Evaluate Options for Site Preferences in a CPA

### Cloud Pod Architecture (CPA) の概要

CPA は複数の Horizon Pod を Federation として連携させ、グローバルなデスクトップ・アプリケーション配信を実現するアーキテクチャ。

**構成要素**:
- **Pod Federation**: 最大50個の Pod を連携
- **Global Entitlement**: Federation 内の複数 Pod にまたがるエンタイトルメント
- **Home Site**: ユーザーの優先接続先サイト
- **Global LDAP (VGDS)**: View Global Data Service によるグローバルデータの同期

**最大構成**:
- 最大 50 Pod
- 最大 40 サイト
- 最大 350,000 セッション（Federation 全体）

### Site Preferences の設定オプション

CPA では、Global Entitlement に対してサイトの優先順位を細かく制御できる。

#### Home Site Assignment

ユーザーまたはグループにデフォルトの接続先サイトを割り当てる。

**設定方法**:

```
Horizon Console > Settings > Cloud Pod Architecture > Sites
→ 対象サイトを選択 > Home Site Assignments > Add
→ ユーザーまたはグループを選択
```

**lmvutil コマンドでの設定**:

```bash
lmvutil --authAs admin --authDomain DOMAIN --authPassword ***
         --assignHomeSite --userName user@domain.com --siteName "Tokyo-Site"
```

**一括設定**:

```bash
lmvutil --assignHomeSite --userName user1@domain.com --siteName "Tokyo-Site"
lmvutil --assignHomeSite --userName user2@domain.com --siteName "NY-Site"
```

#### Global Entitlement の Scope 設定

| Scope | 動作 |
|---|---|
| **ANY** | Federation 内のどのサイトのリソースでも使用可能 |
| **SITE** | ユーザーの Home Site 内のリソースのみ使用 |
| **SITE_AND_ADJACENT** | Home Site と隣接サイトのリソースを使用 |

#### Pod 優先度の設定

Global Entitlement 内の各ローカルプールに対して優先度を設定:

| 優先度 | 説明 |
|---|---|
| **Default** | 通常の優先度 |
| **Low** | 最後に使用（他の Pod にリソースがない場合のみ） |
| **Disabled** | このプールからリソースを割り当てない |

### Site Preferences の判断フレームワーク

| シナリオ | 推奨設定 |
|---|---|
| ユーザーが固定拠点に所属 | Home Site を各ユーザー/グループに割り当て、Scope = SITE |
| ユーザーが拠点間を移動 | Home Site 設定 + Scope = SITE_AND_ADJACENT |
| DR/BCP 対応が必要 | Scope = ANY で全サイトフェイルオーバー可能に |
| WAN レイテンシが大きい | Home Site を厳格に適用し、Scope = SITE で制限 |
| リソースの局所性が重要 | Home Site + Pod 優先度で細かく制御 |

---

## Consider Upgrade Processes and Dependencies in a CPA

### CPA 環境のアップグレード順序

CPA 環境のアップグレードは依存関係に注意して段階的に実施する。

#### 推奨アップグレード順序

```
1. Horizon Connection Server（全 Pod のプライマリ CS → レプリカ CS）
2. Horizon Agent（Golden Image → プール更新）
3. Horizon Client（エンドユーザー）
```

#### Pod 単位のアップグレード手順

1. **Pod 内の1台目の Connection Server をアップグレード**
   - プライマリ CS からアップグレード開始
   - アップグレード中はこの CS への接続を LB から除外

2. **同一 Pod 内の残りの Connection Server をアップグレード**
   - 1台ずつ順次アップグレード
   - 各 CS アップグレード後に LDAP レプリケーションを確認

3. **次の Pod へ進む**
   - 同じ手順を繰り返す

### CPA ネットワークポート要件

| ポート | プロトコル | 用途 |
|---|---|---|
| TCP 22389 | LDAP | ADLDS Global LDAPレプリケーション |
| TCP 22636 | LDAPS | ADLDS Secure Global LDAPSレプリケーション |
| TCP 8472 | VIPA | Inter-pod VIPA通信 |
| TCP 135 | RPC | MS-RPC Endpoint Mapper（レプリケーション用） |
| TCP 49152-65535 | RPC | MS-RPC動的ポート範囲 |

### CPA アップグレードの依存関係と制約

| 制約 | 詳細 |
|---|---|
| **混在バージョン** | アップグレード中は異なるバージョンの Pod が混在可能（互換性マトリクス確認要） |
| **Global Entitlement** | 全 Pod が同じメジャーバージョンであることが推奨 |
| **VGDS レプリケーション** | 異なるバージョン間でのデータ同期に制限がある場合あり |
| **lmvutil** | 最新バージョンの CS から実行すること |
| **ロールバック** | CS のバックアップ/スナップショットから復元可能 |

### アップグレード前チェックリスト

- [ ] 全 Pod の Connection Server のスナップショット/バックアップ
- [ ] Global Entitlement の現在の設定をエクスポート
- [ ] 互換性マトリクスの確認（CS間、CS-Agent間）
- [ ] メンテナンスウィンドウの計画
- [ ] ロールバック手順の準備と検証
- [ ] テスト環境での事前検証

---

## Consider Options to Load Balance RDSH Farms

### RDSH ファームのロードバランシングメカニズム

Horizon 8 では、RDSH ファーム内のホスト間でセッションを分散する複数の方法がある。

#### Connection Server ブローカーによる内蔵ロードバランシング

Horizon Connection Server は、ファーム内の RDS ホストにセッションを割り当てる際に以下のアルゴリズムを使用する。

| 方式 | 説明 | 適するケース |
|---|---|---|
| **Session Count** | 各ホストの現在のセッション数に基づく | 均等なワークロード |
| **Server Load Index** | ホストの CPU、メモリ使用率を考慮した負荷指標 | リソース集約型アプリケーション |

**設定方法**:

```
Horizon Console > Inventory > Farms > 対象ファーム > Edit
→ Advanced Storage Options 内の Load Balancing Settings
```

#### サーバー負荷指標（Server Load Index）

Horizon Agent が各 RDS ホストの負荷を Connection Server に報告する。

**負荷指標の構成要素**:
- CPU 使用率
- メモリ使用率
- ディスク I/O 待機
- セッション数

**レジストリ設定によるカスタマイズ**:

```
HKLM\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration
```

- `LoadIndex`: 現在の負荷指標値（0-100）
- Connection Server は負荷指標が**最も低い**ホストに新しいセッションを割り当て

#### 外部ロードバランサーの使用

RDS ホストの前段に外部 LB を配置する場合:
- Horizon のブローカーリングは外部 LB を通さず直接ホストにセッションを割り当てる
- 外部 LB は主に Connection Server 層の冗長化に使用
- RDSH ファーム内の分散は Horizon ブローカーの内蔵機能で行う

### ロードバランシング方式の比較

| 方式 | メリット | デメリット |
|---|---|---|
| Session Count ベース | シンプル、設定不要 | ホストの実負荷を考慮しない |
| Server Load Index ベース | 実際のリソース使用率を反映 | Agent からの報告にわずかな遅延 |
| 外部 LB | 高度なヘルスチェック | RDSH ファーム分散には Horizon ブローカー推奨 |

---

## Evaluate to Increase Login Performance for RDSH-Based Sessions

### RDSH ログインパフォーマンスの構成要素

RDSH セッションのログイン時間は複数のフェーズで構成される。

**Logon Monitor** による測定可能なフェーズ:

```
Horizon Console > Monitor > Dashboard > Session Details > Logon Timing
```

| フェーズ | 内容 | 最適化の方向性 |
|---|---|---|
| **Brokering** | Connection Server によるセッション割り当て | CS リソース、LB 設定 |
| **Connection** | クライアント → RDS ホスト接続 | ネットワーク、プロトコル設定 |
| **Authentication** | ユーザー認証 | AD 応答時間、認証方式 |
| **Profile Load** | ユーザープロファイルのロード | DEM 設定、プロファイルサイズ |
| **GPO Processing** | グループポリシー適用 | GPO の数と複雑さ |
| **Logon Script** | ログオンスクリプト実行 | スクリプトの最適化 |
| **Shell Load** | Windows Shell の初期化 | OS 最適化、不要サービス停止 |

### ログインパフォーマンス最適化手法

#### 1. OS イメージ最適化

- **OS Optimization Tool** を使用して不要なサービス・スケジュールタスクを無効化
- Windows Search、Superfetch、Windows Update 等の無効化
- 参照: Manually Creating Optimized Windows Images for Horizon VMs

#### 2. プロファイル管理の最適化

- **DEM DirectFlex** を有効化 → アプリケーション設定をログイン時ではなくアプリ起動時に読み込み
- フォルダリダイレクションで AppData 等の大容量データを分離
- 不要なプロファイルデータの除外設定

#### 3. GPO の最適化

- GPO の数を最小限に抑える
- WMI フィルターの使用を避ける（処理時間が増加）
- ループバック処理を「Replace」モードで使用

#### 4. ネットワーク最適化

- RDS ホストと AD ドメインコントローラー間のレイテンシを最小化
- DNS 解決の高速化
- DEM の Configuration Share / Profile Archive Share をローカルサイトに配置

#### 5. Horizon Agent 設定

- `Always wait for the network at computer startup and logon` を有効化（DEM 使用時に推奨）
- Logon Monitor を有効化して各フェーズの所要時間を可視化

---

## Evaluate to Limit the Number of Sessions per RDS Host

### セッション制限の設定

RDS ホストあたりのセッション数を制限することで、パフォーマンスの安定性を確保する。

#### Horizon Console での設定

```
Horizon Console > Inventory > Farms > 対象ファーム > Edit
→ Max Sessions per RDS Host
```

| 設定項目 | 説明 |
|---|---|
| **Max Sessions** | ホストあたりの最大セッション数 |
| **No Limit** | 制限なし（デフォルト） |

#### Windows Server RDS 側の設定

```
gpedit.msc > Computer Configuration > Administrative Templates
> Windows Components > Remote Desktop Services
> Remote Desktop Session Host > Connections
→ Limit number of connections
```

### セッション数の見積もり方法

| 要因 | 考慮事項 |
|---|---|
| **ホスト CPU** | vCPU 数 × コアあたりのセッション数（目安: 1-2セッション/vCPU） |
| **ホストメモリ** | セッションあたり 1-2GB + OS オーバーヘッド |
| **アプリケーション要件** | 軽量オフィス: 1GB/セッション、CAD等: 4GB+/セッション |
| **ストレージ IOPS** | セッションあたり 5-15 IOPS（アプリケーション依存） |
| **ネットワーク帯域** | Blast Extreme: セッションあたり 100-500 Kbps |

### セッション制限の判断フレームワーク

| ワークロード | 推奨最大セッション数（8vCPU/32GB RAM の場合） |
|---|---|
| タスクワーカー（軽量オフィス） | 25-30 セッション |
| ナレッジワーカー（Office + ブラウザ） | 15-20 セッション |
| パワーユーザー（重量アプリケーション） | 8-12 セッション |

> **注意**: これらは目安であり、必ず実環境でのパイロットテストで検証すること。Login VSI 等のツールで負荷テストを実施し、適切な値を決定する。

---

## Evaluate Use Case for Application on Demand and Configure Prerequisites in Horizon UI

### Application on Demand（Apps on Demand）の概要

Apps on Demand は **App Volumes** と連携し、RDSH 環境で公開アプリケーションをオンデマンドで配信する機能。ユーザーがアプリケーションを起動した時点で、App Volumes パッケージを RDSH サーバーにアタッチする。

### Classic Mode vs. On Demand Mode の比較

| 項目 | Classic Mode | On Demand Mode |
|---|---|---|
| **パッケージアタッチ** | マシン起動時またはユーザーログイン時 | ユーザーがアプリ起動時 |
| **対象** | コンピューター/OU にアサイン | ユーザー/グループにアサイン |
| **リソース消費** | 常時（使用しないアプリもアタッチ） | 必要時のみ |
| **ログインストーム** | 影響大（多数パッケージの同時アタッチ） | 影響小（分散アタッチ） |
| **ファーム運用** | パッケージ変更時にファーム再構成要 | 柔軟（エンタイトルメントベース） |

### Apps on Demand のユースケース

| ユースケース | 説明 |
|---|---|
| **大規模 RDSH ファーム** | ログインストーム軽減、リソース効率化 |
| **アプリケーション数が多い環境** | 必要なアプリのみ動的にアタッチ |
| **頻繁なアプリ更新** | ファーム再構成なしでパッケージ更新可能 |
| **ユーザーごとに異なるアプリセット** | エンタイトルメントベースの柔軟な配信 |

### 前提条件と Horizon UI での構成

#### 前提条件

1. **App Volumes Manager** がインストール・構成済み
2. **App Volumes Agent** が RDSH ゴールデンイメージにインストール済み
3. App Volumes Manager が Horizon Connection Server に統合済み
4. アプリケーションパッケージが作成済み

#### Horizon Console での設定

1. **ファームの作成**:

```
Horizon Console > Inventory > Farms > Add
→ Type: Automated Farm (Instant Clone 推奨)
→ ゴールデンイメージに App Volumes Agent を含む
```

2. **App Volumes アプリケーションの公開**:

```
Horizon Console > Inventory > Applications > Add
→ App Volumes Application を選択
→ App Volumes Manager から利用可能なアプリケーションを選択
→ 配信モード: On Demand
```

3. **エンタイトルメントの設定**:

```
対象アプリケーション > Entitlements > Add
→ ユーザーまたはグループを選択
```

#### App Volumes Manager 側の設定

- パッケージの RDSH 互換性確認（RDSH OS でパッケージング）
- RD-Install モードでアプリケーションをインストール
- Writable Volumes は RDSH アサインメントでは非サポート

#### Connection Server 側の統合設定

Apps on Demand を使用するには、Connection Server と App Volumes Manager の統合が必要。

```
Horizon Console > Settings > App Volumes Settings
→ App Volumes Manager のURL（またはLB VIP）を入力
→ 認証情報を設定
```

Connection Server → App Volumes Manager: TCP 443（監視・Apps on Demand呼び出し）

> **ベストプラクティス**: Apps on Demand を使用する場合、パッケージは AD の OU レベルではなく、ユーザー/グループにアサインする。これにより Horizon のエンタイトルメントと一致させ、柔軟な管理が可能になる。

---

## ベストプラクティスとアンチパターン

### ベストプラクティス

| カテゴリ | 推奨事項 |
|---|---|
| CPA サイト設定 | ユーザーの地理的位置に基づき Home Site を設定 |
| CPA アップグレード | 1 Pod ずつ段階的にアップグレード、テスト環境で事前検証 |
| RDSH ロードバランシング | Server Load Index ベースの分散でリソース使用率を反映 |
| ログインパフォーマンス | DEM DirectFlex + OS 最適化 + GPO 最小化の組み合わせ |
| セッション制限 | パイロットテストで適切な値を決定、安全マージンを確保 |
| Apps on Demand | ユーザーベースのアサインメント、RDSH 専用パッケージを作成 |

### アンチパターン

| アンチパターン | リスク |
|---|---|
| Home Site なしで CPA 運用 | ユーザーが遠距離サイトに接続、レイテンシ増大 |
| 全 Pod を同時アップグレード | 全面障害のリスク |
| セッション制限なしで運用 | ホスト過負荷によるパフォーマンス劣化 |
| Classic Mode で大量パッケージ配信 | ログインストーム、起動時間の増大 |
| WMI フィルター多用の GPO | ログイン時間の大幅な増加 |

---

## 理解度チェックリスト

### CPA サイト設定
- [ ] Home Site、Global Entitlement Scope（ANY/SITE/SITE_AND_ADJACENT）の違いを説明できる
- [ ] lmvutil を使用した Home Site 割り当て手順を実行できる
- [ ] サイト設定がユーザーエクスペリエンスに与える影響を評価できる

### CPA アップグレード
- [ ] CPA 環境のアップグレード順序と依存関係を説明できる
- [ ] 混在バージョン環境での制約を理解している
- [ ] アップグレード前のバックアップとロールバック手順を準備できる

### RDSH ファーム
- [ ] Session Count と Server Load Index ベースのロードバランシングの違いを評価できる
- [ ] RDSH ログインパフォーマンスの各フェーズ（Brokering〜Shell Load）を特定し最適化できる
- [ ] ワークロードに応じた適切なセッション制限数を見積もれる

### Application on Demand
- [ ] Classic Mode と On Demand Mode の違いとユースケースを評価できる
- [ ] Apps on Demand の前提条件（App Volumes Agent、Manager 統合）を説明できる
- [ ] Horizon Console での Apps on Demand の設定手順を実行できる
