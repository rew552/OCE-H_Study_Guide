# 1.6 Pod/Farm Architecture

## 概要

Pod/Farmアーキテクチャの管理は、Horizon環境のスケーラビリティと可用性に重要です。OCE-Hレベルでは、CPAでのサイト設定、アップグレードプロセス、RDSHファームのロードバランシング、Application on Demandの設定が求められます。

## CPAでのサイト設定オプションの評価

### サイト設定の種類

#### Home Site

**概要**:
- ユーザーのホームサイトを指定
- 可能な限りホームサイトのポッドに接続

**設定方法**:
```bash
# Imvutilコマンドで設定
imvutil -c -s -u username -h pod-name
```

**利点**:
- レイテンシの最小化
- データの局所性
- ネットワーク帯域幅の最適化

#### Site Preferences

**設定オプション**:
- **Preferred**: 優先サイト
- **Allowed**: 許可されたサイト
- **Blocked**: ブロックされたサイト

**設定例**:
- ユーザーグループごとにサイト設定
- アプリケーションごとにサイト設定

**地理的分散の考慮**:

**地理的分散の設計**:
- ユーザーの地理的位置に基づくHome Site設定
- レイテンシの最小化
- データの局所性

**レイテンシ最適化**:
- ユーザーとポッド間のレイテンシを測定
- 最適なHome Siteを自動的に選択
- レイテンシが高い場合の代替サイト設定

**レイテンシ測定の例**:
```powershell
# ユーザーとポッド間のレイテンシを測定
Test-NetConnection -ComputerName "pod-tokyo.contoso.com" -Port 443
Test-NetConnection -ComputerName "pod-newyork.contoso.com" -Port 443

# 最適なポッドを選択（レイテンシが低い方）
```

**一括Home Site設定**:
```powershell
# CSVファイルから一括設定
# users.csvの形式:
# username,pod-name
# contoso\jsmith,Pod-Tokyo
# contoso\jdoe,Pod-NewYork

$users = Import-Csv "users.csv"
foreach ($user in $users) {
    imvutil -c -s -u $user.username -h $user.'pod-name'
}
```

> [!IMPORTANT]

> サイト設定は、Cloud Pod Architectureのパフォーマンスとユーザーエクスペリエンスに直接影響します。適切な設定が重要です。

## CPAでのアップグレードプロセスと依存関係の考慮

### アップグレード順序

**推奨順序**:
1. Cloud Pod Orchestratorのアップグレード
2. 各ポッドのConnection Serverのアップグレード
3. エージェントのアップグレード

**依存関係**:
- すべてのポッドが同じバージョンである必要がある
- グローバルエンタイトルメントの互換性

**詳細なアップグレード手順**:

1. **アップグレード前の準備**
   - すべてのポッドのバックアップ
   - グローバルエンタイトルメントの確認
   - テスト環境での検証

2. **Cloud Pod Orchestratorのアップグレード**
   - 最初のポッドでOrchestratorをアップグレード
   - 他のポッドとの互換性を確認

3. **各ポッドのConnection Serverのアップグレード**
   - ポッドごとに順次アップグレード
   - 各ポッドのアップグレード後に検証

4. **エージェントのアップグレード**
   - すべてのポッドのConnection Serverがアップグレード完了後
   - エージェントを一括または段階的にアップグレード

**アップグレードチェックリスト**:
- [ ] すべてのポッドのバックアップ
- [ ] グローバルエンタイトルメントの確認
- [ ] テスト環境での検証
- [ ] メンテナンスウィンドウの計画
- [ ] ロールバック計画の準備

> [!WARNING]

> CPA環境でのアップグレードは、すべてのポッドを順次アップグレードする必要があります。一部のポッドのみをアップグレードすると、互換性の問題が発生する可能性があります。

## RDSHファームのロードバランシングオプションの評価

### ロードバランシング方法

#### セッションベースのロードバランシング

**概要**:
- 各RDSHホストのセッション数を監視
- セッション数が少ないホストに接続

**利点**:
- シンプルな実装
- 自動的な負荷分散

#### リソースベースのロードバランシング

**概要**:
- CPU、メモリ、ディスク使用率を監視
- リソース使用率が低いホストに接続

**利点**:
- より正確な負荷分散
- パフォーマンスの最適化

### ロードバランシング設定

**Horizon Consoleでの設定**:
- Inventory → Farms → ファームを選択
- Settings → Load Balancing
- ロードバランシング方法を選択

> [!TIP]

> リソースベースのロードバランシングは、パフォーマンスが重要な環境で推奨されます。

## RDSHベースセッションのログイン性能向上の評価

### パフォーマンス最適化

#### ホスト側の最適化

**設定項目**:
- メモリ割り当ての最適化
- CPU割り当ての最適化
- ディスクIOPSの最適化

**推奨設定**:
- セッションあたりのメモリ: 768MB-1GB
- CPU: セッション数に応じて調整

#### ネットワーク最適化

**設定項目**:
- ネットワーク帯域幅の確保
- レイテンシの最小化

## RDSホストあたりのセッション数の制限評価

### セッション数の計算

**考慮事項**:
- ホストのリソース（CPU、メモリ、ディスク）
- アプリケーションの要件
- ユーザーの使用パターン

**推奨値**:
- 標準的なオフィス作業: 50-100セッション
- 重いアプリケーション: 20-50セッション

**設定方法**:
- Horizon Console → Inventory → Farms
- ファームを選択 → Settings → Session Limits

> [!IMPORTANT]

> セッション数の制限は、ホストのリソースとアプリケーションの要件に基づいて設定する必要があります。過剰なセッション数は、パフォーマンスの低下を引き起こします。

## Application on Demandのユースケース評価とHorizon UIでの前提条件設定

### Application on Demandの概要

**機能**:
- アプリケーションをオンデマンドで配信
- VM起動時にアプリケーションを動的にアタッチ
- リソース効率の向上

### ユースケース

**適用可能なシナリオ**:
- たまに使用されるアプリケーション
- 大規模なアプリケーション
- 頻繁に更新されるアプリケーション

**適用不可なシナリオ**:
- 常に使用されるアプリケーション
- 起動時間が重要なアプリケーション

### 前提条件設定

**Horizon UIでの設定**:

1. **Application on Demandの有効化**
   - Horizon Console → View Configuration → Global Settings
   - Application on Demandを有効化

2. **前提条件の設定**
   - App Volumes Managerの統合
   - ストレージの設定
   - ネットワークの設定

3. **アプリケーションの設定**
   - Inventory → Applications
   - アプリケーションを選択
   - Application on Demandを有効化

> [!NOTE]

> Application on Demandを使用するには、App Volumes Managerの統合が必要です。

## グローバルエンタイトルメントの詳細な管理

### グローバルエンタイトルメントの作成と管理

**作成手順**:

1. **Horizon Consoleでの作成**
   - Inventory → Global Entitlements
   - Add Global Entitlementをクリック
   - 基本情報を入力

2. **プールの追加**
   - Global Entitlementを選択
   - Poolsタブ → Add Pool
   - 複数ポッドからプールを選択

3. **エンタイトルメントの設定**
   - Entitlementsタブ → Add
   - ユーザーまたはグループを追加

**グローバルエンタイトルメントの優先順位**:
- グローバルエンタイトルメントがローカルエンタイトルメントより優先
- 複数のグローバルエンタイトルメントがある場合、より具体的なものが優先

**Imvutilコマンドでの管理**:
```bash
# グローバルエンタイトルメントの一覧
imvutil -c -l -g

# グローバルエンタイトルメントにプールを追加
imvutil -c -a -g "Global-Entitlement-Name" -p "Pool-Name"

# グローバルエンタイトルメントからプールを削除
imvutil -c -r -g "Global-Entitlement-Name" -p "Pool-Name"
```

## ポッド間のデータレプリケーション

### データレプリケーションの概要

**レプリケーションが必要なデータ**:
- グローバルエンタイトルメント設定
- ユーザーのHome Site設定
- サイト設定

**レプリケーション方法**:
- **自動レプリケーション**: Connection Server間で自動的にレプリケート
- **手動レプリケーション**: 必要に応じて手動でレプリケート

**レプリケーションの確認**:
```bash
# ポッド間のレプリケーション状態を確認
imvutil -c -l -p

# 特定のポッドの状態を確認
imvutil -c -l -p -n "Pod-Name"
```

### レプリケーションのトラブルシューティング

**一般的な問題**:
- レプリケーションの遅延
- レプリケーションの失敗
- データの不整合

**トラブルシューティング手順**:
1. ネットワーク接続の確認
2. ファイアウォールルールの確認
3. ログファイルの確認
4. 手動レプリケーションの実行

## サイト障害時のフェイルオーバー手順

### フェイルオーバーの概要

**フェイルオーバーの種類**:
- **自動フェイルオーバー**: サイト障害を自動的に検出してフェイルオーバー
- **手動フェイルオーバー**: 管理者が手動でフェイルオーバーを実行

### フェイルオーバー手順

**自動フェイルオーバーの設定**:

1. **サイト設定での有効化**
   - Horizon Console → View Configuration → Cloud Pod Architecture
   - Site Settings → Failover Settings
   - Automatic Failover: Enabled

2. **フェイルオーバー条件の設定**
   - サイト障害の検出時間: 30秒
   - フェイルオーバー遅延: 60秒

**手動フェイルオーバーの手順**:

1. **障害サイトの確認**
   ```bash
   # ポッドの状態を確認
   imvutil -c -l -p -n "Pod-Name"
   ```

2. **フェイルオーバーの実行**
   - Horizon Console → View Configuration → Cloud Pod Architecture
   - Site Settings → Failover
   - フェイルオーバー先のサイトを選択

3. **フェイルオーバーの検証**
   - ユーザーが代替サイトに接続できることを確認
   - パフォーマンスを確認

**フェイルオーバー後の復旧手順**:

1. **障害サイトの復旧**
   - 障害の原因を特定して修正
   - サイトを復旧

2. **レプリケーションの確認**
   - データの整合性を確認
   - レプリケーションが正常に動作することを確認

3. **フェイルバックの実行**
   - 必要に応じてフェイルバックを実行
   - ユーザーを元のサイトに戻す

> [!IMPORTANT]

> サイト障害時のフェイルオーバー手順は、事前に計画し、定期的にテストする必要があります。

## ベストプラクティス

1. **サイト設定**
   - ユーザーの位置に基づくHome Site設定
   - ネットワーク帯域幅を考慮した設定

2. **アップグレード**
   - すべてのポッドを順次アップグレード
   - テスト環境での検証

3. **ロードバランシング**
   - リソースベースのロードバランシングを推奨
   - 定期的な監視と調整

4. **セッション制限**
   - ホストのリソースに基づく設定
   - アプリケーション要件の考慮

## 理解度チェックリスト

以下の項目について理解度を確認してください：

### CPAサイト設定
- [ ] CPAでのサイト設定オプション（Home Site、Site Preferences）を評価できる
- [ ] サイト設定の影響を理解している

### アップグレードプロセス
- [ ] CPAでのアップグレードプロセスと依存関係を考慮できる
- [ ] アップグレード順序を説明できる

### RDSHファーム
- [ ] RDSHファームのロードバランシングオプションを評価できる
- [ ] RDSHベースセッションのログイン性能向上の評価方法を理解している
- [ ] RDSホストあたりのセッション数制限の評価方法を説明できる

### Application on Demand
- [ ] Application on Demandのユースケースを理解している
- [ ] Application on Demandの前提条件と設定方法を説明できる

## まとめ

Pod/Farmアーキテクチャの適切な管理は、Horizon環境のスケーラビリティと可用性に重要です。サイト設定、アップグレードプロセス、ロードバランシング、Application on Demandの適切な設定により、効率的で可用性の高いHorizon環境を構築できます。
