# 1.3 Integrate Active Directory for Authentication and User Access Control

## 試験ガイド対応 (Section 4.1.3)

- Create Service Accounts, groups, and OU for Horizon Deployment
- Import ADMX templates for Horizon

---

## 1. Service Accountの作成

### 1.1 Horizon展開に必要なService Account一覧

| Service Account | 用途 | 必要な権限 |
|----------------|------|----------|
| Horizon vdmadmin | Connection Server管理操作 | Domain Users + Horizon管理者ロール |
| Instant Clone Domain Admin | Instant Cloneのコンピューターアカウント作成 | 対象OUへの「コンピューターオブジェクトの作成/削除」権限 |
| vCenter Service Account | Connection Server → vCenter API接続 | vCenter管理者ロール（または必要な最小権限） |
| True SSO (Enrollment Server) | 証明書要求 | Enrollment Agent証明書 + テンプレートのEnroll権限 |
| App Volumes Service Account | App Volumes Manager操作 | Domain Users + ストレージアクセス権 |
| DEM Service Account | DEM構成ファイル共有アクセス | SMBファイル共有のRead/Write権限 |

### 1.2 Instant Clone Domain Adminの作成（重要）

Instant Clone用のService Accountには、コンピューターオブジェクトの作成・削除に関する細かい委任設定が必要。

**作成手順**:

1. **ADユーザーの作成**
   - 名前例: `svc-horizon-ic`
   - Password never expires: 有効
   - User cannot change password: 有効

2. **OUへの権限委任**（Instant Cloneのコンピューターアカウントが作成されるOU）

   Active Directory Users and Computers → 対象OUを右クリック → Delegate Control

   **必要な権限**:

   | 権限 | 対象 |
   |------|------|
   | Create Computer Objects | このOUおよび子OU |
   | Delete Computer Objects | このOUおよび子OU |
   | Read All Properties | Computer Objects |
   | Write All Properties | Computer Objects |
   | Reset Password | Computer Objects |
   | Read/Write Account Restrictions | Computer Objects |

   または、PowerShellでの委任:

   ```powershell
   $ou = "OU=VDI Desktops,OU=Horizon,DC=mydomain,DC=com"
   $user = "mydomain\svc-horizon-ic"
   dsacls $ou /I:S /G "${user}:CCDC;computer"
   dsacls $ou /I:S /G "${user}:LCDC;computer"
   ```

3. **Horizon Consoleでの登録**
   - Horizon Console → Settings → Instant Clone Domain Admins → Add
   - ドメイン名、Service Account名、パスワードを入力

### 1.3 Connection Server用Service Account

Connection Serverサービス自体はLocal Systemアカウントで実行される。ただし、以下の操作にはADアカウントが必要:

| 操作 | アカウント要件 |
|------|-------------|
| Horizon Consoleログイン | Domain Users + Horizon管理者ロール割り当て |
| vCenter接続 | vCenter管理者権限を持つアカウント |
| LDAP Bind（ADクエリ） | Connection Serverのコンピューターアカウント（自動） |

### 1.4 Service Accountのセキュリティベストプラクティス

| プラクティス | 詳細 |
|------------|------|
| 最小権限の原則 | 各Service Accountに必要最小限の権限のみを付与 |
| Password never expires | サービス中断を防ぐために有効化。ただし定期的に手動変更 |
| 専用アカウント | 個人アカウントとService Accountを分離 |
| 命名規則 | 一貫した命名規則（例: `svc-horizon-*`） |
| パスワード管理 | パスワード金庫（Vault）で管理 |
| ログオン制限 | 「Log on as a service」のみ許可。対話的ログオンは拒否 |

---

## 2. グループの作成

### 2.1 Horizon環境で推奨されるADグループ

| グループ名（例） | スコープ | 種類 | 用途 |
|----------------|---------|------|------|
| Horizon-Admins | Global | Security | Horizon完全管理者 |
| Horizon-ReadOnly-Admins | Global | Security | 読み取り専用管理者 |
| Horizon-HelpDesk | Global | Security | ヘルプデスクロール |
| Horizon-Pool-VDI-Users | Global | Security | VDIプールのエンタイトルメント |
| Horizon-Pool-RDSH-Users | Global | Security | RDSHファームのエンタイトルメント |
| Horizon-IC-DomainAdmins | Global | Security | Instant Cloneドメイン管理者 |
| Horizon-ES-Computers | Global | Security | Enrollment Serverコンピューターアカウント |

### 2.2 Horizon管理者ロールの割り当て

Horizon ConsoleでRole-Based Delegated Administrationを構成する。

**Horizon Console → Settings → Administrators and Groups**

| ロール | 権限 |
|--------|------|
| Administrators | 全操作 |
| Administrators (Read Only) | 読み取りのみ |
| Inventory Administrators | プール・ファーム管理 |
| Help Desk Administrators | セッション管理・ユーザーサポート |
| Global Configuration and Policy Administrators | グローバル設定・ポリシー管理 |

ADグループをHorizonロールに割り当てることで、グループメンバーシップの変更だけで権限管理が可能になる。

### 2.3 エンタイトルメント用グループの設計原則

| 原則 | 説明 |
|------|------|
| グループベース | 個別ユーザーではなくADグループにエンタイトルメントを割り当て |
| プールごとに分離 | デスクトッププール・アプリケーションプールごとに専用グループ |
| ネスト回避 | グループのネストは最小限に。パフォーマンスと可読性の維持 |
| 命名規則 | `Horizon-Pool-<プール名>-Users` のような一貫した規則 |

> **重要**: エンタイトルメントは個別ユーザーではなくADグループに割り当てるのがベストプラクティス。管理のスケーラビリティと一貫性が向上する。

---

## 3. OU（組織単位）の作成

### 3.1 Horizon用OU構造の設計

GPO（Group Policy Object）の適用とコンピューターアカウントの管理を効率化するため、論理的なOU階層を設計する。

**推奨OU構造**:

```
DC=mydomain,DC=com
└── OU=Horizon
    ├── OU=Servers
    │   ├── OU=Connection Servers
    │   ├── OU=Enrollment Servers
    │   └── OU=App Volumes Managers
    ├── OU=VDI Desktops          ← Instant Cloneのコンピューターアカウント先
    ├── OU=RDSH Hosts             ← RDSHサーバーのコンピューターアカウント先
    ├── OU=Service Accounts
    └── OU=Groups
```

### 3.2 OU設計の判断基準

| 判断基準 | 説明 |
|---------|------|
| GPO適用範囲 | 異なるGPOを適用するコンピュータータイプごとにOUを分離 |
| 委任管理 | 異なる管理者が異なるOUを管理する場合に分離 |
| Instant Cloneの宛先 | Instant Cloneプール構成時に指定するOU。専用OUが必要 |
| ブロック継承 | 上位GPOの影響を遮断する場合にOU分離とブロック継承を併用 |

### 3.3 Instant Clone用OUの重要性

Instant Cloneプールを作成する際、VMのコンピューターアカウントが配置されるAD OUを指定する。このOUに対して:

- Instant Clone Domain Admin Accountに適切な権限を委任
- VDI専用のGPOをリンク
- 上位OUのGPOが不適切に継承されないよう必要に応じてブロック継承を設定

---

## 4. Horizon用ADMXテンプレートのインポート

### 4.1 ADMXテンプレートの概要

Horizon用ADMXテンプレートは、Group Policyを使用してHorizon Client・Agent・プロトコルの設定を一元管理するためのテンプレートファイル。

**入手先**: Horizon Connection Serverインストーラーに同梱、または Horizon Extras Bundle（Omnissa Downloads）

> **Horizon 2412以降の変更**: Omnissaリブランディングに伴い、ADMXテンプレートのファイル名やGPOパスが `VMware` から `Omnissa` に変更されている。アップグレード時はCentral Store内のADMXファイルも更新が必要。

**主要なテンプレートファイル**:

| テンプレート | 適用先 | 主な設定内容 |
|------------|--------|------------|
| omnissa-view-agent.admx | Computer Configuration | Agent動作、USB、CDR、マルチメディア |
| omnissa-view-agent-direct-connection.admx | Computer Configuration | Agent Direct Connection (ADCP) |
| omnissa-view-client.admx | User/Computer Configuration | Client動作、接続設定 |
| omnissa-view-server.admx | Computer Configuration | Connection Server動作 |
| omnissa-blast-protocol.admx | Computer Configuration | Blast Extreme設定 |
| omnissa-pcoip.admx | Computer Configuration | PCoIP設定 |
| omnissa-rdsh-flash.admx | Computer Configuration | Flash URL redirection |
| omnissa-dem.admx | Computer/User Configuration | DEM設定 |

### 4.2 Central Storeへのインポート手順

ADMXテンプレートはドメインのCentral Store（中央ストア）にコピーすることで、ドメイン内の全GPMC（Group Policy Management Console）から利用可能になる。

**Step 1: Central Storeの作成（存在しない場合）**

```
\\<domain-FQDN>\SYSVOL\<domain-FQDN>\Policies\PolicyDefinitions
```

このフォルダが存在しない場合は手動で作成する。また、言語フォルダ（例: `en-US`, `ja-JP`）も作成する。

**Step 2: ADMXファイルのコピー**

```
コピー元: <Horizon Extras Bundle>\admx\*.admx
コピー先: \\<domain-FQDN>\SYSVOL\<domain-FQDN>\Policies\PolicyDefinitions\
```

**Step 3: ADMLファイル（言語リソース）のコピー**

```
コピー元: <Horizon Extras Bundle>\admx\en-US\*.adml
コピー先: \\<domain-FQDN>\SYSVOL\<domain-FQDN>\Policies\PolicyDefinitions\en-US\
```

**Step 4: 確認**

1. `gpmc.msc` を起動
2. 任意のGPOを編集
3. Computer Configuration → Policies → Administrative Templates に「Omnissa」フォルダが表示されることを確認

> **重要**: ADMXファイルは`.admx`がテンプレート本体、`.adml`が言語リソース。Central StoreにコピーするとSYSVOLレプリケーションにより全DCに配布される。

### 4.3 GPOの設計と適用

#### 推奨GPOの分類

| GPO名（例） | リンク先OU | 対象 | 主な設定 |
|------------|----------|------|---------|
| Horizon-VDI-Computer | VDI Desktops OU | Computer | Loopback Replace, Agent設定, Blast設定 |
| Horizon-RDSH-Computer | RDSH Hosts OU | Computer | RDSH固有設定, ライセンス, Agent設定 |
| Horizon-User-Settings | VDI Desktops OU + RDSH OU | User (Loopback) | シャットダウン禁止, ログオフ追加 |

#### Computer Configuration の重要設定

**Loopback Processing（必須）**

```
Computer Configuration → Policies → Administrative Templates → System → Group Policy
→ Configure user Group Policy loopback processing mode: Enabled (Mode: Replace)
```

Loopback Replace を有効にすることで、ユーザーがVDI/RDSHにログインした際に、ユーザーのOU GPOではなく、コンピューターのOU GPOのUser Configurationが適用される。

**ログオンスクリプト遅延の無効化**

```
Computer Configuration → Policies → Administrative Templates → System → Group Policy
→ Configure Logon Script Delay: Disabled
```

**初回サインインアニメーションの無効化**

```
Computer Configuration → Policies → Administrative Templates → System → Logon
→ Show first sign-in animation: Disabled
```

**ネットワーク待機の有効化**

```
Computer Configuration → Policies → Administrative Templates → System → Logon
→ Always wait for the network at computer startup and logon: Enabled
```

#### RDSH固有の設定

```
Computer Configuration → Policies → Administrative Templates
→ Windows Components → Remote Desktop Services → Remote Desktop Session Host → Licensing
→ Use the specified Remote Desktop license servers: Enabled（ライセンスサーバーを指定）
→ Set the Remote Desktop licensing mode: Enabled（ライセンスモードを指定）
```

#### User Configuration の重要設定

```
User Configuration → Policies → Administrative Templates → Start Menu and Taskbar
→ Remove and prevent access to the Shut Down, Restart, Sleep and Hibernate commands: Enabled
→ Add Logoff to the Start Menu: Enabled
```

### 4.4 GPOのベストプラクティス

| プラクティス | 説明 |
|------------|------|
| Loopback Replace | VDI/RDSHのOUで必ず有効化 |
| GPOの再利用 | 同様の設定は1つのGPOにまとめて再利用 |
| 継承のブロック | VDI/RDSH OUで上位GPOの不要な継承をブロック |
| MonolithicとFunctionalの使い分け | 汎用設定はドメインレベル（Monolithic）、特定設定はOU レベル（Functional） |
| セキュリティフィルタリング | ADグループによるGPO適用対象の制御 |
| テスト環境での検証 | 本番適用前に必ずテストOUで検証 |

### 4.5 GPO適用順序（LSDOU）

| 順序 | レベル | 優先度 |
|------|--------|--------|
| 1 | Local GPO | 最低 |
| 2 | Site GPO | |
| 3 | Domain GPO | |
| 4 | OU GPO（親→子） | 最高 |

同一レベルでは、リンク順序の数値が小さいGPOが優先される。

**Enforced（強制）**: 子OUでオーバーライドできない
**Block Inheritance（継承ブロック）**: 親OUのGPOを継承しない

**確認コマンド**:

```
gpresult /r /scope Computer
gpresult /r /scope User
gpresult /h C:\GPOReport.html /f
```

---

## 5. マルチドメイン・クロスフォレスト環境

### 5.1 サポートされる信頼関係

| 信頼タイプ | サポート | 備考 |
|----------|---------|------|
| 一方向外部信頼 | ○ | ユーザードメインがリソースドメインを信頼 |
| 双方向外部信頼 | ○ | |
| フォレスト信頼（一方向） | ○ | |
| フォレスト信頼（双方向） | ○ | True SSOクロスフォレストに必要 |

### 5.2 True SSOクロスフォレスト構成

クロスフォレストでTrue SSOを使用する場合の追加手順:

1. リソースフォレストとユーザーアカウントフォレスト間の双方向フォレスト信頼を確認
2. リソースフォレストのCAでLDAPリファーラルを有効化: `certutil -setreg Policy\EditFlags +EDITF_ENABLELDAPREFERRALS`
3. リソースフォレストのCA証明書をユーザーアカウントフォレストに公開（`certutil -dspublish`）
4. PKISync.ps1を使用して証明書テンプレートをユーザーアカウントフォレストにコピー
5. ユーザーアカウントドメイン用のTrue SSOコネクタを`vdmutil`で作成

### 5.3 ADサイトの最適化

Connection Serverは所属するADサイトのDomain Controllerを優先的に使用する。地理的に分散した環境では、ADサイトとサブネットを適切に構成し、Connection Serverが最寄りのDCを使用するようにする。

### 5.4 Horizon AgentのAD通信ポート

| 通信元 | 通信先 | ポート | 用途 |
|--------|--------|--------|------|
| Horizon Agent | Connection Server | TCP 389 | Unmanaged Agent登録時（RDSHエージェントをInstant Clone/Linked Clone以外で登録する場合） |

> **重要**: Horizon AgentからConnection ServerへのTCP 389はすべてのAgent登録で必要なわけではない。Instant Cloneプールの場合はJMS（TCP 4001/4002）のみで登録が完了する。RDSHサーバーの手動登録など、unmanaged agent registrationの場合にのみTCP 389が必要。

---

## 理解度チェックリスト

### Service Account
- [ ] Instant Clone Domain Adminに必要な権限（Create/Delete Computer Objects等）を列挙できる
- [ ] Service Accountの命名規則・セキュリティプラクティスを説明できる
- [ ] Connection Serverサービス自体がLocal Systemで動作することを把握している

### グループ
- [ ] Horizon管理者ロール（Administrators, Read Only, Help Desk等）を区別できる
- [ ] エンタイトルメントはADグループベースで割り当てるベストプラクティスを説明できる

### OU
- [ ] Horizon用の推奨OU構造を設計できる
- [ ] Instant Cloneプールが使用するOUの要件を説明できる
- [ ] Loopback Processing（Replace）の必要性とリンク先を説明できる

### ADMXテンプレート
- [ ] Central Storeのパス（`\\domain\SYSVOL\domain\Policies\PolicyDefinitions`）を把握している
- [ ] ADMX（テンプレート本体）とADML（言語リソース）の区別ができる
- [ ] 主要なテンプレート（Agent, Client, Blast, PCoIP）の適用先を把握している
- [ ] GPO適用順序（LSDOU）とEnforced/Block Inheritanceの動作を説明できる
- [ ] Loopback Replace、ログオンスクリプト遅延無効化、初回アニメーション無効化などの推奨設定を把握している

### クロスフォレスト
- [ ] True SSOクロスフォレスト構成の追加手順を説明できる
- [ ] `certutil -setreg Policy\EditFlags +EDITF_ENABLELDAPREFERRALS` の用途を把握している
