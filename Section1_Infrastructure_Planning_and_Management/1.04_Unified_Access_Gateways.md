# 1.4 Deploy/Update Unified Access Gateways

## 試験ガイド対応 (Section 4.1.4)

- Evaluate the deployment method UAG installation based on the use case (Multi-NIC, PowerShell script vs UI)
- Evaluate HA configuration (load balancer) for UAG (Third party LB, UAG HA)
- Evaluate firewall settings for UAG session protocol
- Create or export UAG configuration and prepare deployment via PS-script

---

## 1. ユースケースに基づくUAGデプロイメント方法の評価

### 1.1 UAGの基本情報

Unified Access Gateway (UAG) はDMZに配置される仮想アプライアンスで、Horizon環境への安全な外部アクセスを提供する。

**サイジングオプション**

| サイズ | vCPU | メモリ | ディスク | 最大Horizonセッション | 主な用途 |
|-------|------|--------|---------|---------------------|---------|
| Standard | 2 | 4 GB | 20 GB | 2,000 | Horizonエッジサービス |
| Large | 4 | 16 GB | 20 GB | 50,000（WS1サービス/サービス） | WS1 UEMサービス（Tunnel, CGW, SEG） |
| Extra Large | 8 | 32 GB | 20 GB | 4,000（2412以降） | 大規模Horizonエッジサービス |

> **試験ポイント**: Horizonエッジサービスには通常Standard（2,000セッション）を使用。WS1 UEMサービス（Tunnel, Content Gateway, SEG）にはLargeを使用。Extra Largeは2412リリースから利用可能で4,000セッションをサポート。

### 1.2 NIC構成の評価

#### Single-NIC構成

| 項目 | 内容 |
|------|------|
| NIC数 | 1 |
| ネットワーク分離 | なし（全トラフィックが同一NICを共有） |
| ユースケース | テスト環境、シンプルなネットワーク |
| セキュリティ | 低（管理・バックエンド・インターネットトラフィックが混在） |

#### Two-NIC構成（推奨）

| 項目 | 内容 |
|------|------|
| NIC数 | 2 |
| NIC 0 (eth0) | インターネット向け（外部トラフィック） |
| NIC 1 (eth1) | バックエンド + 管理トラフィック |
| ユースケース | 本番環境 |
| セキュリティ | 中（インターネットとバックエンド/管理を分離） |

**セキュリティ上の利点**:
- フロントエンドNICが侵害されても、バックエンドNICへの直接アクセスは不可
- L4ファイアウォールルールとL7 UAGセキュリティの組み合わせ（Defense-in-depth）
- 管理ポート（9443）がインターネット側から到達不能

#### Three-NIC構成

| 項目 | 内容 |
|------|------|
| NIC数 | 3 |
| NIC 0 (eth0) | インターネット向け |
| NIC 1 (eth1) | バックエンド（Connection Server等への接続） |
| NIC 2 (eth2) | 管理専用（REST API: 9443） |
| ユースケース | 最もセキュリティ要件の高い環境 |
| セキュリティ | 高（全トラフィックタイプを完全分離） |

**管理トラフィックの完全分離**: HTTPS管理トラフィック（ポート9443）は管理LANからのみアクセス可能。

### 1.3 NIC構成の判断フレームワーク

| 判断基準 | Single-NIC | Two-NIC | Three-NIC |
|---------|-----------|---------|-----------|
| ネットワーク分離要件 | なし | インターネットとバックエンド分離 | 全トラフィック完全分離 |
| DMZ構成 | 不要 | 標準DMZ | セキュリティ最重視DMZ |
| パフォーマンス | ボトルネックの可能性 | トラフィック分散 | 最適なトラフィック分散 |
| 構成の複雑さ | 低 | 中 | 高 |
| 推奨度 | テストのみ | **本番推奨** | 高セキュリティ環境 |

> **試験ポイント**: Horizonサービスが有効な場合、ほとんどのトラフィックはBlast/PCoIPの表示プロトコル。2NIC以上ではフロントエンドとバックエンドにトラフィックが分散され、パフォーマンス向上の効果もある。

### 1.4 デプロイメント方法: PowerShell vs UI

#### PowerShellスクリプトによるデプロイ

**デプロイコマンド**:

```
.\uagdeploy.ps1 .\<name>.ini [rootPassword] [adminPassword] [skipValidation] [skipSSL] [joinCEIP]
```

実行例:
```
.\uagdeploy.ps1 .\uag-01.ini P@ssw0rd1 P@ssw0rd2 false false yes
```

| パラメータ | 説明 |
|----------|------|
| 第1引数 | INIファイルパス |
| 第2引数 | rootパスワード（アプライアンスコンソール用） |
| 第3引数 | adminパスワード（REST API管理用） |
| 第4引数 | 署名・証明書検証のスキップ（false推奨） |
| 第5引数 | SSL検証のスキップ（false推奨） |
| 第6引数 | CEIP参加 |

**前提条件**:
- Windows 10以降 / Windows Server 2019以降
- VMware OVF Tool 4.3以降（vSphereデプロイ時）
- PowerShell実行環境

#### UIによるデプロイ（OVFテンプレート + 管理コンソール）

1. vSphere ClientでOVFインポートウィザードを実行
2. デプロイ中に各種設定値を対話的に入力
3. 初回起動後、管理コンソール（`https://<UAG>:9443/admin`）でポストデプロイ構成
4. または別のUAGアプライアンスから設定ファイルをインポート

### 1.5 デプロイ方法の判断フレームワーク

| 判断基準 | PowerShellスクリプト | UI (OVFテンプレート) |
|---------|-------------------|-------------------|
| 一貫性 | **高**（INIファイルで再現可能） | 低（手動入力エラーの可能性） |
| 自動化 | **可能**（CI/CD統合可） | 不可 |
| 複数インスタンス | **効率的**（INIファイルを複製・修正） | 非効率（毎回手動） |
| 初回起動時の状態 | **本番稼働可能** | 追加構成が必要 |
| アップグレード | **容易**（同一INIで再デプロイ） | 手動操作必要 |
| バージョン管理 | **可能**（INIファイルをGit管理） | 不可 |
| 対話操作 | 不要 | 必要（エラーの即時確認は可能） |
| 推奨ユースケース | **本番環境・複数UAG** | 初回検証・単体テスト |

> **Reference Architecture決定**: PowerShell方式が採用された。理由: 手動入力エラーの排除、アップグレードと追加アプライアンスの容易さ。

### 1.6 デプロイメントモデル

| モデル | 説明 | ユースケース |
|--------|------|------------|
| Basic | UAGをDMZに配置、LBの背後に配置 | 標準的な外部アクセス |
| Cascade | フロントエンド（DMZ）とバックエンド（内部）の2層UAG | ダブルDMZ環境、DMZからの内部DNS解決不可 |

**Cascade modeの対応サービス**: Horizon, Tunnel, Content Gateway

---

## 2. HA構成の評価

### 2.1 サードパーティロードバランサー

#### Horizonプロトコルの理解（LB設計の前提知識）

Horizonクライアント接続は2段階のプロトコルで構成される:

**Primary Protocol（XML-API）**: TCP 443
- 認証・認可・セッション管理
- LBがラウンドロビン/最少接続でUAGを選択
- Cookie-basedまたはSource IPアフィニティが必要

**Secondary Protocols（表示プロトコル）**:
- Blast: TCP/UDP 8443（またはTCP 443でポート共有）
- PCoIP: TCP/UDP 4172
- HTTPS Tunnel: TCP 443（RDP, CDR, USB等をカプセル化）

**重要**: SecondaryプロトコルはPrimaryと**同じUAGアプライアンス**にルーティングされなければならない。異なるUAGにルーティングされると、認可されずDMZでドロップされ接続失敗する。

#### セッションアフィニティの3つの方式

**方式1: Source IPアフィニティ**

| 項目 | 内容 |
|------|------|
| 原理 | クライアントIPアドレスに基づいて同一UAGにルーティング |
| VIP数 | 1 |
| ポート | 標準ポート使用 |
| 利点 | シンプル、標準ポート、VIP 1つ |
| 欠点 | NATデバイス・プロバイダーによりSource IPが変わる場合は使用不可 |
| 推奨 | Source IPアフィニティが可能な環境すべて |

**UAG設定**（全UAGで同一値）:

| 設定 | UAG01 | UAG02 |
|------|-------|-------|
| tunnelExternalUrl | `https://uag.example.com:443` | `https://uag.example.com:443` |
| blastExternalUrl | `https://uag.example.com:443` | `https://uag.example.com:443` |
| pcoipExternalUrl | `<PublicIP>:4172` | `<PublicIP>:4172` |

**方式2: Multiple Port Number Groups**

| 項目 | 内容 |
|------|------|
| 原理 | UAGごとに固有のポート番号を割り当て、LBが正しいUAGにルーティング |
| VIP数 | 1 |
| ポート | 非標準ポート（例: UAG01=10443/10172, UAG02=10243/10272） |
| 利点 | Source IPアフィニティ不要、VIP 1つ |
| 欠点 | 非標準ポート使用（クライアント環境のファイアウォール考慮必要） |

**UAG設定**（UAGごとに固有値）:

| 設定 | UAG01 | UAG02 |
|------|-------|-------|
| tunnelExternalUrl | `https://uag.example.com:10443` | `https://uag.example.com:10243` |
| blastExternalUrl | `https://uag.example.com:10443` | `https://uag.example.com:10243` |
| pcoipExternalUrl | `<PublicIP>:10172` | `<PublicIP>:10272` |

**方式3: Multiple VIPs**

| 項目 | 内容 |
|------|------|
| 原理 | UAGごとに固有のVIPを割り当て + Primary用の共有VIP |
| VIP数 | n+1（UAG数+1） |
| ポート | 標準ポート |
| 利点 | Source IPアフィニティ不要、標準ポート |
| 欠点 | 追加のパブリックIPが必要（UAGごとに1つ） |

**UAG設定**（UAGごとに固有FQDN/IP）:

| 設定 | UAG01 | UAG02 |
|------|-------|-------|
| tunnelExternalUrl | `https://uag1.example.com:443` | `https://uag2.example.com:443` |
| blastExternalUrl | `https://uag1.example.com:443` | `https://uag2.example.com:443` |
| pcoipExternalUrl | `<UAG01-PublicIP>:4172` | `<UAG02-PublicIP>:4172` |

### 2.2 セッションアフィニティ方式の比較表

| 方式 | Source IP依存 | 標準ポート | VIP数 | UAG HA併用 | 推奨度 |
|------|------------|----------|-------|-----------|--------|
| Method 1: Source IP | **要** | ○ | 1 | - | Source IP可能なら最推奨 |
| Method 2: Port Groups | 不要 | × | 1 | ○ | Source IP不可時 |
| Method 3: Multiple VIPs | 不要 | ○ | n+1 | ○ | パブリックIP確保可能時 |

### 2.3 ヘルスモニタリング

| 項目 | 値 |
|------|-----|
| ヘルスチェックリクエスト | `HTTPS GET /favicon.ico` |
| 期待レスポンス | `HTTP/1.1 200 OK` |
| 推奨ポーリング間隔 | 30秒 |
| 200以外のレスポンス | UAGをダウンとマーク、新規セッションをルーティングしない |

**200 OKの意味**: UAG自体の健全性 + Horizonサービスの健全性 + 背後のConnection Serverの健全性を含む。

**Quiesceモード**: メンテナンス前にUAGをQuiesceモードにすると、LBヘルスチェックに`503`を返す。新規セッションは他のUAGにルーティングされ、既存セッションはユーザー切断またはセッションタイムアウト（デフォルト10時間）まで継続する。ゼロダウンタイムのローリングアップグレードに活用可能。

### 2.4 SSL Offloading / SSL Bridging

| 構成 | 説明 | 注意点 |
|------|------|--------|
| SSL Pass-through | LBはSSLを終端せず、UAGまでSSLを通過 | クライアント証明書認証に必要（L4 TCP LB） |
| SSL Bridging | LBでSSL終端→再暗号化してUAGに転送 | LBとUAGに同一証明書が必要（Tunnel/Blastの証明書検証のため） |
| SSL Offloading | LBでSSL終端のみ | UAG側は非暗号化通信（非推奨） |

> **試験ポイント**: クライアント証明書認証を使用する場合、LBはSSLを終端できない。L4 TCP LB構成が必要。SSL Bridging使用時は、LBとUAGに同じ証明書をインストールする必要がある（MITMを防ぐため）。

### 2.5 UAG Built-in High Availability

サードパーティLBなしで高可用性を実現するUAG内蔵機能。

**特徴**:
- 最大10,000同時接続をサポート
- VIP + Group IDで構成
- vSphere環境のみサポート

**構成パラメータ**:

| パラメータ | 説明 |
|----------|------|
| groupID | クラスターを識別する整数値（同一クラスター内で同一値） |
| virtualIPAddress | 外部NIC（eth0）と同一サブネット上のVIP |

**トラフィック分散アルゴリズム**:

| サービス | セッションアフィニティ | 分散アルゴリズム |
|---------|---------------------|----------------|
| Horizon | Source IPアフィニティ | Round Robin |
| Web Reverse Proxy | Source IPアフィニティ | Round Robin |
| Tunnel (Per-App VPN) | なし | Least Connection |
| Content Gateway | なし | Least Connection |

**HorizonサービスのIP要件**: n+1個のパブリックIPが必要
- 1個: XML-API用のフローティングVIP
- n個: 各UAGのNIC 0 (eth0) IPアドレス（Secondaryプロトコル用）

XML-APIトラフィック（全体の1%未満）はVIP経由でPrimaryノードに到達。残りのトラフィック（表示プロトコル）は、XML-API認証時に割り当てられたUAGに直接接続。

### 2.6 サードパーティLB vs UAG HAの判断フレームワーク

| 判断基準 | サードパーティLB | UAG Built-in HA |
|---------|---------------|----------------|
| 追加ライセンスコスト | あり | なし |
| Active-Active | ○ | ○（Round Robin分散） |
| 高度な負荷分散 | ○ | 限定的（Source IP + RR/LC） |
| Cookie-basedアフィニティ | ○ | × |
| 最大接続数 | LB依存 | 10,000 |
| ヘルスモニタリング | 高度なカスタマイズ可能 | 内蔵（Heartbeat） |
| 構成の複雑さ | 高 | 低 |
| プラットフォーム | 任意 | vSphereのみ |
| 推奨 | 大規模・高機能要件 | 小〜中規模・コスト重視 |

---

## 3. ファイアウォール設定の評価

### 3.1 外部ファイアウォール（インターネット → UAG）

| ポート | プロトコル | 用途 | 必須/任意 |
|--------|-----------|------|----------|
| 443 | TCP | ログイン（XML-API）、HTTPS Tunnel | 必須 |
| 443 | UDP | ログイン（TCP接続困難時のフォールバック）、トンネルトラフィック | 任意 |
| 8443 | TCP | Blast Extreme（データ/パフォーマンスチャネル） | 推奨（Blast使用時） |
| 8443 | UDP | Blast Extreme（Adaptive Transport） | 推奨（Blast使用時） |
| 4172 | TCP | PCoIP Secure Gateway | PCoIP使用時 |
| 4172 | UDP | PCoIP Secure Gateway | PCoIP使用時 |

**Blastポート共有**: TCP 443でBlastデータトラフィックを転送する構成も可能（TCP 8443の代わり）。IPv4/IPv6デュアルモードではTCP 443の使用が必須。

### 3.2 内部ファイアウォール（UAG → 内部）

| 通信先 | ポート | プロトコル | 用途 |
|--------|--------|-----------|------|
| Connection Server | TCP 443 | HTTPS | ログイン |
| Horizon Agent | TCP 22443 | TCP | Blast |
| Horizon Agent | UDP 22443 | UDP | Blast |
| Horizon Agent | TCP 4172 | TCP | PCoIP |
| Horizon Agent | UDP 4172 | UDP | PCoIP |
| Horizon Agent | TCP 3389 | TCP | RDP |
| Horizon Agent | TCP 9427 | TCP | CDR, MMR, Teams最適化, プリンタリダイレクト, USB |
| Horizon Agent | TCP 32111 | TCP | USBリダイレクト、時刻同期 |
| RADIUS等 | UDP 5500 | UDP | 2要素認証（構成可能） |

> **試験ポイント**: Blast使用時、CDRとUSBトラフィックはBlastポート（22443）にサイドチャネル化可能。この場合、TCP 9427/32111は不要。

### 3.3 管理アクセス

| 通信先 | ポート | 用途 |
|--------|--------|------|
| UAG Admin Console | TCP 9443 | `https://<UAG>:9443/admin` |

3-NIC構成では管理ポートは管理NICのみで到達可能。2-NIC構成ではバックエンドNIC経由でアクセス。

### 3.4 表示プロトコル別のファイアウォール構成

| プロトコル | 外部→UAG | UAG→Agent | 備考 |
|----------|---------|-----------|------|
| Blast Only | 443, 8443 (TCP/UDP) | 22443 (TCP/UDP) | 最も推奨。UDP 8443でAdaptive Transport |
| PCoIP Only | 443, 4172 (TCP/UDP) | 4172 (TCP/UDP) | レガシー互換 |
| Blast + PCoIP | 443, 8443, 4172 (TCP/UDP) | 22443, 4172 (TCP/UDP) | 両プロトコル対応 |

> **試験ポイント**: 試験では「使用するプロトコルに応じて必要なポートのみを開放する」最小権限の原則が問われる。Blastのみ使用する場合、PCoIPポート（4172）は開放不要。

---

## 4. UAG設定の作成・エクスポートとPowerShellデプロイ準備

### 4.1 INIファイルの構造

INIファイルはセクションベースで構成される。主要セクション:

```ini
[General]
name=uag-01
uagName=uag-01.example.com
adminPasswordExpirationDays=365
allowedHostHeaderValues=horizon.example.com,uag-01.example.com
source=C:\UAG-deploy\euc-unified-access-gateway-<version>_OVF10.ova
target=vi://administrator@vsphere.local:PASSWORD@vcenter.example.com/DC/host/Cluster/
ds=datastore1
diskMode=thin
deploymentOption=twonic
ipMode=STATICV4
ip0=192.168.1.51
netmask0=255.255.255.0
ip1=10.0.1.51
netmask1=255.255.255.0
defaultGateway=192.168.1.1
dns=10.0.1.10 10.0.1.11
netInternet=DMZ-External
netManagementNetwork=DMZ-Internal
netBackendNetwork=DMZ-Internal
honorCipherOrder=true
sessionTimeout=36000000

[HighAvailability]
groupID=1
virtualIPAddress=192.168.1.50

[SSLCert]
pemCerts=C:\Certs\uag-chain.pem
pemPrivKey=C:\Certs\private.key

[SSLCertAdmin]
pemCerts=C:\Certs\uag-chain.pem
pemPrivKey=C:\Certs\private.key

[Horizon]
proxyDestinationUrl=https://cs1.example.com
tunnelExternalUrl=https://horizon.example.com:443
blastExternalUrl=https://horizon.example.com:443
pcoipExternalUrl=<PublicIP>:4172
pcoipDisableLegacyCertificate=true
```

### 4.2 INIファイルの主要パラメータ

| セクション | パラメータ | 説明 |
|-----------|----------|------|
| [General] | deploymentOption | `onenic`, `twonic`, `threenic` |
| [General] | ip0 / netmask0 | 外部NIC（インターネット向け） |
| [General] | ip1 / netmask1 | バックエンド+管理NIC |
| [General] | source | OVAファイルのパス |
| [General] | target | vSphereターゲット（`vi://user@vcenter/DC/host/Cluster/`） |
| [General] | sessionTimeout | セッションタイムアウト（ミリ秒、デフォルト36000000=10時間） |
| [HighAvailability] | groupID | HAクラスター識別子（同一クラスター内で同一値） |
| [HighAvailability] | virtualIPAddress | フローティングVIP（eth0と同一サブネット） |
| [SSLCert] | pemCerts | PEMチェーン証明書のパス |
| [SSLCert] | pemPrivKey | PEM秘密鍵のパス |
| [Horizon] | proxyDestinationUrl | Connection ServerのURL（UAGごとに異なるCSを指定可） |
| [Horizon] | tunnelExternalUrl | HTTPS TunnelのExternal URL |
| [Horizon] | blastExternalUrl | Blast SecureGatewayのExternal URL |
| [Horizon] | pcoipExternalUrl | PCoIPのExternal URL（IPアドレス:ポート形式） |

### 4.3 設定のエクスポート

**管理コンソールからのエクスポート**

1. `https://<UAG>:9443/admin` にアクセス
2. Settings → Export Configuration
3. JSON形式の設定ファイルをダウンロード

**エクスポートした設定の用途**:
- 別のUAGへのインポート（UIデプロイ後のポストデプロイ構成を省力化）
- バックアップ
- 設定の比較・監査

### 4.4 証明書の準備

UAGはPEMまたはPFX形式の証明書をサポートする。

| 証明書タイプ | サポート |
|------------|---------|
| 個別サーバー証明書 | ○ |
| SAN (Subject Alternate Name) | ○ |
| ワイルドカード | ○ |

**証明書ファイル形式**:
- PEM: `pemCerts`（チェーン証明書）+ `pemPrivKey`（秘密鍵）
- PFX: `pfxCerts`（PFXファイル）+ `pfxCertPassword`（パスワード）

> **試験ポイント**: 本番環境ではデフォルトの自己署名証明書をCA署名証明書に置き換える必要がある。証明書の置き換えはデプロイ時（INIファイル内）または初期構成時に実行可能。

### 4.5 複数UAGの一括デプロイワークフロー

1. **ベースINIファイルを作成**（共通設定）
2. **UAGごとのINIファイルを複製・修正**:
   - `name`, `uagName`: UAG識別名
   - `ip0`, `ip1`: NIC IPアドレス
   - `proxyDestinationUrl`: ターゲットConnection Server
   - `ds`: データストア（分散配置用）
3. **各INIファイルでデプロイスクリプトを実行**:
   ```
   .\uagdeploy.ps1 .\uag-01.ini [rootPW] [adminPW] false false yes
   .\uagdeploy.ps1 .\uag-02.ini [rootPW] [adminPW] false false yes
   ```
4. **管理コンソールでHA状態を確認**: Primary/Backupの割り当て
5. **LBヘルスチェックを確認**: `/favicon.ico` → 200 OK

### 4.6 アップグレード手順

PowerShellスクリプトによるアップグレードは、同一INIファイルで新しいOVAバージョンを指定して再デプロイすることで実行する。Quiesceモードを活用したローリングアップグレードでゼロダウンタイムを実現。

1. UAG-02をQuiesceモードに設定（LBが503を検出、新規セッションをUAG-01に誘導）
2. 既存セッションの終了を待つ（またはセッションタイムアウト）
3. UAG-02をシャットダウン・削除
4. 新しいOVAバージョンでUAG-02を再デプロイ
5. UAG-02の稼働を確認
6. UAG-01に同じ手順を繰り返す

---

## 5. ベストプラクティスとアンチパターン

### ベストプラクティス

| 領域 | ベストプラクティス |
|------|-------------------|
| NIC構成 | 本番環境では2-NICまたは3-NIC構成 |
| デプロイ方法 | PowerShellスクリプト + INIファイル |
| HA | n+1構成。LBまたはBuilt-in HA |
| UAG-CS接続 | UAGとCS間にLBを配置しない（推奨アーキテクチャ） |
| 証明書 | CA署名証明書を使用。SSL Bridging時はLBと同一証明書 |
| ファイアウォール | 使用プロトコルに応じた最小ポートのみ開放 |
| アップグレード | Quiesceモードを活用したローリングアップグレード |
| 設定管理 | INIファイルをバージョン管理（Git等） |
| サービス分離 | 大規模環境ではHorizonとWS1 UEMサービスを別UAGセットに分離 |

### アンチパターン

| アンチパターン | 正しい設計 |
|---------------|----------|
| 本番でSingle-NIC | 2-NIC以上を使用 |
| 本番でUIデプロイのみ | PowerShellスクリプトで一貫したデプロイ |
| SecondaryプロトコルのLBミスルーティング | セッションアフィニティの3方式から適切なものを選択 |
| 自己署名証明書のまま運用 | CA署名証明書に置換 |
| クライアント証明書認証時のSSL Bridging | L4 TCP LB構成を使用 |
| SSL Bridging時にLBとUAGで異なる証明書 | 同一証明書をインストール |

---

## 6. TLS/SSLプロトコル設定

| バージョン | UAG設定 |
|----------|---------|
| SSL | 無効（デフォルト） |
| TLS 1.0 | 無効（デフォルト） |
| TLS 1.1 | 無効（UAG 3.10以降のBlast 8443） |
| TLS 1.2 | **有効** |
| TLS 1.3 | **有効** |

セキュリティプロトコルと暗号スイートはサービスごとに構成可能。管理コンソールまたはREST APIで変更。

> ポート8443および4172で動作するBlast/PCoIPの暗号スイート更新は、ポート443上で動作していない場合はサポートされない。

**Blastポート8443のTLS 1.1サポート変更**:
- UAG 3.9以前: Blast (8443) は TLS 1.1 と TLS 1.2 の両方を有効
- UAG 3.10以降: Blast (8443) は TLS 1.1 を無効化し、TLS 1.2 のみサポート

---

## 理解度チェックリスト

### デプロイ方法の評価
- [ ] Single-NIC / Two-NIC / Three-NICの違いとセキュリティ上の利点を説明できる
- [ ] PowerShell vs UIデプロイの判断基準を説明できる
- [ ] INIファイルの主要セクション（General, HighAvailability, SSLCert, Horizon）の役割を把握している
- [ ] UAGのサイジング（Standard: 2,000, Large: WS1用, Extra Large: 4,000）を区別できる

### HA構成の評価
- [ ] Horizonの Primary / Secondary プロトコルの区別と、同一UAGルーティングの必要性を説明できる
- [ ] セッションアフィニティの3方式（Source IP, Port Groups, Multiple VIPs）を比較評価できる
- [ ] 各方式のUAG External URL設定の違いを把握している
- [ ] ヘルスチェック（`/favicon.ico` → 200 OK, 30秒間隔）を説明できる
- [ ] Quiesceモード（503返答）によるローリングアップグレード手順を説明できる
- [ ] UAG Built-in HAの構成（VIP + GroupID）とアルゴリズム（Horizon: Source IP + RR）を把握している
- [ ] サードパーティLBとUAG HAの判断基準を説明できる
- [ ] SSL Bridging時の証明書一致要件と、クライアント証明書認証時のL4 LB要件を把握している

### ファイアウォール設定
- [ ] 外部FW（443, 8443, 4172）と内部FW（443, 22443, 4172, 3389, 9427, 32111）のポートを列挙できる
- [ ] 使用プロトコルに応じた最小ポート構成を選択できる
- [ ] Blastサイドチャネル化によるポート削減を説明できる

### 設定エクスポート・デプロイ準備
- [ ] INIファイルを作成し、複数UAGに展開する手順を説明できる
- [ ] 設定のエクスポート方法（管理コンソール → Export Configuration）を把握している
- [ ] 証明書の準備（PEM/PFX）と本番環境での要件を説明できる
