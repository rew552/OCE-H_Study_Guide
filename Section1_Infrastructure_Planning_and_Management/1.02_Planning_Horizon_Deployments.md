# 1.2 Planning Horizon Deployments

## 試験ガイド対応 (Section 4.1.2)

- Identify which components are required for a specific Horizon deployment
- Size the number of management components, depending on CCU and HA-/DR-request

---

## 1. Horizon展開に必要なコンポーネントの特定

### 1.1 コアコンポーネント（すべての展開で必須）

| コンポーネント | 役割 | 必須/任意 |
|-------------|------|----------|
| Horizon Connection Server | ユーザー認証・ブローカリング・管理コンソール | 必須 |
| Horizon Agent | VDI/RDSHにインストール。プロトコルセッション確立 | 必須 |
| Horizon Client | エンドユーザーが接続するクライアント（またはブラウザ） | 必須 |
| Hypervisor Manager (vCenter / Prism Central) | VMライフサイクル管理・プロビジョニング | 必須 |
| Hypervisor Hosts (ESXi / AHV) | VM実行基盤 | 必須 |
| Active Directory | ユーザー認証・ポリシー適用 | 必須 |
| Events Database | イベント記録（SQL Server / PostgreSQL / Oracle） | 必須（外部DB） |

### 1.2 コンポーネント選択の判断フレームワーク

要件に基づいて追加コンポーネントを決定する。試験では「特定のシナリオでどのコンポーネントが必要か」を問われる。

| 要件 | 必要なコンポーネント | 判断基準 |
|------|-------------------|---------|
| 外部アクセス（リモートワーク） | Unified Access Gateway (UAG) | インターネット経由の接続が必要な場合 |
| True SSO（SAML認証からのSSO） | Enrollment Server + Microsoft CA | AD資格情報以外の認証でSSOが必要な場合 |
| IDプロバイダー統合・条件付きアクセス | Omnissa Access + Access Connector | SSO・MFA・条件付きアクセスが必要な場合 |
| アプリケーション動的配信 | App Volumes Manager | アプリの即時配信・更新が必要な場合 |
| プロファイル・環境管理 | Dynamic Environment Manager (DEM) | ユーザー設定の永続化・環境制御が必要な場合 |
| セッション記録 | Recording Server | コンプライアンス要件でセッション記録が必要な場合 |
| 複数サイト統合 | Cloud Pod Architecture (CPA) | 複数Podのグローバルエンタイトルメントが必要な場合 |
| クラウドサービス・サブスクリプションライセンス | Horizon Edge Gateway Appliance | Horizon Cloudサービスへの接続が必要な場合 |
| 分析・レポート | Workspace ONE Intelligence + ETL Connector | 集約的な可視化・分析が必要な場合 |

### 1.3 シナリオ別コンポーネント構成例

#### シナリオA: 社内のみ・基本VDI

| コンポーネント | 台数 |
|-------------|------|
| Connection Server | 2（n+1） |
| vCenter Server | 1 |
| Events Database | 1 |

#### シナリオB: 外部アクセスあり・True SSO・App Volumes

| コンポーネント | 台数 |
|-------------|------|
| Connection Server | 3 |
| UAG | 4-6 |
| Enrollment Server | 2（n+1） |
| Microsoft CA | 1-2 |
| Omnissa Access | 1+ |
| Access Connector | 1+ |
| App Volumes Manager | 2（HA） |
| vCenter Server | 1-2 |
| Events Database | 1 |

#### シナリオC: マルチサイトDR構成

| コンポーネント | サイト1 | サイト2 |
|-------------|--------|--------|
| Connection Server | 3 | 3 |
| UAG | 4-6 | 4-6 |
| Enrollment Server | 2 | 2 |
| CPA | ○ | ○ |
| vCenter Server | 1-2 | 1-2 |
| GSLB | ○ | ○ |

> **試験ポイント**: 問題文の要件（外部アクセスの有無、SSOの認証方式、アプリ配信方式、DR要件）から必要なコンポーネントを正確に特定する能力が問われる。「必要ない」コンポーネントを選択肢から除外する判断も重要。

---

## 2. CCUとHA/DR要件に基づく管理コンポーネントのサイジング

### 2.1 Connection Serverのサイジング

**基本計算**

| パラメータ | 値 |
|----------|-----|
| 1台あたりの最大セッション数 | 4,000（Secure Gateway無効時） |
| トンネル有効時 | 2,000 |
| Pod最大セッション数 | 20,000 |
| Pod最大CS数 | 7 |

**サイジング計算式**:

```
必要CS数 = ceil(CCU / 4,000) + 1 (n+1)
```

| CCU | 計算 | 推奨CS数 | 備考 |
|-----|------|---------|------|
| 1,000 | ceil(1000/4000)+1=2 | 2 | 最小HA構成 |
| 4,000 | ceil(4000/4000)+1=2 | 2 | 最小HA構成 |
| 8,000 | ceil(8000/4000)+1=3 | 3 | Reference Architectureの構成 |
| 12,000 | ceil(12000/4000)+1=4 | 4 | |
| 20,000 | ceil(20000/4000)+1=6 | 6 | Pod最大（7台まで可） |
| 20,000超 | 複数Podに分割 | Pod×n | CPA使用 |

**VMスペック（全サイズ共通）**

| リソース | 値 |
|---------|-----|
| vCPU | 4 |
| vMemory | 12 GB |
| Disk | 100 GB |

### 2.2 Unified Access Gatewayのサイジング

**サイジングオプション**

| サイズ | vCPU | メモリ | 最大Horizonセッション |
|-------|------|--------|-------------------|
| Standard | 2 | 4 GB | 2,000 |
| Large | 4 | 16 GB | WS1 UEMサービス用（50,000セッション/サービス） |
| Extra Large | 8 | 32 GB | 4,000（2412リリース以降） |

**Horizonエッジサービス用のサイジング計算**:

```
必要UAG数 = ceil(外部CCU / 2,000) + 1 (n+1)
```

| 外部CCU | Standard UAG数（n+1） | 備考 |
|---------|---------------------|------|
| 2,000 | 2 | 最小HA構成 |
| 4,000 | 3 | |
| 8,000 | 5 | Reference Architecture構成 |

**UAGとCSの比率**

UAG-CS間にLBを配置しない推奨アーキテクチャでは、CS数を考慮してUAG数を決定する。

Reference Architectureの例:
- 8,000 CCU → CS 3台 → UAG 6台（2:1比率）
- 各UAGが特定のCSを`proxyDestinationUrl`で指定

> **試験ポイント**: UAGのStandard/Large/Extra Largeの違い。Horizonエッジサービスには通常Standardを使用。WS1 UEMサービス（Tunnel, Content Gateway, SEG）にはLargeを使用。

### 2.3 Enrollment Serverのサイジング

| パラメータ | 値 |
|----------|-----|
| 1台のESの処理能力 | 1 Pod全体のリクエスト |
| 1台のCAの証明書生成速度 | 約35証明書/秒 |
| 推奨構成 | 2台/Pod（n+1） |
| ロードバランシング | Round Robin（ADSI Editで設定） |

**VMスペック**

| リソース | 値 |
|---------|-----|
| vCPU | 4 |
| vMemory | 12 GB |
| Disk | 100 GB |

CAのスケーラビリティがボトルネックになるため、高負荷環境では複数CAの構成も検討する。

### 2.4 Omnissa Access Connectorのサイジング

| リソース | 値 |
|---------|-----|
| vCPU | 4 |
| vMemory | 8 GB |
| Disk | 100 GB |

### 2.5 Recording Serverのサイジング

| リソース | 値 |
|---------|-----|
| vCPU | 4（推奨8以上） |
| vMemory | 8 GB（推奨16 GB以上） |
| OS Disk | 50 GB |
| Data Disk | 録画要件に応じてサイジング |
| NIC | 1 Gbps |

Recording Serverには専用のデータベース（SQL Server / PostgreSQL）が必要。録画データはファイル共有（TCP 445）に保存する。

### 2.6 Events Databaseのサイジング

| リソース | 値 |
|---------|-----|
| vCPU | 2 |
| vMemory | 8 GB |
| OS Disk | 50 GB |
| Data Disk | 50 GB |

対応DB: SQL Server, PostgreSQL, Oracle。Podごとに個別のEvents DBを構成する。

### 2.6 App Volumes Managerのサイジング

| リソース | 値 |
|---------|-----|
| vCPU | 2 |
| vMemory | 8 GB |
| Disk | 100 GB |

HA構成には最小2台。Connection ServerへのApp Volumes Manager登録時は、LBのFQDNを使用して全Managerをカバーする。

> **注意**: Reference Architecture（上記表）ではApp Volumes Managerは2 vCPU / 8 GB RAMで検証されているが、App Volumesインストールガイドでは8 vCPU / 10 GB RAMをシステム要件として記載している。本番環境では後者の要件を満たすことを推奨する。

---

## 3. HA（高可用性）要件

### 3.1 HAの基本原則

すべてのコンポーネントで **n+1** 設計を採用する。

| コンポーネント | n+1構成 | 追加のHA手段 |
|-------------|---------|------------|
| Connection Server | 必要台数+1台 | LB + vSphere HA |
| UAG | 必要台数+1台 | LB / UAG Built-in HA |
| Enrollment Server | 2台/Pod | Round Robin + vSphere HA + Anti-Affinity |
| vCenter Server | vSphere HA | vCenter HA (Active/Passive) |
| App Volumes Manager | 2台（HA） | LB |
| Events DB | SQL Always On / PostgreSQL HA | DB固有のHA |

### 3.2 vSphere HAとAnti-Affinityルール

管理コンポーネントVMにはvSphere HAを有効化し、ホスト障害時に自動再起動させる。

**Anti-Affinityルール**: 同一ロールのVMが同一ホストに配置されないように構成。

- Connection Server 1 と 2 → 異なるホスト
- Enrollment Server 1 と 2 → 異なるホスト
- UAG 1 と 2 → 異なるホスト

### 3.3 管理コンポーネントの配置戦略

| 戦略 | 説明 | 推奨環境 |
|------|------|---------|
| 専用管理クラスター | 管理VMを専用ESXiクラスターに配置 | 大規模環境 |
| リソース共有 | 管理VMとデスクトップVMを同一クラスターに配置 | 小規模環境・HCI |

共有配置する場合は、管理VMにリソース優先度（Resource Reservation）を設定し、デスクトップVMの負荷によって管理VMが影響を受けないようにする。

---

## 4. DR（災害復旧）要件

### 4.1 マルチサイトアーキテクチャ

| モデル | 説明 | ユースケース |
|--------|------|------------|
| Active-Passive | プライマリサイトで運用、セカンダリはDR待機 | コスト重視のDR |
| Active-Active | 両サイトで同時運用、障害時に相互バックアップ | ダウンタイム最小化 |

**重要**: Horizon Podはサイトをまたいでストレッチすることはサポートされない。各サイトに独立したPodを配置し、CPAで連携する。

### 4.2 Cloud Pod Architecture (CPA) によるマルチサイト

- 複数PodをFederationに結合
- Global Entitlement（GE）で複数Podのリソースをユーザーに割り当て
- **Scope**設定でセッション配置を制御

| GEスコープ | 動作 |
|-----------|------|
| Any Site | どのサイトでもセッションを配置可能 |
| Within Site | ユーザーのHome Siteのリソースのみ使用 |

**Home Site Override**: DR時に、ダウンサイトのユーザーグループを別サイトにリダイレクト可能。障害サイトのリソースがフェイルオーバー完了後にのみOverrideを設定する。

### 4.3 Global Server Load Balancing (GSLB)

マルチサイト構成では、GSLBを使用してユーザーを最適なサイトにルーティングする。

---

## 5. Pod and Block設計

### 5.1 Pod and Blockの概念

**Pod**: Connection Serverのグループ。最大7台、最大20,000セッション。

**Block**: 1つ以上のリソースクラスターで構成されるリソース単位。各Blockには独自のHypervisor Managerを持つのが一般的。

**スケーリング手順**:
1. リソース容量を追加 → Blockを追加
2. セッション接続能力を追加 → Connection Serverを追加
3. Pod上限（20,000）を超える → 新規Podを追加 + CPAで連携

### 5.2 Hypervisor Managerの考慮事項

Hypervisor Managerは障害ドメインの区切りとなる。

| 考慮事項 | 説明 |
|---------|------|
| 障害ドメイン | 1台のvCenterダウン時に影響を受けるVMの範囲を制限 |
| パフォーマンス | プロビジョニングタスクの同時実行による負荷 |
| Configuration Maximums | 公開最大値まで設計するのではなく、余裕を持った設計 |

> **試験ポイント**: Pod and Block設計は「反復可能でスケーラブルなアプローチ」として出題される。Block追加でリソース拡張、CS追加でセッション能力拡張、Pod追加で20,000超に対応。

---

## 6. サイジング早見表

### 管理コンポーネントのサイジング一覧

| コンポーネント | ~2,000 CCU | ~4,000 CCU | ~8,000 CCU | ~20,000 CCU |
|-------------|-----------|-----------|-----------|------------|
| Connection Server | 2 | 2 | 3 | 6 |
| UAG (Standard) | 2 | 3 | 5 | 11 |
| Enrollment Server | 2 | 2 | 2 | 2 |
| App Volumes Manager | 2 | 2 | 2 | 2 |
| vCenter Server | 1 | 1 | 1-2 | 2-3 |
| Events DB | 1 | 1 | 1 | 1 |

※ すべてn+1を含む。UAGは外部CCU=全CCUと仮定。
※ Recording Serverはコンプライアンス要件がある場合のみ追加。

### VMスペック一覧

| コンポーネント | vCPU | vMemory | Disk |
|-------------|------|---------|------|
| Connection Server | 4 | 12 GB | 100 GB |
| Enrollment Server | 4 | 12 GB | 100 GB |
| Access Connector | 4 | 8 GB | 100 GB |
| App Volumes Manager | 2 | 8 GB | 100 GB |
| Recording Server | 4-8 | 8-16 GB | 50 GB + Data |
| Events DB (SQL Server) | 2 | 8 GB | 50+50 GB |
| UAG (Standard) | 2 | 4 GB | 20 GB |
| UAG (Large) | 4 | 16 GB | 20 GB |
| UAG (Extra Large) | 8 | 32 GB | 20 GB |

---

## 理解度チェックリスト

### コンポーネントの特定
- [ ] 要件（外部アクセス、True SSO、App Volumes等）に基づいて必要なコンポーネントを特定できる
- [ ] 各コンポーネントの役割と、不要な場合の判断基準を説明できる
- [ ] シナリオ（社内のみ、外部あり、マルチサイトDR）ごとの構成例を構築できる

### サイジング
- [ ] Connection Serverのサイジング計算（CCU/4,000 + 1）を実行できる
- [ ] UAGのサイジングオプション（Standard: 2,000, Extra Large: 4,000）を区別できる
- [ ] Enrollment Serverの容量（1台/Pod、CA: ~35 certs/sec）を把握している
- [ ] 各コンポーネントのVMスペック（特にCS: 4vCPU/12GB, ES: 4vCPU/12GB）を把握している

### HA/DR
- [ ] n+1設計原則を各コンポーネントに適用できる
- [ ] Pod and Block設計の概念（スケーリング手順）を説明できる
- [ ] Pod上限（7 CS, 20,000セッション）を把握している
- [ ] CPAのGlobal Entitlement Scope（Any Site vs Within Site）とHome Site Overrideを説明できる
- [ ] マルチサイトモデル（Active-Passive vs Active-Active）の違いを説明できる
- [ ] Stretched Podが非サポートであることを把握している
