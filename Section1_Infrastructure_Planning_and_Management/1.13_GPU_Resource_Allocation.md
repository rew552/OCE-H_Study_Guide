# 1.13 GPU Resource Allocation

## 試験ガイド対応: Objective 4.1.13

> **Identify the scenario for using each type of Graphic acceleration.**
> **Consider VM density and dependency with GPU acceleration.**

---

## 各タイプのグラフィックアクセラレーションを使用するシナリオの特定

Horizon環境では4種類のグラフィックアクセラレーション方式が利用可能であり、ワークロード要件に応じて適切な方式を選択する必要がある。

### 4つのGPUアクセラレーション方式の比較

| 項目 | vGPU (NVIDIA GRID) | vSGA (Virtual Shared Graphics Acceleration) | vDGA (Virtual Dedicated Graphics Acceleration) | DirectPath I/O |
|---|---|---|---|---|
| **概要** | 物理GPUを複数VMで仮想的に共有（GPUパーティショニング） | ESXiホストのGPUをAPIレベルで共有（ソフトウェア共有） | 物理GPUをVMに専用割り当て（vSphere経由） | 物理GPUをVMにパススルー（PCIパススルー） |
| **GPU共有** | あり（vGPUプロファイルで制御） | あり（ESXi GPUドライバー経由） | なし（1 GPU : 1 VM） | なし（1 GPU : 1 VM） |
| **パフォーマンス** | 高（プロファイルに依存） | 中（ソフトウェアベースのAPI変換） | 最高 | 最高 |
| **3Dサポート** | DirectX 12, OpenGL 4.6, Vulkan | DirectX 11, OpenGL 4.1 | フルハードウェア機能 | フルハードウェア機能 |
| **GPUベンダー** | NVIDIA（GRID/vGPUライセンス必要） | NVIDIA, AMD, Intel | NVIDIA, AMD | NVIDIA, AMD |
| **VM密度** | 高（プロファイルに依存：2〜32 VM/GPU） | 高（CPU/メモリ依存） | 低（1 VM/GPU） | 低（1 VM/GPU） |
| **vMotion** | サポート（vGPU vMotion） | サポート | 非サポート | 非サポート |
| **HA / DRS** | vGPU vMotionでDRS対応 | サポート | 非サポート | 非サポート |
| **ライセンス** | NVIDIA vGPUライセンス必要 | 不要（ESXi標準機能） | 不要（ハードウェアパススルー） | 不要（ハードウェアパススルー） |
| **推奨ユースケース** | CAD/CAM、3Dデザイン、ビデオ編集、高密度GPU環境 | 基本的な3D/2D、AeroGlass、Windows UI効果 | 最高性能が必要なワークステーション | 最高性能が必要なワークステーション |

### 各方式のアーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                      ESXi Host                          │
│                                                         │
│  ┌──────┐ ┌──────┐ ┌──────┐    ┌──────────────────┐    │
│  │ VM 1 │ │ VM 2 │ │ VM 3 │    │ Physical GPU     │    │
│  │      │ │      │ │      │    │                  │    │
│  └──┬───┘ └──┬───┘ └──┬───┘    │  ┌────┐┌────┐   │    │
│     │        │        │        │  │vGPU││vGPU│   │    │
│     │        │        │        │  │ 1  ││ 2  │   │    │
│     └────────┴────────┘        │  └────┘└────┘   │    │
│              │                 │  ┌────┐┌────┐   │    │
│         vGPU Manager           │  │vGPU││vGPU│   │    │
│              │                 │  │ 3  ││ 4  │   │    │
│              └─────────────────│  └────┘└────┘   │    │
│                                └──────────────────┘    │
│          ▲ vGPU方式の例                                 │
└─────────────────────────────────────────────────────────┘
```

### シナリオ別の推奨方式

| シナリオ | 推奨方式 | 理由 |
|---|---|---|
| **CAD/CAMユーザー（中規模環境）** | vGPU | GPU共有による高密度化とコスト効率 |
| **オフィスワーカー（基本的なGUI効果）** | vSGA または ソフトウェアGPU | 追加ハードウェア不要、最もコスト効率が高い（ただしvSGAはvSphere 8で非推奨） |
| **ハイエンドCAD/シミュレーション** | vDGA / DirectPath I/O | フルGPU性能が必要 |
| **ビデオ編集・レンダリング** | vGPU（大容量プロファイル） | 十分なVRAMと高い3D性能 |
| **AIワークロード / GPU Computing** | DirectPath I/O | CUDA/OpenCLのフルサポート |
| **多数のナレッジワーカー** | ソフトウェアGPU (no GPU) | GPU不要、VM密度を最大化 |
| **Windows 11 デスクトップ** | vGPU 推奨 | Windows 11はGPU性能を活用するUI |

### 判断フレームワーク: どの方式を選ぶか

```
3Dアプリケーションが必要か？
├─ No → ソフトウェアGPU（GPU不使用）で十分
└─ Yes
    ├─ フルGPU性能（CAD最高設定、AI/ML）が必要か？
    │   ├─ Yes → vDGA / DirectPath I/O
    │   └─ No
    │       ├─ GPU共有（複数VMで1GPU）が必要か？
    │       │   ├─ Yes
    │       │   │   ├─ DirectX 12 / Vulkanが必要か？
    │       │   │   │   ├─ Yes → vGPU (NVIDIA GRID)
    │       │   │   │   └─ No  → vSGA（追加ライセンス不要）
    │       │   │   └─ vMotion / HA が必要か？
    │       │   │       ├─ Yes → vGPU（vGPU vMotionサポート）
    │       │   │       └─ No  → vSGA で十分
    │       │   └─ No → vDGA
    │       └─ NVIDIA GPUを保有しているか？
    │           ├─ Yes → vGPU推奨
    │           └─ No  → vSGA
    └─ vMotion / DRS が必要か？
        ├─ Yes → vGPU が唯一の選択肢（3D + vMotion）
        └─ No  → 上記フローに従う
```

---

## GPUアクセラレーションとの依存関係を含むVM密度の考慮

### VM密度への影響

GPUアクセラレーション方式によって、ESXiホストあたりのVM密度は大幅に変動する。

| 方式 | VM密度の決定要因 | 密度範囲（目安） |
|---|---|---|
| **ソフトウェアGPU** | CPU・メモリのみに依存 | 高（50-100+ VM/host） |
| **vSGA** | CPU・メモリ + 共有GPU性能 | 中〜高（30-60 VM/host） |
| **vGPU** | vGPUプロファイルサイズ × 物理GPU数 | 中（プロファイルに依存） |
| **vDGA / DirectPath I/O** | 物理GPU数 = VM数 | 低（GPU数 = VM数） |

### vGPUプロファイルとVM密度の関係

NVIDIA vGPUプロファイルは、プロファイルサイズ（割り当てるVRAM容量）とVM密度がトレードオフの関係にある。

#### NVIDIA vGPUプロファイルの命名規則

```
nvidia_<GPU型番>-<VRAM容量><タイプ>

タイプ:
  Q = Quadro (プロフェッショナルワークロード)
  C = Compute (AI/ML/GPU Computing)
  B = Virtual PC (基本的なグラフィックス)
  A = Virtual Applications (RDS用)
```

#### プロファイルサイズとVM密度の例（NVIDIA A16 GPU — 16GB VRAM）

| プロファイル | VRAM割当 | VM/GPU | 用途 |
|---|---|---|---|
| `nvidia_a16-1b` | 1 GB | 16 | 基本的なデスクトップ（VDI） |
| `nvidia_a16-1q` | 1 GB | 16 | 基本的な3D |
| `nvidia_a16-2q` | 2 GB | 8 | 中程度の3D / CAD |
| `nvidia_a16-4q` | 4 GB | 4 | 高品質3D / CAD |
| `nvidia_a16-8q` | 8 GB | 2 | ハイエンドCAD / ビデオ編集 |
| `nvidia_a16-16q` | 16 GB | 1 | 最高品質（GPUフルパフォーマンス） |

**密度計算式（vGPU）:**

```
VM密度 = ホスト内GPU数 × (GPU VRAM ÷ プロファイルVRAM)

例: サーバに NVIDIA A16 を 2枚搭載、プロファイル nvidia_a16-2q (2GB) の場合
VM密度 = 2 × (16GB ÷ 2GB) = 2 × 8 = 16 VM/host（GPU制約）
```

> **注意**: 実際のVM密度はGPU制約だけでなく、CPU・メモリ制約も考慮する必要がある。最終的なVM密度は**GPU・CPU・メモリの3つの制約のうち最も厳しいもの**で決まる。

### VM密度の総合計算

```
VM密度(GPU) = ホスト内GPU数 × (GPU VRAM ÷ プロファイルVRAM)
VM密度(CPU) = ホストvCPU数 ÷ VMあたりのvCPU数
VM密度(MEM) = ホストメモリ(使用可能) ÷ VMあたりのメモリ

最終VM密度 = MIN(VM密度(GPU), VM密度(CPU), VM密度(MEM))
```

**計算例:**

| リソース | ホストスペック | VMあたり | VM密度 |
|---|---|---|---|
| GPU | NVIDIA A16 × 2 (32GB VRAM計) | 2GB (nvidia_a16-2q) | 16 |
| CPU | 64 vCPU (2ソケット × 32コア) | 2 vCPU | 32 |
| メモリ | 512 GB (ESXiオーバーヘッド除外: 480 GB使用可能) | 8 GB | 60 |
| **最終** | — | — | **16 VM/host（GPUがボトルネック）** |

### コスト・密度・パフォーマンスの比較

| 方式 | 初期コスト | ランニングコスト | VM密度 | グラフィックス性能 |
|---|---|---|---|---|
| ソフトウェアGPU | 低 | 低 | 最高 | 低 |
| vSGA | 中（GPU HW） | 低（ライセンス不要） | 高 | 中 |
| vGPU | 高（GPU HW + ライセンス） | 高（年間ライセンス） | 中 | 高 |
| vDGA / DirectPath I/O | 最高（GPU HW × VM数） | 低（ライセンス不要） | 最低 | 最高 |

### vGPU vMotion と DRS の詳細

NVIDIA vGPU環境でのvMotionは以下の条件で動作する:

| 要件 | 詳細 |
|---|---|
| **同一vGPUプロファイル** | 移行元と移行先のホストで同一のvGPUプロファイルが利用可能であること |
| **同一GPUアーキテクチャ** | 推奨（異なるアーキテクチャ間のvMotionは制限あり） |
| **ドライバーバージョン** | ホスト側のvGPU Managerバージョンが一致すること |
| **DRS対応** | vGPU-aware DRSにより、GPUリソースを考慮した自動配置が可能 |

> **重要**: vGPU vMotionはライブマイグレーション中にGPU状態を転送する。短時間の画面フリーズが発生するが、セッションは維持される。vDGA/DirectPath I/Oではハードウェアパススルーのため、vMotion/HA/DRSは一切使用できない。

### GPUドライバーの管理

| レイヤー | ドライバー | 注意点 |
|---|---|---|
| **ESXiホスト** | NVIDIA vGPU Manager (VIB) | ESXiバージョンとの互換性を確認。`esxcli software vib install` でインストール |
| **ゲストVM** | NVIDIA GRID Guest Driver | vGPUプロファイルに対応するドライバーバージョンを使用 |
| **バージョン一致** | ホストとゲストのドライバーバージョンを揃える | メジャーバージョンの一致が必須。互換性マトリックスを確認 |

---

## ベストプラクティスとアンチパターン

### ベストプラクティス

| # | プラクティス |
|---|---|
| 1 | ワークロード要件を正確に把握してから方式を選択する（過剰なGPU割り当ては密度を低下させる） |
| 2 | vGPUプロファイルは実際のアプリケーション要件に基づいて選択する（テスト環境で検証） |
| 3 | GPU・CPU・メモリの3要素すべてでVM密度を計算し、ボトルネックを特定する |
| 4 | vMotion/HAが必要な場合はvGPUを選択する（vDGA/DirectPathではvMotion不可） |
| 5 | GPUリソースプールを分離する（GPU要件の異なるワークロードは別プール/クラスタに配置） |
| 6 | ESXiホストとゲストVMのGPUドライバーバージョンを揃える |
| 7 | NVIDIA vGPUライセンスの必要性を事前に確認し、予算に含める |

### アンチパターン

| # | アンチパターン | リスク |
|---|---|---|
| 1 | ワークロードの分析なしに最大プロファイル（例: 16Q）を割り当て | VM密度が極端に低下、コスト増大 |
| 2 | GPUドライバーのホスト-ゲスト間バージョン不一致 | GPU機能障害、ブルースクリーン |
| 3 | vMotionが必要な環境でvDGA/DirectPathを選択 | vMotion/HA/DRSが使用不可 |
| 4 | GPU制約のみでVM密度を計算（CPU/メモリを無視） | 実際の密度が想定と異なる |
| 5 | vSGAで高度な3Dアプリケーションを実行 | パフォーマンス不足、ユーザー体験の低下 |
| 6 | NVIDIA vGPUライセンスの計画なし | 予算超過、ライセンス違反 |

---

## 理解度チェックリスト

- [ ] 4つのGPUアクセラレーション方式（vGPU, vSGA, vDGA, DirectPath I/O）の違いを説明できる
- [ ] 各方式を使用すべきシナリオを判断できる（CAD, オフィス, AI/ML, レンダリング等）
- [ ] vGPUプロファイルの命名規則（Q/C/B/Aタイプ）を理解している
- [ ] プロファイルサイズとVM密度のトレードオフを説明できる
- [ ] VM密度の総合計算（GPU・CPU・メモリの3要素の`MIN`）を実行できる
- [ ] vMotion/HA/DRSのサポート状況を方式ごとに説明できる（vGPUのみvMotion対応）
- [ ] GPUドライバーの管理（ホスト側VIB、ゲスト側ドライバー、バージョン一致）を理解している
- [ ] コスト・密度・パフォーマンスの観点で各方式を比較評価できる
