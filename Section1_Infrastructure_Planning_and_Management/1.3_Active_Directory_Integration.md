# 1.3 Active Directory Integration

## 概要

Active Directory（AD）との統合は、Horizon環境の認証とアクセス制御の基盤です。OCE-Hレベルでは、Service Account、グループ、OUの作成、ADMXテンプレートのインポートなど、高度な統合設定が求められます。

## Service Account、グループ、OUの作成

### Service Accountの作成

#### Connection Server用Service Account

**要件**:
- ドメインユーザーアカウント
- パスワードの永続化（パスワードの有効期限なし）
- 適切な権限の付与

**作成手順**:

1. **Active Directoryユーザーとコンピューターでアカウント作成**
   ```
   名前: svc-horizon-conn
   説明: Horizon Connection Server Service Account
   パスワード: 強力なパスワード
   パスワードの有効期限なし: チェック
   ```

2. **パスワードの永続化設定**
   ```powershell
   # PowerShellでパスワードの永続化を設定
   Set-ADUser -Identity "svc-horizon-conn" -PasswordNeverExpires $true
   ```

3. **必要な権限の付与**
   - ドメイン内のコンピューターアカウントの読み取り権限
   - 組織単位（OU）への書き込み権限（必要に応じて）

> [!IMPORTANT]
> Service Accountのパスワードは定期的に変更する必要がありますが、パスワードの有効期限を無効にすることで、予期しない認証エラーを防ぎます。

#### App Volumes Manager用Service Account

**要件**:
- ドメインユーザーアカウント
- パスワードの永続化
- ストレージへのアクセス権限

**作成手順**:
1. Active Directoryユーザーとコンピューターでアカウント作成
2. パスワードの永続化設定
3. ストレージ共有へのアクセス権限の付与

#### DEM用Service Account

**要件**:
- ドメインユーザーアカウント
- パスワードの永続化
- ファイル共有へのアクセス権限

**作成手順**:
1. Active Directoryユーザーとコンピューターでアカウント作成
2. パスワードの永続化設定
3. DEMファイル共有へのアクセス権限の付与

### グループの作成

#### Horizon管理者グループ

**作成手順**:

1. **Active Directoryユーザーとコンピューターでグループ作成**
   ```
   グループ名: Horizon-Admins
   グループスコープ: グローバル
   グループの種類: セキュリティ
   ```

2. **メンバーの追加**
   - Horizon環境を管理する管理者アカウントを追加

3. **Horizon Consoleでの権限付与**
   - Horizon Console → View Configuration → Administrators
   - 作成したグループを追加
   - 適切なロールを割り当て（Administrator、Read-Only Administratorなど）

#### デスクトッププール用グループ

**作成手順**:

1. **プールごとにグループを作成**
   ```
   グループ名: Horizon-Pool-Desktop-Users
   グループスコープ: グローバル
   グループの種類: セキュリティ
   ```

2. **ユーザーの追加**
   - 該当プールにアクセスするユーザーを追加

3. **エンタイトルメントの設定**
   - Horizon Console → Inventory → Desktop Pools
   - プールを選択 → Entitlements
   - 作成したグループを追加

> [!TIP]
> グループベースの管理を推奨します。個別ユーザーへのエンタイトルメントよりも、管理が容易でスケーラブルです。

#### RDSHファーム用グループ

**作成手順**:

1. **ファームごとにグループを作成**
   ```
   グループ名: Horizon-Farm-RDSH-Users
   グループスコープ: グローバル
   グループの種類: セキュリティ
   ```

2. **ユーザーの追加**
   - 該当ファームにアクセスするユーザーを追加

3. **エンタイトルメントの設定**
   - Horizon Console → Inventory → Farms
   - ファームを選択 → Entitlements
   - 作成したグループを追加

### 組織単位（OU）の作成

#### Horizon用OU構造の設計

**推奨OU構造**:

```
OU=Horizon
  ├── OU=Computers
  │   ├── OU=Connection Servers
  │   ├── OU=UAG
  │   ├── OU=Virtual Desktops
  │   └── OU=RDSH Hosts
  ├── OU=Users
  │   ├── OU=Service Accounts
  │   └── OU=Horizon Users
  └── OU=Groups
      ├── OU=Administrators
      └── OU=End Users
```

**作成手順**:

1. **Active DirectoryユーザーとコンピューターでOU作成**
   ```
   OU名: Horizon
   説明: Horizon環境用OU
   ```

2. **サブOUの作成**
   - Computers OU
   - Users OU
   - Groups OU

3. **コンピューターアカウントの移動**
   - Connection Server、UAG、仮想デスクトップ、RDSHホストを適切なOUに移動

> [!IMPORTANT]
> OU構造は、GPO（Group Policy Object）の適用と管理を容易にします。適切なOU構造を設計することで、ポリシーの適用と管理が効率化されます。

#### GPO適用のためのOU設計

**OU設計の考慮事項**:
- コンピュータータイプごとにOUを分離
- ユーザータイプごとにOUを分離
- GPOの適用範囲を明確にする

**推奨構成**:
- Connection Server用OU: Connection Server専用のGPOを適用
- 仮想デスクトップ用OU: デスクトップ用のGPOを適用
- RDSHホスト用OU: RDSHホスト用のGPOを適用

## Horizon用ADMXテンプレートのインポート

### ADMXテンプレートの概要

Horizon用ADMXテンプレートは、Group Policyを使用してHorizon設定を管理するために使用されます。

**利用可能なADMXテンプレート**:
- Horizon Client設定
- Horizon Agent設定
- 表示プロトコル設定
- セキュリティ設定

### ADMXテンプレートのインポート手順

#### ステップ1: ADMXテンプレートファイルの取得

1. **Horizonインストールメディアから取得**
   - `VMware-Horizon-Connection-Server-x.x.x-xxxxx.exe`を展開
   - `ADMX Templates`フォルダを探す

2. **または、Horizon Consoleからダウンロード**
   - Horizon Console → View Configuration → Group Policy Management
   - ADMXテンプレートのダウンロードリンク

#### ステップ2: 中央ストアへのコピー

**中央ストアの場所**:
```
\\<ドメイン名>\SYSVOL\<ドメイン名>\Policies\PolicyDefinitions
```

**コピー手順**:

1. **中央ストアフォルダへのアクセス**
   - ドメインコントローラーまたは管理ワークステーションからアクセス

2. **ADMXファイルのコピー**
   ```
   コピー元: <Horizonインストールメディア>\ADMX Templates\*.admx
   コピー先: \\<ドメイン名>\SYSVOL\<ドメイン名>\Policies\PolicyDefinitions\
   ```

3. **ADMLファイルのコピー（言語ファイル）**
   ```
   コピー元: <Horizonインストールメディア>\ADMX Templates\<言語>\*.adml
   コピー先: \\<ドメイン名>\SYSVOL\<ドメイン名>\Policies\PolicyDefinitions\<言語>\
   ```

> [!NOTE]
> ADMLファイルは、ADMXテンプレートの言語リソースです。日本語環境の場合は、`ja-JP`フォルダ内のADMLファイルをコピーします。

#### ステップ3: Group Policy Management Consoleでの確認

1. **Group Policy Management Consoleを開く**
   - `gpmc.msc`を実行

2. **ADMXテンプレートの確認**
   - 任意のGPOを編集
   - Computer ConfigurationまたはUser Configuration
   - Policies → Administrative Templates
   - VMwareフォルダを確認

3. **利用可能なポリシーの確認**
   - Horizon Client設定
   - Horizon Agent設定
   - 表示プロトコル設定

### ADMXテンプレートの使用例

#### Horizon Client設定のGPO適用

**設定手順**:

1. **GPOの作成**
   ```
   GPO名: Horizon Client Settings
   リンク先: Horizon Users OU
   ```

2. **User Configurationの設定**
   - Policies → Administrative Templates → VMware → VMware Horizon Client
   - 必要な設定を有効化
     - 自動接続設定
     - セキュリティ設定
     - 表示プロトコル設定

3. **GPOの適用**
   - 対象OUにリンク
   - 必要に応じてセキュリティフィルタリングを設定

#### Horizon Agent設定のGPO適用

**設定手順**:

1. **GPOの作成**
   ```
   GPO名: Horizon Agent Settings
   リンク先: Virtual Desktops OU
   ```

2. **Computer Configurationの設定**
   - Policies → Administrative Templates → VMware → VMware Horizon Agent
   - 必要な設定を有効化
     - セッション設定
     - セキュリティ設定
     - パフォーマンス設定

3. **GPOの適用**
   - 対象OUにリンク
   - 仮想デスクトップを対象OUに移動

> [!TIP]
> ADMXテンプレートを使用することで、Horizon設定を一元管理できます。個別の設定変更よりも、一貫性と管理性が向上します。

## ベストプラクティス

1. **Service Account管理**
   - 強力なパスワードを使用
   - パスワードの永続化を設定
   - 定期的なパスワード変更（手動）
   - 最小権限の原則を適用

2. **グループ管理**
   - グループベースの管理を推奨
   - 明確な命名規則を使用
   - 定期的なメンバーシップの確認

3. **OU設計**
   - 論理的な階層構造を設計
   - GPO適用を考慮した構造
   - 管理しやすい構造

4. **ADMXテンプレート**
   - 中央ストアを使用
   - 定期的なテンプレートの更新
   - テスト環境での検証

> [!CAUTION]
> ADMXテンプレートの適用は、すべての対象コンピューターに影響を与える可能性があります。本番環境で適用する前に、テスト環境で十分に検証してください。

## 複数ドメイン環境での統合

### 信頼関係の設定

**一方向の信頼関係**:
- 信頼するドメイン（Trusting Domain）
- 信頼されるドメイン（Trusted Domain）

**双方向の信頼関係**:
- 両方のドメインが相互に信頼

**信頼関係の作成手順**:

1. **Active Directoryドメインと信頼関係で設定**
   - ドメインコントローラーで「Active Directoryドメインと信頼関係」を開く
   - ドメインを右クリック → プロパティ → 信頼タブ
   - 「新しい信頼」をクリック

2. **信頼関係の種類を選択**
   - 外部の信頼
   - フォレストの信頼

3. **信頼の方向を選択**
   - 一方向: 受信
   - 一方向: 送信
   - 双方向

**PowerShellでの信頼関係の確認**:
```powershell
# 信頼関係の確認
Get-ADTrust -Filter *

# 特定のドメインとの信頼関係の確認
Get-ADTrust -Identity "contoso.com"
```

### クロスフォレスト認証

**フォレスト間の信頼関係**:

**設定手順**:

1. **フォレスト間の信頼関係の作成**
   - 各フォレストのルートドメインで信頼関係を作成
   - フォレスト全体の信頼を確立

2. **Horizon Consoleでの設定**
   - View Configuration → Servers → Connection Server
   - Edit → Authentication → LDAP Settings
   - 追加のLDAPインスタンスを追加

**クロスフォレスト認証の設定**:

**LDAPインスタンスの追加**:
```
Horizon Console → View Configuration → Servers → Connection Server
→ Edit → Authentication → LDAP Settings → Add LDAP Instance

LDAP Server: ldap://forest2.contoso.com:389
Base DN: DC=forest2,DC=contoso,DC=com
Bind User: CN=svc-horizon,OU=Service Accounts,DC=forest2,DC=contoso,DC=com
Bind Password: [パスワード]
```

**認証の優先順位**:
- プライマリLDAPインスタンス: 最初に検索
- セカンダリLDAPインスタンス: プライマリで見つからない場合に検索

> [!IMPORTANT]
> クロスフォレスト認証を使用する場合、両方のフォレストで適切なService Accountを作成し、必要な権限を付与する必要があります。

### ADサイトとサービスの最適化

**ADサイトの設計**:

**サイトの作成**:
- 地理的に近いドメインコントローラーを同じサイトに配置
- ネットワーク帯域幅を考慮

**サイトリンクの設定**:
- サイト間のレプリケーションスケジュール
- レプリケーションコストの設定

**Horizon環境での最適化**:

**最寄りのドメインコントローラーの使用**:
```powershell
# 最寄りのドメインコントローラーの確認
Get-ADDomainController -Discover -Service PrimaryDC

# 特定のサイトのドメインコントローラーを指定
$dc = Get-ADDomainController -SiteName "Tokyo" -Service PrimaryDC
```

**Connection Serverでの設定**:
- View Configuration → Servers → Connection Server
- Edit → Authentication → LDAP Settings
- 最寄りのドメインコントローラーを指定

**レプリケーションの最適化**:
- サイト間のレプリケーションスケジュールを調整
- ピーク時間帯を避ける
- レプリケーションコストを最適化

### グループポリシーの適用順序と競合解決

**GPOの適用順序**:

**優先順位（高い順）**:
1. **ローカルGPO**: コンピューターのローカルポリシー
2. **サイトGPO**: サイトにリンクされたGPO
3. **ドメインGPO**: ドメインにリンクされたGPO
4. **OU GPO**: OUにリンクされたGPO（親OUから子OUへ）

**リンク順序**:
- 同じレベルで複数のGPOがリンクされている場合、リンク順序が低い（数値が小さい）ほど優先

**競合の解決**:

**競合が発生した場合**:
- より具体的なレベル（OU）のGPOが優先
- リンク順序が低いGPOが優先
- 明示的に設定された値が優先（未設定は継承）

**GPOの適用結果の確認**:
```powershell
# GPOの適用結果を確認
gpresult /r /scope Computer
gpresult /r /scope User

# 詳細なレポートを生成
gpresult /h "C:\GPOReport.html" /f
```

**GPOの強制適用**:
- GPOの「強制」オプションを有効化
- 子OUのGPOで上書きできない

**GPOのブロック継承**:
- OUの「ブロック継承」オプションを有効化
- 親OUのGPOを継承しない

> [!WARNING]
> GPOの強制適用とブロック継承は、慎重に使用してください。予期しない動作を引き起こす可能性があります。

## ベストプラクティス

1. **Service Account管理**
   - 強力なパスワードを使用
   - パスワードの永続化を設定
   - 定期的なパスワード変更（手動）
   - 最小権限の原則を適用

2. **グループ管理**
   - グループベースの管理を推奨
   - 明確な命名規則を使用
   - 定期的なメンバーシップの確認

3. **OU設計**
   - 論理的な階層構造を設計
   - GPO適用を考慮した構造
   - 管理しやすい構造

4. **ADMXテンプレート**
   - 中央ストアを使用
   - 定期的なテンプレートの更新
   - テスト環境での検証

5. **複数ドメイン環境**
   - 信頼関係の適切な設定
   - クロスフォレスト認証のテスト
   - ADサイトの最適化

6. **GPO管理**
   - 明確な適用順序の設計
   - 競合の回避
   - 定期的なレビュー

> [!CAUTION]
> ADMXテンプレートの適用は、すべての対象コンピューターに影響を与える可能性があります。本番環境で適用する前に、テスト環境で十分に検証してください。

## 理解度チェックリスト

以下の項目について理解度を確認してください：

### Service Account、グループ、OU
- [ ] Connection Server用Service Accountの作成手順を理解している
- [ ] App Volumes Manager用Service Accountの作成手順を理解している
- [ ] DEM用Service Accountの作成手順を理解している
- [ ] Horizon管理者グループの作成と権限付与を説明できる
- [ ] デスクトッププール用グループの作成とエンタイトルメント設定を理解している
- [ ] OU構造の設計と作成手順を説明できる

### ADMXテンプレート
- [ ] Horizon用ADMXテンプレートのインポート手順を理解している
- [ ] 中央ストアへのコピー方法を説明できる
- [ ] ADMXテンプレートの使用方法を理解している

### 複数ドメイン環境
- [ ] 信頼関係の設定方法を説明できる
- [ ] クロスフォレスト認証の設定方法を理解している
- [ ] ADサイトとサービスの最適化方法を説明できる

### GPO
- [ ] GPOの適用順序を理解している
- [ ] GPOの競合解決方法を説明できる
- [ ] GPOの強制適用とブロック継承の違いを理解している

## まとめ

Active Directoryとの適切な統合は、Horizon環境のセキュリティと管理性を向上させます。Service Account、グループ、OUの適切な設計と作成、ADMXテンプレートのインポートと使用、複数ドメイン環境での統合、ADサイトとサービスの最適化、GPOの適用順序と競合解決により、効率的でセキュアなHorizon環境を構築できます。
