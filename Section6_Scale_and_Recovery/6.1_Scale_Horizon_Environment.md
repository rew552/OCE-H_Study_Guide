# 6.1 Scale Horizon Environment

## 概要

Horizon環境のスケーリングは、成長するユーザー数とリソース要件に対応するために重要です。OCE-Hレベルでは、Horizonインフラストラクチャ（CS、App Volumes、DEM）のスケーリング分析と評価、容量計画、パフォーマンス監視が求められます。

## 学習目標

このセクションを学習することで、以下のことができるようになります：

- Connection Server、App Volumes、DEMのスケーリング分析と評価ができる
- 容量計画の方法を理解している
- パフォーマンス監視の方法を説明できる
- スケーリング戦略を策定できる

## 関連リソース

- [クイックリファレンス](../../00_Quick_Reference.md) - ポート番号、設定値、制限値
- [用語集](../../README.md#用語集) - 関連用語の定義
- [1.2 Planning Horizon Deployments](../../Section1_Infrastructure_Planning_and_Management/1.2_Planning_Horizon_Deployments.md) - デプロイメント計画
- [3.3 Pool Capacity Planning](../../Section3_Monitoring_Optimization/3.3_Pool_Capacity_Planning.md) - 容量計画
- [実環境シナリオ](../../00_Scenarios/Section6_Scenarios.md) - 実環境でのシナリオ例

## スケーリング戦略

### 水平スケーリング（スケールアウト）

**概要**:
- 追加のコンポーネントをインストール
- 負荷を分散
- 高可用性の向上

**適用コンポーネント**:
- Connection Server
- UAG
- App Volumes Manager

### 垂直スケーリング（スケールアップ）

**概要**:
- 既存コンポーネントのリソースを増加
- CPU、メモリ、ストレージの追加

**適用コンポーネント**:
- vCenter Server
- データベースサーバー
- ファイルサーバー

## Connection Serverのスケーリング

### スケーリング要因の分析

**主要な要因**:
1. **CCU数の増加**
   - 現在のCCU数
   - 予測されるCCU数
   - ピーク時のCCU数

2. **セッション数の増加**
   - アクティブセッション数
   - 同時接続数
   - セッションあたりのリソース使用量

3. **パフォーマンス要件**
   - 応答時間の要件
   - スループット要件
   - 可用性要件

### 容量計算

**計算式**:
```
必要なConnection Server数 = (CCU数 / 2,000) + 1（高可用性用）
```

**例**:
- CCU数: 5,000
- 必要なConnection Server数: (5,000 / 2,000) + 1 = 3.5 → 4台

### スケーリング手順

**追加Connection Serverのインストール**:

1. **前提条件の確認**
   - 既存Connection Serverのバージョン確認
   - データベースの容量確認
   - ネットワーク帯域幅の確認

2. **Replica Serverのインストール**
   - インストールタイプで「Replica」を選択
   - 既存Connection ServerのFQDNを指定
   - レプリケーショングループに参加

3. **ロードバランサーの設定**
   - 新しいConnection Serverをプールに追加
   - ヘルスチェックの設定
   - セッションアフィニティの設定

4. **検証**
   - 接続テスト
   - パフォーマンステスト
   - ログの確認

**詳細なスケーリング計算式**:

**CPU容量の計算**:
```
必要なCPU = (CCU数 × CPU使用率) / (CPUコア数 × CPU利用率)

例:
- CCU数: 5,000
- CPU使用率: 10%
- CPUコア数: 8コア/Connection Server
- CPU利用率: 80%
- 必要なCPU = (5,000 × 0.1) / (8 × 0.8) = 78.125コア
- 必要なConnection Server数 = 78.125 / 8 = 9.77 → 10台
```

**メモリ容量の計算**:
```
必要なメモリ = (CCU数 × メモリ使用量) / (メモリ容量 × メモリ利用率)

例:
- CCU数: 5,000
- メモリ使用量: 100MB/セッション
- メモリ容量: 16GB/Connection Server
- メモリ利用率: 90%
- 必要なメモリ = (5,000 × 0.1) / (16 × 0.9) = 34.72GB
- 必要なConnection Server数 = 34.72 / 16 = 2.17 → 3台
```

**総合的な計算**:
```
必要なConnection Server数 = max(CPU容量, メモリ容量) + 1（高可用性用）

例:
- CPU容量: 10台
- メモリ容量: 3台
- 必要なConnection Server数 = max(10, 3) + 1 = 11台
```

## スケーリングの自動化

### 自動スケーリングスクリプト

**PowerShellスクリプト例**:
```powershell
# Connection Serverの自動スケーリングスクリプト
$threshold = 80  # CPU使用率の閾値（%）
$maxServers = 10  # 最大Connection Server数

$currentServers = Get-VM | Where-Object {$_.Name -like "*Connection-Server*"}
$avgCPU = ($currentServers | Get-Stat -Stat "cpu.usage.average" -Realtime | 
    Measure-Object -Property Value -Average).Average

if ($avgCPU -gt $threshold -and $currentServers.Count -lt $maxServers) {
    # 新しいConnection Serverをプロビジョニング
    Write-Host "Scaling out: Adding new Connection Server"
    # プロビジョニングスクリプトを実行
}
```

## スケーリングのコスト分析

### コスト計算

**コスト要因**:
- ハードウェアコスト
- ライセンスコスト
- 運用コスト

**コスト計算式**:
```
総コスト = (ハードウェアコスト + ライセンスコスト) × Connection Server数 + 運用コスト
```

## スケーリングのパフォーマンス影響

### パフォーマンスへの影響

**影響要因**:
- ネットワーク帯域幅
- データベースパフォーマンス
- レプリケーションオーバーヘッド

**最適化方法**:
- ネットワーク帯域幅の確保
- データベースの最適化
- レプリケーションの最適化

:::important
Connection Serverのスケーリングは、データベースの容量とネットワーク帯域幅を考慮する必要があります。
:::

## App Volumesのスケーリング

### スケーリング要因の分析

**主要な要因**:
1. **アプリケーション数の増加**
   - 現在のAppStack数
   - 予測されるAppStack数
   - AppStackサイズ

2. **ユーザー数の増加**
   - 現在のユーザー数
   - 予測されるユーザー数
   - ユーザーあたりのAppStack数

3. **ストレージ要件**
   - 現在のストレージ使用量
   - 予測されるストレージ使用量
   - レプリケーション要件

### 容量計算

**ストレージ計算**:
```
必要なストレージ = (AppStack数 × 平均サイズ) + (Writable Volume数 × 平均サイズ) + オーバーヘッド（20%）
```

**例**:
- AppStack数: 50
- 平均AppStackサイズ: 10GB
- Writable Volume数: 1,000
- 平均Writable Volumeサイズ: 5GB
- 必要なストレージ: (50 × 10) + (1,000 × 5) + オーバーヘッド = 約6TB

### スケーリング手順

**追加App Volumes Managerのインストール**:

1. **前提条件の確認**
   - 既存Managerのバージョン確認
   - データベースの容量確認
   - ストレージの容量確認

2. **追加Managerのインストール**
   - 既存のManagerを指定
   - 登録を実行

3. **負荷分散の設定**
   - ストレージグループの設定
   - 負荷分散の有効化

4. **検証**
   - 接続テスト
   - パフォーマンステスト
   - レプリケーションの確認

:::tip
App Volumes Managerのスケーリングは、データベースとストレージの容量を考慮する必要があります。
:::

## DEMのスケーリング

### スケーリング要因の分析

**主要な要因**:
1. **ユーザー数の増加**
   - 現在のユーザー数
   - 予測されるユーザー数
   - 同時ログオン数

2. **プロファイルサイズの増加**
   - 現在のプロファイルサイズ
   - 予測されるプロファイルサイズ
   - プロファイルの増加率

3. **ファイル共有の容量**
   - 現在の使用量
   - 予測される使用量
   - 可用性要件

### 容量計算

**ファイル共有容量計算**:
```
必要な容量 = (ユーザー数 × 平均プロファイルサイズ) + オーバーヘッド（30%）
```

**例**:
- ユーザー数: 1,000
- 平均プロファイルサイズ: 500MB
- 必要な容量: (1,000 × 0.5GB) + オーバーヘッド = 約650GB

### スケーリング手順

**追加ファイル共有の設定**:

1. **ファイルサーバーの準備**
   - 新しいファイルサーバーの構築
   - 共有フォルダの作成
   - アクセス権限の設定

2. **DEMでの設定**
   - DEM Management Consoleでファイル共有を追加
   - 負荷分散の設定

3. **検証**
   - 接続テスト
   - パフォーマンステスト
   - プロファイルの読み込みテスト

## スケーリング計画

### 計画の要素

1. **現状分析**
   - 現在のリソース使用率
   - パフォーマンスメトリック
   - ボトルネックの特定

2. **成長予測**
   - ユーザー数の成長予測
   - リソース要件の成長予測
   - ピーク使用時間の分析

3. **スケーリング戦略**
   - 水平スケーリング vs 垂直スケーリング
   - 段階的なスケーリング計画
   - コスト分析

### スケーリングタイミング

**スケーリングが必要な指標**:
- CPU使用率が80%以上を継続
- メモリ使用率が90%以上を継続
- 応答時間が目標値を超過
- エラー率の増加

## ベストプラクティス

1. **プロアクティブな計画**
   - 成長予測の考慮
   - リソース要件の評価
   - 定期的な容量レビュー

2. **段階的なスケーリング**
   - 段階的な拡張
   - パフォーマンスの監視
   - 各段階での検証

3. **モニタリング**
   - 定期的なパフォーマンス監視
   - リソース使用率の追跡
   - トレンド分析

:::warning
スケーリングは、パフォーマンスとコストのバランスを考慮して計画する必要があります。過剰なスケーリングは、コストの増加を引き起こします。
:::

## トラブルシューティング

### 一般的な問題

**スケーリング後のパフォーマンス低下**:
- ロードバランサーの設定を確認
- ネットワーク帯域幅を確認
- データベースのパフォーマンスを確認

**リソース不足**:
- リソース使用率を監視
- ボトルネックを特定
- 追加のスケーリングを検討

## 理解度チェックリスト

以下の項目について理解度を確認してください：

### Connection Serverのスケーリング
- [ ] CCUに基づいてConnection Serverをサイジングできる
- [ ] スケーリングの計算方法を理解している
- [ ] スケーリングの影響を評価できる

### App Volumesのスケーリング
- [ ] App Volumes Managerの追加手順を説明できる
- [ ] ストレージ要件の計算方法を理解している
- [ ] レプリケーション要件を考慮できる

### DEMのスケーリング
- [ ] DEMファイル共有の追加方法を説明できる
- [ ] プロファイルサイズの計算方法を理解している
- [ ] 容量計画の方法を説明できる

## まとめ

Horizon環境の適切なスケーリングは、成長する要件に対応するために重要です。Connection Server、App Volumes、DEMのスケーリング分析と評価、容量計画、パフォーマンス監視により、効率的でスケーラブルなHorizon環境を構築できます。
