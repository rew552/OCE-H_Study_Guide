# 6.2 Cloud Pod Architecture (CPA)

## Exam Objective

> **4.6.2. Scale Horizon environment using Cloud Pod Architecture (CPA).**
> - Initializing Cloud Pod Architecture
> - Join a Pod to the Pod Federation in Horizon Console
> - Compare the purpose of the global LDAP instance and the local LDAP instance
> - Add a Pool to a Global Entitlement in Horizon Console
> - Implement Home Site strategy for user location
> - Use the Horizon Console and the lmvutil command to modify and maintain the Cloud Pod Architecture environment

---

## CPA 概要

Cloud Pod Architecture (CPA) は、複数の Horizon Pod をリンクして **Pod Federation** を構成し、デスクトップ・アプリケーションの仲介と管理を単一の大規模環境として行う機能。

### CPA のユースケース

- **マルチサイト展開**: 複数データセンターのリソースを統合管理
- **20,000 セッション超への拡張**: 単一 Pod の上限を超えるスケーリング
- **DR/BC**: サイト障害時に別サイトのリソースにフェイルオーバー
- **Global Entitlement**: 複数 Pod のプールに対する統一資格管理
- **ハイブリッドクラウド**: オンプレミスと VMware Cloud on AWS / Azure VMware Solution / Google Cloud VMware Engine / Oracle Cloud VMware Solution のポッドを CPA で相互接続

### CPA トポロジの制限値

| オブジェクト | 上限値 |
|---|---|
| セッション合計 | **250,000** |
| Pod 数 | **50** |
| Pod あたりのセッション数 | **20,000** |
| Site 数 | **15** |
| Pod あたりの Connection Server 数 | **7** |
| Connection Server インスタンス合計 | **350** |

### CPA ポート要件

| プロトコル | ポート | 用途 |
|---|---|---|
| HTTP | **22389** | Global Data Layer の LDAP レプリケーション |
| HTTPS | **22636** | 安全な Global Data Layer LDAP レプリケーション |
| HTTPS | **8472** | View InterPod API (VIPA) 通信 |

> **セットアップ時の注意**: CPA 初期化中はポート **135** と全エフェメラルポートを開放する必要がある。参加完了後は 135 とエフェメラルポートを閉じ、上記ポートのみ開放。Microsoft Windows Server では、すべての CS インスタンス間で RPC 用の動的ポート範囲も必要。

### CPA の制限事項

- キオスク モード クライアントは CPA 環境ではデフォルトで非サポート（KB2148888 の回避策が必要）
- IPv6 環境は Horizon 2206 では非サポート。**Horizon 2212 以降**で IPv6 サポートが追加
- 信頼されていないドメインは Pod ごとに個別に構成する必要がある

---

## CPA の初期化 (Initializing CPA)

### 前提条件

- ポッド内のすべての Connection Server が同一バージョン
- Pod 間のネットワーク接続とファイアウォールルール確認
- AD ドメインが複数にまたがる場合、**双方向信頼関係**の設定
- 信頼されていないドメインは Pod ごとに個別構成

### Horizon Console での初期化手順

1. Pod 内の Connection Server の Horizon Console にログイン
2. **[設定] > [クラウド ポッド アーキテクチャ]** を選択
3. **[クラウド ポッド アーキテクチャ機能を初期化する]** をクリック → **[OK]**
4. 初期化完了後のデフォルト値：
   - Federation 名: `Horizon Cloud Pod Federation`
   - Pod 名: `Cluster-<CS ホスト名>` （例: `Cluster-CS1`）
   - Site 名: `Default First Site`
5. 必要に応じて Federation 名・Pod 名・Site 名を **[編集]** で変更

### lmvutil での初期化

```powershell
lmvutil --initialize
```

### 初期化時に発生する処理

- Pod 内の各 Connection Server に **Global Data Layer**（グローバル LDAP インスタンス）を構成
- **VIPA (View InterPod API)** 通信チャネルを設定
- 各 Connection Server 間で Replication Agreement を確立
- 管理者にルート Federation Access Group の権限を自動作成

> **重要**: 初期化は Pod Federation 内の最初の Pod で **1 回のみ** 実行する。以降の Pod はフェデレーションに「参加」させる。

---

## Pod Federation へのポッド参加

### Horizon Console での手順

1. **参加する Pod** の Connection Server で Horizon Console にログイン
2. **[設定] > [クラウド ポッド アーキテクチャ]** を選択
3. **[ポッド フェデレーションに参加する]** をクリック
4. 初期化済み（または参加済み）Pod の Connection Server の **ホスト名 / IP アドレス** を入力
5. 初期化済み Pod の Horizon 管理者の **ユーザー名**（`domain\username` 形式）と **パスワード** を入力
6. **[OK]** をクリック

### lmvutil での参加

```powershell
lmvutil --join --joinServer <初期化済みCS のFQDN> --userName <domain\user> --password <password>
```

### 参加時の注意事項

- 参加操作中は Connection Server サービスの停止 / 起動を行わない
- 同名の Connection Server は参加不可（異なるドメインでも同様）
- 参加後、Global Entitlement / Global Session / Federation Access Group がレプリケーションされる

---

## Global LDAP vs Local LDAP の比較

| 項目 | Global LDAP Instance | Local LDAP Instance |
|---|---|---|
| **格納場所** | Pod Federation 内の全 CS にレプリケーション | 各 Pod 内の CS 間でレプリケーション |
| **格納データ** | Global Entitlement、ホーム サイト割り当て、Pod Federation トポロジ情報、CPA ポリシー | Pool 定義、ローカル Entitlement、CS 設定、vCenter 登録情報 |
| **レプリケーション範囲** | **フェデレーション全体**（全 Pod の全 CS） | **Pod 内のみ**（同一 Pod の CS 間） |
| **レプリケーションポート** | TCP 22389 (LDAP) / 22636 (LDAPS) | TCP 389 (LDAP) / 636 (LDAPS) |
| **作成タイミング** | CPA 初期化時に自動構成 | Connection Server インストール時に自動構成 |
| **用途** | Pod 間でのグローバルな資格管理・トポロジ共有 | Pod 固有のリソース管理・ブローカリング |
| **管理ツール** | Horizon Console / lmvutil | Horizon Console / ADSI Edit / vdmadmin |

> **ポイント**: CPA 初期化により各 CS 上に 2 つの LDAP インスタンスが動作する。Local LDAP は Pod 固有データ、Global LDAP は Federation 共有データを保持する。

---

## Global Entitlement の作成と Pool 追加

### Global Entitlement の作成

1. Pod Federation 内の任意の CS で Horizon Console にログイン
2. **[インベントリ] > [グローバル資格]** → **[追加]**
3. 資格タイプを選択:
   - **デスクトップに対する資格**: Global Desktop Entitlement
   - **アプリケーションに対する資格**: Global Application Entitlement
4. 設定項目を入力:
   - **名前 / 表示名**: 一意識別名（1〜64 文字）
   - **ユーザー割り当て**: フローティング or 専用（Desktop のみ）
   - **範囲 (Scope)**: すべてのサイト / サイト内 / ポッド内
   - **ホーム サイトを使用する**: 有効 / 無効
   - **デフォルト表示プロトコル**: PCoIP or Horizon Blast
   - **セッション負荷分散**: なし / セッション数 / ロード インデックス（2309 以降）
5. ユーザー / グループを追加 → **[完了]**

### Pool の追加手順

1. **追加するプールが存在する Pod** の CS で Horizon Console にログイン
2. **[インベントリ] > [グローバル資格]** → グローバル資格名をクリック
3. **[ローカル プール]** タブ → **[追加]**
4. デスクトッププール / アプリケーションプールを選択 → **[追加]**

> **重要**: ローカルプールの追加は、そのプールが存在する Pod の CS にログインして行う必要がある。リモート Pod のプールは、そのリモート Pod の CS にログインして追加する。

### セッション負荷分散ポリシー（Session Distribution Policy）

Horizon 2306 以降で利用可能。Global Entitlement 作成時にセッション分散方式を指定：

| ポリシー | 説明 | バージョン |
|---|---|---|
| **なし（デフォルト）** | セッション分散なし。ローカル→サイト→他サイトの順にリソースを検索 | 2306〜 |
| **セッション数** | 現在の使用率（セッション数/最大キャパシティ）に基づいて均等分散 | 2306〜 |
| **ロード インデックス** | 実際の負荷に基づいて均等分散（デスクトップ: セッション数*100/VM総数、RDS: ホストの平均ロードインデックス） | **2309〜** |

> **Scope との組み合わせ**: すべてのサイト → ホームサイト/接続サイト内で最も負荷の低いポッド・プールを選択し、見つからなければ他サイトを検索。サイト内 → ホームサイト/接続サイト内のみ。ポッド内 → 接続先ポッド内のみ。

### バックアップ グローバル資格（Backup Global Entitlement）

プライマリ Global Entitlement がプール容量不足やポッド障害でセッション開始に失敗した場合、バックアップ Global Entitlement がリソースを提供するフォールバック機能。

**設定方法**: Global Entitlement の編集画面で「バックアップ グローバル資格」を選択

**制約事項**:
- フローティング デスクトップ資格でのみ設定可能（専用は不可）
- バックアップ GE の設定が有効になると、バックアップ GE 自体の編集・ユーザー資格・Home Site Override は無効化
- 既存のプライマリまたはバックアップ GE を別のバックアップとして選択不可
- バックアップ GE はプライマリ GE のセッション分散ポリシーを継承

**一致が必要な設定**:
- ユーザー割り当てタイプ / デフォルト表示プロトコル / サポートされる表示プロトコル
- ユーザーのマシン再起動許可 / 複数セッション / セッション共同作業

### Connection Server タグによるグローバル資格の制限

Connection Server インスタンスにタグを割り当て、Global Entitlement へのアクセスを制限可能（内部/外部ユーザーの分離に使用）。

| CS タグ | GE タグ | アクセス |
|---|---|---|
| タグなし | タグなし | **許可** |
| タグなし | 1つ以上のタグ | **拒否** |
| 1つ以上のタグ | タグなし | **許可** |
| 1つ以上のタグ | 1つ以上のタグ | **タグ一致時のみ許可** |

> **UAG 使用時**: UAG 自体にタグは設定不可。対になる Connection Server インスタンスにタグを設定する。

### Global Entitlement 構成のベストプラクティス

- ローカル資格とグローバル資格を **同じプールに対して同時に設定しない**（重複表示が発生）
- Global Application Entitlement には **同じアプリケーション** のプールのみを追加する
- Desktop Pool のプロパティ（ユーザー割り当て、プロトコル等）は Global Entitlement の設定と一致させる
- プールレベルの表示プロトコルやリセットポリシーを GE 関連付け後に変更すると起動エラーの原因になる

---

## Home Site 戦略

### Home Site の種類

| 種類 | 説明 | 優先度 |
|---|---|---|
| **Global Home Site** | ユーザーまたはグループに割り当てるホーム サイト。すべての Global Entitlement に適用。 | ユーザー > グループ |
| **Home Site Override** | 特定の Global Entitlement に関連付けるホーム サイト。Global Home Site を上書きする。 | 最優先 |

### Home Site の動作

- Home Site が設定されたユーザーがリソースを要求 → **ホーム サイト内から検索開始**
- ホーム サイトにリソースがない場合 → **Scope ポリシーに従い他サイトを検索**
- Home Site が未設定 → 接続先 Pod / Site からの検索（デフォルト動作）

### Scope ポリシーとの組み合わせ

| Scope | 検索範囲 | Home Site との組み合わせ |
|---|---|---|
| **ANY（すべてのサイト）** | Pod Federation 全体 | Home Site → 同一サイト → 他サイトの順に検索 |
| **SITE（サイト内）** | ユーザー接続先サイト内のみ | Home Site 内のみ検索。リソースなしの場合は他サイトを検索**しない** |
| **POD（ポッド内）** | ユーザー接続先ポッド内のみ | 接続先 Pod 内のみ。Home Site は検索開始位置に影響 |

### Home Site の設定手順（Horizon Console）

1. **[ユーザーとグループ]** → **[ホーム サイトの割り当て]** タブ → **[追加]**
2. ユーザーまたはグループを検索・選択 → **[次へ]**
3. **[ホーム サイト]** ドロップダウンからサイトを選択
4. （オプション）**[リダイレクトを有効にする]** で Home Site Redirect を設定
5. **[発行]**

### Home Site Override の設定手順

1. **[インベントリ] > [グローバル資格]** → 対象の Global Entitlement を選択
2. **[ホーム サイト上書き]** タブ → **[追加]**
3. ユーザーまたはグループを選択 → **[次へ]**
4. **[ホーム サイト上書き]** ドロップダウンからサイトを選択 → **[送信]**

> **前提**: Global Entitlement で **[ホーム サイトを使用する]** が有効になっていること。デフォルトでは無効。

### Home Site Redirect

ユーザーを接続先サイトから指定された Home Site に **UAG 経由の再認証なし** でリダイレクトする機能。バックホールトラフィックを削減。

有効化手順:
1. サイト設定で Redirect URL を事前設定
2. Global LDAP の `OU=Properties, OU=Global, CN=Common` で `pae-EnableSiteRedirection` を **1** に設定

---

## フェデレーション アクセス グループ

### 概要

グローバル資格とグローバルセッションの管理を特定の管理者に委任するための仕組み。デフォルトではすべてのグローバル資格は **ルート フェデレーション アクセス グループ（Root(/)）** に作成される。

### 設定手順

1. **[設定] > [管理者]** → **[フェデレーション アクセス グループ]** タブ → **[フェデレーション グループの追加]**
2. グローバル資格を作成時または編集時に、フェデレーション アクセス グループを選択
3. 管理者にロールを割り当てる際、対象のフェデレーション アクセス グループを指定

### 権限の継承

ルート フェデレーション アクセス グループに対するロールを持つ管理者は、すべてのフェデレーション アクセス グループに対してそのロールの権限を自動的に継承する（スーパー管理者）。

---

## lmvutil コマンド一覧

### 基本情報

- **パス（Omnissa リブランド後）**: `%PROGRAM FILES%\Omnissa\Horizon\Server\tools\bin\lmvutil.exe`
- **パス（レガシー）**: `C:\Program Files\VMware\VMware View\Server\tools\bin\lmvutil.exe`
- **代替コマンド**: `vdmutil`（lmvutil と同一の操作を実行可能）
- **実行要件**: Connection Server 上で管理者権限で実行
- **認証**: `--authAs <user> --authDomain <domain> --authPassword <password>`
- **セキュアなパスワード入力**: `--authPassword "*"` でプロンプト入力（推奨）
- **注意**: コマンドとパラメータは**大文字小文字を区別**する

### 主要コマンド

#### Federation 管理

| コマンド | 用途 |
|---|---|
| `lmvutil --initialize [--federationName <name>]` | CPA 初期化（Federation 名を指定可能） |
| `lmvutil --uninitialize` | CPA 無効化（不可逆、全 GE 削除） |
| `lmvutil --join --joinServer <FQDN> --userName <user> --password <pw>` | Pod をフェデレーションに参加（方式1） |
| `lmvutil --join --serverName <FQDN> --federationName <name>` | Pod をフェデレーションに参加（方式2） |
| `lmvutil --unjoin` | 現在の Pod をフェデレーションから離脱 |
| `lmvutil --updatePod --pod <podName> --podName <newName>` | Pod 名の変更 |

#### Site 管理

| コマンド | 用途 |
|---|---|
| `lmvutil --createSite --siteName <name>` | サイトの作成 |
| `lmvutil --deleteSite --siteName <name>` | サイトの削除 |
| `lmvutil --assignPodToSite --pod <podName> --siteName <name>` | Pod をサイトに割り当て |
| `lmvutil --updateSite --siteName <name> --newSiteName <newName>` | サイト名の変更 |

#### Global Entitlement 管理

| コマンド | 用途 |
|---|---|
| `lmvutil --createGlobalEntitlement --entitlementName <name> --scope <ALL_SITES\|WITHIN_SITE\|WITHIN_POD> --isFloating\|--isDedicated [--defaultProtocol <BLAST\|PCOIP>] [--fromHome] [--sessionDistributionPolicy <...>]` | Global Desktop Entitlement の作成 |
| `lmvutil --createGlobalApplicationEntitlement --entitlementName <name> --scope <ALL_SITES\|WITHIN_SITE\|WITHIN_POD>` | Global Application Entitlement の作成 |
| `lmvutil --deleteGlobalEntitlement --entitlementName <name>` | GDE の削除 |
| `lmvutil --deleteGlobalApplicationEntitlement --entitlementName <name>` | GAE の削除 |
| `lmvutil --addPool --entitlementName <name> --poolName <name>` | プールの追加（名前指定） |
| `lmvutil --addPoolAssociation --entitlementName <name> --poolId <id>` | プールの追加（ID 指定） |
| `lmvutil --removePool --entitlementName <name> --poolName <name>` | プールの削除（名前指定） |
| `lmvutil --addUser --entitlementName <name> --userName <user> --domain <domain>` | ユーザーの追加 |
| `lmvutil --removeUser --entitlementName <name> --userName <user> --domain <domain>` | ユーザーの削除 |
| `lmvutil --addGroup --entitlementName <name> --groupName <group> --domain <domain>` | グループの追加 |
| `lmvutil --removeGroup --entitlementName <name> --groupName <group> --domain <domain>` | グループの削除 |
| `lmvutil --updateGlobalEntitlement --entitlementName <name> --scope <ALL_SITES\|WITHIN_SITE\|WITHIN_POD>` | Scope 変更 |

#### Home Site 管理

| コマンド | 用途 |
|---|---|
| `lmvutil --assignHomeSite --userName <user> --domain <domain> --siteName <name>` | ユーザーの Global Home Site 設定 |
| `lmvutil --removeHomeSite --userName <user> --domain <domain>` | Global Home Site の削除 |
| `lmvutil --assignHomeSite --userName <user> --domain <domain> --siteName <name> --entitlementName <ge>` | Home Site Override の設定（GE ごと） |
| `lmvutil --removeHomeSite --entitlementName <ge> --userName <user> --domain <domain>` | Home Site Override の削除 |
| `lmvutil --assignHomeSite --groupName <group> --domain <domain> --siteName <name>` | グループの Home Site 設定 |

#### 情報表示

| コマンド | 用途 |
|---|---|
| `lmvutil --listEntitlements` | 全 Global Desktop Entitlement の一覧 |
| `lmvutil --listApplicationEntitlements` | 全 Global Application Entitlement の一覧 |
| `lmvutil --listAssociatedPools --entitlementName <name>` | GE に関連付けられたプール一覧 |
| `lmvutil --listUserEntitlements --entitlementName <name>` | GE のユーザー / グループ一覧 |
| `lmvutil --listHomeSites --userName <user> --domain <domain>` | ユーザーの Home Site 一覧 |
| `lmvutil --listEffectiveHomeSite --userName <user> --domain <domain>` | 有効な Home Site の確認 |
| `lmvutil --listPods` | Pod 一覧 |
| `lmvutil --listSites` | サイト一覧 |
| `lmvutil --listDedicatedPoolAssignments --entitlementName <name>` | 専用プール割り当て一覧 |

#### SSL 証明書管理

| コマンド | 用途 |
|---|---|
| `lmvutil --createPendingCertificate` | 保留中の SSL 証明書を作成 |
| `lmvutil --activatePendingCertificate` | 保留中の証明書を有効化 |

### lmvutil 使用シナリオ

| シナリオ | 推奨ツール | 理由 |
|---|---|---|
| CPA 初期化 / Pod 参加 | Horizon Console | GUI での操作が直感的 |
| 大量ユーザーの Home Site 一括設定 | lmvutil + スクリプト | PowerShell ループで効率的に処理 |
| CI/CD パイプラインでの GE 管理 | lmvutil | 自動化に適した CLI |
| トラブルシューティング | lmvutil | 詳細出力 (`--verbose`) でデバッグ |
| 日常的な GE / Pool 追加 | Horizon Console | GUI で設定を視覚的に確認 |

---

## ベストプラクティス

1. **Federation 名・Pod 名・Site 名** を物理的なロケーションに基づいて命名
2. **すべての Pod を同一 Horizon バージョン**にアップグレード（混在環境では新機能が動作しない。Horizon 7.4 以降で混在サポート）
3. ローカル資格とグローバル資格を **同じプールに混在させない**（同一ファームから作成されたアプリケーションプールでも同様）
4. **Home Site 戦略** を事前に設計し、ユーザーの地理的分布に基づいて割り当て
5. **GSLB (Global Server Load Balancing)** を使用して、ユーザーを最寄りの Pod に誘導（単一 URL で全サイト対応）
6. CPA 変更前に **lmvutil で現在の構成をバックアップ** / 記録
7. **Backup Global Entitlement** を構成して、プライマリ GE 障害時のフォールバックを確保
8. **フェデレーション アクセス グループ** を活用して管理の委任を行う
9. `--authPassword "*"` を使用し、パスワードをコマンド履歴に残さない
10. **UAG** は 1 つの Pod に関連付ける（複数 Pod にまたがる UAG は非サポート）

## アンチパターン

1. **Connection Server を複数サイトにまたがって配置**（Pod は単一データセンター内に限定）
2. **Home Site 未設定のまま Scope: SITE を使用**（ユーザーが別サイトに接続した場合リソースが見つからない）
3. **Global Entitlement に異なるアプリケーションのプールを混在**（ユーザーにランダムなアプリが提供される）
4. **CPA ポートの閉鎖**（22389, 22636, 8472 を閉じるとレプリケーション・通信が停止）
5. **GE 関連付け後にプールレベルの表示プロトコルを変更**（起動エラーの原因）
6. **タグなしの CS でタグ付き GE にアクセスしようとする**（アクセス拒否される）

---

## 理解度チェックリスト

### CPA 初期化
- [ ] CPA 初期化の前提条件と手順を説明できる
- [ ] 初期化時に構成される Global Data Layer と VIPA チャネルの役割を理解している
- [ ] CPA 初期化は最初の Pod で 1 回のみであることを把握している

### Pod 参加
- [ ] Horizon Console で Pod を Federation に参加させる手順を説明できる
- [ ] lmvutil --join コマンドの構文と必要パラメータを理解している
- [ ] 参加時の注意事項（CS サービス停止不可、同名 CS 不可）を把握している

### Global LDAP vs Local LDAP
- [ ] 格納データの違いを説明できる
- [ ] レプリケーション範囲の違い（Federation 全体 vs Pod 内）を説明できる
- [ ] 使用ポートの違い（22389/22636 vs 389/636）を把握している

### Global Entitlement
- [ ] Global Entitlement の作成手順と主要設定項目を説明できる
- [ ] Pool の追加手順と、対象 Pod の CS にログインする必要性を理解している
- [ ] Scope ポリシー（ANY / SITE / POD）の検索動作を説明できる
- [ ] セッション負荷分散ポリシー（なし / セッション数 / ロード インデックス）の動作を理解している
- [ ] バックアップ グローバル資格の目的と制約を説明できる
- [ ] Connection Server タグによる GE アクセス制限の仕組みを理解している
- [ ] フェデレーション アクセス グループによる管理の委任を説明できる

### Home Site 戦略
- [ ] Global Home Site と Home Site Override の優先順位を説明できる
- [ ] Home Site と Scope の組み合わせによる検索動作を説明できる
- [ ] Home Site Redirect の機能と有効化手順を把握している

### lmvutil コマンド
- [ ] lmvutil の主要コマンド（initialize, join, createSite, createGlobalEntitlement, assignHomeSite）を使用できる
- [ ] lmvutil と vdmutil が同一の操作を実行できることを理解している
- [ ] lmvutil と Horizon Console の使い分けを判断できる
- [ ] lmvutil の認証オプション（--authAs, --authDomain, --authPassword）を理解している
- [ ] CPA トポロジの制限値（50 Pods, 15 Sites, 350 CS, 250,000 Sessions）を把握している
- [ ] CPA の制限事項（キオスク モード、IPv6 サポート要件）を把握している
