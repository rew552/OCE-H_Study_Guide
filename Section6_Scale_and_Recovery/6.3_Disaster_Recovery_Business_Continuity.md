# 6.3 Disaster Recovery and Business Continuity

## 概要

災害復旧と事業継続戦略は、Horizon環境の可用性とデータ保護に重要です。OCE-Hレベルでは、Connection Serverバックアップとリカバリ、App Volume HAオプション、DEMのHAオプション、DR計画の策定が求められます。

## 学習目標

このセクションを学習することで、以下のことができるようになります：

- Connection Serverバックアップとリカバリのセットアップができる
- App Volumes HAオプションを評価できる
- DEMのHAオプションを評価できる
- DR計画を策定できる

## 関連リソース

- [クイックリファレンス](../../00_Quick_Reference.md) - ポート番号、設定値、制限値
- [用語集](../../README.md#用語集) - 関連用語の定義
- [1.2 Planning Horizon Deployments](../../Section1_Infrastructure_Planning_and_Management/1.2_Planning_Horizon_Deployments.md) - デプロイメント計画
- [1.8 App Volumes Integration](../../Section1_Infrastructure_Planning_and_Management/1.8_App_Volumes_Integration.md) - App Volumes統合
- [実環境シナリオ](../../00_Scenarios/Section6_Scenarios.md) - 実環境でのシナリオ例

## Connection Serverバックアップとリカバリのセットアップ

### バックアップの設定

#### バックアップ対象

**必須バックアップ**:
1. **Connection Server設定**
   - グローバル設定
   - プール設定
   - エンタイトルメント設定

2. **データベース**
   - 組み込みデータベース
   - 外部データベース（SQL Server、Oracle）

3. **証明書**
   - SSL証明書
   - 署名証明書

#### 設定のエクスポート

**Horizon Consoleからのエクスポート**:
1. View Configuration → Servers
2. Connection Serverを選択
3. Export Configurationをクリック
4. 設定ファイルを保存

**PowerShellスクリプト**:
```powershell
# 設定のエクスポート（手動）
# Horizon Consoleから手動でエクスポート
# または、データベースのバックアップを実行
```

#### データベースのバックアップ

**SQL Serverの場合**:
```sql
-- フルバックアップ
BACKUP DATABASE horizon_config
TO DISK = 'C:\Backup\horizon_config_$(Get-Date -Format "yyyyMMdd").bak'
WITH FORMAT, INIT, NAME = 'Full Backup of horizon_config',
     COMPRESSION, STATS = 10;

-- トランザクションログのバックアップ
BACKUP LOG horizon_config
TO DISK = 'C:\Backup\horizon_config_log_$(Get-Date -Format "yyyyMMdd").trn'
WITH FORMAT, INIT, NAME = 'Transaction Log Backup';
```

**PowerShellスクリプト**:
```powershell
# SQL Serverバックアップスクリプト
$backupPath = "C:\Backup"
$date = Get-Date -Format "yyyyMMdd"
$backupFile = "$backupPath\horizon_config_$date.bak"

# SQL Serverバックアップコマンドを実行
sqlcmd -S "SQLServer\Instance" -d horizon_config `
    -Q "BACKUP DATABASE horizon_config TO DISK = '$backupFile' WITH FORMAT, INIT"
```

**Oracleの場合**:
```sql
-- RMANバックアップ
RUN {
  BACKUP DATABASE PLUS ARCHIVELOG;
  BACKUP CURRENT CONTROLFILE;
}
```

#### 証明書のバックアップ

**証明書のエクスポート**:
```powershell
# 証明書のエクスポート
$cert = Get-ChildItem -Path Cert:\LocalMachine\My | Where-Object {$_.Subject -like "*horizon*"}
Export-Certificate -Cert $cert -FilePath "C:\Backup\horizon_cert.cer"

# 秘密キーのエクスポート（可能な場合）
$cert | Export-PfxCertificate -FilePath "C:\Backup\horizon_cert.pfx" -Password (ConvertTo-SecureString -String "Password123!" -AsPlainText -Force)
```

### リカバリ手順

#### 新しいConnection Serverのインストール

**手順**:
1. 新しいWindows ServerにOSをインストール
2. Active Directoryドメインに参加
3. Horizon Connection Serverをインストール
4. インストールタイプで「Replica」を選択（既存のレプリケーショングループに参加する場合）

#### 設定のインポート

**手順**:
1. Horizon Console → View Configuration → Servers
2. Connection Serverを選択
3. Import Configurationをクリック
4. バックアップした設定ファイルを選択

#### データベースのリストア

**SQL Serverの場合**:
```sql
-- データベースのリストア
RESTORE DATABASE horizon_config
FROM DISK = 'C:\Backup\horizon_config_20240101.bak'
WITH REPLACE, RECOVERY,
     MOVE 'horizon_config' TO 'C:\Data\horizon_config.mdf',
     MOVE 'horizon_config_log' TO 'C:\Data\horizon_config_log.ldf';
```

**PowerShellスクリプト**:
```powershell
# SQL Serverリストアスクリプト
$backupFile = "C:\Backup\horizon_config_20240101.bak"
sqlcmd -S "SQLServer\Instance" `
    -Q "RESTORE DATABASE horizon_config FROM DISK = '$backupFile' WITH REPLACE, RECOVERY"
```

#### 証明書の復元

**手順**:
1. 証明書ファイルをインポート
2. Horizon Consoleで証明書を設定
3. 接続テスト

> [!IMPORTANT]

> 定期的なバックアップは、災害復旧に不可欠です。少なくとも週次でバックアップを実行し、月次でリカバリテストを実施してください。

## App Volume HAオプションの評価とセットアップ

### HAオプションの評価

#### 高可用性データベース

**SQL Server Always On**:
- 高可用性グループの構成
- 自動フェイルオーバー
- 読み取りレプリカ

**Oracle RAC**:
- Real Application Clusters
- 複数のノードで共有

#### 複数のApp Volumes Manager

**構成**:
- 最小2台のApp Volumes Manager
- 負荷分散
- 自動フェイルオーバー

### HA設定手順

#### 追加Managerのインストール

**手順**:
1. 新しいWindows ServerにApp Volumes Managerをインストール
2. 既存のManagerを指定
3. 登録を実行

#### 高可用性データベースの設定

**SQL Server Always On**:
1. Always On可用性グループを作成
2. App Volumes Managerで可用性グループを指定
3. フェイルオーバーのテスト

#### ストレージレプリケーション

**設定**:
- パートナーとのレプリケーション設定
- レプリケーションスケジュール
- ストレージ要件の評価

## DEMのHAオプションの評価と設定

### HAオプションの評価

#### 複数のファイル共有

**構成**:
- 最小2台のファイルサーバー
- DFS (Distributed File System) の使用
- 負荷分散

#### Management Consoleの冗長化

**構成**:
- 複数のManagement Console
- 負荷分散
- 自動フェイルオーバー

### HA設定手順

#### 追加ファイル共有の設定

**手順**:
1. 新しいファイルサーバーを構築
2. 共有フォルダを作成
3. DFSに追加
4. DEM Management Consoleで設定

#### Management Consoleの冗長化

**手順**:
1. 追加のManagement Consoleをインストール
2. 同じファイル共有を指定
3. 負荷分散の設定

> [!TIP]

> HAオプションの実装により、可用性が大幅に向上します。ただし、コストと複雑性も増加するため、要件に応じて適切なHA構成を選択してください。

## DR計画の策定

### DR計画の要素

1. **RTO (Recovery Time Objective)**
   - 目標復旧時間
   - 例: 4時間以内

2. **RPO (Recovery Point Objective)**
   - 目標復旧ポイント
   - 例: 1時間以内のデータ損失

3. **バックアップ戦略**
   - バックアップ頻度
   - バックアップ保持期間
   - バックアップ場所

4. **リカバリ手順**
   - ステップバイステップの手順
   - 責任者の明確化
   - 連絡先情報

### DRテスト

**テスト項目**:
- バックアップの検証
- リカバリ手順のテスト
- RTO/RPOの検証

**テスト頻度**:
- 四半期ごと（推奨）
- 年次（最小）

## ベストプラクティス

1. **バックアップ**
   - 定期的なバックアップ（日次または週次）
   - バックアップの検証
   - オフサイトバックアップ

2. **テスト**
   - 定期的なリカバリテスト（四半期ごと）
   - DR計画の更新
   - ドキュメントの維持

3. **モニタリング**
   - バックアップの成功/失敗の監視
   - アラートの設定
   - 定期的なレビュー

> [!WARNING]

> DR計画は、定期的に更新し、テストする必要があります。計画が古くなると、実際の災害時に機能しない可能性があります。

## トラブルシューティング

### 一般的な問題

**バックアップが失敗する**:
- ストレージ容量の確認
- ネットワーク接続の確認
- 権限の確認

**リカバリが失敗する**:
- バックアップファイルの整合性確認
- データベースの状態確認
- ログファイルの確認

## 詳細なDR計画の策定

### DR計画の要素

**計画項目**:
- **RTO（Recovery Time Objective）**: 目標復旧時間
- **RPO（Recovery Point Objective）**: 目標復旧ポイント
- **復旧手順**: 詳細な復旧手順
- **責任者の明確化**: 各手順の責任者
- **連絡先情報**: 緊急時の連絡先

**DR計画テンプレート**:
```
1. 災害の種類と影響範囲
2. RTO/RPOの定義
3. バックアップ戦略
4. 復旧手順
5. テスト計画
6. 連絡先情報
```

## RTO/RPOの計算

### RTOの計算

**RTOの定義**:
- サービスを復旧するまでの目標時間
- 例: 4時間以内にサービスを復旧

**RTO計算式**:
```
RTO = 復旧作業時間 + 検証時間 + バッファ時間

例:
- 復旧作業時間: 2時間
- 検証時間: 1時間
- バッファ時間: 1時間
- RTO = 2 + 1 + 1 = 4時間
```

### RPOの計算

**RPOの定義**:
- 許容できるデータ損失の最大時間
- 例: 1時間以内のデータ損失

**RPO計算式**:
```
RPO = バックアップ間隔 + データ転送時間

例:
- バックアップ間隔: 1時間
- データ転送時間: 5分
- RPO = 1時間 + 5分 = 1時間5分
```

## DRテストの計画と実行

### DRテスト計画

**テスト頻度**:
- 四半期ごと（推奨）
- 年次（最小）

**テスト項目**:
- バックアップの検証
- 復旧手順のテスト
- RTO/RPOの検証
- ドキュメントの更新

**テストチェックリスト**:
- [ ] バックアップの整合性確認
- [ ] 復旧環境の準備
- [ ] 復旧手順の実行
- [ ] サービス復旧の確認
- [ ] パフォーマンステスト
- [ ] ロールバック手順の確認

## まとめ

災害復旧と事業継続戦略の適切な実装は、Horizon環境の可用性とデータ保護に重要です。Connection Serverバックアップ、App Volume HA、DEM HAの適切な設定、詳細なDR計画の策定、RTO/RPOの計算、DRテストの計画と実行により、堅牢で可用性の高いHorizon環境を構築できます。
