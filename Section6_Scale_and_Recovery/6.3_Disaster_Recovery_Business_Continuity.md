# 6.3 Disaster Recovery and Business Continuity

## Exam Objective

> **4.6.3. Configure disaster recovery and business continuity strategies for Horizon environment.**
> - Setup Connection Server backup and recovery
> - Evaluate and set up App Volume HA options
> - Evaluate and configure HA options for DEM

---

## Connection Server バックアップとリカバリ

### バックアップ対象一覧

| 対象 | 方法 | 内容 |
|---|---|---|
| **Horizon LDAP データ** | `vdmexport` コマンド | Pool 定義、Entitlement、グローバル設定、CS 構成 |
| **SSL 証明書** | certutil / MMC からエクスポート | CS の TLS 証明書と秘密鍵 |
| **Events Database** | SQL Server バックアップ | イベントログ・監査データ |
| **vCenter Server 登録情報** | Horizon LDAP に含まれる | vCenter 接続設定 |
| **CPA Global Data** | CPA 初期化済みの場合、`vdmexport` に含まれる | Global Entitlement、Home Site 割り当て |

### vdmexport / vdmimport

Connection Server の ADAM（Active Directory Application Mode）LDAP データベース（Horizon 構成情報）のバックアップとリストアに使用する公式ツール。

**パス（Omnissa リブランド後）**: `%PROGRAM FILES%\Omnissa\Horizon\Server\tools\bin\`
**パス（レガシー）**: `C:\Program Files\VMware\VMware View\Server\tools\bin\`

#### vdmexport（バックアップ）

```powershell
# 基本的なエクスポート
vdmexport -f C:\Backup\horizon_config_backup.LDF

# 暗号化エクスポート（Data Recovery Password 使用）
vdmexport -f C:\Backup\horizon_config_encrypted.LDF -c

# 詳細出力でエクスポート
vdmexport -f C:\Backup\horizon_config_backup.LDF -v
```

| オプション | 説明 |
|---|---|
| `-f <ファイルパス>` | エクスポート先ファイルを指定 |
| `-v` | 詳細出力（verbose） |
| `-c` | 暗号化エクスポート（Data Recovery Password で暗号化） |

エクスポートされるデータ:
- Pool 構成（Desktop Pool、Farm、Application Pool）
- Entitlement（ローカルおよびグローバル）
- Connection Server 設定（グローバル設定、セキュリティ設定）
- vCenter Server 登録情報
- CPA 構成（初期化済みの場合：Global Entitlement、Home Site 割り当て、Federation トポロジ）

#### vdmimport（リストア）

```powershell
# 基本的なインポート
vdmimport -f C:\Backup\horizon_config_backup.LDF

# 詳細出力でインポート
vdmimport -f C:\Backup\horizon_config_backup.LDF -v
```

| オプション | 説明 |
|---|---|
| `-f <ファイルパス>` | インポート元ファイルを指定 |
| `-v` | 詳細出力（verbose） |

### 自動バックアップ機能

Connection Server は ADAM LDAP データベースの自動バックアップ機能を内蔵：

| 項目 | デフォルト設定 |
|---|---|
| **バックアップ間隔** | 毎日深夜（DAY_1） |
| **保持するバックアップ数** | **10** |
| **保存先** | `C:\ProgramData\Omnissa\Horizon\backups` |
| **暗号化** | Data Recovery Password で暗号化 |

**設定変更**: Horizon Console → **[設定] > [サーバ] > [Connection Server]** → 対象 CS を選択 → バックアップ設定を編集

**バックアップ間隔の選択肢**: 1時間（HOUR_1）/ 6時間（HOUR_6）/ 12時間（HOUR_12）/ 1日（DAY_1）/ 2日（DAY_2）/ 1週間（WEEK_1）/ 2週間（WEEK_2）/ 無効（HOUR_0）

> **Data Recovery Password**: Connection Server インストール時に設定するパスワード。自動バックアップの暗号化に使用される。リカバリ時にこのパスワードが必要。

#### バックアップ運用ルール

- **頻度**: 設定変更後および定期バックアップ（日次推奨）
- **保持**: 複数世代を保持（最低 7 日分）
- **保管場所**: CS とは別のストレージにオフサイトバックアップ
- **検証**: 定期的にリストアテストを実施
- **Data Recovery Password の管理**: 安全な場所に保管（紛失するとバックアップからのリストア不可）

### SSL 証明書のバックアップ

```powershell
$cert = Get-ChildItem -Path Cert:\LocalMachine\My |
    Where-Object { $_.FriendlyName -eq "vdm" }
Export-PfxCertificate -Cert $cert `
    -FilePath "C:\Backup\horizon_cert.pfx" `
    -Password (ConvertTo-SecureString -String "BackupP@ss" -AsPlainText -Force)
```

### リカバリ手順

#### シナリオ 1: 単一 CS 障害（レプリケーショングループ内に他の CS が稼働中）

1. 障害 CS を修復 or 新規 OS をインストール
2. Connection Server を **Replica** モードでインストール（既存 CS の FQDN を指定）
3. LDAP レプリケーションにより自動的に構成が同期
4. ロードバランサーにプールメンバーとして再追加

#### シナリオ 2: 全 CS 障害（レプリケーショングループ全滅）

1. 新規 OS に Connection Server を **Standard** モードでインストール
2. `vdmimport` でバックアップから LDAP データをリストア
3. SSL 証明書をインポート
4. Events Database の接続を再設定
5. 追加の CS を Replica モードでインストール
6. 接続テスト・エンタイトルメント検証

---

## App Volumes HA オプション

### HA 構成コンポーネント

App Volumes の HA は 3 層で構成：

| 層 | コンポーネント | HA 方式 |
|---|---|---|
| **Manager 層** | App Volumes Manager | Multi-Manager + Load Balancer |
| **DB 層** | SQL Server | SQL Always On Availability Group |
| **Storage 層** | Package / Writable Volume ストレージ | Storage Replication / Storage Group |

### Multi-Manager 構成

- **最小構成**: 2 台の App Volumes Manager
- 同一 SQL データベースに接続（同一サイト内でDBを共有）
- ロードバランサー配下で負荷分散
- Agent は LB の VIP に接続するよう構成

**障害時の動作**:
- 1 台の Manager がダウン → LB のヘルスチェックで検出 → 残りの Manager にトラフィック転送
- Agent はセッション中に Manager と定期通信 → LB 経由で別 Manager にフェイルオーバー

### SQL Always On Availability Group

App Volumes DB の高可用性を実現：

| 項目 | 設定 |
|---|---|
| **構成** | 2+ SQL Server ノードで Always On AG |
| **フェイルオーバーモード** | 自動フェイルオーバー（同期コミット） |
| **App Volumes Manager 接続先** | AG Listener の DNS 名を指定 |
| **読み取りレプリカ** | 監視用クエリに利用可能 |

### ストレージレプリケーション

**Package のレプリケーション**:
- **Storage Group 機能**: App Volumes Manager が Package を複数データストアに自動レプリケーション
- **vSphere Storage Replication**: vSphere レベルでデータストア間を複製
- **手動コピー**: 管理者がデータストア間で Package ファイルをコピー

**Writable Volume のレプリケーション**:
- Writable Volume はユーザー固有（1:1）のため、ユーザーの所在サイトに配置
- サイト間フェイルオーバーが必要な場合はストレージレベルのレプリケーションを構成
- DR サイトの App Volumes Manager にリモートストレージを登録

### Multi-Site フェイルオーバー

| コンポーネント | Primary Site | DR Site |
|---|---|---|
| App Volumes Manager | アクティブ（LB 配下） | スタンバイまたはアクティブ（独立 DB） |
| SQL Database | プライマリ（AG） | セカンダリ（AG レプリカ） |
| Package ストレージ | ソース | レプリカ（Storage Group / ストレージレプリケーション） |
| Writable Volume | ソース | レプリカ（ストレージレプリケーション） |

---

## DEM HA オプション

### DEM HA アーキテクチャ

DEM は DB に依存しないファイルベースのアーキテクチャのため、HA は **ファイル共有の冗長化** で実現する。

### Configuration Share の HA（Active-Active）

IT 設定データ（Configuration Share）は **読み取り専用** のため、複数のアクティブターゲットが安全に使用可能。

**構成**:

```
DFS-N (統一名前空間)
  ├── File Server A (Site 1) ← Active, Read Target
  ├── File Server B (Site 2) ← Active, Read Target
  └── DFS-R で Hub-Spoke レプリケーション
        管理者は Hub サーバーに対してのみ書き込み
```

| 項目 | 設定 |
|---|---|
| **DFS-N** | 統一パス（例: `\\domain\DEMConfig`） |
| **DFS-R** | Hub-Spoke トポロジ（Hub = 書き込み先、Spoke = 読み取り専用レプリカ） |
| **アクティブターゲット** | **複数可**（読み取り専用のため安全） |
| **管理者の書き込み先** | 常に同一の Hub サーバー（DFS-N 経由ではなくサーバー URL で直接接続） |
| **RTO** | 30〜60 秒（DFS-N リファラル切り替え） |
| **RPO** | 30〜60 秒（DFS-R レプリケーション遅延） |

### Profile Archive Share の HA（Active-Passive）

ユーザー設定データ（Profile Archive Share）は **読み書き** のため、**アクティブターゲットは 1 つのみ**。

> **警告**: Profile Archive Share で複数のアクティブターゲットを設定すると **データ破損** が発生する。Microsoft の「Replicated User Profile Data に関するサポートステートメント」を参照。

**構成**:

```
DFS-N (統一名前空間)
  ├── File Server A (Site 1) ← Active Referral Target
  ├── File Server B (Site 2) ← Deactivated Referral Target (パッシブ)
  └── DFS-R でレプリケーション
```

| 項目 | 設定 |
|---|---|
| **DFS-N** | 統一パス（例: `\\domain\DEMProfiles`） |
| **DFS-R** | 双方向レプリケーション |
| **アクティブターゲット** | **1 つのみ**（読み書きデータのため） |
| **フェイルオーバー** | 手動（DFS-N リファラルの有効 / 無効を切り替え） |
| **RPO** | 約 2 時間（DFS-R の最終レプリケーション依存） |

**フェイルオーバー手順**:
1. DFS-R のレプリケーション完了を確認（可能な場合）
2. アクティブターゲット（File Server A）の DFS-N リファラルを **無効化**
3. パッシブターゲット（File Server B）の DFS-N リファラルを **有効化**

### Management Console の冗長化

- Management Console は任意の台数のコンピュータにインストール可能
- 障害時は新しいサーバーに Management Console をインストールし、Configuration Share を指定するだけで復旧
- 専用の HA 構成は不要

---

## Active-Passive DR 戦略

### 方式比較

| 方式 | Stretched vSAN Cluster | CPA による Multi-Site Active-Active | Manual Failover |
|---|---|---|---|
| **概要** | 2 サイト間で vSAN ストレージを同期レプリケーション | サイトごとに独立した Pod を CPA で連携 | プライマリ障害時にセカンダリで手動復旧 |
| **RTO** | 15〜30 分 | ほぼゼロ（ユーザー再接続のみ） | 数時間〜 |
| **RPO** | 15〜30 分（同期レプリケーション） | ユースケース依存 | バックアップ間隔依存 |
| **CS 配置** | **全 CS を同一サイトにピン留め** | サイトごとに独立 Pod | サイトごとに独立 |
| **主要ユースケース** | Full Clone / Persistent Desktop / 開発者ワークスペース | Non-Persistent / Instant Clone | 小規模環境 |
| **レイテンシ要件** | サイト間 < 5 ms RTT | 特になし（WAN 許容） | 特になし |
| **複雑性** | 高（vSAN / DRS / HA 設定） | 中（CPA 設定） | 低 |
| **DEM RTO/RPO** | IT設定: 30-60秒 / ユーザーデータ: 約2時間 | DFS-R 依存 | DFS-R 依存 |

### Stretched vSAN Cluster

Horizon 管理 VM とデスクトップ VM を vSAN Stretched Cluster 上で稼働させ、サイト障害時に vSphere HA でフェイルオーバー。

**アーキテクチャ上の制約**:
- **Connection Server は全台を同一サイトにピン留め** する必要がある（DRS Affinity Rule で VM-Host Group を設定）
- CS を 2 サイトに分散（Pod の Stretch）は **非サポート**
- デスクトップ VM はアクティブ / アクティブで両サイトに配置可能

**Fault Domain 構成**:
- Preferred Site（プライマリデータサイト）
- Secondary Site（セカンダリデータサイト）
- Witness Site（Witness Appliance / ESXi）

**vSphere 設定**:

| 設定項目 | 推奨値 |
|---|---|
| vSphere HA | 有効 |
| Host Monitoring | 有効 |
| Admission Control | **50%** |
| Failures and Responses | Power off and restart VMs |
| DRS Automation | **Partially Automated** |
| VMHost Groups | Preferred-Site-Hosts / Secondary-Site-Hosts |
| VM Group | Management-VM-Group（CS, vCenter 等） |
| VM-Host Rule | Management VMs → Preferred Site にピン留め |
| HA Rule | vSphere HA should respect rules during failover |

**Storage Policy（3+3+1 構成）**:
- PFTT (Primary Level of Failures to Tolerate) = 1
- SFTT (Secondary Level of Failures to Tolerate) = 1
- Failure Tolerance Method = RAID-1 (Mirroring)

**ネットワーク要件**:
- データサイト間: < 5 ms RTT, 10 Gbps, L2 or L3, Unicast（vSAN 6.6+）
- データサイト ↔ Witness: 100〜200 ms RTT（10+10+1 構成以下）、100 ms RTT（10+10+1 超の構成）, L3

**Datastore Heartbeats 設定**:
- `Use datastores only from the specified list` を選択し、**データストアは選択しない**

**フェイルオーバーテスト結果（Reference Architecture 検証）**:

| テスト項目 | 結果 |
|---|---|
| サイト障害シミュレーション → vSphere HA が管理 VM を Site 2 で再起動 | 25 秒以内 |
| vSphere HA がフルクローンデスクトップを Site 2 で再起動 | 2 分以内 |
| ストレージポリシー | 非準拠を報告（サイト復旧後に再同期） |
| 障害中のログインユーザー | デスクトップが Site 1 にある場合はセッション切断 |
| 障害中の新規ログイン | 管理サービス復旧まで不可 |

> **重要**: Stretched vSAN Cluster は **Disaster Avoidance** モデルであり、真の DR ではない。OS/VM の破損はレプリケーションされるため、CPA による独立 Pod の方がクロスサイト障害に強い。デスクトップ VM はアクティブ/アクティブで両サイトに配置可能だが、管理 VM（CS, vCenter）は常に 1 つのサイトにピン留めする。

### CPA を使用した Multi-Site DR

Non-Persistent / Instant Clone 環境に最適：
- サイトごとに独立した Pod → Pod 間の障害分離（クロスサイト障害に強い）
- Global Entitlement で両サイトのプールを統合
- プライマリサイト障害時 → セカンダリサイトのプールからリソースを自動提供
- ユーザーデータは DEM / Folder Redirection でサイト間レプリケーション
- **Backup Global Entitlement** を活用して、プライマリ GE 障害時のフォールバックを確保
- Persistent デスクトップの場合、VM の直接レプリケーションが不要（各サイトで同等の VM を提供）
- App Volumes Package は Storage Group / ストレージレプリケーションで各サイトに複製

### Stretched vSAN Cluster の構築手順（概要）

| ステップ | 詳細 |
|---|---|
| **前提条件確認** | Stretched Cluster Design Considerations の確認 |
| **Witness デプロイ** | Witness サイト (Site 3) に vSAN Witness Appliance をデプロイし、静的ルート設定 |
| **vSphere クラスタ作成** | Site 1 + Site 2 の ESXi ホストで Stretched Cluster を作成。vSAN を有効化、Fault Domain を設定、Witness を選択 |
| **DRS / HA 設定** | 上記の推奨値に従い設定 |
| **Affinity ルール** | 管理 VM を特定サイトにピン留めするための VMHost Group / VM Group / VM-Host Rule を作成 |
| **Horizon 構成** | CS, vCenter をデプロイ。Golden Image を構築し、Full Clone Desktop Pool を作成 |

---

## ベストプラクティス

1. **vdmexport を定期実行**: 設定変更後および日次バックアップとしてスケジュール
2. **Data Recovery Password を安全に管理**: 紛失すると自動バックアップからのリストア不可
3. **リカバリテストを四半期ごとに実施**: バックアップの整合性とリストア手順を検証
4. **App Volumes は Multi-Manager + SQL Always On**: 単一障害点の排除
5. **App Volumes の Multi-Site ではサイトごとに個別 DB を使用**: Multi-Instance 管理で Package / Entitlement をレプリケーション
6. **DEM の Configuration Share は Active-Active**: 読み取り専用のため複数ターゲットが安全
7. **DEM の Profile Archive Share は Active-Passive のみ**: 複数アクティブターゲットはデータ破損リスク
8. **Stretched vSAN では CS を 1 サイトにピン留め**: Pod の Stretch は非サポート
9. **Non-Persistent 環境では CPA + 独立 Pod が最適**: 障害分離とスケーラビリティの両立
10. **Backup Global Entitlement を活用**: プライマリ GE のフォールバックとして構成

## アンチパターン

1. **vdmexport バックアップの未取得**: LDAP データ損失時に全構成を手動再作成が必要
2. **Data Recovery Password の紛失**: 自動バックアップが復元不可に
3. **App Volumes で SQL Express を本番使用**: HA 機能なし、サイズ制限あり
4. **Profile Archive Share に複数のアクティブ DFS-N ターゲット**: データ破損の原因
5. **Stretched Cluster で CS を 2 サイトに分散**: Pod の Stretch は非サポート
6. **DR テスト未実施**: 災害時にリストア手順が機能しないリスク
7. **Stretched vSAN を真の DR として設計**: Disaster Avoidance モデルであり、OS/VM 破損はレプリケーションされる

---

## 理解度チェックリスト

### Connection Server バックアップ
- [ ] vdmexport / vdmimport の用途とコマンド構文を説明できる
- [ ] vdmexport の `-c` オプション（暗号化）の用途を理解している
- [ ] 自動バックアップのデフォルト設定（日次、10世代保持、保存先）を把握している
- [ ] Data Recovery Password の役割とリカバリ時の必要性を理解している
- [ ] バックアップ対象（LDAP データ、証明書、Events DB、CPA構成）を列挙できる
- [ ] 全 CS 障害時のリカバリ手順を順序立てて説明できる
- [ ] 単一 CS 障害時は Replica インストールで自動同期されることを理解している

### App Volumes HA
- [ ] Multi-Manager + LB の構成と障害時の動作を説明できる
- [ ] SQL Always On AG の役割と設定方法を理解している
- [ ] Storage Group / ストレージレプリケーションによる Package 複製を説明できる
- [ ] Writable Volume のサイト間レプリケーションの考慮事項を把握している

### DEM HA
- [ ] Configuration Share が Active-Active で安全な理由を説明できる
- [ ] Profile Archive Share が Active-Passive に限定される理由を説明できる
- [ ] DFS-N / DFS-R を使用したフェイルオーバー手順を説明できる
- [ ] DEM の RTO / RPO の目安値を把握している

### DR 戦略
- [ ] Stretched vSAN Cluster と CPA Multi-Site の使い分けを判断できる
- [ ] Stretched vSAN で CS をピン留めする必要性と DRS Affinity Rule の設定を理解している
- [ ] Stretched vSAN が Disaster Avoidance モデルであることを理解している
- [ ] Stretched vSAN のフェイルオーバーテスト結果（管理VM: 25秒、デスクトップ: 2分）を把握している
- [ ] Non-Persistent 環境に CPA が最適である理由を説明できる
- [ ] Backup Global Entitlement を使用した DR フォールバック戦略を説明できる
- [ ] Stretched vSAN の構築手順（Witness デプロイ→クラスタ作成→DRS/HA 設定→Affinity ルール）を説明できる
