# 5.1 SSL Certificates and Multi-Factor Authentication

## Objective 4.5.1: Implement SSL certificates

Horizon Connection Server 用 SSL/TLS 証明書の生成・適用、および SAML / RADIUS / RSA / Smart Card を使用した多要素認証（MFA）の実装について扱う。

---

## SSL/TLS 証明書の生成と適用

### 証明書タイプの選択

Horizon 8 では以下の TLS 証明書タイプが使用可能。環境規模・コストに応じて選択する。

| 証明書タイプ | 説明 | ユースケース |
|---|---|---|
| Single-Server Name | 特定サーバの FQDN を Subject に持つ（例: `cs01.corp.local`） | Connection Server が 1 台のみの小規模環境 |
| Subject Alternative Name (SAN) | 複数の FQDN を SAN 属性に含む | LB 背後に複数 CS を配置する構成 |
| Wildcard (`*.corp.local`) | 単一レベルのサブドメインすべてに適用可能 | 多数のサーバが証明書を必要とする大規模環境 |

> **試験ポイント**: Wildcard 証明書は単一レベルのドメインのみ有効。`*.company.com` は `dept.company.com` に使えるが `dept.it.company.com` には使えない。

### 証明書要件

| 要件 | 値 |
|---|---|
| Key Length | 2048 bit 以上（推奨）。1024 未満は Horizon Client が検証不可 |
| Hash Algorithm | SHA-256 以上（SHA-1 以前は非推奨） |
| Key Usage | `0xa0`（Digital Signature + Key Encipherment） |
| Enhanced Key Usage | `Server Authentication`（OID: 1.3.6.1.5.5.7.3.1） |
| Subject (CN) | サーバの FQDN（IP アドレスやショートネームは不可） |
| Exportable | TRUE（他サーバへのエクスポートに必要） |
| Provider | `Microsoft Strong Cryptographic Provider`（ProviderType = 12） |

### CSR 生成手順（certreq ユーティリティ）

**Step 1: CSR 構成ファイル（request.inf）の作成**

```ini
[Version]
Signature="$Windows NT$"

[NewRequest]
Subject = "CN=cs01.corp.local, OU=VDI, O=Corp, L=Tokyo, S=Tokyo, C=JP"
KeySpec = 1
KeyLength = 2048
HashAlgorithm = SHA256
Exportable = TRUE
MachineKeySet = TRUE
SMIME = False
PrivateKeyArchive = FALSE
UserProtected = FALSE
UseExistingKeySet = FALSE
ProviderName = "Microsoft Strong Cryptographic Provider"
ProviderType = 12
RequestType = PKCS10
KeyUsage = 0xa0

[EnhancedKeyUsageExtension]
OID=1.3.6.1.5.5.7.3.1
```

**Step 2: CSR の生成**

```powershell
certreq -new request.inf certreq.txt
```

**Step 3: CA へ CSR を提出し署名付き証明書を取得**

- CA の登録プロセスに従って `certreq.txt` の内容を提出
- サーバタイプは「Microsoft」または「Microsoft IIS 7」を選択
- CA から返される証明書ファイル: `cert.cer`（サーバ証明書）、`root.cer`（ルート CA）、`intermediate.cer`（中間 CA）

**Step 4: 署名付き証明書のインポート**

```powershell
certreq -accept cert.cer
```

**Step 5: CSR とプライベートキーの確認**

1. MMC → 証明書スナップイン（ローカルコンピュータ）を追加
2. `Certificate Enrollment Request` → `Certificates` フォルダを展開
3. 証明書にプライベートキー（黄色のキーアイコン）が含まれていることを確認

### Horizon Console からの CSR 生成（代替手法）

Horizon 8 2312 以降では Horizon Console の **Certificate Management** ペインから直接 CSR を生成可能。

1. **Certificate Management** → **Generate CSR** をクリック
2. Subject Name を入力（X.500 形式: `CN`, `O`, `OU`, `L`, `S`, `C` 等）
3. Certificate Usage: **Machine** または **Cluster** を選択
4. 生成された CSR をコピーまたはダウンロードし CA に提出
5. CA 署名付き PEM 証明書を受領後、**Import** で取り込む

### 証明書のインポートとフレンドリ名「vdm」の設定

証明書を Windows 証明書ストアにインポートした後、Horizon 8 Server が使用できるように設定する。

**手順**:

1. MMC 証明書スナップインで `Personal` → `Certificates` を開く
2. インポートしたサーバ証明書を右クリック → **Properties**
3. **Friendly Name** を以下のとおり変更:
   - Machine 証明書: **`vdm`**（小文字必須）
   - Cluster 証明書: **`vdm.ec`**（小文字必須、2312 以降）
4. 他の証明書に `vdm` / `vdm.ec` のフレンドリ名が付いていないことを確認（重複がある場合は名前を変更または削除）

> **試験ポイント**: フレンドリ名は **必ず小文字** で `vdm` と設定する。大文字・スペルミスがあると Connection Server が証明書を認識しない。

### 証明書チェーン構成

```
Root CA Certificate
  └─ Intermediate CA Certificate
       └─ Server Certificate (Friendly Name: vdm)
```

**ルート CA / 中間 CA 証明書のインポート**:

1. MMC 証明書スナップイン（ローカルコンピュータ）を開く
2. ルート CA 証明書 → `Trusted Root Certification Authorities` → `Certificates` にインポート
3. 中間 CA 証明書 → `Intermediate Certification Authorities` → `Certificates` にインポート
4. **Connection Server サービスを再起動**
5. Horizon Web Client（HTML Access）使用時は **Blast Secure Gateway サービス** も再起動

---

## 多要素認証（MFA）の実装

### MFA 方式の比較

| 方式 | 認証要素 | プロトコル/ポート | 主な設定場所 | ユースケース |
|---|---|---|---|---|
| **SAML 2.0** | Federation（IdP トークン） | HTTPS / 443 | CS Authentication タブ | Workspace ONE Access 連携、SSO |
| **RADIUS** | OTP / Push / SMS | UDP / 1812 | CS Authentication タブ | サードパーティ MFA（Duo, Azure MFA 等） |
| **RSA SecurID** | ハードウェア/ソフトウェアトークン | RSA プロトコル | CS Authentication タブ + `sdconf.rec` | RSA Authentication Manager 環境 |
| **Smart Card** | X.509 クライアント証明書 | TLS クライアント認証 | CS Authentication タブ + Truststore | PKI 基盤が整備された組織（政府機関等） |

### SAML Authenticator の設定

**Connection Server 側の設定**:

1. Horizon Console → **Settings** → **Servers** → **Connection Servers** タブ
2. 対象 CS を選択 → **Edit** → **Authentication** タブ
3. **Delegation of authentication to Omnissa Horizon (SAML 2.0 Authenticator)** で以下を選択:

| オプション | 動作 |
|---|---|
| **Disabled** | SAML 認証無効。Horizon Client からのみ接続可 |
| **Enabled** | SAML 認証有効。Horizon Client と Workspace ONE Access の両方から接続可 |
| **Required** | SAML 認証必須。Workspace ONE Access / サードパーティ IdP 経由のみ接続可 |

4. **Manage SAML Authenticators** → **Add** をクリック
5. Authenticator の設定:

| フィールド | 説明 |
|---|---|
| **Type** | `Dynamic`（Workspace ONE Access）/ `Static`（UAG / サードパーティ） |
| **Label** | 一意の識別名 |
| **Metadata URL** | Dynamic の場合: `https://<WS1_FQDN>/SAAS/API/1.0/GET/metadata/idp.xml` |
| **SAML Metadata** | Static の場合: UAG / サードパーティから生成したメタデータをペースト |
| **Enabled for Connection Server** | チェックで有効化 |
| **Require Encrypted Assertion** | IdP が暗号化アサーションを送信する場合にチェック（2412 以降） |

**IdP 側の設定**（Workspace ONE Access / サードパーティ）:

- Service Provider（SP）Metadata の取得: `https://<CS_FQDN>/SAML/metadata/sp.xml`
- SP Entity ID / Assertion Consumer Service URL の設定

**認証フロー**:

```
User → Horizon Client → Connection Server
                              ↓ (SAML AuthnRequest)
                         Identity Provider (IdP)
                              ↓ (ユーザー認証)
                         IdP → SAML Assertion → CS
                              ↓ (アサーション検証)
                         CS → デスクトップ/アプリ起動
```

> **Pod レベル SAML 構成**（2412 以降）: Pod 内のすべての CS に統一 SAML 設定を適用可能。`vdm.enc` 暗号化証明書は全 CS で共通である必要がある。

### RADIUS 認証の設定

**前提条件**:
- RADIUS サーバ（NPS, FreeRADIUS, Duo Authentication Proxy 等）が稼働中
- Connection Server を RADIUS クライアントとして登録済み
- Shared Secret を設定済み

**Connection Server での設定手順**:

1. Horizon Console → **Settings** → **Servers** → **Connection Servers** タブ
2. 対象 CS を選択 → **Edit** → **Authentication** タブ
3. **2-factor authentication** ドロップダウンから **RADIUS** を選択
4. **Enforce 2-factor and Windows user name matching** を必要に応じて有効化
5. **Create New Authenticator** で以下を設定:

| フィールド | 値 |
|---|---|
| **Hostname/Address** | RADIUS サーバの FQDN または IP |
| **Authentication Port** | `1812`（デフォルト） |
| **Accounting Port** | `0`（課金不要の場合） |
| **Authentication Type** | `PAP` / `CHAP` / `MS-CHAPv1` / `MS-CHAPv2` |
| **Shared Secret** | RADIUS サーバと同一の共有シークレット |
| **Server Timeout** | 秒単位（デフォルト: 5 秒、Push 通知使用時は 60 秒推奨） |
| **Max Retries** | リトライ回数 |
| **Realm Prefix / Suffix** | 必要に応じてドメイン修飾（例: `DOMAIN-A\` / `@mycorp.com`） |

6. **Secondary Authenticator** で冗長構成が可能

**RADIUS 認証フロー**:

```
User → Horizon Client → Connection Server
                              ↓ (Access-Request)
                         RADIUS Server
                              ↓ (チャレンジ/認証)
                         RADIUS → Access-Accept/Reject → CS
                              ↓
                         CS → AD 認証 → デスクトップ起動
```

**トラブルシューティング**:
- **Access Denied**: CS が RADIUS クライアントとして登録されていない、または Shared Secret の不一致
- **タイムアウト**: ファイアウォールで UDP 1812 がブロックされている

### RSA SecurID の設定

1. Horizon Console → **Settings** → **Servers** → **Connection Servers** タブ
2. 対象 CS → **Edit** → **Authentication** タブ
3. **2-factor authentication** → **RSA SecureID** を選択
4. **Upload File** で RSA Authentication Manager からエクスポートした **`sdconf.rec`** ファイルをアップロード
5. **Enforce SecurID and Windows user name matching** を必要に応じて有効化

**`sdconf.rec` ファイル**:
- RSA Authentication Manager からエクスポート
- Connection Server ごとに個別のファイルが必要
- 配置場所: Horizon Console からアップロード（手動配置は不要）

**トラブルシューティング**:
- **Node Verification Failed**: Authentication タブで **Clear node secret** をチェック → RSA Authentication Manager 側で Agent Host の **Node Secret Created** チェックボックスを解除

### Smart Card 認証の設定

**Connection Server 側の設定**:

1. **CA 証明書の取得**: Smart Card 発行 CA のルート / 中間 CA 証明書を取得

2. **Truststore ファイルへの CA 証明書追加**:
   - `keytool` コマンドで Truststore ファイルに CA 証明書をインポート
   - Truststore ファイルを Connection Server の設定ディレクトリに配置

3. **Connection Server 構成プロパティの変更**:
   - `locked.properties` ファイルで Truststore のパスとパスワードを設定

4. **Horizon Console での Smart Card 設定**:
   - **Settings** → **Servers** → CS 選択 → **Edit** → **Authentication** タブ
   - **Smart card authentication** を以下から選択:

| オプション | 動作 |
|---|---|
| **Not allowed** | Smart Card 認証無効 |
| **Optional** | Smart Card またはパスワードで認証可 |
| **Required** | Smart Card 認証必須（パスワード認証不可） |

5. **証明書認証マッピングの構成**:
   - **Global Settings** → **Security Settings** → **Certificate Authentication**
   - マッピングオプション: **SID**（推奨）、**Custom Alt Security ID**、**UPN + Legacy**
   - 優先順位: SID > Custom > UPN (Legacy)

**CRL / OCSP による失効確認**:

| 方式 | 説明 | 設定箇所 |
|---|---|---|
| **CRL** | 証明書失効リストによるオフライン検証 | `locked.properties` で `enableRevocationChecking=true` |
| **OCSP** | リアルタイムの失効ステータス確認 | `locked.properties` で `enableOCSP=true`、`ocspURL=<URL>` |
| **CRL Prefetch** | CDP URL にアクセスできない場合のプリフェッチ | Horizon Console → Global Settings → Security Settings |

**CRL Prefetch 設定**:
- **Horizon CRL Prefetcher** サービスを構成（インターネット経由で CDP にアクセスできるサービスアカウントを使用）
- 更新期間: デフォルト 60 分
- 最大ファイルサイズ: デフォルト 1024 KB

---

## CS と UAG を使用した二要素認証

### UAG での証明書認証 vs CS での証明書認証

| 項目 | UAG での認証 | CS での認証 |
|---|---|---|
| **認証実行場所** | DMZ（UAG アプライアンス） | 内部ネットワーク（Connection Server） |
| **設定場所** | UAG Admin UI → Authentication Settings | Horizon Console → CS → Authentication タブ |
| **CA 証明書の保存** | UAG に PEM 形式でアップロード | CS の Truststore ファイル（JKS） |
| **利点** | DMZ で認証完了、内部ネットワークへの未認証トラフィック遮断 | 既存 PKI 基盤との統合が容易 |
| **推奨ケース** | 外部アクセス時（インターネット経由） | 内部アクセス時（LAN 内） |

### UAG での認証方式設定

UAG Admin UI → **Configure Manually** → **Authentication Settings** で以下を設定可能:

| 認証方式 | UAG 設定項目 |
|---|---|
| **Certificate** | X.509 Certificate → CA 証明書アップロード、CRL/OCSP 設定 |
| **RADIUS** | RADIUS Server / Port / Shared Secret / Auth Type |
| **RSA SecurID** | Access Key / Server URL / sdconf.rec 相当の設定 |
| **SAML** | IdP Metadata アップロード、SP Metadata 生成 |

### UAG + CS の二要素認証フロー

**パターン 1: Certificate（UAG）+ SAML（UAG → CS）**

```
User → Horizon Client
  ↓ TLS Client Certificate
UAG (証明書認証: 第1要素)
  ↓ SAML Assertion 生成
CS (SAML 検証: 第2要素)
  ↓ AD 認証
Desktop / App 起動
```

**パターン 2: RADIUS（UAG）+ AD Password（CS）**

```
User → Horizon Client
  ↓ OTP / Push
UAG (RADIUS 認証: 第1要素)
  ↓ 認証成功後に AD 認証情報を転送
CS (AD 認証: 第2要素)
  ↓
Desktop / App 起動
```

**パターン 3: Certificate（UAG）+ RADIUS（UAG）**

```
User → Horizon Client
  ↓ TLS Client Certificate + OTP
UAG (証明書認証: 第1要素、RADIUS: 第2要素)
  ↓ 両方成功後に CS へ転送
CS (AD 認証)
  ↓
Desktop / App 起動
```

### UAG と IdP（サードパーティ）の統合

**UAG 側の設定**:

1. **IdP で SAML アプリケーションを作成**:
   - Entity ID: `https://<UAG_FQDN>/portal`
   - ACS URL: `https://<UAG_FQDN>/portal/samlsso`
   - IdP メタデータをエクスポート

2. **UAG に IdP メタデータをアップロード**:
   - Admin UI → **Identity Provider Metadata** → Upload

3. **Horizon Settings で SAML 統合を有効化**:
   - **Auth Methods** で SAML を選択
   - **Identity Provider** から登録済み IdP を選択

**CS 側の設定**:
- UAG からの Static SAML Authenticator を登録
- CS の SP Metadata を UAG に設定

---

## セキュリティプロトコルと暗号スイートの構成

### デフォルトのグローバルポリシー

Horizon 8 2312.1 以降では **TLS 1.3** が推奨プロトコル。Connection Server のセキュリティプロトコルと暗号スイートはグローバルポリシーとサーバ個別ポリシーの 2 レベルで構成可能。

| プロトコル | デフォルト暗号スイート |
|---|---|
| **TLS 1.3** | `TLS_AES_128_GCM_SHA256`, `TLS_AES_256_GCM_SHA384` |
| **TLS 1.2** | `TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256`, `TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384` |

**無効化されているプロトコル**: SSLv3, TLSv1.0, TLSv1.1, RC4, DHE 暗号スイート（PFS なしの暗号含む）

### グローバルポリシーの変更（ADSI Edit）

**LDAP パス**: `cn=common,ou=global,ou=properties,dc=vdi,dc=horizon,dc=internal`

| LDAP 属性 | 説明 |
|---|---|
| `pae-ServerSSLSecureProtocols` | 承諾ポリシーのプロトコルリスト（例: `\LIST:TLSv1.3,TLSv1.2`） |
| `pae-ServerSSLCipherSuites` | 承諾ポリシーの暗号スイートリスト |
| `pae-ClientSSLSecureProtocols` | 提案ポリシーのプロトコルリスト |
| `pae-ClientSSLCipherSuites` | 提案ポリシーの暗号スイートリスト |
| `pae-SSLNamedGroups` | 名前付きグループ（楕円曲線、DH グループ） |

### サーバ個別の承諾ポリシー（locked.properties）

**ファイルパス**: `install_directory\Omnissa\Horizon\Server\sslgateway\conf\locked.properties`

```ini
secureProtocols.1=TLSv1.3
preferredSecureProtocol=TLSv1.3
enabledCipherSuite.1=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
enabledCipherSuite.2=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
honorClientOrder=true
```

> **試験ポイント**: CS のセキュリティ設定は **BSG には適用されない**。BSG は `absg.properties` で個別に構成する必要がある。

### BSG（Blast Secure Gateway）の暗号構成

**ファイルパス**: `install_directory\Omnissa\Horizon\Server\appblastgateway\absg.properties`

| プロパティ | 説明 |
|---|---|
| `localHttpsProtocolLow` | 最低プロトコル（例: `tls1.2`） |
| `localHttpsProtocolHigh` | 最高プロトコル（例: `tls1.3`） |
| `localHttpsCipherSpec` | 暗号スイートリスト（OpenSSL 形式） |

### PSG（PCoIP Secure Gateway）の暗号構成

PSG は GPO で構成: `Computer Configuration` → `Administrative Templates` → `PCoIP Session Variables` → `Overridable Administrator Defaults`

- **Configure SSL Protocols** / **Configure SSL cipher list** / **Configure SSL ciphersuites for TLS1.3**（2312 以降）

---

## メッセージセキュリティモード（JMS）

Horizon コンポーネント間の JMS メッセージの保護レベルを制御する設定。

**設定パス**: Horizon Console → **Settings** → **Global Settings** → **Security Settings** → **Message Security Mode**

| モード | 動作 | 推奨 |
|---|---|---|
| **Disabled** | メッセージセキュリティ無効 | 非推奨 |
| **Mixed** | 署名付きだが検証は強制しない | アップグレード時の一時的使用のみ |
| **Enabled** | メッセージ署名・検証を強制。TLS と非 TLS の混在を許容 | — |
| **Enhanced** | 全 JMS 接続に TLS を使用。証明書は自動管理 | **推奨（新規インストールのデフォルト）** |

> **試験ポイント**: 新規インストールのデフォルトは **Enhanced**。アップグレード時は既存設定を維持。Enhanced への変更後は全 CS の **Horizon Message Bus Component** サービスの再起動が必要。

**vdmutil による監視**:

```powershell
vdmutil --getMsgSecMode --authAs admin --authDomain corp.local --authPassword *
vdmutil --getMsgSecLevel --authAs admin --authDomain corp.local --authPassword *
```

---

## TLS オフロード

ロードバランサや中間サーバに TLS を終端させ、CS への接続を非 TLS にする構成。

**手順**:

1. 中間サーバから TLS 証明書とプライベートキーをダウンロード
2. PKCS#12 形式に変換（`openssl pkcs12` コマンド）
3. Windows Certificate Store にインポート → フレンドリ名 `vdm` を設定
4. ルート/中間 CA 証明書をインポート
5. CS の外部 URL を TLS オフロードサーバの URL に設定
6. `locked.properties` で `allowHttpNonTunnel=true` を設定し、中間サーバからの HTTP 接続を許可

---

## TrueSSO（証明書ベース SSO）

SAML 認証後に Windows デスクトップへのパスワードレスログオンを実現する仕組み。

**コンポーネント**: Enrollment Server + Microsoft CA + Connection Server + Horizon Agent

**フロー**:

```
Horizon Client → IdP (SAML 認証) → CS (SAML Assertion 検証)
                                       ↓
                              Enrollment Server → Microsoft CA
                                       ↓ (短期証明書発行)
                              CS → Horizon Agent (証明書でログイン)
```

**ポート**: CS → Enrollment Server: TCP 32111 / Enrollment Server → CA: TCP 135 + 動的ポート

---

## セキュリティ関連のグローバル設定

Horizon Console → **Settings** → **Global Settings** → **Security Settings** で設定可能な主要項目:

| 設定 | 説明 | デフォルト |
|---|---|---|
| **SSO 認証情報の破棄** | ログイン後一定時間で SSO 認証情報を破棄。内部/外部接続に個別適用可 | 15 分後 |
| **ユーザーの強制切断** | ログイン後指定時間で全セッション切断 | 600 分 |
| **ネットワーク割り込み後の再認証** | セキュアトンネル使用時、ネットワーク中断後に再認証を要求 | 無効 |
| **View Administrator セッションタイムアウト** | Console のアイドルタイムアウト | 30 分 |

---

## UAG の OIDC 認証

UAG 2303 以降では **OpenID Connect (OIDC)** 認証をサポート。

| 項目 | 説明 |
|---|---|
| **Auth Methods** | UAG Horizon Settings → Auth Methods で `OIDC` を選択 |
| **OIDC Configuration ID** | 構成済み OIDC プロバイダの名前を指定 |
| **対応 IdP** | Okta, Azure AD, PingFederate 等の OIDC 準拠 IdP |

---

## UAG の Endpoint Compliance Check

UAG は **OPSWAT MetaDefender** と統合し、エンドポイントのコンプライアンスチェックを実行可能。

| 設定 | 説明 |
|---|---|
| **Endpoint Compliance Check Provider** | UAG Horizon Settings → `OPSWAT` を選択 |
| **Compliance Check on Authentication** | 認証時にコンプライアンスチェックを実行（デフォルト有効） |
| **定期チェック** | セッション中に定期的にエンドポイントコンプライアンスを再チェック |

---

## UAG の BSG Feature List（機能制御）

UAG の Horizon Settings で BSG を通過するリモートエクスペリエンス機能を個別に制御可能。

| 機能名 | Standard Feature Name |
|---|---|
| Clipboard Redirection | `MKSCchan` |
| CDR | `tsdr` |
| USB Redirection | `UsbRedirection` |
| Printer Redirection | `PrintRedir` |
| Scanner Redirection | `NLR3hv;NLW3hv` |
| FIDO2 Redirection | `fido2` |
| SDR（Storage Drive Redirection） | `SDRTrans` |

> **試験ポイント**: BSG Feature List が構成されている場合、リストに含まれる機能 **のみ** 許可され、それ以外は **すべてブロック** される。未構成の場合は全機能が許可される。

---

## Horizon 2412 のセキュリティ新機能

| 機能 | 説明 |
|---|---|
| **Automated Keylogger Protection** | Agent 側でポリシーを有効にすると、Client が自動的にキーロガーブロック有効化の手順をエンドユーザーにプロンプト表示 |
| **FIDO2 WebAuthn for Linux Client** | Linux Client でローカルエンドポイントの FIDO2 コンポーネントをリモートセッションで利用可能 |
| **Pod-level SAML Configuration** | Pod 内の全 CS に統一 SAML 設定を適用可能。`vdm.enc` 暗号化証明書は全 CS で共通である必要がある |
| **Require Encrypted Assertion** | SAML Authenticator で暗号化アサーションの要求を設定可能 |

---

## ベストプラクティス

- 本番環境では **自己署名証明書を使用しない**。CA 署名付き証明書に速やかに置き換える
- 証明書の **有効期限を監視** し、期限切れ前に更新する計画を策定する
- フレンドリ名 `vdm` は **1 つの証明書のみ** に設定する（重複は認識エラーの原因）
- SAML Authenticator の **メタデータ有効期限** はデフォルト 24 時間。ADSI Edit で `cs-samlencryptionkeyvaliditydays` と `cs-samlsigningkeyvaliditydays` を延長する
- RADIUS のタイムアウト値は **Push 通知型 MFA の場合 60 秒以上** に設定する
- UAG で認証を行う場合、**CS 側でも同じ認証方式を重複設定しない**（二重認証プロンプトの原因）
- Smart Card 認証を **Required** に設定すると **Unauthenticated Access が無効** になる
- メッセージセキュリティモードは **Enhanced** を使用する（新規インストールのデフォルト）
- BSG と PSG の暗号スイートは CS とは **個別に構成** する必要がある
- UAG の **Endpoint Compliance Check** を有効にし、管理外デバイスからのアクセスを制限する
- **TLS 1.3** を有効にし、TLS 1.0/1.1 は無効のままにする

## アンチパターン

| やってはいけないこと | 理由 |
|---|---|
| KeyLength を 1024 未満で生成 | Horizon Client が証明書を検証できず接続失敗 |
| フレンドリ名を大文字「VDM」で設定 | CS が証明書を認識しない |
| IP アドレスを Subject (CN) に使用 | セキュリティ推奨事項違反、証明書検証エラーの原因 |
| UAG と CS の両方で RADIUS を設定 | ユーザーに二重のトークン入力プロンプトが表示される |
| `sdconf.rec` を複数 CS で共有 | Node Verification Failed エラーの原因 |
| CRL/OCSP を設定せずに Smart Card を Required にする | 失効した証明書でもアクセス可能になる |
| CS のセキュリティ設定変更で BSG も更新されると思い込む | BSG は `absg.properties` で個別に構成が必要 |
| Enhanced モードへの変更後に Message Bus サービスを再起動しない | 移行が完了せず Mixed 状態のまま停滞する |
| TLS 1.0/1.1 を有効のまま運用 | 既知の脆弱性（RFC 8996）により非推奨 |

---

## 理解度チェックリスト

### SSL/TLS 証明書

- [ ] `certreq` ユーティリティを使用した CSR 生成手順を説明できる
- [ ] `request.inf` の主要パラメータ（KeyLength, HashAlgorithm, KeyUsage, EKU）の意味を理解している
- [ ] 証明書のフレンドリ名「vdm」の設定手順と注意点を説明できる
- [ ] 証明書チェーン構成（Root CA → Intermediate → Server Cert）を理解している
- [ ] SAN 証明書とワイルドカード証明書の違いと使い分けを説明できる
- [ ] Horizon Console からの CSR 生成手順（2312 以降）を理解している
- [ ] セキュリティプロトコルと暗号スイートのデフォルト構成（TLS 1.3/1.2）を理解している
- [ ] `locked.properties` と `absg.properties` の役割と設定方法を説明できる
- [ ] メッセージセキュリティモードの 4 つのオプションとその違いを説明できる
- [ ] TLS オフロードの構成手順を理解している

### MFA 実装

- [ ] SAML Authenticator の設定手順（Dynamic / Static の違いを含む）を説明できる
- [ ] RADIUS 認証の設定パラメータ（Port, Auth Type, Shared Secret, Timeout）を理解している
- [ ] RSA SecurID の設定における `sdconf.rec` ファイルの役割を説明できる
- [ ] Smart Card 認証の設定手順（Truststore, CRL/OCSP, 証明書マッピング）を説明できる
- [ ] UAG と CS での認証設定の違いを理解している
- [ ] UAG + CS の二要素認証フロー（Certificate + SAML, Certificate + RADIUS）を説明できる
- [ ] 各 MFA 方式の特徴と使い分け（比較表の内容）を理解している
- [ ] UAG の OIDC 認証と Endpoint Compliance Check の概要を理解している
- [ ] TrueSSO のフローと必要コンポーネント（Enrollment Server, Microsoft CA）を説明できる
- [ ] BSG Feature List による機能制御の仕組みを説明できる
