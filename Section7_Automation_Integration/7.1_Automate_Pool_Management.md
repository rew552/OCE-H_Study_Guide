# 7.1 Automate Pool Management

## 概要

プール管理の自動化は、Horizon環境の効率的な運用に重要です。OCE-Hレベルでは、APIベースの統合を使用したプール管理の自動化、スクリプトの作成、エラーハンドリングが求められます。

## 学習目標

このセクションを学習することで、以下のことができるようになります：

- Horizon REST APIの使用方法を理解している
- APIベースのプール管理の自動化ができる
- 自動化スクリプトの作成ができる
- 適切なエラーハンドリングとリトライロジックを実装できる

## 関連リソース

- [クイックリファレンス](../../00_Quick_Reference.md) - ポート番号、設定値、制限値
- [用語集](../../README.md#用語集) - 関連用語の定義
- [2.2 Desktop Pools](../../Section2_Desktop_Application_Profile_Management/2.2_Desktop_Pools.md) - デスクトッププール
- [実環境シナリオ](../../00_Scenarios/Section7_Scenarios.md) - 実環境でのシナリオ例

## Horizon REST APIの概要

### APIエンドポイント

**ベースURL**:
```
https://<Connection Server FQDN>/rest/api/v1/
```

**主要なエンドポイント**:
- `/pools`: プール管理
- `/sessions`: セッション管理
- `/machines`: 仮想マシン管理
- `/entitlements`: エンタイトルメント管理

### 認証方法

#### Basic認証

**設定方法**:
```powershell
# Basic認証のヘッダー作成
$username = "administrator"
$password = "SecurePassword123!"
$base64AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${username}:${password}"))
$headers = @{
    "Authorization" = "Basic $base64AuthInfo"
    "Content-Type" = "application/json"
}
```

#### SAML認証

**設定方法**:
1. SAML認証を有効化
2. アクセストークンを取得
3. トークンをヘッダーに含める

## プール管理APIの使用

### プール情報の取得

**API呼び出し**:
```powershell
# すべてのプール情報を取得
$uri = "https://horizon.contoso.com/rest/api/v1/pools"
$response = Invoke-RestMethod -Uri $uri -Headers $headers -Method Get
$response | ConvertTo-Json -Depth 10
```

**特定のプール情報を取得**:
```powershell
# プールIDを指定
$poolId = "pool-123"
$uri = "https://horizon.contoso.com/rest/api/v1/pools/$poolId"
$response = Invoke-RestMethod -Uri $uri -Headers $headers -Method Get
```

### プールの作成

**リクエストボディの例**:
```json
{
  "name": "VDI-Pool-Development",
  "displayName": "Development Desktop Pool",
  "description": "Development team desktop pool",
  "type": "AUTOMATED",
  "userAssignment": "DEDICATED",
  "source": "INSTANT_CLONE_ENGINE",
  "parentVmId": "vm-123",
  "snapshotId": "snapshot-456",
  "vmNaming": {
    "namingPattern": "VDI-DEV-{n:fixed=3}",
    "maxNamingLength": 15
  },
  "vmTemplate": {
    "cpuCount": 2,
    "memoryMB": 4096,
    "disk": [
      {
        "capacityGB": 60
      }
    ]
  },
  "automatedDesktopSettings": {
    "minReady": 1,
    "maxDesktops": 100,
    "powerPolicy": "POWER_ON"
  }
}
```

**PowerShellスクリプト例**:
```powershell
# プール作成のリクエストボディ
$poolConfig = @{
    name = "VDI-Pool-Development"
    displayName = "Development Desktop Pool"
    type = "AUTOMATED"
    userAssignment = "DEDICATED"
    source = "INSTANT_CLONE_ENGINE"
    parentVmId = "vm-123"
    snapshotId = "snapshot-456"
    vmNaming = @{
        namingPattern = "VDI-DEV-{n:fixed=3}"
        maxNamingLength = 15
    }
    vmTemplate = @{
        cpuCount = 2
        memoryMB = 4096
        disk = @(
            @{
                capacityGB = 60
            }
        )
    }
    automatedDesktopSettings = @{
        minReady = 1
        maxDesktops = 100
        powerPolicy = "POWER_ON"
    }
} | ConvertTo-Json -Depth 10

# プールを作成
$uri = "https://horizon.contoso.com/rest/api/v1/pools"
$response = Invoke-RestMethod -Uri $uri -Headers $headers -Method Post -Body $poolConfig
```

### プールの更新

**更新例**:
```powershell
# プール設定の更新
$poolId = "pool-123"
$updateConfig = @{
    displayName = "Updated Development Desktop Pool"
    automatedDesktopSettings = @{
        minReady = 2
        maxDesktops = 150
    }
} | ConvertTo-Json -Depth 10

$uri = "https://horizon.contoso.com/rest/api/v1/pools/$poolId"
$response = Invoke-RestMethod -Uri $uri -Headers $headers -Method Put -Body $updateConfig
```

### プールの削除

**削除例**:
```powershell
# プールの削除
$poolId = "pool-123"
$uri = "https://horizon.contoso.com/rest/api/v1/pools/$poolId"
$response = Invoke-RestMethod -Uri $uri -Headers $headers -Method Delete
```

> [!IMPORTANT]
> プールの削除は、すべてのVMとエンタイトルメントも削除します。実行前に十分に確認してください。

## 自動化スクリプトの作成

### プール作成スクリプト

**完全なスクリプト例**:
```powershell
# Horizon Pool Creation Script
param(
    [Parameter(Mandatory=$true)]
    [string]$ConnectionServer,
    
    [Parameter(Mandatory=$true)]
    [string]$Username,
    
    [Parameter(Mandatory=$true)]
    [string]$Password,
    
    [Parameter(Mandatory=$true)]
    [string]$PoolName,
    
    [Parameter(Mandatory=$true)]
    [string]$ParentVmId,
    
    [Parameter(Mandatory=$true)]
    [string]$SnapshotId
)

# 認証ヘッダーの作成
$base64AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${Username}:${Password}"))
$headers = @{
    "Authorization" = "Basic $base64AuthInfo"
    "Content-Type" = "application/json"
}

# プール設定
$poolConfig = @{
    name = $PoolName
    displayName = $PoolName
    type = "AUTOMATED"
    userAssignment = "FLOATING"
    source = "INSTANT_CLONE_ENGINE"
    parentVmId = $ParentVmId
    snapshotId = $SnapshotId
    vmNaming = @{
        namingPattern = "$PoolName-{n:fixed=3}"
        maxNamingLength = 15
    }
    vmTemplate = @{
        cpuCount = 2
        memoryMB = 4096
        disk = @(
            @{
                capacityGB = 60
            }
        )
    }
    automatedDesktopSettings = @{
        minReady = 1
        maxDesktops = 50
        powerPolicy = "POWER_ON"
    }
} | ConvertTo-Json -Depth 10

# プールを作成
try {
    $uri = "https://$ConnectionServer/rest/api/v1/pools"
    $response = Invoke-RestMethod -Uri $uri -Headers $headers -Method Post -Body $poolConfig
    Write-Host "Pool created successfully: $($response.id)" -ForegroundColor Green
    return $response
} catch {
    Write-Host "Error creating pool: $($_.Exception.Message)" -ForegroundColor Red
    throw
}
```

### プール状態監視スクリプト

**監視スクリプト例**:
```powershell
# Pool Status Monitoring Script
param(
    [Parameter(Mandatory=$true)]
    [string]$ConnectionServer,
    
    [Parameter(Mandatory=$true)]
    [string]$Username,
    
    [Parameter(Mandatory=$true)]
    [string]$Password
)

# 認証ヘッダーの作成
$base64AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${Username}:${Password}"))
$headers = @{
    "Authorization" = "Basic $base64AuthInfo"
    "Content-Type" = "application/json"
}

# すべてのプール情報を取得
$uri = "https://$ConnectionServer/rest/api/v1/pools"
$pools = Invoke-RestMethod -Uri $uri -Headers $headers -Method Get

# 各プールの状態を表示
foreach ($pool in $pools) {
    Write-Host "Pool: $($pool.displayName)" -ForegroundColor Cyan
    Write-Host "  ID: $($pool.id)"
    Write-Host "  Type: $($pool.type)"
    Write-Host "  Status: $($pool.status)"
    Write-Host "  Desktops: $($pool.automatedDesktopSettings.maxDesktops)"
    Write-Host ""
}
```

## エラーハンドリング

### エラー処理の実装

**エラーハンドリング例**:
```powershell
function Invoke-HorizonAPI {
    param(
        [string]$Uri,
        [hashtable]$Headers,
        [string]$Method = "Get",
        [object]$Body = $null
    )
    
    try {
        $params = @{
            Uri = $Uri
            Headers = $Headers
            Method = $Method
        }
        
        if ($Body) {
            $params.Body = $Body
        }
        
        $response = Invoke-RestMethod @params
        return $response
    } catch {
        $errorResponse = $_.ErrorDetails.Message | ConvertFrom-Json
        Write-Host "API Error: $($errorResponse.error_code) - $($errorResponse.error_message)" -ForegroundColor Red
        throw
    }
}
```

### リトライロジック

**リトライ実装例**:
```powershell
function Invoke-HorizonAPIWithRetry {
    param(
        [string]$Uri,
        [hashtable]$Headers,
        [string]$Method = "Get",
        [object]$Body = $null,
        [int]$MaxRetries = 3,
        [int]$RetryDelay = 5
    )
    
    $retryCount = 0
    while ($retryCount -lt $MaxRetries) {
        try {
            return Invoke-HorizonAPI -Uri $Uri -Headers $Headers -Method $Method -Body $Body
        } catch {
            $retryCount++
            if ($retryCount -ge $MaxRetries) {
                throw
            }
            Write-Host "Retry attempt $retryCount of $MaxRetries after $RetryDelay seconds..." -ForegroundColor Yellow
            Start-Sleep -Seconds $RetryDelay
        }
    }
}
```

## ベストプラクティス

1. **セキュリティ**
   - API認証情報の安全な管理（環境変数、シークレット管理）
   - 最小権限の原則
   - APIアクセスの監査

2. **エラーハンドリング**
   - 適切なエラーハンドリング
   - リトライロジックの実装
   - ログ記録

3. **パフォーマンス**
   - バッチ処理の使用
   - 非同期処理の検討
   - レート制限の考慮

4. **ドキュメント**
   - スクリプトのドキュメント化
   - API使用例の記録
   - 変更履歴の管理

> [!WARNING]
> API認証情報は、スクリプトにハードコードしないでください。環境変数やシークレット管理ツールを使用してください。

## トラブルシューティング

### 一般的な問題

**認証エラー**:
- 認証情報の確認
- アカウントの権限確認
- 証明書の検証

**APIエラー**:
- エラーメッセージの確認
- APIバージョンの確認
- リクエストボディの検証

## エラーハンドリングとリトライロジック

### エラーハンドリングの実装

**エラーハンドリングパターン**:
```powershell
# エラーハンドリングの例
function Invoke-HorizonAPI {
    param(
        [string]$Uri,
        [hashtable]$Headers,
        [string]$Method = "Get",
        [object]$Body = $null
    )
    
    $maxRetries = 3
    $retryDelay = 5
    
    for ($i = 1; $i -le $maxRetries; $i++) {
        try {
            if ($Body) {
                $response = Invoke-RestMethod -Uri $Uri -Headers $Headers -Method $Method -Body ($Body | ConvertTo-Json) -ErrorAction Stop
            } else {
                $response = Invoke-RestMethod -Uri $Uri -Headers $Headers -Method $Method -ErrorAction Stop
            }
            return $response
        } catch {
            if ($i -eq $maxRetries) {
                Write-Error "API call failed after $maxRetries retries: $($_.Exception.Message)"
                throw
            }
            Write-Warning "API call failed (attempt $i/$maxRetries): $($_.Exception.Message). Retrying in $retryDelay seconds..."
            Start-Sleep -Seconds $retryDelay
        }
    }
}
```

### リトライロジック

**指数バックオフ**:
```powershell
# 指数バックオフの実装
function Invoke-APIWithBackoff {
    param(
        [string]$Uri,
        [hashtable]$Headers
    )
    
    $maxRetries = 5
    $baseDelay = 1
    
    for ($i = 1; $i -le $maxRetries; $i++) {
        try {
            $response = Invoke-RestMethod -Uri $Uri -Headers $Headers -ErrorAction Stop
            return $response
        } catch {
            if ($i -eq $maxRetries) {
                throw
            }
            $delay = $baseDelay * [math]::Pow(2, $i - 1)
            Write-Warning "Retrying in $delay seconds (attempt $i/$maxRetries)..."
            Start-Sleep -Seconds $delay
        }
    }
}
```

## 理解度チェックリスト

以下の項目について理解度を確認してください：

### REST API
- [ ] Horizon REST APIの認証方法を理解している
- [ ] APIエンドポイントの使用方法を説明できる

### プール管理の自動化
- [ ] APIベースのプール作成方法を理解している
- [ ] プールの更新と削除方法を説明できる
- [ ] プール状態の監視方法を理解している

### エラーハンドリング
- [ ] 適切なエラーハンドリングの実装方法を説明できる
- [ ] リトライロジックの実装方法を理解している

## まとめ

プール管理の自動化は、Horizon環境の効率的な運用に重要です。Horizon REST APIの使用、自動化スクリプトの作成、適切なエラーハンドリングとリトライロジックにより、自動化されたプール管理環境を構築できます。
