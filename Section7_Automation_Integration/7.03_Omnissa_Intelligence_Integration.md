# 7.3 Integrate with Omnissa Intelligence (for Custom Reports)

## 試験ガイド対応 (Section 4.7.3)

- Deploy an Edge Gateway
- Install DEEM agent on Horizon agent VMs
- Login to connect.Omnissa.com. In Intelligence, go to Marketplace > Solutions > Experience Management. Activate the Virtual Desktop & Apps tile.

---

## 1. Deploy an Edge Gateway

### 1.1 Horizon Edge Gateway の概要

Horizon Edge Gateway Appliance は、オンプレミスの Horizon 8 環境を Horizon Cloud Service（Control Plane）に接続するための仮想アプライアンスである。サブスクリプションライセンスの有効化と、Omnissa Intelligence へのテレメトリデータ送信を担う。

**主な機能**

| 機能 | 説明 |
|------|------|
| ライセンス管理 | Horizon Subscription License の有効化（手動キー入力不要） |
| テレメトリ送信 | Horizon 環境のメトリクスを Horizon Cloud Service / Intelligence に送信 |
| 構成管理 | Horizon Universal Console からの一元管理を可能にする |

**アーキテクチャ上の位置付け**

```
Horizon Agent VM (DEEM) ──→ Connection Server ──→ Edge Gateway ──→ Horizon Cloud Service
                                                                      ├── Intelligence
                                                                      └── License Service
```

> **重要**: Edge Gateway Appliance は内部ネットワークセグメントにデプロイする。DMZ や外部公開ネットワークへのデプロイは非推奨。

### 1.2 前提条件

**インフラ要件**

| 要件 | 詳細 |
|------|------|
| プラットフォーム | vSphere 環境（OVA/OVF デプロイ） |
| Omnissa Connect アカウント | Horizon Universal Console へのアクセス権 |
| DNS | Edge Gateway の FQDN が Connection Server および UAG から内部解決できること |
| インターネット接続 | Edge Gateway → Horizon Cloud Control Plane DNS エントリへの HTTPS 疎通 |
| Pod 内疎通 | Edge Gateway → Connection Server 間のネットワーク疎通 |
| ライセンス | Horizon Subscription License（Horizon Plus / Universal License） |

**ネットワーク情報（OVF デプロイ時に必要）**

| 情報 | 説明 |
|------|------|
| IP Address | Edge Gateway の静的 IP |
| Subnet Mask | サブネットマスク |
| Default Gateway | デフォルトゲートウェイ |
| DNS Servers | DNS サーバーアドレス |
| Domain Name | ドメイン名 |
| NTP Server | 時刻同期サーバー |
| Root Password | アプライアンスの root パスワード |
| Pairing Key | Horizon Universal Console から取得する接続文字列 |

### 1.3 デプロイ手順

deploying_a_horizon_edge_gateway_for_horizon_8_environments.pdf に基づく手順。

#### Step 1: Horizon Universal Console でプロバイダー設定を作成

1. `https://connect.omnissa.com` にログイン（Omnissa Connect 資格情報）
2. **Horizon Cloud** → **Capacity** → **Horizon Edges** に移動
3. 構成ウィザードを開始し、以下の手順を完了:

| ステップ | 操作 |
|---------|------|
| 1 | Resource Capacity Provider の選択（**Horizon 8**） |
| 2 | 前提条件の確認 |
| 3 | **Horizon Edge 名** と説明の入力 |
| 4 | Capacity Type = **Private data center (vSphere)** を選択 |
| 5 | アプライアンスの **FQDN** を入力 |
| 6 | **OVA ファイルをダウンロード** |
| 7 | **Pairing Code（接続コード）** をコピーして保存 |
| 8 | **Save & Close** |

#### Step 2: OVA を vSphere にデプロイ

1. vSphere Client で対象のクラスター/ホストを右クリック → **Deploy OVF Template**
2. ダウンロードした OVA ファイルを選択
3. 以下の情報を入力:

| カテゴリ | 設定項目 | 説明 |
|---------|---------|------|
| Server Fields | Root Password | アプライアンス root パスワード |
| | Connection String / Pairing Code | Step 1 で取得した Pairing Code |
| Kubernetes | POD Network | Kubernetes Pod ネットワーク（デフォルト使用可） |
| | Service Network | Kubernetes Service ネットワーク |
| | Public Key for CCADMIN | CCADMIN 用公開鍵（任意） |
| Networking | Default Gateway | デフォルトゲートウェイ |
| | Domain Name | ドメイン名 |
| | Domain Search Path | ドメイン検索パス |
| | DNS Servers | DNS サーバー |
| | Network IP Address | アプライアンスの静的 IP |
| | Network Netmask | サブネットマスク |
| Proxy（Optional） | Proxy Host / Port / SSL | プロキシ使用時の設定 |

4. **Finish** をクリック → デプロイ完了を待機

> **重要**: デプロイ後、全サービスの起動・設定完了まで最大 **15分** かかる場合がある。接続成功時は Horizon Universal Console に通知が表示される。Pairing Code は一度しか使用できないため紛失しないこと。

#### Step 3: Connection Server への接続

1. Pairing プロセス完了後、Omnissa Connect コンソールに戻り **Refresh** をクリック
2. **Primary Connection Server の URL** を指定
3. Pod 内に複数の Connection Server がある場合、プライマリの1台のみ指定すればよい（他の CS は自動検出される）

#### Step 4: 接続確認

- Horizon Universal Console で Edge Gateway のステータスが **Connected** になることを確認
- Connection Server のライセンスが Subscription License で有効化されたことを確認

### 1.4 トラブルシューティング

Edge Gateway Appliance は Photon OS 上で動作し、Kubernetes コンテナで各種サービスを実行する。

**SSH アクセスによる診断**

```bash
# コンテナの状態確認
kubectl get pods -A

# 特定コンテナのログ取得
kubectl -n <namespace> logs <pod-name> > /tmp/edge-gw-logs.txt
```

**確認すべきポイント**

| ポッド | 確認事項 |
|-------|---------|
| `edgedevice-deployment` | READY、Running、Restarts = 0 |
| `view-cs-module-deployment` | READY、Running、Restarts = 0 |

---

## 2. Install DEEM Agent on Horizon Agent VMs

### 2.1 DEEM（Digital Employee Experience Management）の概要

DEEM Agent は Horizon Agent VM（デスクトップまたは RDSH サーバー）にインストールし、エンドユーザーのデジタル体験に関するテレメトリデータを収集する。収集されたデータは Omnissa Intelligence に送信され、Experience Score の算出やカスタムレポートの生成に活用される。

**収集するデータの例**

| カテゴリ | メトリクス |
|---------|----------|
| セッション | ログオン時間、セッション遅延、再接続時間 |
| プロトコル | Blast/PCoIP RTT、フレームレート、パケットロス |
| アプリケーション | アプリ起動時間、クラッシュ頻度、ハング時間 |
| OS | CPU/Memory/Disk 使用率、ブートタイム |
| ネットワーク | 帯域幅、レイテンシ、DNS 解決時間 |

### 2.2 Golden Image への組み込み手順

DEEM Agent は **Golden Image（マスターイメージ）** にインストールし、Instant Clone や Linked Clone で展開する全 VM に自動的に含まれるようにするのがベストプラクティスである。

#### Step 1: DEEM Agent のダウンロード

- Omnissa Customer Connect（`customerconnect.omnissa.com`）からダウンロード
- または Horizon Universal Console の Downloads セクションから取得
- インストーラーは `.msi` 形式

#### Step 2: Golden Image VM でのインストール

1. Golden Image VM にログイン（管理者権限）
2. DEEM Agent インストーラーを実行

**サイレントインストールコマンド**

```cmd
msiexec /i "DEEMAgent.msi" /qn REBOOT=ReallySuppress
```

**インストール時の構成パラメータ**

| パラメータ | 説明 | 例 |
|-----------|------|-----|
| `/qn` | サイレントインストール | — |
| `REBOOT=ReallySuppress` | 再起動を抑制 | — |

#### Step 3: インストールの確認

```powershell
# DEEM Agent サービスの状態確認
Get-Service -Name "Omnissa DEEM" | Format-Table Name, Status, StartType

# Agent のバージョン確認
Get-ItemProperty "HKLM:\SOFTWARE\Omnissa\DEEM" | Select-Object Version
```

#### Step 4: Golden Image のスナップショット取得

- DEEM Agent インストール後に新しいスナップショットを取得
- このスナップショットを使って Instant Clone プールの Push Image を実行

### 2.3 DEEM テレメトリデータのフロー

DEEM Agent が収集したテレメトリデータは以下の経路で Intelligence に送信される。

```
DEEM Agent (VM) → Horizon Agent → Connection Server → Edge Gateway → Horizon Cloud Service → Intelligence
```

| フェーズ | コンポーネント | 動作 |
|---------|-------------|------|
| 収集 | DEEM Agent | セッション、プロトコル、アプリ、OS メトリクスを収集 |
| 中継 | Horizon Agent → Connection Server | テレメトリデータを Connection Server に転送 |
| 送信 | Edge Gateway | データを Horizon Cloud Control Plane に HTTPS で送信 |
| 処理 | Intelligence | データを分析し、Experience Score を算出。ダッシュボードに表示 |

> **重要**: DEEM データの送信には Edge Gateway が必須。Edge Gateway が接続されていない、または HTTPS 通信がブロックされている場合、Intelligence にデータは到達しない。

### 2.4 既存 VM への展開

既存のデスクトッププールに DEEM Agent を展開する場合は、以下の方法が利用できる。

| 方法 | 適用場面 |
|------|---------|
| Golden Image 更新 + Push Image | Instant Clone プール（推奨） |
| GPO ソフトウェア配布 | 管理対象 VM への一括展開 |
| SCCM / UEM 配布 | エンタープライズ配布基盤経由 |
| App Volumes Package | App Volumes で DEEM Agent をパッケージとして配信 |

> **重要**: DEEM Agent は Golden Image にインストールするのがベストプラクティス。Instant Clone 環境では、Push Image 実行時にすべてのクローン VM に自動的に反映される。

---

## 3. Intelligence Console での設定手順

### 3.0 前提条件の確認

Experience Management のアクティベーション前に以下が完了していることを確認する。

| 前提条件 | 確認方法 |
|---------|---------|
| Edge Gateway がデプロイ済み | Horizon Universal Console で Status = Connected |
| Edge Gateway → Control Plane の HTTPS 通信 | ファイアウォールで必要な URL が許可されていること |
| DEEM Agent がインストール済み | Agent VM で `Get-Service -Name "Omnissa DEEM"` |
| Horizon Subscription License | Connection Server がサブスクリプションライセンスで有効化済み |
| Omnissa Connect アカウント | Intelligence へのアクセス権限を持つアカウント |

### 3.1 Marketplace での Experience Management アクティベーション

試験ガイドで指定された手順に基づく。

#### Step 1: connect.omnissa.com にログイン

1. ブラウザで `https://connect.omnissa.com` にアクセス
2. Omnissa Connect の資格情報でログイン（管理者権限が必要）

#### Step 2: Intelligence に移動

1. ナビゲーションから **Intelligence** を選択
2. Intelligence Dashboard が表示される

> **注意**: Intelligence と Access のテナントは同一リージョンに存在する必要がある。異なるリージョンの場合、統合が完了しない。

#### Step 3: Marketplace → Solutions → Experience Management

1. 左側メニューまたはダッシュボードから **Marketplace** を選択
2. **Solutions** カテゴリに移動
3. **Experience Management** セクションを見つける

#### Step 4: Virtual Desktop & Apps タイルをアクティブ化

1. **Virtual Desktop & Apps** タイルをクリック
2. ソリューションの詳細を確認
3. **Activate**（アクティブ化）をクリック
4. アクティベーション完了を待機

> **重要**: 試験ガイドの正確な手順は「Login to connect.Omnissa.com → Intelligence → Marketplace → Solutions → Experience Management → Activate the Virtual Desktop & Apps tile」。アクティベーション後、データの収集・表示が開始されるまで数時間かかる場合がある。

### 3.2 アクティベーション後の確認事項

| 確認項目 | 確認方法 |
|---------|---------|
| Edge Gateway 接続状態 | Horizon Universal Console で Status = Connected |
| DEEM データ受信 | Intelligence Dashboard で Horizon データが表示されること |
| Experience Score | Experience Management ダッシュボードにスコアが表示されること |
| デバイス数 | 監視対象 VM の台数が正しいこと |

---

## 4. Custom Reports / Dashboards の作成

### 4.1 Intelligence のレポート機能

Omnissa Intelligence では、DEEM Agent が収集したテレメトリデータを基にカスタムレポートとダッシュボードを作成できる。

**標準ダッシュボード（Experience Management アクティベーション後）**

| ダッシュボード | 内容 |
|-------------|------|
| Experience Score Overview | 全体の Experience Score サマリ |
| Session Performance | セッションパフォーマンスの詳細 |
| Application Performance | アプリケーション起動・動作の分析 |
| Device Health | VM のリソース使用状況 |
| Login Analysis | ログオン時間の内訳分析 |

### 4.2 カスタムレポートの作成手順

1. Intelligence Console → **Workspace** → **Reports**
2. **Create Report** をクリック
3. **Data Source** を選択（`Horizon Sessions`, `Horizon Devices` 等）
4. **Columns**（表示フィールド）を選択
5. **Filters**（フィルター条件）を設定
6. **Preview** で確認
7. **Save** で保存

**フィルター条件の例**

| フィルター | 条件 | 用途 |
|----------|------|------|
| Pool Name | `= IC-Pool-Dev` | 特定プールの分析 |
| Login Duration | `> 30 seconds` | ログオン遅延の検出 |
| Protocol Latency | `> 100 ms` | ネットワーク問題の特定 |
| App Crash Count | `> 0` | アプリ障害の特定 |
| Date Range | `Last 7 days` | 直近1週間の分析 |

### 4.3 カスタムダッシュボードの作成

1. Intelligence Console → **Workspace** → **Dashboards**
2. **Create Dashboard** をクリック
3. ウィジェットを追加:
   - **Chart**（棒グラフ、折れ線グラフ、円グラフ）
   - **Table**（データテーブル）
   - **Metric**（単一メトリクス表示）
   - **Heatmap**（ヒートマップ）
4. 各ウィジェットのデータソースとフィルターを設定
5. レイアウトを調整して **Save**

---

## 5. Experience Score の概念と主要メトリクス

### 5.1 Experience Score とは

Experience Score は、エンドユーザーのデジタル体験を 0〜100 のスコアで定量化する指標である。DEEM Agent が収集したテレメトリデータを Intelligence が機械学習アルゴリズムで分析し、複数のサブカテゴリから総合スコアを算出する。

**スコアの分類**

| スコア範囲 | 評価 | 意味 | アクション |
|----------|------|------|----------|
| 80–100 | Good（良好） | ユーザー体験に問題なし | 通常モニタリング |
| 60–79 | Neutral（普通） | 軽微な問題あり | トレンド監視、予防的対応 |
| 0–59 | Poor（不良） | 改善が必要 | 即時対応、根本原因分析 |

### 5.2 主要サブスコアと計算要素

各サブスコアは、関連するメトリクスの加重平均で算出される。サブスコアの組み合わせから全体の Experience Score が決定される。

| サブスコア | 測定対象 | 主要メトリクス | 閾値例（Poor 判定） |
|----------|---------|-------------|------------------|
| **Device Health** | VM リソース | CPU 使用率、メモリ使用率、ディスク I/O、ディスク空き容量 | CPU > 90%、メモリ > 95% |
| **Login Experience** | ログオンプロセス | 総ログオン時間、プロファイルロード時間、GPO 処理時間、認証時間 | ログオン > 60秒 |
| **Session Experience** | セッション品質 | プロトコルレイテンシ（RTT）、フレームレート、パケットロス率 | RTT > 250ms |
| **App Experience** | アプリケーション | アプリ起動時間、クラッシュ数、ハング時間、応答時間 | クラッシュ > 3回/日 |
| **Network Experience** | ネットワーク | DNS 解決時間、ネットワーク遅延、帯域使用率、接続安定性 | DNS > 2秒 |

### 5.3 Experience Score の活用

| 活用方法 | 説明 |
|---------|------|
| プロアクティブな問題検出 | スコア低下のトレンドから障害予兆を検知 |
| 根本原因分析（RCA） | サブスコアのドリルダウンで問題領域を特定 |
| SLA モニタリング | Experience Score を SLA 指標として活用 |
| 容量計画 | Device Health スコアの推移から容量不足を予測 |
| 変更影響分析 | Push Image 前後の Experience Score を比較 |

---

## 6. ベストプラクティスとアンチパターン

### ベストプラクティス

| カテゴリ | 推奨事項 |
|---------|---------|
| Edge Gateway | 内部ネットワークに配置し、Horizon Cloud Control Plane への HTTPS 疎通を確保 |
| DNS | Edge Gateway の FQDN を内部 DNS に登録（Connection Server / UAG から解決可能にする） |
| DEEM Agent | Golden Image にインストールし、Push Image で全 VM に展開 |
| ファイアウォール | Edge Gateway → Internet（Control Plane URL）の HTTPS を許可。URL リストは公式ドキュメント参照 |
| 監視 | Edge Gateway の Kubernetes Pod 状態を定期的に確認 |
| レポート | カスタムレポートは目的別に作成し、定期配信をスケジュール |
| Experience Score | ベースラインを設定し、変更前後のスコア推移を比較 |

### アンチパターン

| アンチパターン | リスク | 対策 |
|--------------|-------|------|
| Edge Gateway を DMZ にデプロイ | セキュリティリスク、接続不安定 | 内部ネットワークにデプロイ |
| DEEM Agent を個別 VM にインストール | 管理コスト増大、展開漏れ | Golden Image に組み込み |
| Edge Gateway の DNS 未登録 | CS / UAG から名前解決不可 | 内部 DNS に A レコード登録 |
| ファイアウォールで Control Plane URL をブロック | データ送信失敗 | 公式 URL リストを allowlist に追加 |
| Experience Score を無視 | ユーザー体験の劣化を見逃す | ダッシュボードを定期チェック |
| レポートのフィルター未設定 | 大量データで分析困難 | 目的に応じたフィルター設定 |

---

## 理解度チェックリスト

- [ ] Horizon Edge Gateway の役割（ライセンス管理、テレメトリ送信、Control Plane 接続）を説明できる
- [ ] Edge Gateway は内部ネットワークにデプロイすべきであり、DMZ には配置しないことを理解している
- [ ] Edge Gateway のデプロイ手順（connect.omnissa.com → Provider 作成 → OVA ダウンロード → Pairing Code 取得 → vSphere デプロイ → CS 接続）を順序立てて説明できる
- [ ] Pairing Code の取得場所（Horizon Universal Console / connect.omnissa.com）と一度きりの使用制限を理解している
- [ ] Edge Gateway のトラブルシューティングコマンド（`kubectl get pods -A`）と確認すべき Pod（`edgedevice-deployment`, `view-cs-module-deployment`）を知っている
- [ ] DEEM Agent の役割と収集するデータカテゴリ（セッション、プロトコル、アプリ、OS、ネットワーク）を説明できる
- [ ] DEEM テレメトリデータのフロー（DEEM → Horizon Agent → CS → Edge Gateway → Control Plane → Intelligence）を説明できる
- [ ] DEEM Agent を Golden Image にインストールし、Push Image で展開する手順を説明できる
- [ ] Intelligence Console での Experience Management アクティベーション手順（connect.omnissa.com → Intelligence → Marketplace → Solutions → Experience Management → Virtual Desktop & Apps → Activate）を正確に説明できる
- [ ] Custom Reports / Dashboards の作成手順と主要なフィルター条件を説明できる
- [ ] Experience Score の概念（0–100スコア、5つのサブスコア）と閾値（Good: 80–100、Neutral: 60–79、Poor: 0–59）を説明できる
- [ ] Experience Score の活用方法（プロアクティブ検出、RCA、SLA モニタリング、変更影響分析）を説明できる
