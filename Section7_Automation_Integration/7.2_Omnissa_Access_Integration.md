# 7.2 Omnissa Access Integration

## 概要

Omnissa Accessとの統合は、シングルサインオン（SSO）と条件付きアクセスを提供します。OCE-Hレベルでは、Omnissa Accessでの認証ポリシーの実装、Horizon ConsoleでのSAML Authenticatorの設定、Connection Server設定、Omnissa AccessコンソールでのHorizon設定が求められます。

## Omnissa Accessでの認証ポリシーの実装

### 認証ポリシーの概要

**機能**:
- 多要素認証（MFA）
- 条件付きアクセス
- デバイスベースのアクセス制御
- リスクベースの認証

### 認証ポリシーの作成

**手順**:

1. **Omnissa Accessコンソールにアクセス**
   - `https://<Omnissa Access URL>`
   - 管理者アカウントでログイン

2. **認証ポリシーの作成**
   - Policies → Authentication Policies
   - Add Policyをクリック

3. **ポリシー設定**
   - **Name**: ポリシー名（例: "Horizon-Access-Policy"）
   - **Description**: 説明
   - **Priority**: 優先順位

4. **条件の設定**
   - **User Groups**: 対象ユーザーグループ
   - **Device Types**: デバイスタイプ
   - **Network Locations**: ネットワーク位置
   - **Time**: 時間帯

5. **認証方法の設定**
   - **Primary Authentication**: プライマリ認証方法
     - Active Directory
     - LDAP
     - RADIUS
   - **Secondary Authentication**: セカンダリ認証方法（MFA）
     - SMS
     - Email
     - Authenticator App
     - Hardware Token

6. **ルールの設定**
   - 条件に基づく認証方法の選択
   - リスクスコアに基づく認証強化

**設定例**:
```
Policy Name: Horizon-High-Security-Policy
Conditions:
  - User Groups: Domain Admins, IT Staff
  - Network Locations: External
Rules:
  - Primary: Active Directory
  - Secondary: Authenticator App (Required)
  - Risk Score > 50: Additional verification required
```

:::important
認証ポリシーは、セキュリティ要件に基づいて適切に設定する必要があります。過度に厳しいポリシーは、ユーザーエクスペリエンスを低下させる可能性があります。
:::

## Horizon ConsoleでのSAML Authenticatorの設定

### SAML Authenticatorの概要

**機能**:
- SAML 2.0認証
- Omnissa Accessとの統合
- SSOの実現

### SAML Authenticatorの設定手順

**手順**:

1. **Omnissa AccessでSAMLアプリケーションを作成**
   - Omnissa Accessコンソール → Resources → Web Apps
   - Add Web App → SAML 2.0
   - アプリケーション情報を入力
   - メタデータをダウンロード

2. **Horizon Consoleでの設定**
   - View Configuration → Authentication
   - SAML Authenticatorを追加
   - Addをクリック

3. **SAML設定の入力**
   - **Name**: Authenticator名（例: "Omnissa-Access-SAML"）
   - **Entity ID**: Omnissa AccessのエンティティID
   - **SSO URL**: Omnissa AccessのSSO URL
   - **SLO URL**: Omnissa AccessのSLO URL（オプション）
   - **Certificate**: Omnissa Accessの署名証明書

4. **メタデータのインポート**
   - Import Metadataをクリック
   - Omnissa Accessからダウンロードしたメタデータファイルを選択
   - 自動的に設定が入力される

5. **設定の確認**
   - Test Connectionをクリック
   - 接続が成功することを確認

**設定例**:
```
Name: Omnissa-Access-SAML
Entity ID: https://access.omnissa.com/saml
SSO URL: https://access.omnissa.com/saml/sso
SLO URL: https://access.omnissa.com/saml/slo
Certificate: (Omnissa Accessの署名証明書)
```

:::tip
SAML Authenticatorの設定は、Omnissa AccessとHorizon Consoleの両方で正しく設定する必要があります。設定ミスがあると、SSOが機能しません。
:::

## シングルサインオンのためのHorizon Connection Server設定の設定

### SSO設定の概要

**機能**:
- ユーザーは一度の認証でHorizon環境にアクセス
- Omnissa Access経由での認証
- セキュリティの向上

### SSO設定手順

**手順**:

1. **Horizon Consoleでの設定**
   - View Configuration → Servers
   - Connection Serverを選択
   - Editをクリック

2. **SSO設定**
   - SSO Settingsタブを選択
   - **Enable SSO**: 有効化
   - **SSO Method**: SAML 2.0を選択
   - **SAML Authenticator**: 作成したSAML Authenticatorを選択

3. **設定の適用**
   - OKをクリック
   - Connection Serverの再起動（必要に応じて）

4. **検証**
   - ブラウザでHorizon環境にアクセス
   - Omnissa Accessのログイン画面が表示されることを確認
   - ログイン後、Horizon環境に直接アクセスできることを確認

:::important
SSOの設定により、ユーザーは一度の認証でHorizon環境にアクセスできます。ただし、すべてのConnection Serverで同じ設定を適用する必要があります。
:::

## Omnissa AccessコンソールでのHorizon設定の設定

### Horizon設定の概要

**機能**:
- Horizon環境の登録
- アクセス制御
- セッション管理

### Horizon設定手順

**手順**:

1. **Omnissa Accessコンソールにアクセス**
   - `https://<Omnissa Access URL>`
   - 管理者アカウントでログイン

2. **Horizon環境の追加**
   - Resources → Horizon
   - Add Horizon Environmentをクリック

3. **環境情報の入力**
   - **Name**: 環境名（例: "Production-Horizon"）
   - **Description**: 説明
   - **Connection Server URL**: Connection ServerのFQDN
     - 例: `https://horizon.contoso.com`
   - **Port**: ポート番号（デフォルト: 443）

4. **認証設定**
   - **Authentication Method**: SAML 2.0
   - **SAML Application**: 作成したSAMLアプリケーションを選択

5. **アクセスポリシーの設定**
   - **Access Policy**: アクセスポリシーを選択
   - **Device Policy**: デバイスポリシーを選択
   - **Network Policy**: ネットワークポリシーを選択

6. **設定の保存**
   - Saveをクリック
   - 設定が適用される

**設定例**:
```
Name: Production-Horizon
Connection Server URL: https://horizon.contoso.com
Port: 443
Authentication Method: SAML 2.0
SAML Application: Horizon-SAML-App
Access Policy: Standard-Access-Policy
```

:::tip
Omnissa AccessコンソールでのHorizon設定により、統一された認証とアクセス制御が可能になります。
:::

## トラブルシューティング

### 一般的な問題

**SSOが機能しない**:
- SAML Authenticatorの設定を確認
- 証明書の有効期限を確認
- ネットワーク接続を確認
- ログファイルを確認

**認証エラー**:
- Omnissa Accessの認証ポリシーを確認
- ユーザーのグループメンバーシップを確認
- アクセスポリシーを確認

**接続エラー**:
- Connection ServerのURLを確認
- ネットワーク接続を確認
- ファイアウォールルールを確認

### ログファイルの確認

**Horizon Connection Serverログ**:
- `C:\ProgramData\VMware\VDM\logs\vdm.log`
- `C:\ProgramData\VMware\VDM\logs\vdm-security.log`

**Omnissa Accessログ**:
- Omnissa Accessコンソール → Monitoring → Logs

## ベストプラクティス

1. **セキュリティ**
   - 適切な認証ポリシー
   - 条件付きアクセス
   - 定期的なセキュリティレビュー

2. **テスト**
   - テスト環境での検証
   - ユーザー受け入れテスト
   - 段階的な展開

3. **モニタリング**
   - 認証ログの監視
   - エラーログの確認
   - パフォーマンス監視

:::caution
SSOの設定変更は、すべてのユーザーのアクセスに影響を与える可能性があります。本番環境で変更する前に、テスト環境で十分に検証してください。
:::

## 認証フローの詳細

### SAML認証フロー

**詳細なフロー**:
1. ユーザーがHorizon Clientに接続
2. Connection ServerがOmnissa Accessにリダイレクト
3. ユーザーがOmnissa Accessで認証
4. Omnissa AccessがSAMLアサーションを生成
5. ユーザーがConnection Serverにリダイレクト
6. Connection ServerがSAMLアサーションを検証
7. ユーザーがHorizon環境にアクセス

## トラブルシューティングガイド

### 一般的な問題

**SSOが機能しない**:
- SAML設定の確認
- 証明書の確認
- メタデータの確認
- ログファイルの確認

**認証が失敗する**:
- Omnissa Accessの状態確認
- ネットワーク接続の確認
- 認証ポリシーの確認

**トラブルシューティング手順**:
1. ログファイルの確認
2. SAML設定の確認
3. ネットワーク接続の確認
4. テスト接続の実行

## セキュリティ設定の詳細

### セキュリティ設定項目

**設定項目**:
- **証明書のピニング**: 特定の証明書のみを信頼
- **セッションタイムアウト**: セッションのタイムアウト時間
- **条件付きアクセス**: デバイス、ネットワーク位置に基づくアクセス制御

**設定例**:
```
証明書のピニング: Enabled
セッションタイムアウト: 8時間
条件付きアクセス:
  - 内部ネットワーク: 許可
  - 外部ネットワーク: MFA必須
```

## 理解度チェックリスト

以下の項目について理解度を確認してください：

### Omnissa Access統合
- [ ] Omnissa Accessでの認証ポリシーの実装方法を理解している
- [ ] 認証ポリシーの条件設定を説明できる
- [ ] 認証方法の設定を理解している

### SAML Authenticator
- [ ] Horizon ConsoleでのSAML Authenticatorの設定手順を説明できる
- [ ] SAML設定の入力項目を理解している
- [ ] メタデータのインポート方法を説明できる

### SSO設定
- [ ] シングルサインオン用のHorizon Connection Server設定を理解している
- [ ] UAGでのSSO設定を説明できる
- [ ] SSOの動作確認方法を理解している

### Omnissa Accessコンソール
- [ ] Omnissa AccessコンソールでのHorizon設定方法を説明できる
- [ ] 統合の検証方法を理解している

## まとめ

Omnissa Accessとの適切な統合は、シングルサインオンと条件付きアクセスを提供します。認証ポリシー、SAML Authenticator、SSO設定、Omnissa AccessコンソールでのHorizon設定の適切な実装、認証フローの詳細、トラブルシューティングガイド、セキュリティ設定の詳細により、セキュアで使いやすいHorizon環境を構築できます。
