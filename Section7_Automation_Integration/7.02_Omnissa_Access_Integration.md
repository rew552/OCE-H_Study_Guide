# 7.2 Integrate Horizon Pod into Omnissa Access

## 試験ガイド対応 (Section 4.7.2)

- Implement Authentication policy in Omnissa Access
- Configure a SAML Authenticator in Horizon Console
- Configure Horizon Connection Server Settings for Single Sign-On
- Configure Horizon Settings in the Omnissa Access console

---

## 1. Implement Authentication Policy in Omnissa Access

### 1.1 認証ポリシーの概要

Omnissa Access（旧 Workspace ONE Access）の認証ポリシーは、ユーザーがリソースにアクセスする際の認証要件を定義する。ポリシーは **Policy Rules**、**Authentication Methods**、**Network Ranges** の3要素で構成される。

### 1.2 Policy Rules（ポリシールール）

ポリシールールは、特定の条件に一致した場合に適用される認証要件を定義する。ルールは上から順に評価され、最初にマッチしたルールが適用される。

**ルールの構成要素**

| 要素 | 説明 | 設定例 |
|------|------|--------|
| Network Range | アクセス元のネットワーク範囲 | `ALL RANGES` / `Internal` / `External` |
| Device Type | デバイスの種類 | `Web Browser` / `Horizon Client` / `iOS` / `Android` |
| Authentication Method | 要求する認証方法（第1、第2） | `Password (Cloud)` / `Certificate` / `RADIUS` |
| Fallback Method | プライマリ認証失敗時の代替 | `Password (Local Directory)` |
| Re-authentication | 再認証の間隔 | `8 hours` |

**ルール設定例（内部 vs 外部）**

| 条件 | 内部ネットワーク | 外部ネットワーク |
|------|----------------|----------------|
| Authentication Method 1 | Kerberos | Password (Cloud) |
| Authentication Method 2 | — | RADIUS（MFA） |
| Session Length | 8 hours | 4 hours |
| Device Compliance | Optional | Required |

### 1.3 Authentication Methods（認証方法）

Omnissa Access で利用可能な主要な認証方法は以下の通り。

| 認証方法 | 説明 | 用途 |
|---------|------|------|
| Password (Cloud) | AD パスワード認証（Access Connector 経由） | 基本認証 |
| Password (Local Directory) | ローカルディレクトリ認証 | フォールバック |
| Kerberos | Windows 統合認証 | 内部ネットワーク SSO |
| Certificate (Cloud) | クライアント証明書認証 | デバイス認証 |
| RADIUS | RADIUS サーバー経由の MFA | 外部アクセス時の MFA |
| RSA SecurID | RSA SecurID トークン認証 | ハードウェアトークン MFA |
| Mobile SSO (iOS) | iOS デバイスの SSO | モバイル SSO |
| Mobile SSO (Android) | Android デバイスの SSO | モバイル SSO |
| Device Compliance | UEM デバイスコンプライアンスチェック | デバイスポリシー準拠確認 |

### 1.4 Network Ranges（ネットワーク範囲）

ネットワーク範囲は、ユーザーのアクセス元 IP アドレスに基づいてポリシールールを適用するために使用する。

**設定手順**: Access Console → Identity & Access Management → Policies → Network Ranges

| 設定項目 | 説明 | 例 |
|---------|------|-----|
| Name | 範囲名 | `Corporate-Internal` |
| IP Ranges | CIDR 表記の IP 範囲 | `10.0.0.0/8`, `172.16.0.0/12` |
| Description | 説明 | `Internal corporate network` |

### 1.5 認証ポリシーの設定手順

1. Access Console → **Identity & Access Management** → **Policies**
2. **default_access_policy_set** を選択するか、**Add Policy** で新規ポリシーを作成
3. **Policy Name** と **Description** を入力
4. 対象アプリケーションを選択（Horizon リソースなど）
5. **Add Policy Rule** でルールを追加
   - Network Range を選択
   - Device Type を選択
   - Authentication Method を指定（1st, 2nd）
   - Session Length を設定
6. **Save** をクリック

> **試験ポイント**: Default Access Policy は全てのアプリケーションに適用される。Horizon リソース専用の認証強化が必要な場合は、個別のアプリケーション固有ポリシーを作成する。

---

## 2. Configure a SAML Authenticator in Horizon Console

### 2.1 SAML 認証の概要

Horizon Connection Server に SAML 2.0 Authenticator を設定することで、Omnissa Access からの SAML Assertion による認証委任が可能になる。これにより Access で認証済みのユーザーが Horizon リソースにシームレスにアクセスできる。

### 2.2 前提条件

| 要件 | 詳細 |
|------|------|
| 時刻同期 | Access、Access Connector、Horizon Connection Server 間で NTP 同期 |
| ネットワーク疎通 | Connection Server → Access の FQDN（ポート443）への到達性 |
| DNS 解決 | Access の FQDN が Connection Server から正引きできること |
| 証明書 | Access の SSL 証明書が Connection Server から信頼されること |

### 2.3 SAML Authenticator の設定手順

以下の手順を Horizon Console で実行する（component_integration.pdf 準拠）。

**Step 1**: Horizon Console → **Settings** → **Servers** → **Connection Servers**

**Step 2**: 対象の Connection Server を選択し、**Edit** をクリック

**Step 3**: **Authentication** タブを選択

**Step 4**: **Delegation of authentication to Omnissa Horizon (SAML 2.0 Authenticator)** を以下のいずれかに変更

| オプション | 動作 |
|-----------|------|
| **Disabled** | SAML 認証を使用しない（デフォルト） |
| **Allowed** | SAML 認証を許可するが、AD 認証も引き続き可能 |
| **Required** | SAML 認証を必須にする。SAML Assertion なしの接続は拒否 |

**Step 5**: **Manage SAML Authenticators** → **Add** をクリック

**Step 6**: SAML Authenticator の詳細を入力

| 設定項目 | 説明 | 例 |
|---------|------|-----|
| Type | Static（UAG 用）または Dynamic（Access 用） | `Dynamic` |
| Label | Authenticator の識別名 | `Omnissa-Access-SAML` |
| Metadata URL | Access メタデータの URL（Dynamic のみ） | `https://access.corp.example.com/SAAS/API/1.0/GET/metadata/idp.xml` |
| Administration URL | Access 管理コンソール URL（任意） | `https://access.corp.example.com` |
| True SSO Trigger Mode | True SSO の有効化（Dynamic のみ） | `Enabled` |
| Enabled for Connection Server | この CS で有効化 | チェック |
| Require Encrypted Assertion | 暗号化 SAML Assertion を要求（Horizon 2412 以降） | 必要に応じてチェック |
| Workspace ONE Mode | Access Authenticator としてマーク | チェック |

**Static vs Dynamic Authenticator の違い**

| タイプ | 用途 | メタデータ指定方法 |
|-------|------|-----------------|
| **Dynamic** | Omnissa Access（vIDM）用 | Metadata URL を指定し自動取得。ステータスが Green/Red で表示 |
| **Static** | UAG / サードパーティデバイス用 | XML テキストを手動貼り付け。ステータスは常に Green |

> **試験ポイント**: Metadata URL の `<YOUR HORIZON SERVER NAME>` を Access の FQDN に置き換える。URL の残りのパス（`/SAAS/API/1.0/GET/metadata/idp.xml`）はそのまま使用する。1つの Connection Server に複数の SAML Authenticator を設定可能だが、各 Authenticator の entity-ID は異なる必要がある。

**Step 7**: **OK** をクリック

**Step 8**: Pod 内の他の Connection Server でも同様に SAML Authenticator を有効化する

SAML Authenticator の定義は Pod で共有されるが、各 Connection Server で個別に有効化が必要。手順：
1. 各 Connection Server を **Edit** → **Authentication** タブ
2. **Delegation of authentication** を **Allowed** または **Required** に設定（最初の CS と同じ値）
3. **Manage SAML Authenticators** → 既存 Authenticator を **Edit** → **Enabled for Connection Server** をチェック → **OK**

### 2.4 Service Provider メタデータの有効期限延長

デフォルトでは Connection Server の SP メタデータは **24時間** で期限切れになる。期限切れ後は SAML Assertion が拒否されるため、本番環境では延長が必須。

**設定手順**（ADSI Edit を使用）

1. Connection Server で **ADSI Edit** ユーティリティを起動
2. 接続先: `DC=vdi, DC=horizon, DC=internal`、ポート: `389`
3. ツリーを展開: **OU=Properties** → **OU=Global** → **CN=Common**
4. `pae-SAMLMetaDataValidDays` 属性の値を変更（推奨値: `90` 日）

> **試験ポイント**: メタデータ有効期限を延長しないと、24時間後に SAML 認証が失敗する。これは本番環境でよく見落とされる設定ポイント。

### 2.5 SAML Authenticator の検証

- Horizon Console → Settings → Servers → Connection Servers で各 CS の SAML 設定を確認
- Dynamic Authenticator の Status が **Green（正常）** であることを確認（Red の場合は Metadata URL への接続に失敗）
- Static Authenticator のステータスは常に Green（事前定義のメタデータを使用するため）
- メタデータの有効期限と証明書の有効期限を確認

---

## 3. Configure Horizon Connection Server Settings for Single Sign-On

### 3.1 True SSO の概要

True SSO は、SAML Assertion のみでユーザーのデスクトップ/アプリケーションセッションへの SSO を実現する仕組みである。ユーザーが AD パスワードを入力する必要がなくなる。

**True SSO の認証フロー**

```
User → Access (SAML認証) → Horizon CS (SAML Assertion受理)
  → Enrollment Server → AD CS (短期証明書発行)
  → Agent VM (証明書ログオン) → Windows セッション確立
```

### 3.2 True SSO の前提条件

| コンポーネント | 要件 |
|-------------|------|
| Enrollment Server | Horizon Enrollment Server のデプロイ（Connection Server とは別サーバー推奨、冗長化のため2台推奨） |
| Microsoft AD CS | **Enterprise CA** が必要（Standalone CA は不可）。Certificate Template の作成と公開 |
| Certificate Template | `Horizon-TrueSSO` テンプレート（Enrollment Server のコンピュータアカウントに `Enroll` 権限付与） |
| Enrollment Service Client Certificate | Connection Server から Enrollment Server への証明書ベースの信頼を確立 |
| Connection Server | SAML Authenticator で `TrueSSO Trigger Mode = Enabled` |
| Agent VM | スマートカードログオンが有効であること |

### 3.2.1 True SSO 証明書テンプレートの作成（詳細手順）

horizon_8_administration.pdf に基づく詳細手順。

**Step 1**: Microsoft Certificate Authority サーバーで **certtmpl.msc** を起動

**Step 2**: 既存テンプレート **Smartcard Logon** を複製（Duplicate Template）

**Step 3**: テンプレートのプロパティを設定

| タブ | 設定項目 | 値 |
|-----|---------|-----|
| General | Template display name | `Horizon-TrueSSO` |
| General | Validity period | `1 hour`（短期証明書） |
| General | Renewal period | `0 hours` |
| Request Handling | Purpose | `Signature and smartcard logon` |
| Subject Name | Supply in the request | チェック |
| Security | Enrollment Server のコンピュータアカウント | `Read` + `Enroll` 権限を付与 |

**Step 4**: CA サーバーの **Certificate Authority** コンソールで **Certificate Templates** → **New** → **Certificate Template to Issue** → `Horizon-TrueSSO` を選択して公開

> **試験ポイント**: True SSO 用の証明書テンプレートは **Smartcard Logon** テンプレートの複製が基本。有効期間を非常に短く設定（通常1時間）することで、短期証明書がセッション確立時にのみ使用されるセキュリティモデルとなる。

### 3.3 Connection Server での SSO 設定

**SAML Authenticator 側の設定（前セクションで完了）**

- `TrueSSO Trigger Mode` = **Enabled** に設定済み

**Connection Server の SSO 動作モード**

| 設定 | 動作 |
|------|------|
| SAML = **Allowed** + True SSO **Enabled** | Access 経由の場合は True SSO、直接接続は AD 認証 |
| SAML = **Required** + True SSO **Enabled** | 全接続で True SSO 必須（Access 経由のみ許可） |
| SAML = **Allowed** + True SSO **Disabled** | Access 経由でも AD パスワード入力が必要 |

### 3.4 Enrollment Server との連携設定

Enrollment Server は `vdmutil` コマンドラインツールで Connection Server に登録する。Connection Server 上で実行する。

**True SSO セットアップの流れ**

```
1. Enrollment Server をインストール
2. Enrollment Service Client 証明書をエクスポート（CS から）
3. 証明書を Enrollment Server にインポート
4. vdmutil で Enrollment Server を Connection Server に登録
5. vdmutil で True SSO 環境（Connector / Certificate Server / Template）を構成
```

**主要な vdmutil コマンド — Enrollment Server 管理**

| サブコマンド | 説明 |
|------------|------|
| `--truesso --environment --add` | True SSO 環境の追加（Connector, CA, Template, Domain を一括指定） |
| `--truesso --environment --list` | 構成済み True SSO 環境の一覧表示 |
| `--truesso --environment --delete` | True SSO 環境の削除 |
| `--truesso --environment --update` | True SSO 環境の更新 |

**vdmutil — Connector（Enrollment Server 接続）管理**

| サブコマンド | 説明 |
|------------|------|
| `--truesso --create --connector` | Enrollment Server Connector の作成 |
| `--truesso --list --connector` | Connector 一覧の表示 |
| `--truesso --delete --connector` | Connector の削除 |
| `--truesso --edit --connector` | Connector 設定の編集 |

**vdmutil — Authenticator 管理**

| サブコマンド | 説明 |
|------------|------|
| `--truesso --list --authenticator` | SAML Authenticator 一覧の表示 |
| `--truesso --enable --authenticator` | Authenticator の True SSO を有効化 |
| `--truesso --disable --authenticator` | Authenticator の True SSO を無効化 |

**環境追加コマンド例**

```
vdmutil --authAs admin --authDomain corp --authPassword ***
  --truesso --environment --add
  --connector <Enrollment Server FQDN>
  --certificateserver <CA Server FQDN>
  --templatename Horizon-TrueSSO
  --primaryenrollmentserver <Enrollment Server FQDN>
  --domain corp.example.com
```

> **試験ポイント**: True SSO には Enrollment Server、Microsoft AD CS（Enterprise CA）、適切な証明書テンプレートが必須。Standalone CA では動作しない。`vdmutil` は Connection Server 上の `C:\Program Files\Omnissa\Horizon\Server\tools` ディレクトリに存在する。

---

## 4. Configure Horizon Settings in the Omnissa Access Console

### 4.1 統合方式の選択

Horizon と Omnissa Access の統合には2つの方式がある。使用するブローカリング方式に応じて選択する。

| 統合方式 | 使用条件 | 特徴 |
|---------|---------|------|
| **Virtual Apps Collection** | Universal Broker を使用していない場合 | Pod 単位または CPA Federation 単位で登録 |
| **Universal Broker 直接統合** | Universal Broker を使用している場合 | 全 Pod のエンタイトルメントを一括で Access に同期 |

> **試験ポイント**: Universal Broker を使用していない環境では Virtual Apps Collection が必須。本セクションでは試験ガイドに沿い Virtual Apps Collection 方式を説明する。

### 4.2 Virtual App Collection の概要

Omnissa Access Console で Horizon リソース（デスクトップ・アプリケーション）をカタログに追加するには、**Virtual App Collection** を作成する。Collection にはHorizon Pod の接続情報、同期設定、ネットワーク設定を定義する。

### 4.3 Virtual App Collection の作成手順

以下の手順は component_integration.pdf に基づく。

**Step 1**: Access Console → **Resources** → **Virtual Apps Collection** → **New**

**Step 2**: Source Type で **Horizon** を選択

**Step 3**: Collection の基本情報を入力

| 設定項目 | 説明 | 例 |
|---------|------|-----|
| Name | Collection の識別名 | `Corp-Horizon-Collection` |
| Sync Connector | 同期に使用する Access Connector | `access-connector-01` |

**Step 4**: **Add A Pod** をクリックし、Horizon Pod の情報を入力

| 設定項目 | 説明 | 例 |
|---------|------|-----|
| Connection Server | CS の FQDN | `horizon-cs01.corp.example.com` |
| Domain | AD ドメイン | `corp.example.com` |
| Username | 管理者ユーザー名 | `horizonadmin` |
| Password | パスワード | (入力) |
| Smart Card Auth | スマートカード認証の有効/無効 | `No` |
| True SSO | True SSO の有効/無効 | `Yes` |

**Step 5**: Cloud Pod Architecture（CPA）を使用している場合

1. **Cloud Pod Architecture** チェックボックスを有効化
2. **Add A Federation** をクリック
3. Federation Name を入力
4. **Client Access FQDN** を設定（通常は LB の名前空間）
5. Federation に属する Pod を選択

**Step 6**: Configuration（同期設定）

| 設定項目 | 説明 | 推奨値 |
|---------|------|--------|
| Sync Frequency | 同期間隔 | `Every hour` |
| Sync Duplicate Apps | 重複アプリの同期 | `No` |
| Activation Policy | ユーザーへの公開方法 | `User-Activated` |
| Default Launch Client | デフォルト起動クライアント | `Native Client` |

**Step 7**: **Save** をクリック

**Step 8**: Network Ranges の設定

- **ALL RANGES** の Client Access FQDN を LB の名前空間に変更（デフォルトでは CS の FQDN が入る）
- 必要に応じて Internal / External 用の Network Range を追加し、異なる Client Access FQDN を設定

| Network Range | Client Access FQDN | 説明 |
|--------------|-------------------|------|
| ALL RANGES | `horizon-lb.corp.example.com` | デフォルト |
| Internal | `horizon-lb-int.corp.example.com` | 内部接続用（LB VIP） |
| External | `horizon-uag.corp.example.com` | 外部接続用（UAG FQDN） |

**Step 9**: 初回同期の実行

- Virtual Apps Collection 一覧から対象 Collection を選択
- **SYNC** ボタンをクリック
- 初回は **Sync Without Safeguards** を選択（Safeguard Threshold Limits を無視）

> **試験ポイント**: Client Access FQDN はデフォルトで Connection Server の FQDN が設定される。本番環境では LB の名前空間に変更する必要がある。外部アクセスの場合は UAG の FQDN を設定する。

---

## 5. 統合後の認証フロー

### 5.1 内部クライアントの認証フロー

component_integration.pdf に記載された内部クライアントのフローを以下に示す。

| Step | 動作 |
|------|------|
| 1 | ユーザーが Access（ブラウザまたは Intelligent Hub）で認証済み状態から Horizon リソースを選択・起動 |
| 2 | Access が SAML Assertion と SAML Artifact を生成。`horizon-client://` URL を含む Artifact をクライアントに返却 |
| 3 | クライアントデバイスの Horizon Client が `horizon-client://` URL ハンドラーとして起動 |
| 4 | Horizon Client が Connection Server に SAML Artifact を送信（XML-API `do-submit-authentication`） |
| 5 | Connection Server が Access に対して **SAML Artifact Resolve** を実行 |
| 6 | Access が Artifact を検証し、SAML Assertion を Connection Server に返却 |
| 7 | Connection Server が認証成功を返却（XML-API OK response） |
| 8 | リモートプロトコルセッション（Blast / PCoIP）が確立 |

### 5.2 外部クライアントの認証フロー

外部クライアントの場合、UAG がプロキシとして介在する。

| Step | 動作 |
|------|------|
| 1 | ユーザーが Access で認証後、Horizon リソースを起動 |
| 2 | Access が SAML Artifact を含む `horizon-client://` URL を返却 |
| 3 | Horizon Client が起動し、UAG に接続 |
| 4 | **UAG** が認証リクエストを Connection Server にプロキシ |
| 5 | Connection Server が Access に SAML Artifact Resolve を実行 |
| 6 | Access が SAML Assertion を返却 |
| 7 | Connection Server が認証成功を UAG 経由でクライアントに返却 |
| 8 | **UAG** がプロトコルセッションを Agent VM にプロキシ |

> **試験ポイント**: 外部クライアントの場合、UAG が認証トラフィックとプロトコルセッションの両方をプロキシする。Connection Server は直接外部に公開されない。

---

## 6. ベストプラクティスとアンチパターン

### ベストプラクティス

| カテゴリ | 推奨事項 |
|---------|---------|
| 時刻同期 | Access、Connector、Connection Server 間の NTP 同期を確実にする（SAML Assertion の有効期限検証に影響） |
| 証明書 | 全コンポーネントに信頼された CA 発行の証明書を使用 |
| Network Ranges | 内部/外部を適切に区分し、外部アクセスには MFA を適用 |
| SAML 設定 | 初期は `Allowed` で設定し、検証後に `Required` に移行 |
| True SSO | Enrollment Server を冗長化（Pod あたり2台推奨） |
| 同期設定 | 初回は `Sync Without Safeguards`、以降は Safeguard 有効で定期同期 |
| Client Access FQDN | LB / UAG の名前空間を設定し、個別 CS の FQDN は使用しない |

### アンチパターン

| アンチパターン | リスク | 対策 |
|--------------|-------|------|
| NTP 未同期 | SAML Assertion 検証失敗 | 全コンポーネントで NTP 同期 |
| 自己署名証明書の使用 | メタデータ取得失敗 | 正規 CA 証明書を使用 |
| 全 CS で SAML 未有効化 | 一部 CS 経由で SSO 失敗 | Pod 内全 CS で有効化 |
| Client Access FQDN 未変更 | LB バイパス、外部アクセス不可 | LB/UAG FQDN に変更 |
| True SSO で Standalone CA 使用 | 証明書発行失敗 | Enterprise CA を使用 |

---

## 理解度チェックリスト

- [ ] Omnissa Access の認証ポリシーにおける Policy Rules、Authentication Methods、Network Ranges の関係を説明できる
- [ ] Horizon Console での SAML Authenticator 設定手順を順序立てて説明できる（Settings → Servers → Authentication → SAML Authenticator）
- [ ] SAML 認証の Delegation オプション（Disabled / Allowed / Required）の違いを説明できる
- [ ] Static Authenticator と Dynamic Authenticator の違いと用途を説明できる
- [ ] Metadata URL のフォーマットを理解している（`https://<Access FQDN>/SAAS/API/1.0/GET/metadata/idp.xml`）
- [ ] SP メタデータの有効期限延長方法（ADSI Edit で `pae-SAMLMetaDataValidDays`）を理解している
- [ ] Require Encrypted Assertion オプション（Horizon 2412 以降）の目的を説明できる
- [ ] True SSO の前提条件（Enrollment Server, Enterprise CA, Certificate Template, Enrollment Service Client Certificate）を列挙できる
- [ ] True SSO 用証明書テンプレートの作成手順（Smartcard Logon テンプレートの複製、有効期間1時間設定）を説明できる
- [ ] `vdmutil --truesso` コマンドで Enrollment Server、Connector、Authenticator を管理する方法を理解している
- [ ] Virtual Apps Collection と Universal Broker 直接統合の違いを説明できる
- [ ] Access Console での Virtual App Collection 作成手順を説明できる
- [ ] Client Access FQDN の設定目的と Network Range ごとの使い分けを説明できる
- [ ] 内部/外部クライアントの SAML 認証フローの違い（UAG の介在）を説明できる
- [ ] 統合の前提条件（NTP 同期、ネットワーク疎通、証明書信頼）を説明できる
