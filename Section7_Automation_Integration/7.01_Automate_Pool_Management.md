# 7.1 Automate Pool Management

## 試験ガイド対応 (Section 4.7.1)

- Automate pool management using API-based integrations.

---

## 1. Horizon REST API の概要

### 1.1 API アーキテクチャ

Horizon 8 は RESTful API を提供し、プール管理やセッション管理など主要な管理操作をプログラムから実行できる。Connection Server 上でホストされ、HTTPS 経由でアクセスする。

**ベースURL構造**

```
https://<Connection Server FQDN>/rest/
```

API は複数バージョンが共存する。バージョンによって利用可能なエンドポイントが異なる。

| バージョン | パス | 用途 |
|-----------|------|------|
| Inventory v1 | `/rest/inventory/v1/` | インベントリ情報取得（sessions, machines 等） |
| Inventory v2 | `/rest/inventory/v2/` | 拡張インベントリ操作（desktop-pools CRUD 等） |
| External v1 | `/rest/external/v1/` | 外部統合用（AD ユーザー/グループ検索） |
| Monitor v1 | `/rest/monitor/v1/` | 監視データ取得（Connection Server 状態、イベント） |
| Config v1 | `/rest/config/v1/` | 構成管理（vCenter、ドメイン設定等） |
| Entitlements v1 | `/rest/entitlements/v1/` | エンタイトルメント管理 |
| Federated v1 | `/rest/federated/v1/` | CPA（Cloud Pod Architecture）操作 |

> **試験ポイント**: Horizon REST API のベースパスは `/rest/` であり、`/rest/api/v1/` ではない。Swagger UI は `https://<CS>/rest/swagger-ui.html` で確認できる。API ドキュメントは Omnissa Developer Portal（`developer.omnissa.com/horizon-apis`）でもバージョンごとに参照可能。

### 1.3 API バージョニングとリリース対応

Horizon のリリースごとに新しい API エンドポイントや機能が追加される。API バージョンは Horizon のリリースバージョン（例: 2412, 2503）に対応する。

| Horizon リリース | 主な API 追加・変更 |
|-----------------|-------------------|
| 2306 以降 | Inventory v2 エンドポイントの拡充 |
| 2412 | SAML Authenticator に Encrypted Assertion オプション追加、Desktop Pool v2 の拡張 |
| 2503 | Horizon Enterprise 向け追加 API |

> **試験ポイント**: 本番環境で API スクリプトを使用する場合、Swagger UI の `/rest/swagger-ui.html` でその Connection Server バージョンで利用可能なエンドポイントを必ず確認する。

### 1.2 認証フロー（Login → Bearer Token → API Call → Logout）

Horizon REST API は Bearer Token 方式の認証を使用する。全てのAPI操作の前にログインしてトークンを取得し、完了後はログアウトしてトークンを無効化する。

```
[Login] → [Bearer Token 取得] → [API Call (Authorization: Bearer <token>)] → [Logout]
```

**認証フローの詳細**

| ステップ | エンドポイント | メソッド | 説明 |
|---------|--------------|---------|------|
| 1. Login | `/rest/login` | POST | AD資格情報でログイン、Access Token を取得 |
| 2. API Call | 各エンドポイント | GET/POST/PUT/DELETE | `Authorization: Bearer <token>` ヘッダーを付与 |
| 3. Refresh | `/rest/refresh` | POST | トークンの有効期限を延長 |
| 4. Logout | `/rest/logout` | POST | トークンを無効化 |

**Login リクエストボディ**

```json
{
  "domain": "corp.example.com",
  "username": "horizonadmin",
  "password": "SecurePassword"
}
```

**Login レスポンス**

```json
{
  "access_token": "eyJhbGci...",
  "token_type": "Bearer"
}
```

> **試験ポイント**: ログアウトせずトークンを放置するとセキュリティリスクとなる。自動化スクリプトでは必ず `finally` ブロック等でログアウトを実行すべきである。

---

## 2. 主要エンドポイント一覧

### 2.1 Desktop Pools CRUD

| 操作 | メソッド | エンドポイント | 説明 |
|------|---------|--------------|------|
| List | GET | `/rest/inventory/v1/desktop-pools` | 全デスクトッププールの一覧 |
| Get | GET | `/rest/inventory/v1/desktop-pools/{id}` | 特定プールの詳細情報 |
| Create | POST | `/rest/inventory/v2/desktop-pools` | 新規プール作成 |
| Update | PUT | `/rest/inventory/v2/desktop-pools/{id}` | プール設定の更新 |
| Delete | DELETE | `/rest/inventory/v1/desktop-pools/{id}` | プール削除 |

### 2.2 Sessions 管理

| 操作 | メソッド | エンドポイント | 説明 |
|------|---------|--------------|------|
| List | GET | `/rest/inventory/v1/sessions` | アクティブセッション一覧 |
| Get | GET | `/rest/inventory/v1/sessions/{id}` | 特定セッションの詳細 |
| Disconnect | POST | `/rest/inventory/v1/sessions/{id}/action/disconnect` | セッション切断 |
| Logoff | POST | `/rest/inventory/v1/sessions/{id}/action/logoff` | セッションログオフ |
| Send Message | POST | `/rest/inventory/v1/sessions/{id}/action/send-message` | メッセージ送信 |

### 2.3 Farms 管理

| 操作 | メソッド | エンドポイント | 説明 |
|------|---------|--------------|------|
| List | GET | `/rest/inventory/v1/farms` | ファーム一覧 |
| Get | GET | `/rest/inventory/v1/farms/{id}` | 特定ファームの詳細 |
| Create | POST | `/rest/inventory/v2/farms` | 新規ファーム作成 |
| Update | PUT | `/rest/inventory/v2/farms/{id}` | ファーム設定更新 |
| Delete | DELETE | `/rest/inventory/v1/farms/{id}` | ファーム削除 |

### 2.4 Application Pools 管理

| 操作 | メソッド | エンドポイント | 説明 |
|------|---------|--------------|------|
| List | GET | `/rest/inventory/v1/application-pools` | アプリケーションプール一覧 |
| Get | GET | `/rest/inventory/v1/application-pools/{id}` | 特定アプリケーションプールの詳細 |
| Create | POST | `/rest/inventory/v2/application-pools` | 新規アプリケーションプール作成 |
| Update | PUT | `/rest/inventory/v2/application-pools/{id}` | アプリケーションプール設定更新 |
| Delete | DELETE | `/rest/inventory/v1/application-pools/{id}` | アプリケーションプール削除 |

### 2.5 その他の主要エンドポイント

| カテゴリ | エンドポイント | 説明 |
|---------|--------------|------|
| Machines | `/rest/inventory/v1/machines` | 仮想マシン管理（状態確認、電源操作等） |
| Machine Actions | `/rest/inventory/v1/machines/action/{action}` | マシンの一括操作（recover, rebuild, reset 等） |
| Entitlements | `/rest/entitlements/v1/desktop-pools/{id}` | デスクトッププール・エンタイトルメント管理 |
| App Entitlements | `/rest/entitlements/v1/application-pools/{id}` | アプリケーションプール・エンタイトルメント管理 |
| Global Desktop Entitlements | `/rest/entitlements/v1/global-desktop-entitlements` | CPA グローバルデスクトップ・エンタイトルメント |
| Global App Entitlements | `/rest/entitlements/v1/global-application-entitlements` | CPA グローバルアプリ・エンタイトルメント |
| AD Users & Groups | `/rest/external/v1/ad-users-or-groups` | AD ユーザー/グループ検索 |
| Connection Servers | `/rest/monitor/v1/connection-servers` | Connection Server 状態監視 |
| Gateways | `/rest/monitor/v1/gateways` | UAG ゲートウェイ監視 |
| Events | `/rest/monitor/v1/events` | イベント/監査ログ |
| vCenters | `/rest/config/v1/virtual-centers` | vCenter 構成 |
| Base Images | `/rest/inventory/v1/base-images` | ゴールデンイメージ一覧 |
| Base Snapshots | `/rest/inventory/v1/base-snapshots` | ベーススナップショット一覧 |
| SAML Authenticators | `/rest/config/v1/saml-authenticators` | SAML Authenticator 管理 |

---

## 3. API によるプール管理の自動化

### 3.1 プロビジョニング自動化

新規 Instant Clone プールの作成を API で自動化する例。v2 エンドポイントでは、プール作成に必要な全てのパラメータを一括で指定できる。

**主要パラメータ（Automated Instant Clone Desktop Pool）**

| パラメータ | 説明 | 例 |
|-----------|------|-----|
| `name` | プール識別名 | `IC-Pool-Dev` |
| `display_name` | 表示名 | `Development Pool` |
| `type` | プールタイプ | `AUTOMATED` |
| `user_assignment` | ユーザー割り当て | `FLOATING` / `DEDICATED` |
| `source` | ソースタイプ | `INSTANT_CLONE` |
| `provisioning_settings.base_snapshot_id` | ベーススナップショット | (ID) |
| `provisioning_settings.parent_vm_id` | 親VM | (ID) |
| `provisioning_settings.vm_template_id` | VMテンプレート | (ID) |
| `provisioning_settings.host_or_cluster_id` | クラスター | (ID) |
| `provisioning_settings.resource_pool_id` | リソースプール | (ID) |
| `provisioning_settings.datacenter_id` | データセンター | (ID) |
| `pattern_naming_settings.naming_pattern` | ネーミングパターン | `DEV-{n:fixed=3}` |
| `pattern_naming_settings.max_number_of_machines` | 最大デスクトップ数 | `100` |

### 3.2 メンテナンス自動化

API を利用して Golden Image の更新（Push Image）を自動化する。

**Push Image（イメージ更新）の流れ**

1. 新しいスナップショットの ID を取得（`GET /rest/inventory/v1/base-snapshots`）
2. プールに対して Push Image を実行（`POST /rest/inventory/v1/desktop-pools/{id}/action/schedule-push-image`）

**Push Image リクエストボディ**

```json
{
  "base_snapshot_id": "snapshot-new-id",
  "logoff_policy": "WAIT_FOR_LOGOFF",
  "stop_on_first_error": false,
  "start_time": "2026-03-01T02:00:00Z"
}
```

### 3.3 再構成（Recompose / Rebuild）

| 操作 | エンドポイント | 説明 |
|------|--------------|------|
| Schedule Push Image | `POST .../action/schedule-push-image` | IC プールの Golden Image を更新 |
| Cancel Push Image | `POST .../action/cancel-scheduled-push-image` | スケジュール済み Push Image のキャンセル |
| Recover Machines | `POST /rest/inventory/v1/machines/action/recover` | マシンのリカバリ |
| Rebuild Machines | `POST /rest/inventory/v1/machines/action/rebuild` | マシンのリビルド |

---

## 4. PowerShell での API 呼び出し例

### 4.1 完全な自動化スクリプト

```powershell
$cs = "horizon-cs01.corp.example.com"
$baseUri = "https://$cs/rest"

# TLS/SSL 証明書検証をスキップ（ラボ環境のみ）
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12

# --- Step 1: Login ---
$loginBody = @{
    domain   = "corp.example.com"
    username = "horizonadmin"
    password = $env:HORIZON_PASSWORD
} | ConvertTo-Json

$login = Invoke-RestMethod -Uri "$baseUri/login" -Method POST `
    -Body $loginBody -ContentType "application/json"

$headers = @{ "Authorization" = "Bearer $($login.access_token)" }

try {
    # --- Step 2: プール一覧の取得 ---
    $pools = Invoke-RestMethod -Uri "$baseUri/inventory/v1/desktop-pools" `
        -Method GET -Headers $headers

    foreach ($pool in $pools) {
        Write-Output "Pool: $($pool.name) | Type: $($pool.type) | Source: $($pool.source)"
    }

    # --- Step 3: 特定プールの詳細取得 ---
    $poolId = $pools[0].id
    $detail = Invoke-RestMethod -Uri "$baseUri/inventory/v1/desktop-pools/$poolId" `
        -Method GET -Headers $headers

    # --- Step 4: セッション一覧の取得 ---
    $sessions = Invoke-RestMethod -Uri "$baseUri/inventory/v1/sessions" `
        -Method GET -Headers $headers

    Write-Output "Active Sessions: $($sessions.Count)"
}
finally {
    # --- Step 5: Logout（必ず実行）---
    Invoke-RestMethod -Uri "$baseUri/logout" -Method POST -Headers $headers
}
```

### 4.2 Python での API 呼び出し例

```python
import requests
import urllib3
import os

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

CS = "horizon-cs01.corp.example.com"
BASE = f"https://{CS}/rest"

# Login
login_resp = requests.post(f"{BASE}/login", json={
    "domain": "corp.example.com",
    "username": "horizonadmin",
    "password": os.environ["HORIZON_PASSWORD"]
}, verify=False)

token = login_resp.json()["access_token"]
headers = {"Authorization": f"Bearer {token}"}

try:
    # プール一覧
    pools = requests.get(f"{BASE}/inventory/v1/desktop-pools",
                         headers=headers, verify=False).json()
    for p in pools:
        print(f"Pool: {p['name']} | Type: {p['type']}")

    # セッション一覧
    sessions = requests.get(f"{BASE}/inventory/v1/sessions",
                            headers=headers, verify=False).json()
    print(f"Active sessions: {len(sessions)}")
finally:
    requests.post(f"{BASE}/logout", headers=headers, verify=False)
```

---

## 5. Horizon PowerCLI モジュールの活用

### 5.1 Horizon PowerCLI の概要

Horizon PowerCLI は2つのモジュールで構成される。`VMwareHorizon` モジュールは Horizon View API のラッパーとして `Connect-HVServer` 等の基本コマンドレットを提供し、`Omnissa.Horizon.Helper`（旧 `VMware.Hv.Helper`）ヘルパーモジュールはより簡潔なコマンドレットでプール管理を実行する。

**インストール**

```powershell
Install-Module -Name VMware.PowerCLI -Scope CurrentUser
```

> **注意**: Omnissa ブランド移行に伴い、ヘルパーモジュール名は `VMware.Hv.Helper` から `Omnissa.Horizon.Helper` に順次変更されている。Omnissa Developer Portal（`developer.omnissa.com/horizon-powercli`）で最新情報を確認すること。

### 5.2 Connect-HVServer の接続方式

`Connect-HVServer` は Horizon View API サービスへの接続を確立する。3つのパラメータセットをサポートする。

| 接続方式 | パラメータ | 用途 |
|---------|-----------|------|
| Credential | `-Server`, `-Credential`, `-Domain` | PSCredential オブジェクトで接続 |
| User/Password | `-Server`, `-User`, `-Password`, `-Domain` | ユーザー名/パスワードで接続 |
| Session | `-Server`, `-SessionId` | 既存セッション ID で再接続 |

既存接続は再利用され（参照カウント方式）、接続先は `$DefaultHVServers` グローバル変数に格納される。

### 5.3 主要なコマンドレット

| コマンドレット | 説明 |
|--------------|------|
| `Connect-HVServer` | Connection Server に接続 |
| `Get-HVPool` | デスクトッププール一覧取得 |
| `New-HVPool` | 新規プール作成 |
| `Set-HVPool` | プール設定変更 |
| `Remove-HVPool` | プール削除 |
| `Start-HVPool` | プールメンテナンス操作（Refresh, Recompose, Rebalance, Push Image） |
| `Get-HVMachine` | マシン一覧取得 |
| `Get-HVSession` | セッション一覧取得 |
| `Get-HVFarm` | ファーム一覧取得 |
| `New-HVFarm` | 新規ファーム作成 |
| `Get-HVEntitlement` | エンタイトルメント取得 |
| `New-HVEntitlement` | エンタイトルメント作成 |
| `Get-HVGlobalEntitlement` | グローバルエンタイトルメント取得 |
| `Disconnect-HVServer` | 接続解除 |

> **試験ポイント**: `Start-HVPool` は Push Image のほか、Refresh（リフレッシュ）、Recompose（再構成）、Rebalance（リバランス）の各メンテナンス操作を `-Maintenance` パラメータで指定して実行できる。

### 5.4 PowerCLI によるプール管理例

```powershell
# Connection Server に接続
Connect-HVServer -Server "horizon-cs01.corp.example.com" -Credential (Get-Credential)

# プール一覧取得
$pools = Get-HVPool
$pools | Format-Table Name, Type, Source, Enabled

# 特定プールのマシン一覧
$machines = Get-HVMachine -PoolName "IC-Pool-Dev"
$machines | Format-Table Name, BasicState, DnsName

# Push Image の実行（Start-HVPool を使用）
Start-HVPool -Pool "IC-Pool-Dev" -Maintenance PUSH_IMAGE `
    -ParentVM "GoldenImage-W11" -SnapshotName "2026-02-Patch" `
    -LogoffSetting WAIT_FOR_LOGOFF

# エンタイトルメントの追加
New-HVEntitlement -ResourceName "IC-Pool-Dev" -ResourceType Desktop `
    -User "corp\vdi-users"

# 切断
Disconnect-HVServer -Confirm:$false
```

### 5.5 Omnissa Developer Portal のサンプルスクリプト

Omnissa Developer Portal（`developer.omnissa.com/euc-samples/Horizon-Samples`）では、PowerCLI および REST API のサンプルスクリプトが公開されている。プール作成、ファーム管理、エンタイトルメント操作など、一般的なユースケースのスクリプトテンプレートを入手できる。

---

## 6. ベストプラクティスとアンチパターン

### ベストプラクティス

| カテゴリ | 推奨事項 |
|---------|---------|
| 認証 | API 資格情報はスクリプトにハードコードせず、環境変数・Secret Manager・Credential Store を使用 |
| トークン管理 | スクリプト終了時に必ず `/rest/logout` を実行（`try/finally` パターン） |
| エラーハンドリング | 指数バックオフ付きリトライロジックを実装（HTTP 429, 503 対応） |
| バージョニング | 利用可能な最新 API バージョンを使用し、Swagger UI で互換性を確認 |
| 監査 | API 操作はイベントログに記録される。`/rest/monitor/v1/events` で監査可能 |
| レート制限 | 大量のAPI呼び出しを短時間に行わない。バッチ処理間にスリープを挟む |
| 冪等性 | 作成操作前に既存リソースの有無を確認し、重複作成を防止 |

### アンチパターン

| アンチパターン | リスク | 対策 |
|--------------|-------|------|
| トークンをログアウトしない | セキュリティ侵害 | `finally` ブロックで必ず Logout |
| 証明書検証を本番環境で無効化 | MITM攻撃 | 正規のCA証明書を使用 |
| パスワードをスクリプトに直書き | 資格情報漏洩 | 環境変数・Vault 使用 |
| エラー処理なしのAPI呼び出し | サイレント障害 | `try/catch` + ログ記録 |
| API バージョン未指定 | 互換性破壊 | 明示的にバージョンパスを指定 |
| ポーリング間隔が短すぎる | Connection Server への負荷 | 適切なインターバル設定（≥30秒） |

---

## 理解度チェックリスト

- [ ] Horizon REST API のベースURL（`/rest/`）とカテゴリ別パス構造（inventory, external, monitor, config, entitlements）を説明できる
- [ ] 認証フロー（Login → Bearer Token → API Call → Logout）を順序立てて説明できる
- [ ] Desktop Pool / Application Pool / Sessions / Farms の主要 CRUD エンドポイントを列挙できる
- [ ] Push Image API のリクエストパラメータ（`base_snapshot_id`, `logoff_policy` 等）を理解している
- [ ] PowerShell / Python で Horizon REST API を呼び出す完全なスクリプトを書ける
- [ ] PowerCLI の `Connect-HVServer` の3つの接続方式（Credential, User/Password, Session）を理解している
- [ ] `Start-HVPool` の `-Maintenance` パラメータ（PUSH_IMAGE, REFRESH, RECOMPOSE, REBALANCE）の違いを説明できる
- [ ] API 自動化のベストプラクティス（トークン管理、エラーハンドリング、資格情報保護）を説明できる
- [ ] Swagger UI（`/rest/swagger-ui.html`）と Omnissa Developer Portal の活用方法を理解している
