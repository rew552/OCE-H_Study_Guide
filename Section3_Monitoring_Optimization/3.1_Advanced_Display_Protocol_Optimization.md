# 3.1 Advanced Display Protocol Optimization

## 概要

高度な表示プロトコルの最適化は、Horizon環境のパフォーマンスとユーザーエクスペリエンスに重要です。OCE-Hレベルでは、Max Session Bandwidthレジストリの設定、Build-to-losslessの使用シナリオ、Blastとlossless圧縮に焦点を当てた最適化が求められます。

## データ使用量を制限するMax Session Bandwidthレジストリの設定

### Max Session Bandwidthの概要

**機能**:
- セッションあたりの最大帯域幅を制限
- ネットワーク帯域幅の管理
- コストの最適化

### レジストリ設定

**レジストリパス**:
```
HKEY_LOCAL_MACHINE\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration
```

**設定値**:
- **MaxSessionBandwidth**: セッションあたりの最大帯域幅（Kbps）

**設定例**:
```powershell
# Max Session Bandwidthを5Mbpsに設定
New-ItemProperty -Path "HKLM:\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration" `
    -Name "MaxSessionBandwidth" -Value 5120 -PropertyType DWord -Force
```

**推奨値**:
| 用途 | 推奨値 |
|------|--------|
| 基本的なオフィス作業 | 1-2 Mbps |
| マルチメディア | 3-5 Mbps |
| 3Dグラフィックス | 5-10 Mbps |

:::important
Max Session Bandwidthの設定は、ネットワーク帯域幅とユーザーエクスペリエンスのバランスを考慮する必要があります。
:::

## Build-to-losslessの使用シナリオ（画像品質向上のためのオプションとして使用すべき場合と使用すべきでない場合）

### Build-to-losslessの概要

**機能**:
- 画像品質を向上させる
- 損失のない圧縮
- 帯域幅を消費

### 使用すべき場合

**シナリオ**:
1. **高品質な画像が必要な場合**
   - 医療画像の表示
   - CAD/CAMアプリケーション
   - デザインアプリケーション

2. **帯域幅が十分な場合**
   - LAN環境
   - 高帯域幅のWAN環境

3. **レイテンシが低い場合**
   - ローカルネットワーク
   - 低レイテンシのWAN環境

:::tip
Build-to-losslessは、高品質な画像が必要で、帯域幅とレイテンシが許容できる環境で使用してください。
:::

### 使用すべきでない場合

**シナリオ**:
1. **帯域幅が限られている場合**
   - 低帯域幅のWAN環境
   - モバイルネットワーク

2. **レイテンシが高い場合**
   - 高レイテンシのWAN環境
   - 衛星通信

3. **基本的な作業のみの場合**
   - テキスト編集
   - 基本的なオフィス作業

:::warning
Build-to-losslessは、帯域幅を大幅に消費します。帯域幅が限られている環境では使用しないでください。
:::

### 設定方法

**Horizon Consoleでの設定**:
1. View Configuration → Global Settings → Display Protocol
2. Blast Protocol Settings
3. Build-to-losslessを有効化/無効化

**レジストリ設定**:
```powershell
# Build-to-losslessを有効化
New-ItemProperty -Path "HKLM:\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration" `
    -Name "BuildToLossless" -Value 1 -PropertyType DWord -Force
```

## Blastとlossless圧縮に焦点

### Blast Protocolの最適化

**コーデック選択**:
- **BlastCodec**: デフォルトコーデック、高品質
- **H.264**: ハードウェアアクセラレーション対応
- **Adaptive**: 適応的最適化

**設定方法**:
1. Horizon Console → View Configuration → Global Settings → Display Protocol
2. Blast Protocol Settings
3. コーデックを選択

### Lossless圧縮の設定

**設定項目**:
- **Lossless Compression**: 有効/無効
- **Quality Level**: 品質レベル（1-100）

**レジストリ設定**:
```powershell
# Lossless圧縮を有効化
New-ItemProperty -Path "HKLM:\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration" `
    -Name "LosslessCompression" -Value 1 -PropertyType DWord -Force

# 品質レベルを設定（100 = 最高品質）
New-ItemProperty -Path "HKLM:\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration" `
    -Name "QualityLevel" -Value 100 -PropertyType DWord -Force
```

:::note
Lossless圧縮は、画像品質を向上させますが、帯域幅とCPUリソースを消費します。
:::

## PCoIPの詳細な最適化設定

### PCoIPの概要

**機能**:
- 高品質な画像転送
- 低レイテンシ
- WAN環境での使用に適している

### PCoIPの最適化設定

**レジストリ設定**:
```powershell
# PCoIPの最適化設定
# 画像品質の設定
New-ItemProperty -Path "HKLM:\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration" `
    -Name "PCoIPImageQuality" -Value 80 -PropertyType DWord -Force

# 帯域幅の設定
New-ItemProperty -Path "HKLM:\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration" `
    -Name "PCoIPMaxBandwidth" -Value 5000 -PropertyType DWord -Force

# レイテンシの最適化
New-ItemProperty -Path "HKLM:\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration" `
    -Name "PCoIPMinBandwidth" -Value 1000 -PropertyType DWord -Force
```

**推奨設定値**:
| 環境 | 画像品質 | 最大帯域幅 |
|------|---------|-----------|
| LAN | 90-100 | 10-20 Mbps |
| WAN（低レイテンシ） | 70-80 | 3-5 Mbps |
| WAN（高レイテンシ） | 50-70 | 1-3 Mbps |

## プロトコル選択の詳細ガイド

### プロトコル選択の決定フローチャート

**選択基準**:
- **ネットワーク帯域幅**: 利用可能な帯域幅
- **レイテンシ**: ネットワークレイテンシ
- **アプリケーション要件**: アプリケーションの種類
- **クライアントデバイス**: クライアントデバイスの性能

**推奨プロトコル**:
| 環境 | 推奨プロトコル |
|------|--------------|
| LAN、高帯域幅 | Blast Protocol |
| WAN、低レイテンシ | Blast Protocol または PCoIP |
| WAN、高レイテンシ | PCoIP |
| モバイルネットワーク | Blast Protocol（適応的） |

### プロトコルの切り替え

**動的プロトコル選択**:
- Horizon Clientが自動的に最適なプロトコルを選択
- ネットワーク条件に応じて切り替え

**手動プロトコル選択**:
- Horizon Consoleでデフォルトプロトコルを設定
- ユーザーが手動でプロトコルを選択

## ネットワーク条件に応じた最適化

### ネットワーク条件の評価

**評価項目**:
- **帯域幅**: 利用可能な帯域幅
- **レイテンシ**: ネットワークレイテンシ
- **パケットロス**: パケットロス率
- **ジッター**: ネットワークジッター

**評価ツール**:
```powershell
# ネットワーク条件の評価
Test-NetConnection -ComputerName "horizon.contoso.com" -Port 443 -InformationLevel Detailed

# 帯域幅の測定
Measure-Command {
    # データ転送テスト
}
```

### 最適化設定

**低帯域幅環境**:
- Max Session Bandwidthを制限
- 画像品質を下げる
- 圧縮を有効化

**高レイテンシ環境**:
- PCoIPを使用
- バッファリングを最適化
- レイテンシ補償を有効化

**高パケットロス環境**:
- エラー訂正を有効化
- 再送信を最適化
- プロトコルの切り替え

## クライアント側の最適化設定

### Horizon Clientの設定

**設定項目**:
- **Display Protocol**: デフォルトプロトコル
- **Image Quality**: 画像品質
- **Bandwidth**: 帯域幅設定
- **Performance Tuning**: パフォーマンスチューニング

**設定方法**:
- Horizon Client → Settings → Display Protocol
- 各設定項目を調整

### クライアント側のレジストリ設定

**Windows Client**:
```powershell
# クライアント側のレジストリ設定
# 画像品質の設定
New-ItemProperty -Path "HKCU:\Software\VMware, Inc.\VMware VDM\Client" `
    -Name "ImageQuality" -Value 80 -PropertyType DWord -Force

# 帯域幅の設定
New-ItemProperty -Path "HKCU:\Software\VMware, Inc.\VMware VDM\Client" `
    -Name "MaxBandwidth" -Value 5000 -PropertyType DWord -Force
```

**macOS Client**:
```bash
# macOS Clientの設定
defaults write com.vmware.horizon "ImageQuality" -int 80
defaults write com.vmware.horizon "MaxBandwidth" -int 5000
```

## ベストプラクティス

1. **帯域幅管理**
   - Max Session Bandwidthの適切な設定
   - ネットワーク帯域幅の監視

2. **品質とパフォーマンスのバランス**
   - 用途に応じた設定
   - テスト環境での検証

3. **モニタリング**
   - 帯域幅使用状況の監視
   - ユーザーエクスペリエンスの確認

## 理解度チェックリスト

以下の項目について理解度を確認してください：

### Max Session Bandwidth
- [ ] Max Session Bandwidthレジストリの設定方法を理解している
- [ ] セッションあたりの最大帯域幅の計算方法を説明できる
- [ ] 用途に応じた推奨値を理解している

### Build-to-lossless
- [ ] Build-to-losslessの機能を説明できる
- [ ] 使用すべき場合と使用すべきでない場合を判断できる
- [ ] 設定方法を理解している

### 表示プロトコル
- [ ] Blast Protocolの特徴を説明できる
- [ ] PCoIPとBlast Protocolの違いを理解している
- [ ] 環境に応じたプロトコルの選択ができる

## まとめ

高度な表示プロトコルの最適化は、Horizon環境のパフォーマンスとユーザーエクスペリエンスに重要です。Max Session Bandwidthの設定、Build-to-losslessの適切な使用、Blastとlossless圧縮の最適化により、効率的で高品質なHorizon環境を構築できます。
