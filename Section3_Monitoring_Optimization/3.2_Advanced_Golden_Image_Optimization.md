# 3.2 Advanced Golden Image Optimization

## 概要

高度なゴールデンイメージの最適化は、ログイン時間の短縮と継続的なパフォーマンスの向上に重要です。OCE-Hレベルでは、ローカルGPOを使用したレジストリ経由での最適化、高度なWindowsパフォーマンス設定、Login Monitorを使用した継続的な監視と最適化が求められます。

## ローカルGPOを使用したレジストリ経由でのHorizonとWindowsのパフォーマンス関連メトリックの設定と最適化

### ローカルGPOの設定

**設定手順**:

1. **ローカルグループポリシーエディターを開く**
   ```powershell
   gpedit.msc
   ```

2. **Computer Configuration → Administrative Templates → VMware → VMware Horizon Agent**
   - パフォーマンス関連の設定を有効化

3. **レジストリ設定の直接編集**
   ```powershell
   # レジストリエディターを開く
   regedit
   
   # Horizon Agent設定
   HKEY_LOCAL_MACHINE\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration
   ```

### パフォーマンス関連レジストリ設定

**主要な設定**:

1. **Session Timeout**
   ```powershell
   New-ItemProperty -Path "HKLM:\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration" `
       -Name "SessionTimeout" -Value 1800 -PropertyType DWord -Force
   ```

2. **Idle Timeout**
   ```powershell
   New-ItemProperty -Path "HKLM:\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration" `
       -Name "IdleTimeout" -Value 900 -PropertyType DWord -Force
   ```

3. **Display Protocol Settings**
   ```powershell
   # Blast Protocolの最適化
   New-ItemProperty -Path "HKLM:\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration" `
       -Name "BlastCodec" -Value 1 -PropertyType DWord -Force
   ```

:::important
レジストリ設定は、ゴールデンイメージに適用し、すべてのVMに継承されます。
:::

## ログインと継続的なパフォーマンスに影響を与える高度なWindowsパフォーマンス設定の特定と設定

### Windowsパフォーマンス設定

#### ログイン時間の最適化

**設定項目**:

1. **サービス最適化**
   ```powershell
   # 不要なサービスの無効化
   Set-Service -Name "ServiceName" -StartupType Disabled
   ```

2. **スタートアッププログラムの最適化**
   - タスクスケジューラーで不要なタスクを無効化
   - スタートアップフォルダのクリーンアップ

3. **ネットワーク設定の最適化**
   ```powershell
   # TCP/IP設定の最適化
   netsh int tcp set global autotuninglevel=normal
   netsh int tcp set global chimney=enabled
   ```

#### 継続的なパフォーマンスの最適化

**設定項目**:

1. **電源設定**
   ```powershell
   # 高性能モードに設定
   powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
   ```

2. **視覚効果の最適化**
   ```powershell
   # 視覚効果をパフォーマンス優先に設定
   Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" `
       -Name "VisualFXSetting" -Value 2 -Type DWord
   ```

3. **ページファイルの最適化**
   ```powershell
   # ページファイルサイズの設定
   $System = Get-WmiObject Win32_ComputerSystem -EnableAllPrivileges
   $System.AutomaticManagedPagefile = $false
   $System.Put()
   ```

:::tip
Windowsパフォーマンス設定の最適化により、ログイン時間と継続的なパフォーマンスが向上します。
:::

## Login Monitorを使用した継続的なログインパフォーマンスの監視と最適化

### Login Monitorの概要

**機能**:
- ログイン時間の測定
- ボトルネックの特定
- パフォーマンスの最適化

### Login Monitorの設定

**インストール**:
- Horizon Agentに含まれる
- 追加のインストール不要

**設定方法**:

1. **Login Monitorの有効化**
   ```powershell
   # レジストリで有効化
   New-ItemProperty -Path "HKLM:\SOFTWARE\VMware, Inc.\VMware VDM\Agent\Configuration" `
       -Name "LoginMonitorEnabled" -Value 1 -PropertyType DWord -Force
   ```

2. **ログの確認**
   - ログファイル: `C:\ProgramData\VMware\VDM\logs\vdm-login-monitor.log`

### Login Monitorの使用

**監視項目**:
- ログイン時間
- 各段階の処理時間
- ボトルネックの特定

**最適化**:
- ボトルネックの特定
- 設定の調整
- 再テスト

**Login Monitorの詳細な使用**:

**ログの分析**:
```powershell
# Login Monitorログの分析
$logContent = Get-Content "C:\ProgramData\VMware\VDM\logs\vdm-login-monitor.log"

# ログイン時間の抽出
$loginTimes = $logContent | Select-String "Login completed" | 
    ForEach-Object {
        if ($_ -match "(\d+)ms") {
            [int]$matches[1]
        }
    }

# 統計情報の表示
$loginTimes | Measure-Object -Average -Maximum -Minimum | Format-List
```

**ボトルネックの特定**:
- 各段階の処理時間を確認
- 最も時間がかかっている段階を特定
- その段階の最適化を実施

:::note
Login Monitorを使用することで、ログイン時間のボトルネックを特定し、継続的に最適化できます。
:::

## OSOTの詳細な使用手順

### カスタム最適化テンプレートの作成

**テンプレート作成手順**:

1. **OSOTで標準テンプレートを読み込み**
   - Optimizeタブ → Load Template
   - 標準テンプレートを選択

2. **最適化項目のカスタマイズ**
   - 不要な最適化項目を無効化
   - 追加の最適化項目を有効化
   - 各カテゴリを展開して詳細を確認

3. **テンプレートの保存**
   - File → Save Template
   - テンプレート名を入力
   - ファイル名: `Custom-VDI-Template.xml`

**カスタムテンプレートの例**:
```xml
<?xml version="1.0" encoding="utf-8"?>
<OptimizationTemplate>
    <Name>Custom VDI Template</Name>
    <Description>Custom optimization for VDI environment</Description>
    <Optimizations>
        <Service Name="WSearch" Action="Disable" />
        <Service Name="Themes" Action="Disable" />
        <ScheduledTask Name="Update" Action="Disable" />
    </Optimizations>
</OptimizationTemplate>
```

## 最適化の影響測定

### 最適化前後の比較

**測定項目**:
- ログイン時間
- メモリ使用量
- CPU使用率
- ディスクI/O
- ネットワーク帯域幅

**測定手順**:

1. **最適化前の測定**
   ```powershell
   # ログイン時間の測定
   Measure-Command { 
       # ログイン処理
   }
   
   # リソース使用量の測定
   Get-Counter "\Processor(_Total)\% Processor Time" -SampleInterval 1 -MaxSamples 60
   Get-Counter "\Memory\% Committed Bytes In Use" -SampleInterval 1 -MaxSamples 60
   ```

2. **最適化の適用**
   - OSOTで最適化を実行
   - システムを再起動

3. **最適化後の測定**
   - 同じ測定を実行
   - 結果を比較

**比較レポートの生成**:
```powershell
# 最適化前後の比較レポート
$before = Import-Csv "before-optimization.csv"
$after = Import-Csv "after-optimization.csv"

$comparison = Compare-Object $before $after -Property "Metric", "Value" -PassThru
$comparison | Export-Csv "optimization-comparison.csv" -NoTypeInformation
```

## 最適化のロールバック手順

### ロールバックの準備

**ロールバック計画**:
- 最適化前のスナップショットの確認
- ロールバック手順の準備
- ロールバック時間の見積もり

### ロールバック手順

**OSOTを使用したロールバック**:

1. **OSOTでロールバックを実行**
   - OSOT → Revert
   - ロールバックする最適化を選択
   - Revertをクリック

2. **システムの再起動**
   - ロールバック後、システムを再起動

3. **検証**
   - システムが正常に動作することを確認
   - パフォーマンスを確認

**スナップショットからのロールバック**:

1. **vSphere Clientでの操作**
   - VMを選択
   - Snapshots → 最適化前のスナップショットを選択
   - Revert to Snapshot

2. **検証**
   - システムが正常に動作することを確認

:::warning
ロールバックは、データ損失のリスクがあります。ロールバック前に、必ずバックアップを確認してください。
:::

## ベストプラクティス

1. **ゴールデンイメージの最適化**
   - 定期的な最適化
   - テスト環境での検証

2. **パフォーマンス監視**
   - Login Monitorの継続的な使用
   - メトリックの定期的な確認

3. **設定の管理**
   - レジストリ設定のドキュメント化
   - 変更管理プロセス

## 理解度チェックリスト

以下の項目について理解度を確認してください：

### ローカルGPOとレジストリ
- [ ] ローカルGPOを使用したレジストリ経由でのパフォーマンス関連メトリックの設定方法を理解している
- [ ] HorizonとWindowsのパフォーマンス設定を説明できる

### Windowsパフォーマンス設定
- [ ] ログインと継続的なパフォーマンスに影響する高度なWindowsパフォーマンス設定を特定できる
- [ ] これらの設定の最適化方法を説明できる

### Login Monitor
- [ ] Login Monitorを使用した継続的なログイン性能の監視方法を理解している
- [ ] Login Monitorを使用した最適化方法を説明できる

## まとめ

高度なゴールデンイメージの最適化は、ログイン時間の短縮と継続的なパフォーマンスの向上に重要です。ローカルGPOとレジストリ設定、Windowsパフォーマンス設定、Login Monitorの使用により、効率的でパフォーマンスの高いHorizon環境を構築できます。
