# 3.2 Advanced Golden Image Optimization（ゴールデンイメージの高度な最適化）

> **試験ガイド対応**: Section 4.3.2 - Advanced optimization of golden images

---

## Objective 1: Utilize local GPO to configure and optimize via registry performance-related metrics（ローカル GPO とレジストリによるパフォーマンス指標の最適化）

### ローカル GPO の概要

ゴールデンイメージ上にドメイン GPO とは別にローカルグループポリシー（LGPO）を構成し、レジストリを直接操作してパフォーマンスを最適化する。OSOT のファイナライズフェーズで LGPO.exe を使用してローカルポリシーを生成できる。

### Horizon Agent 関連のレジストリ最適化

**ベースパス**: `HKLM\SOFTWARE\Omnissa\Horizon\Agent\Configuration`

| レジストリ値 | 型 | 推奨値 | 説明 |
|---|---|---|---|
| `ClientIdleTimeout` | REG_DWORD | 900（秒）= 15分 | アイドル状態のクライアントを切断するまでの時間 |
| `ClientSessionTimeout` | REG_DWORD | 36000（秒）= 10時間 | 最大セッション時間（超過で自動切断） |

### Blast 最適化レジストリ

**ベースパス**: `HKLM\Software\Omnissa\Horizon\Blast\Config`

| レジストリ値 | 型 | 推奨値 | 説明 |
|---|---|---|---|
| `MaxSessionBandwidth` | REG_SZ | ユースケースに依存 | セッション最大帯域幅（kbps） |
| `EncoderMaxFPS` | REG_SZ | 15-30 | 最大フレームレート。タスクワーカーは 15、一般は 30 |
| `EncoderCPUControllerEnabled` | REG_SZ | 1 | CPU 使用率に応じて FPS を動的調整 |
| `EncoderMinCPUThrottleFPS` | REG_SZ | 5 | CPU スロットリング時の最低 FPS |
| `UDPEnabled` | REG_SZ | 1 | UDP (BEAT) の有効化 |
| `EncoderGlobalQualityLevel` | REG_SZ | 1-5 | 全コーデック共通品質（1=低, 5=高） |

### Windows パフォーマンス関連レジストリ

#### セッションタイムアウト設定

**パス**: `HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services`

| レジストリ値 | 型 | 推奨値 | 説明 |
|---|---|---|---|
| `MaxIdleTime` | REG_DWORD | 900000（ミリ秒=15分） | アイドルセッションの切断時間 |
| `MaxConnectionTime` | REG_DWORD | 0（無制限）| セッション最大接続時間 |
| `MaxDisconnectionTime` | REG_DWORD | 300000（ミリ秒=5分） | 切断セッションのログオフまでの時間 |
| `RemoteAppLogoffTimeLimit` | REG_DWORD | 0 | RemoteApp 終了後のログオフ時間 |
| `fResetBroken` | REG_DWORD | 1 | 接続が切断されたセッションの終了 |

#### NIC ドライバ最適化

**パス**: `HKLM\SYSTEM\CurrentControlSet\Services\vmxnet3\Parameters\*`

| レジストリ値 | 型 | 推奨値 | 説明 |
|---|---|---|---|
| `*RssOrVmqPreference` | REG_SZ | 1 | RSS (Receive Side Scaling) の有効化 |
| `RSSEnabled` | REG_SZ | 1 | RSS の有効化 |

#### ページファイル設定

**パス**: `HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management`

| レジストリ値 | 型 | 推奨値 | 説明 |
|---|---|---|---|
| `PagingFiles` | REG_MULTI_SZ | `C:\pagefile.sys 2048 2048` | 固定サイズのページファイル（自動拡張を防止） |
| `ClearPageFileAtShutdown` | REG_DWORD | 0 | シャットダウン時のページファイルクリアを無効化 |

#### Windows Search / インデクサー

**パス**: `HKLM\SOFTWARE\Policies\Microsoft\Windows\Windows Search`

| レジストリ値 | 型 | 推奨値 | 説明 |
|---|---|---|---|
| `AllowCortana` | REG_DWORD | 0 | Cortana の無効化 |
| `AllowSearchToUseLocation` | REG_DWORD | 0 | 検索での位置情報使用を無効化 |
| `DisableWebSearch` | REG_DWORD | 1 | Web 検索の無効化 |
| `PreventIndexingLowDiskSpaceMB` | REG_DWORD | 1 | ディスク容量不足時のインデックス作成防止 |

### ローカル GPO 適用ワークフロー（OSOT 連携）

1. **OSOT で最適化を実行** → テンプレートに基づいてレジストリ値を設定
2. **ファイナライズフェーズ** → LGPO.exe を使用してローカル GPO を生成
3. **生成されたポリシー** → RSOP や GPEdit で確認可能
4. **ドメイン GPO との関係** → ドメイン GPO がローカル GPO より優先される（LSDOU: Local → Site → Domain → OU）

> **試験ポイント**: ローカル GPO はドメイン GPO より優先度が低い。ゴールデンイメージに設定したローカル GPO が本番環境でドメイン GPO に上書きされないか確認が必要。

---

## Objective 2: Identify and configure advanced Windows performance settings（Windows パフォーマンス設定の特定と構成）

### Omnissa Windows OS Optimization Tool (OSOT)

OSOT は Horizon ゴールデンイメージの Windows OS を最適化するための公式ツール。仮想環境に不要な物理デスクトップ機能を無効化し、パフォーマンス向上・集約度向上・UX改善を実現する。

#### サポート対象 OS

| OS | OSOT EXE | MDT Plugin |
|---|---|---|
| Windows 10 | ○ | ○ |
| Windows 11（24H2 以外） | ○ | ○ |
| Windows 11 24H2 | ○（v2503以降） | × |
| Windows Server 2019 | ○ | ○ |
| Windows Server 2022 | ○ | ○ |
| Windows 7 / 8.1 / Server 2012/2016/2025 | × | × |

> **重要**: Omnissa MDT Automation Tool は既知の問題により機能しないため、使用しないこと（非サポート）。MDT サーバは手動でセットアップする必要がある。

#### OSOT の 5 段階ワークフロー

```
VM作成・アプリインストール → 最適化 → 一般化 → ファイナライズ → 更新
```

| フェーズ | 処理内容 |
|---|---|
| **最適化 (Optimize)** | テンプレートに基づき、サービス・レジストリ・スケジュールタスク等を分析・最適化 |
| **一般化 (Generalize)** | Sysprep を実行し、コンピュータ固有の情報を削除。監査モード必須 |
| **ファイナライズ (Finalize)** | SDelete でディスク空き領域をゼロ化、LGPO.exe でローカル GPO 生成 |
| **更新 (Update)** | Windows Update を再有効化し、パッチ適用後に再最適化 |
| **履歴 (History)** | 最適化履歴の表示とロールバック |

#### 最適化テンプレート

テンプレートは `%ProgramData%` 配下の Templates フォルダ内の XML ファイルとして保存される。デフォルトテンプレートは `Windows 10, Windows 11, and Server 2019, 2022.xml`。Windows 11 23H2 と 24H2 は同一テンプレートで最適化可能。

各最適化項目には重要度アイコンが付与される:

| アイコン | 意味 |
|---|---|
| 必須 (Mandatory) | OS Optimization Tool が検出した問題を解決するために適用が必要 |
| 推奨 (Recommended) | 最適化を推奨するが、環境に合うか判断が必要。選択解除されている場合に有効にすると不安定になる可能性あり |
| オプション (Optional) | 推奨なし。環境に応じて判断 |
| OK | 既に最適な状態。変更不要 |

#### OSOT コマンドライン実行

```
optimization-tool.exe [-optimize|-o] [-generalize|-g] [-finalize|-f] [-reboot|-shutdown]
```

最適化レベル指定:

```
optimization-tool.exe -o [default | all | recommended | mandatory | none]
```

その他のコマンドラインオプション:

| パラメータ | 説明 |
|---|---|
| `-v` | 詳細モードを有効化 |
| `-r report_file_path` | 分析レポートをファイルに保存 |
| `-t template` | 使用するテンプレートを指定（XML ファイルパスまたはテンプレート名） |
| `-applyoptimization settings.json` | JSON ファイルから最適化選択をインポートして適用 |

#### 共通オプション（Common Options）

OSOT UI の「共通オプション」ボタン、またはコマンドラインから複数の設定を一括制御できる。

| オプション | パラメータ | 説明 |
|---|---|---|
| **SyncHkuWithHku** | `enable / disable` | HKCU とデフォルトユーザーレジストリハイブの同期。デフォルト: 有効 |
| **Visual Effect** | `performance / balanced / quality / enablehardwareacceleration` | 視覚効果のレベル |
| **Windows Update** | `enable / disable` | 非パーシステントデスクトップでは disable 推奨 |
| **Office Update** | `enable / disable` | Office 365/2016/2019 の更新サービス |
| **Store App** | `keep-all / remove-all [--exclude ...]` | ストアアプリの保持/削除 |
| **Background** | `#000000`（16進カラーコード） | 壁紙を単色に設定 |
| **Notification** | `enable / disable` | システム通知の有効/無効 |
| **Firewall** | `enable / disable` | Windows ファイアウォール |
| **Antivirus** | `enable / disable` | OS 組み込みのウイルス対策 |
| **Security Center** | `enable / disable` | セキュリティセンター |

### Windows 11 固有の最適化注意事項

#### Windows 11 24H2

| 項目 | 注意事項 |
|---|---|
| **OS デプロイ後の再起動** | 必須。再起動しないと最適化後にシステムが再起動保留になり、一般化が失敗する |
| **OSOT バージョン** | v2503 以降が必要。以前のバージョンは 24H2 非対応 |
| **MDT プラグイン** | 24H2 非対応（Microsoft MDT 自体が 24H2 で動作しないため） |
| **BitLocker** | 一般化前に無効化が必要（Lock Status: Disabled、Conversion Status: Not Encrypted） |
| **ストアアプリ削除** | OSOT のストアアプリ削除機能に不具合あり。PowerShell で手動削除が必要な場合がある |

#### vTPM の考慮事項

Windows 11 のゴールデンイメージには vTPM を**付けない**ことが推奨される:
- **パーシステント VM**: クローン後に個別に vTPM を追加
- **インスタントクローン**: デスクトッププール設定でプロビジョニング時に vTPM を自動追加

#### 一般化前の前提条件

- Windows が監査モードであること
- 必要な言語パックがすべてインストール済み
- ユーザー固有のアプリケーションが削除済み（特に Microsoft Copilot、Microsoft Edge）
- インターネットアクセスの無効化を推奨（Windows 11 が組み込みアプリを自動更新し、一般化を中断する可能性）

### Visual Effects（視覚効果）の最適化

**パス**: `HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects`

| 設定レベル（OSOT） | 動作 | 推奨用途 |
|---|---|---|
| **Performance** | すべての視覚効果を無効化。パフォーマンス最優先 | タスクワーカー、高密度VDI |
| **Balanced** | 「画面フォントの縁を滑らかにする」と「デスクトップのアイコン名に影を付ける」のみ有効 | 一般的なナレッジワーカー |
| **Quality** | すべての視覚効果を有効化。UX 優先だがリソース消費増 | 特殊な UX 要件がある場合 |
| **Enable Hardware Acceleration** | アプリケーションでのハードウェアアクセラレーション有効化 | GPU 搭載環境 |

**レジストリ設定（手動の場合）**:

| パス | 値名 | 推奨値 | 説明 |
|---|---|---|---|
| `HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects` | `VisualFXSetting` | 2 | 2=カスタム設定を使用 |
| `HKCU\Control Panel\Desktop` | `UserPreferencesMask` | - | 個々の視覚効果を制御するビットマスク |
| `HKCU\Control Panel\Desktop` | `DragFullWindows` | 0 | ウィンドウドラッグ時のコンテンツ表示を無効化 |
| `HKCU\Control Panel\Desktop\WindowMetrics` | `MinAnimate` | 0 | ウィンドウ最小化時のアニメーション無効化 |

### Power Plan（電源プラン）の最適化

VDI 環境では仮想マシンの電源管理を最適化する。

| 設定 | 推奨値 | 説明 |
|---|---|---|
| **Power Plan** | High Performance | 省電力モードによる CPU スロットリングを防止 |
| **Turn off display** | Never (0) | ディスプレイのオフを無効化 |
| **Hard disk turn off** | Never (0) | ディスクの停止を無効化 |
| **Sleep** | Never (0) | スリープを無効化 |
| **Hibernate** | Disabled | ハイバネーションを無効化（ディスク容量節約） |

**PowerShell でのハイバネーション無効化**:

```powershell
powercfg /hibernate off
```

**PowerShell での High Performance プラン設定**:

```powershell
powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
```

### Services（サービス）の無効化

仮想環境で不要なサービスを無効化することで、CPU・メモリ使用量を削減し集約度を向上させる。OSOT のテンプレートに含まれるが、手動設定も可能。

#### OSOT が推奨する無効化対象サービス（主要なもの）

| サービス名 | 表示名 | 無効化の理由 |
|---|---|---|
| `WSearch` | Windows Search | インデクサーの CPU/ディスク I/O 消費を防止 |
| `wuauserv` | Windows Update | 非パーシステント環境では不要。ゴールデンイメージで管理 |
| `MapsBroker` | Downloaded Maps Manager | オフラインマップ不要 |
| `DiagTrack` | Connected User Experiences and Telemetry | テレメトリデータ収集の CPU/ネットワーク消費を防止 |
| `dmwappushservice` | Device Management WAP Push | 同上 |
| `SysMain` | SysMain (Superfetch) | VDI では逆にパフォーマンス低下を招く |
| `WerSvc` | Windows Error Reporting Service | エラーレポートの自動送信不要 |
| `TabletInputService` | Touch Keyboard and Handwriting Panel | タッチ入力デバイスのない環境で不要 |
| `RetailDemo` | Retail Demo Service | デモモード不要 |
| `XblAuthManager` | Xbox Live Auth Manager | ゲーム関連サービス不要 |
| `XblGameSave` | Xbox Live Game Save | 同上 |
| `Fax` | Fax | FAX 機能不要 |
| `PrintNotify` | Printer Extensions and Notifications | プリンタ拡張機能不要（ThinPrint 使用の場合は有効化が必要） |

#### Scheduled Tasks（スケジュールされたタスク）の無効化

OSOT はスケジュールされたタスクも最適化対象とし、以下を無効化する:

| タスク | 無効化の理由 |
|---|---|
| `\Microsoft\Windows\Defrag\ScheduledDefrag` | SSD/シンプロビジョニング環境では不要 |
| `\Microsoft\Windows\DiskDiagnostic\*` | 物理ディスク診断は仮想環境で不要 |
| `\Microsoft\Windows\Maintenance\WinSAT` | パフォーマンス評価は仮想環境で不要 |
| `\Microsoft\Windows\Power Efficiency Diagnostics\*` | 電力効率診断は仮想環境で不要 |
| `\Microsoft\Windows\WindowsUpdate\*` | 非パーシステント環境で不要 |

> **試験ポイント**: OSOT は最適化をロールバックできる。ロールバックは「履歴」タブから実行し、選択した最適化実行のすべての変更を元に戻す。ファイナライズで SDelete（ディスクゼロ化）と LGPO.exe（ローカル GPO 生成）が必要。

---

## Objective 3: Use Login Monitor to continuously monitor and optimize login performance（Logon Monitor による継続的なログインパフォーマンスの監視と最適化）

### Logon Monitor の概要

Logon Monitor は Horizon Agent の一部としてインストールされるコンポーネント。ユーザーのログオンプロセスを詳細に監視し、ボトルネックを特定するためのメトリクスを収集する。App Volumes や Dynamic Environment Manager などの他の Omnissa 製品とも統合される。

### ログファイル

Logon Monitor のログはデフォルトで `C:\ProgramData\Omnissa\Logs` に書き込まれる。

| ログタイプ | ファイル名 | 内容 |
|---|---|---|
| **メインログ** | `vmlm.txt` | vmlm サービスのステータスメッセージとセッション前後のイベント |
| **セッションログ** | セッションごとのファイル | 個々のユーザーログオンセッションの全イベント。完了時にサマリを出力 |

### Logon Monitor 構成レジストリ

**パス**: `HKLM\SOFTWARE\Omnissa\Horizon\Logon Monitor`

| レジストリ値 | 型 | デフォルト | 説明 |
|---|---|---|---|
| `RemoteLogPath` | REG_SZ | 未設定（無効） | ログアップロード先のリモート共有パス。例: `\\server\share\%username%.%userdomain%` |
| `Flags` | REG_DWORD | 0x2 | 動作制御ビットマスク（下表参照） |
| `LogMaxSizeMB` | REG_DWORD | 100 | メインログの最大サイズ（MB） |
| `LogKeepDays` | REG_DWORD | 7 | メインログの保持日数 |

#### Flags ビットマスク値

| 値 | 機能 | デフォルト |
|---|---|---|
| `0x1` | クラッシュダンプを無効化。ダンプは `C:\ProgramData\Omnissa\Logon Monitor\Data` に書き込み | 無効（ダンプ有効） |
| `0x2` | Horizon 8 との統合を有効化 | **有効** |
| `0x4` | CPU とメモリのメトリクス収集を有効化 | 無効 |
| `0x8` | プロセスイベントとログオンスクリプトメトリクスの収集を有効化 | 無効 |
| `0x10` | リモートパスにユーザーごとのフォルダを作成 | 無効 |

> **重要**: CPU/メモリメトリクスの収集（`0x4`）やプロセスイベント収集（`0x8`）はデフォルトで無効。ログオンパフォーマンスの詳細分析にはこれらのフラグを有効化する（例: `Flags = 0xE` で 0x2 + 0x4 + 0x8 を有効化）。

### Logon Monitor メトリクス

| メトリクス | パラメータ | 説明 |
|---|---|---|
| **Logon Time** | Start / End / Total Time | ゲスト OS 上でのログオン処理の合計時間。ゲスト外の時間は除外 |
| **Session Start to Logon Start** | Total Time | Windows がセッション作成からログオン開始までの時間 |
| **Group Policy Time** | User GPO / Machine GPO | ユーザー GPO とマシン GPO の適用時間 |
| **Profile Sync Time** | Total Time | ログオン中のプロファイル同期時間 |
| **Profile Metrics** | Type / Size | プロファイルタイプ（local/roaming/temporary）とサイズ（ファイル数/フォルダ数/MB） |
| **Shell Load** | Start / End / Total Time | ユーザーシェル（explorer.exe）のロード時間 |
| **Logon to Hive Load** | Total Time | ログオン開始からユーザーレジストリハイブロードまでの時間 |
| **Windows Folder Redirection** | Start / End / Total Time | フォルダリダイレクションの適用時間。初回や新規ファイルアップロード時に長くなる |
| **GPO Logon Script Time** | Total Time | GPO ログオンスクリプトの実行時間 |
| **Processes Started During Logon** | Name / PID / Parent PID | ログオン中に起動されたプロセスの一覧（Flags `0x8` で有効化が必要） |
| **Memory Usage** | Available / Committed / Paged Pool (min/max/avg) | ログオン中のメモリ使用量（Flags `0x4` で有効化が必要） |
| **CPU Usage** | Idle / User / Kernel CPU (min/max/avg) | ログオン中の CPU 使用率（Flags `0x4` で有効化が必要） |
| **Domain Controller Discovery** | Error Code / Total Time | DC への到達時間とエラーコード |
| **Network Connection** | Bandwidth / Slow Link Threshold / Slow Link Detected | ネットワーク帯域幅とスローリンク検出 |

### Timing Profiler（タイミングプロファイラー）

Logon Monitor は Horizon Help Desk Tool のタイミングプロファイラーと統合されている。デフォルトで無効。

**有効化**:

```
vdmadmin -I -timingProfiler -enable
```

**無効化**:

```
vdmadmin -I -timingProfiler -disable
```

タイミングプロファイラーを有効にすると、Logon Monitor はイベントをイベントデータベースに書き込み、Help Desk Tool の UI からログオン時間の詳細を確認できる。

### ログオンに影響する GPO 設定

Logon Monitor は以下の GPO 設定がログオン時間に影響していないかも追跡する:

| GPO パス | 影響 |
|---|---|
| `Computer\Administrative Templates\Logon\Always wait for network at computer startup and logon` | ログオン時にネットワーク待機を強制 |
| `Computer\Administrative Templates\Logon\Run these programs at user logon` | ログオン時のプログラム実行 |
| `Computer\Administrative Templates\User Profiles\Wait for roaming user profile` | ローミングプロファイルの待機 |
| `Computer\Administrative Templates\User Profiles\Set maximum wait time for network...` | プロファイルのネットワーク待機時間 |
| `Computer\Administrative Templates\Group Policy\Configure Logon Script Delay` | ログオンスクリプトの遅延設定 |

### 各ログオンフェーズの最適化手法

#### GPO フェーズの最適化

| 対策 | 詳細 |
|---|---|
| **不要な GPO を減らす** | 適用対象外の GPO リンクを無効化し、処理する GPO 数を削減 |
| **GPO の WMI フィルタリングを最適化** | 複雑な WMI クエリを避け、セキュリティグループフィルタリングを優先 |
| **ループバック処理の使用を検討** | VDI プールに特化した GPO を適用する場合に有効 |
| **同期ログオンスクリプトを避ける** | 非同期実行に変更し、ログオン待ちを削減 |
| **GPO の適用を CSE 単位で確認** | Logon Monitor の CSE (Client Side Extension) 別の処理時間で問題箇所を特定 |

#### Profile フェーズの最適化

| 対策 | 詳細 |
|---|---|
| **プロファイルサイズを制限** | 肥大化したプロファイルはログオン/ログオフを遅延させる |
| **フォルダリダイレクションを使用** | デスクトップ、ドキュメント等をネットワーク共有にリダイレクトし、プロファイル同期を削減 |
| **DEM (Dynamic Environment Manager) を活用** | ユーザー設定の効率的な管理とプロファイルの最適化 |
| **一時プロファイルの検出** | Logon Monitor でプロファイルタイプが temporary と表示される場合、プロファイルサービスの問題を調査 |

#### Shell フェーズの最適化

| 対策 | 詳細 |
|---|---|
| **スタートアッププログラムを削減** | `shell:startup` フォルダと `Run/RunOnce` レジストリキーの項目を最小化 |
| **App Volumes の影響を確認** | App Volumes のアタッチ処理がシェルロードに影響していないか確認 |
| **不要な Shell Extensions を無効化** | サードパーティのシェル拡張がエクスプローラーの起動を遅延させる可能性 |

#### App フェーズ（全体的な最適化）

| 対策 | 詳細 |
|---|---|
| **App Volumes の最適化** | アプリケーションパッケージ数を最適化し、アタッチ時間を短縮 |
| **Logon Script の最適化** | スクリプトの実行時間を確認し、不要な処理を削除 |
| **Omnissa 製品メトリクスを確認** | Logon Monitor のログに Horizon Agent、App Volumes、DEM からのカスタムメトリクスが記録される |

### Horizon Performance Tracker

Horizon Performance Tracker はリモートデスクトップ内で実行するユーティリティで、表示プロトコルとシステムリソースの使用状況をリアルタイムで監視する。

**インストール**: Horizon Agent インストーラのカスタムセットアップオプション（デフォルトでは未選択）

**GPO テンプレート**: `vdm_agent_perfTracker.admx`

**GPO パス**: `Computer Configuration > Administrative Templates > Horizon Performance Tracker`

**サポート**: Blast / PCoIP 両方のプロトコルに対応。Linux Agent を除くすべての Horizon Agent 対応 OS で利用可能。.NET Framework 4.0 以降が必要。

#### At a Glance タブ

| 監視項目 | 内容 |
|---|---|
| **プロトコル** | 使用中のプロトコル名（Blast / PCoIP） |
| **エンコーダ** | 使用中のエンコーダ名（BlastCodec, H.264, HEVC, AV1） |
| **帯域幅** | 現在のネットワーク帯域幅使用量 |
| **FPS** | 現在のフレームレート |
| **CPU 使用率** | エンコーダ CPU / システム CPU |
| **トランスポート** | Client→Agent / Agent→Client の UDP/TCP 使用状況 |
| **オーディオ** | オーディオの状態 |
| **推定帯域幅** | ネットワークの推定帯域幅 |
| **ラウンドトリップレイテンシ** | セッションのレイテンシ |

#### Session Properties タブ

| 監視項目 | 内容 |
|---|---|
| **Broker URL** | 接続先の Connection Server URL |
| **デバイス情報** | クライアントデバイスの詳細 |
| **キーボードタイプ** | 接続されたキーボードの種類 |
| **ユーザーの場所** | ユーザーの接続元 |

#### Performance Tracker の制限事項

- CPU、RAM、ディスク I/O の完全なリソース使用概要は提供しない
- GPU の詳細と使用情報は利用不可
- リソース不足の評価機能が限定的

> **試験ポイント**: Performance Tracker は Horizon Agent のカスタムセットアップオプションで選択する必要がある。At a Glance タブでリアルタイムのプロトコル・帯域幅・FPS を、Session Properties タブでセッション詳細を確認できる。

---

## MDT を使用した自動化されたイメージ作成

### MDT (Microsoft Deployment Toolkit) による自動化の概要

MDT を使用することで、ゴールデンイメージの作成を自動化できる。OSOT の MDT プラグインにより、タスクシーケンスに Horizon 固有の最適化タスクを組み込める。

### 自動化の高レベルフロー

1. ターゲット VM が PXE ブートし、Windows Deployment Services からブートイメージを取得
2. Windows PE イメージが実行される
3. MDT タスクシーケンスが開始
4. タスクシーケンスが Windows、アプリケーション、エージェントをインストールし、OSOT で最適化

### MDT プラグインのタスクシーケンス構成

| ステップ | 内容 |
|---|---|
| **Optimize** | テンプレートに基づく最適化設定の適用 |
| **Generalize** | Sysprep の実行設定 |
| **Finalize** | SDelete、LGPO の設定 |
| **Horizon Agent** | エージェントのインストールとオプション設定 |
| **DEM / App Volumes** | 追加エージェントのインストール |
| **VMware Tools** | ハイパーバイザーツールのインストール |

> **注意**: RDSH ビルドは現在、MDT プラグインで完全に自動化できない。Restart computer ステップで手動ログインが必要。

---

## ベストプラクティス

1. **OSOT テンプレートのカスタマイズ**: デフォルトテンプレートをコピーしてカスタマイズし、組織固有の要件に合わせる。テンプレートは XML 形式で編集可能
2. **最適化前のスナップショット**: 最適化実行前に VM のスナップショットを取得し、問題発生時にロールバック可能にする
3. **OSOT ロールバック機能の活用**: OSOT の履歴タブから最適化をロールバック可能。スナップショットとの二重保護
4. **段階的な最適化**: 全設定を一度に変更せず、段階的に適用してユーザー受け入れテスト（UAT）を実施
5. **非パーシステント環境での Windows Update 無効化**: ゴールデンイメージで一括管理し、プール更新で適用
6. **Logon Monitor の Flags 設定**: 詳細分析が必要な場合は `0x4`（CPU/メモリ）と `0x8`（プロセス）を一時的に有効化。常時有効はオーバーヘッドに注意
7. **RemoteLogPath の活用**: ログを中央ファイルサーバーに集約することで、大規模環境でのトラブルシューティングを効率化
8. **Windows 11 24H2 では OSOT v2503 以降を使用**: 以前のバージョンは非対応
9. **vTPM をゴールデンイメージに付けない**: クローン後またはプロビジョニング時に追加する

## アンチパターン

1. **OSOT のデフォルトテンプレートをそのまま使用**: 組織に必要なサービスまで無効化される可能性がある（例: プリンタサービス、Windows ファイアウォール）
2. **最適化前のスナップショット未取得**: ロールバックが困難になり、問題発生時にイメージの再作成が必要になる
3. **Windows 11 24H2 での再起動忘れ**: OS デプロイ後に再起動しないと最適化後にシステムが再起動保留になり、一般化が失敗する
4. **ローカル GPO とドメイン GPO の競合を無視**: LSDOU の優先順位を理解せず、設定が上書きされることに気付かない
5. **Logon Monitor の全フラグを常時有効化**: CPU/メモリメトリクス収集のオーバーヘッドが常時発生し、本来最適化すべきパフォーマンスに悪影響
6. **Sysprep 前のインターネットアクセス無効化忘れ**: Windows 11 がアプリを自動更新し、一般化が中断される可能性
7. **MDT Automation Tool の使用**: 既知の問題により機能しない。手動での MDT サーバ構築を推奨

---

## 理解度チェックリスト

### ローカル GPO とレジストリ最適化
- [ ] Blast 関連のレジストリパス（`HKLM\Software\Omnissa\Horizon\Blast\Config`）の主要な値を挙げられる
- [ ] ローカル GPO とドメイン GPO の優先順位（LSDOU）を説明できる
- [ ] OSOT のファイナライズフェーズで LGPO.exe が果たす役割を理解している

### OSOT と Windows パフォーマンス設定
- [ ] OSOT の 5 段階ワークフロー（最適化→一般化→ファイナライズ→更新→履歴）を説明できる
- [ ] OSOT のテンプレートの重要度レベル（必須/推奨/オプション/OK）を区別できる
- [ ] コマンドラインでの OSOT 実行方法とパラメータ（`-o recommended` 等）を把握している
- [ ] Visual Effects の各レベル（Performance/Balanced/Quality）の違いを説明できる
- [ ] 非パーシステント環境で無効化すべき主要サービスを 5 つ以上挙げられる
- [ ] OSOT のロールバック機能の操作方法を理解している
- [ ] Windows 11 24H2 固有の注意事項（再起動、OSOT v2503、BitLocker 無効化、vTPM）を把握している

### Logon Monitor
- [ ] Logon Monitor のログ保存先とログタイプ（メイン/セッション）を説明できる
- [ ] Logon Monitor のレジストリ設定パスと主要な値（RemoteLogPath, Flags, LogMaxSizeMB）を把握している
- [ ] Flags のビットマスク値（0x2, 0x4, 0x8）それぞれの機能を説明できる
- [ ] Timing Profiler の有効化コマンド（`vdmadmin -I -timingProfiler -enable`）を把握している
- [ ] 各ログオンフェーズ（GPO, Profile, Shell）のボトルネック特定と最適化手法を説明できる
- [ ] Horizon Performance Tracker のインストール方法と 2 つのタブ（At a Glance / Session Properties）の監視内容を理解している
