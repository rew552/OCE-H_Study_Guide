# 3.3 Pool Capacity Planning

## 概要

プール容量計画は、Horizon環境のリソース管理とスケーラビリティに重要です。OCE-Hレベルでは、リソース制約に基づくプール設定の監視と調整（予測 vs 実際の容量）が求められます。

## リソース制約に基づくプール設定の監視と調整（予測 vs 実際の容量）

### 容量計画の重要性

**考慮事項**:
- CPUリソース
- メモリリソース
- ストレージリソース
- ネットワーク帯域幅

### 詳細な容量計算式

**CPU容量の計算**:
```
予測CPU容量 = (利用可能CPUコア数) / (VMあたりのCPUコア数) × CPUオーバーコミット率

例:
- 利用可能CPU: 100コア
- VMあたりのCPU: 2コア
- CPUオーバーコミット率: 4:1
- 予測容量 = (100 / 2) × 4 = 200 VM
```

**メモリ容量の計算**:
```
予測メモリ容量 = (利用可能メモリ) / (VMあたりのメモリ) × メモリオーバーコミット率

例:
- 利用可能メモリ: 400GB
- VMあたりのメモリ: 8GB
- メモリオーバーコミット率: 1.2:1
- 予測容量 = (400 / 8) × 1.2 = 60 VM
```

**ストレージ容量の計算**:
```
予測ストレージ容量 = (利用可能ストレージ) / (VMあたりのストレージ)

例:
- 利用可能ストレージ: 10TB
- VMあたりのストレージ: 60GB
- 予測容量 = 10TB / 60GB = 166 VM
```

**総合的な容量計算**:
```
予測容量 = min(CPU容量, メモリ容量, ストレージ容量)

例:
- CPU容量: 200 VM
- メモリ容量: 60 VM
- ストレージ容量: 166 VM
- 予測容量 = min(200, 60, 166) = 60 VM
```

### 容量計算ツール

**vRealize Operations Manager**:
- 自動的な容量計算
- トレンド分析
- 推奨事項の提供

**PowerShellスクリプト**:
```powershell
# 容量計算スクリプト
$cluster = Get-Cluster -Name "Production-Cluster"
$hosts = Get-VMHost -Location $cluster

$totalCPU = ($hosts | Measure-Object -Property NumCpu -Sum).Sum
$totalMemory = ($hosts | Measure-Object -Property MemoryTotalGB -Sum).Sum
$totalStorage = ($hosts | Get-Datastore | Measure-Object -Property FreeSpaceGB -Sum).Sum

$vmCPU = 2
$vmMemory = 8
$vmStorage = 60

$cpuCapacity = [math]::Floor(($totalCPU / $vmCPU) * 4)
$memoryCapacity = [math]::Floor(($totalMemory / $vmMemory) * 1.2)
$storageCapacity = [math]::Floor($totalStorage / $vmStorage)

$predictedCapacity = [math]::Min($cpuCapacity, $memoryCapacity, $storageCapacity)

Write-Host "Predicted Capacity: $predictedCapacity VM"
Write-Host "  CPU Capacity: $cpuCapacity VM"
Write-Host "  Memory Capacity: $memoryCapacity VM"
Write-Host "  Storage Capacity: $storageCapacity VM"
```

### 実際の容量の監視

**監視項目**:
1. **CPU使用率**
   - 目標: 80%以下
   - 警告: 80-90%
   - クリティカル: 90%以上

2. **メモリ使用率**
   - 目標: 90%以下
   - 警告: 90-95%
   - クリティカル: 95%以上

3. **ストレージ使用率**
   - 目標: 80%以下
   - 警告: 80-90%
   - クリティカル: 90%以上

### 容量の調整

**調整方法**:

1. **リソースの追加**
   - ESXiホストの追加
   - メモリの追加
   - ストレージの追加

2. **プール設定の調整**
   - 最大VM数の調整
   - リソース割り当ての調整

3. **最適化**
   - リソース使用率の最適化
   - 不要なVMの削除

### リソース使用率のトレンド分析

**トレンド分析の実施**:

1. **データの収集**
   - 日次、週次、月次のデータを収集
   - CPU、メモリ、ストレージ、ネットワークの使用率

2. **トレンドの分析**
   - 使用率の増加傾向を確認
   - ピーク使用時間の特定
   - 成長率の計算

3. **予測の更新**
   - トレンドに基づいて予測を更新
   - 将来の容量要件を予測

**トレンド分析スクリプト**:
```powershell
# リソース使用率のトレンド分析
$data = Import-Csv "resource-usage.csv"

# 日次平均の計算
$dailyAverage = $data | Group-Object Date | 
    ForEach-Object {
        [PSCustomObject]@{
            Date = $_.Name
            AvgCPU = ($_.Group | Measure-Object -Property CPU -Average).Average
            AvgMemory = ($_.Group | Measure-Object -Property Memory -Average).Average
        }
    }

# 成長率の計算
$growthRate = (($dailyAverage[-1].AvgCPU - $dailyAverage[0].AvgCPU) / $dailyAverage[0].AvgCPU) * 100
Write-Host "CPU Growth Rate: $growthRate%"
```

## 容量計画の自動化

### 自動化スクリプト

**容量監視スクリプト**:
```powershell
# 容量監視スクリプト
$threshold = 80  # 警告閾値（%）

$cluster = Get-Cluster -Name "Production-Cluster"
$hosts = Get-VMHost -Location $cluster

foreach ($host in $hosts) {
    $cpuUsage = (Get-Stat -Entity $host -Stat "cpu.usage.average" -Realtime).Value
    $memoryUsage = (Get-Stat -Entity $host -Stat "mem.usage.average" -Realtime).Value
    
    if ($cpuUsage -gt $threshold -or $memoryUsage -gt $threshold) {
        Send-MailMessage -To "admin@contoso.com" `
            -Subject "Capacity Alert: $($host.Name)" `
            -Body "CPU: $cpuUsage%, Memory: $memoryUsage%"
    }
}
```

## 容量アラートの設定

### アラートの設定

**vRealize Operations Managerでの設定**:
- 容量アラートポリシーの作成
- 閾値の設定
- 通知の設定

**PowerShellスクリプトでの設定**:
```powershell
# 容量アラートの設定
$alertThreshold = 80

# スケジュールされたタスクの作成
$action = New-ScheduledTaskAction -Execute "PowerShell.exe" `
    -Argument "-File C:\Scripts\CapacityAlert.ps1"
$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 15)
Register-ScheduledTask -TaskName "Capacity Alert" `
    -Action $action -Trigger $trigger -User "SYSTEM"
```

:::important
予測容量と実際の容量の差を定期的に確認し、必要に応じて調整してください。
:::

## ベストプラクティス

1. **定期的な監視**
   - 容量の定期的な確認
   - トレンド分析

2. **予測と実際の比較**
   - 予測容量と実際の容量の比較
   - 差異の分析

3. **プロアクティブな調整**
   - リソース制約の早期発見
   - 事前の調整

## 理解度チェックリスト

以下の項目について理解度を確認してください：

### 容量の監視
- [ ] リソース制約（予測容量 vs 実際の容量）に基づくプール設定の監視方法を理解している
- [ ] 容量のトレンド分析方法を説明できる

### 容量の調整
- [ ] プール設定の調整方法を理解している
- [ ] リソースの追加方法を説明できる

### 容量計画
- [ ] 将来の容量要件の予測方法を理解している
- [ ] 容量アラートの設定方法を説明できる

## まとめ

プール容量計画は、Horizon環境のリソース管理とスケーラビリティに重要です。予測容量と実際の容量の監視と調整により、効率的でスケーラブルなHorizon環境を構築できます。
