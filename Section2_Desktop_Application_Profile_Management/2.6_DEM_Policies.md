# 2.6 DEM Policies

## 概要

Dynamic Environment Manager (DEM)ポリシーの管理は、ユーザー環境の制御に重要です。OCE-Hレベルでは、Smart Policies、条件セット（モジュラーアプローチ）、Horizon Smart Policiesの使用が求められます。

## 学習目標

このセクションを学習することで、以下のことができるようになります：

- Smart Policiesの作成と管理ができる
- 条件セット（モジュラーアプローチ）の作成と使用ができる
- Horizon Smart Policiesのユースケースを特定できる
- DEMポリシーの適用順序を理解している

## 関連リソース

- [クイックリファレンス](../../00_Quick_Reference.md) - ポート番号、設定値、制限値
- [用語集](../../README.md#用語集) - 関連用語の定義
- [1.7 DEM Integration](../../Section1_Infrastructure_Planning_and_Management/1.7_DEM_Integration.md) - DEM統合
- [実環境シナリオ](../../00_Scenarios/Section2_Scenarios.md) - 実環境でのシナリオ例

## DEMポリシーの種類

### ユーザー環境ポリシー

**主な設定項目**:
- デスクトップ設定（壁紙、テーマ、解像度）
- スタートメニューのレイアウト
- タスクバーの設定
- ファイル関連付け

### コンピューター環境ポリシー

**主な設定項目**:
- システム設定
- ネットワーク設定
- セキュリティ設定
- 環境変数

## Smart Policies

### Smart Policiesの概要

**機能**:
- 条件に基づいてポリシーを適用
- 動的な環境設定
- ユーザー、デバイス、アプリケーションに基づく設定

### 条件の種類

#### ユーザーグループ条件

**設定例**:
```
条件: UserGroup = "CN=Sales,OU=Groups,DC=contoso,DC=com"
適用ポリシー: 営業部門向けのデスクトップ設定
```

**設定手順**:
1. DEM Management Console → Policies → Smart Policies
2. New Smart Policyをクリック
3. Condition Type: User Groupを選択
4. グループを指定
5. 適用するポリシーを選択

#### デバイスタイプ条件

**設定例**:
```
条件: DeviceType = "Desktop"
適用ポリシー: デスクトップ向けの設定

条件: DeviceType = "Tablet"
適用ポリシー: タブレット向けの設定（タッチ最適化）
```

#### アプリケーション条件

**設定例**:
```
条件: Application = "Microsoft Office"
適用ポリシー: Office向けの設定

条件: Application = "CAD Application"
適用ポリシー: CAD向けの設定（高解像度、GPU設定）
```

#### ネットワーク位置条件

**設定例**:
```
条件: NetworkLocation = "Internal"
適用ポリシー: 内部ネットワーク向けの設定

条件: NetworkLocation = "External"
適用ポリシー: 外部ネットワーク向けの設定（セキュリティ強化）
```

### Horizon Smart Policies

**概要**:
- Horizon環境に特化したSmart Policies
- 接続方法、プロトコル、デバイスに基づく設定

**ユースケース**:
1. **接続方法に基づく設定**
   - 内部接続: フル機能
   - 外部接続: セキュリティ強化

2. **プロトコルに基づく設定**
   - Blast Protocol: 高品質設定
   - PCoIP: 帯域幅最適化設定

3. **デバイスに基づく設定**
   - デスクトップ: フル機能
   - モバイル: タッチ最適化

## 条件セットの作成（モジュラーアプローチ）

### 条件セットの概要

**機能**:
- 複数の条件を組み合わせ
- モジュラーなポリシー設計
- 再利用可能な条件

### 条件セットの作成

**手順**:

1. **DEM Management Consoleで条件セットを作成**
   - Conditions → New Condition Set
   - 条件セット名を入力

2. **条件の追加**
   - ユーザーグループ
   - デバイスタイプ
   - アプリケーション
   - ネットワーク位置
   - 時間帯

3. **条件の組み合わせ**
   - **AND条件**: すべての条件を満たす必要がある
   - **OR条件**: いずれかの条件を満たせばよい
   - **NOT条件**: 条件を満たさない場合

**設定例**:
```
条件セット: "管理者デスクトップ"
- ユーザーグループ: "Domain Admins" AND
- デバイスタイプ: "Desktop" AND
- ネットワーク位置: "Internal"
```

**複雑な条件セット例**:
```
条件セット: "外部接続セキュリティ"
- (ネットワーク位置 = "External" OR 接続方法 = "UAG") AND
- デバイスタイプ != "Managed Device"
```

:::important
モジュラーアプローチにより、条件セットを再利用し、ポリシー管理を効率化できます。
:::

### 条件セットの再利用

**利点**:
- ポリシーの一貫性
- 管理の効率化
- 変更の容易さ

**使用例**:
- 複数のSmart Policiesで同じ条件セットを使用
- 条件の変更が一箇所で反映される

## ポリシーの適用順序

### 優先順位

**適用順序**:
1. **Smart Policies**: 最も高い優先順位
2. **ユーザー環境ポリシー**: 中間の優先順位
3. **コンピューター環境ポリシー**: 最も低い優先順位

**競合の解決**:
- より具体的なポリシーが優先
- Smart Policiesが通常のポリシーより優先

## ベストプラクティス

1. **ポリシー設計**
   - 明確な条件定義
   - モジュラーアプローチ
   - 再利用可能な設計

2. **テスト**
   - テスト環境での検証
   - 段階的な展開
   - ユーザー受け入れテスト

3. **ドキュメント**
   - ポリシーのドキュメント化
   - 条件の説明
   - 変更履歴の記録

:::caution
Smart Policiesの設定変更は、すべての対象ユーザーに影響を与える可能性があります。本番環境で変更する前に、テスト環境で十分に検証してください。
:::

## ポリシーの優先順位と競合解決

### 優先順位のルール

**適用順序**:
1. **Smart Policies**: 最も高い優先順位
2. **ユーザー環境ポリシー**: 中間の優先順位
3. **コンピューター環境ポリシー**: 最も低い優先順位

**競合の解決**:
- より具体的なポリシーが優先
- Smart Policiesが通常のポリシーより優先
- 条件がより具体的なSmart Policyが優先

**優先順位の設定**:
- DEM Management Console → Policies
- ポリシーの優先順位を調整
- 数値が小さいほど優先順位が高い

## ポリシーの適用タイミング

### ログオン時の適用

**適用プロセス**:
1. ユーザーがログオン
2. DEM Agentがポリシーを読み込み
3. 条件を評価
4. 該当するポリシーを適用

**最適化**:
- 非同期ログオンの使用
- 必要なポリシーのみを適用
- プロファイルサイズの削減

### ログオフ時の適用

**適用プロセス**:
1. ユーザーがログオフ
2. 変更された設定を検出
3. 設定ファイルに保存
4. ネットワーク共有に保存

**最適化**:
- 変更された設定のみを保存
- 圧縮の使用
- バックグラウンドでの保存

### バックグラウンドでの適用

**適用プロセス**:
1. セッション中に設定の変更を監視
2. 定期的に設定を同期
3. リアルタイムでの設定適用

**設定間隔**:
- デフォルト: 5分
- カスタマイズ可能

## ポリシーのパフォーマンスへの影響

### パフォーマンスへの影響の評価

**影響要因**:
- ポリシーの数
- ポリシーの複雑さ
- プロファイルサイズ
- ネットワーク帯域幅

**最適化方法**:
- 不要なポリシーの削除
- ポリシーの統合
- 条件の最適化
- 非同期ログオンの使用

**パフォーマンス監視**:
```powershell
# DEMログオン時間の監視
Get-Content "C:\ProgramData\VMware\DEM\FlexEngine\Logs\FlexEngine.log" | 
    Select-String "Logon" | 
    Select-Object -Last 50
```

## トラブルシューティング

### 一般的な問題

**ポリシーが適用されない**:
- 条件の確認
- ポリシーの優先順位を確認
- ログファイルを確認
- DEM Agentの状態確認

**競合するポリシー**:
- ポリシーの優先順位を確認
- 条件の重複を確認
- より具体的な条件を使用
- ポリシーの統合

**パフォーマンスの問題**:
- ポリシーの数を確認
- プロファイルサイズを確認
- ネットワーク帯域幅を確認
- ログオン時間を測定

### ログファイルの確認

**DEMログ**:
- `C:\ProgramData\VMware\DEM\FlexEngine\Logs\FlexEngine.log`
- `C:\ProgramData\VMware\DEM\FlexEngine\Logs\FlexEngine-Async.log`

**ログ分析**:
```powershell
# エラーの確認
Get-Content "C:\ProgramData\VMware\DEM\FlexEngine\Logs\FlexEngine.log" | 
    Select-String "Error" | 
    Select-Object -Last 50

# ログオン時間の確認
Get-Content "C:\ProgramData\VMware\DEM\FlexEngine\Logs\FlexEngine.log" | 
    Select-String "Logon completed" | 
    ForEach-Object {
        if ($_ -match "(\d+)ms") {
            [int]$matches[1]
        }
    } | 
    Measure-Object -Average -Maximum -Minimum
```

## まとめ

DEMポリシーの適切な管理は、ユーザー環境の効率的な制御に重要です。Smart Policies、条件セット（モジュラーアプローチ）、Horizon Smart Policiesの使用、ポリシーの優先順位と競合解決、適用タイミング、パフォーマンスへの影響の評価により、柔軟で管理しやすいユーザー環境を構築できます。
