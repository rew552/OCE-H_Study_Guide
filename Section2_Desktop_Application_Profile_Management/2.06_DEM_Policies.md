# 2.6 DEMによるプロファイル・ポリシー管理

## 試験ガイド対応 (Section 4.2 — OCA知識前提)

- DEM (Dynamic Environment Manager) のアーキテクチャ
- Flex Configuration File によるアプリケーション設定管理
- DirectFlex の仕組みと設定
- Predefined Settings の作成とインポート
- Profile Archive とバックアップ
- Condition / Condition Set の設計（モジュラーアプローチ）
- Horizon Smart Policies

---

## 1. DEMのアーキテクチャ

### 1.1 DEMの主要コンポーネント

| コンポーネント | 役割 | 配置先 |
|--------------|------|-------|
| DEM Management Console | 管理コンソール（設定作成・管理） | 管理者のPC |
| DEM FlexEngine (Agent) | ユーザーセッション内で設定を適用 | Golden Image (VDI / RDSH) |
| DEM Application Profiler | アプリケーション設定のプロファイリング | Packaging VM |
| Config Share | Flex設定ファイルの格納先（SMBファイル共有） | ファイルサーバー |
| Profile Archive Share | ユーザープロファイルアーカイブの格納先 | ファイルサーバー |

### 1.2 ファイル共有の構造

**Config Share**（管理者が設定を配置）:
```
\\fileserver\DEMConfig\
  ├── General\           ← Flex Configuration Files
  │   ├── Applications\  ← アプリ別設定
  │   └── Windows\       ← Windows設定
  ├── Personalization\   ← User Environment Settings
  └── Computer\          ← Computer Environment Settings
```

**Profile Archive Share**（ユーザー設定が保存される）:
```
\\fileserver\DEMProfiles\
  └── %username%\        ← ユーザーごとのプロファイルアーカイブ
      ├── App1.zip       ← アプリケーション設定のアーカイブ
      ├── App2.zip
      └── ...
```

> **試験ポイント**: Config ShareとProfile Archive Shareは**別のファイル共有**である。Config Shareは管理者が設定を配置する場所（読み取り専用でユーザーに公開）、Profile Archive Shareはユーザーの個人設定が保存される場所（ユーザーに読み書き権限）。

### 1.3 共有のアクセス権設定

| 共有 | SMB権限 | NTFS権限 |
|------|---------|---------|
| Config Share | Everyone: Read | Domain Computers: Read + Execute |
| Profile Archive Share | Authenticated Users: Full Control | Creator Owner: Full Control, Domain Admins: Full Control |

---

## 2. Flex Configuration File

### 2.1 Flex Configuration Fileとは

Flex Configuration File は、DEMが管理するアプリケーション設定の定義ファイル（INIファイル）である。各アプリケーションの設定が保存されるレジストリキー/ファイルパスを指定する。

### 2.2 作成方法

| 方法 | 説明 |
|------|------|
| Application Profiler | アプリを起動して設定変更を検出（自動生成） |
| Application Template | あらかじめ用意されたテンプレートを使用 |
| Windows Common Settings | Windowsの共通設定テンプレート |
| Custom | 手動でレジストリキー/ファイルパスを指定 |

### 2.3 Flex Configuration Fileの構造（Section Headers）

Flex Configuration Fileは、INI形式のセクションヘッダーでインポート/エクスポート対象を定義する:

| セクション | 説明 | 例 |
|-----------|------|-----|
| `[IncludeRegistryTrees]` | 含めるレジストリツリー | `HKCU\Software\Notepad++` |
| `[ExcludeRegistryTrees]` | 除外するレジストリツリー | `HKCU\Software\Notepad++\Cache` |
| `[IncludeFolderTrees]` | 含めるファイルフォルダ | `%AppData%\Notepad++` |
| `[ExcludeFolderTrees]` | 除外するファイルフォルダ | `%AppData%\Notepad++\Temp` |
| `[IncludeFiles]` | 含めるファイル | 特定ファイル指定 |

### 2.4 Folder Tokens

DEMでは環境変数の代わりにFolder Tokenを使用してパスを抽象化する:

| トークン | 展開先 |
|---------|--------|
| `<AppData>` | `%AppData%` (Roaming) |
| `<LocalAppData>` | `%LocalAppData%` |
| `<Desktop>` | `%UserProfile%\Desktop` |
| `<Documents>` | `%UserProfile%\Documents` |
| `<Favorites>` | `%UserProfile%\Favorites` |
| `<PersonalFolder>` | ユーザープロファイルフォルダ |

---

## 3. DirectFlex

### 3.1 DirectFlexとは

DirectFlexは、アプリケーション起動時にその設定をリアルタイムでインポートし、アプリケーション終了時にエクスポートする仕組み。従来のログオン時/ログオフ時の一括処理と異なり、アプリ単位での遅延処理を実現する。

### 3.2 DirectFlexの動作

| タイミング | 動作 |
|-----------|------|
| ログオン時 | DirectFlex対象外のFlex設定のみインポート |
| アプリ起動時 | DirectFlex対象のアプリ設定をインポート |
| アプリ終了時 | DirectFlex対象のアプリ設定をエクスポート |
| ログオフ時 | DirectFlex対象外のFlex設定をエクスポート |

### 3.3 DirectFlexの設定

DEM Management Console > Personalization > 対象Flex Configuration File > **Advanced** タブ:

- **DirectFlex** チェックボックスを有効化
- **Process Name**: 対象アプリのプロセス名（例: `notepad++.exe`）

### 3.4 DirectFlexのメリット

| メリット | 説明 |
|---------|------|
| ログオン時間の短縮 | アプリ設定をログオン時にインポートしないため |
| リソース効率 | 使用しないアプリの設定処理をスキップ |
| App Volumes連携 | On Demandパッケージのアタッチ後に設定をインポート |

> **試験ポイント**: DirectFlexはApp Volumes On Demand配信との組み合わせで特に効果的。On Demandでアプリがアタッチされた後、DirectFlexでアプリ設定が注入される。これにより、ログオン時間に影響を与えずにアプリ配信 + 設定適用が可能。

---

## 4. Predefined Settings

### 4.1 Predefined Settingsとは

Predefined Settingsは、ユーザーが初めてアプリケーションを使用する際の「初期設定」を定義する機能。ユーザーのProfile Archiveに設定が存在しない場合にのみ適用される。

### 4.2 Predefined Settingsの用途

| 用途 | 説明 |
|------|------|
| アプリのデフォルト設定統一 | 全ユーザーに同一の初期設定を配布 |
| 部門別設定 | Conditionと組み合わせて部門ごとに異なる初期設定 |
| App Volumes連携 | App Volumesで配信するアプリのユーザー設定を補完 |

### 4.3 作成方法

**方法1: DEM Application Profilerで作成**:
1. Application Profilerでアプリを起動
2. 希望する設定を変更
3. アプリを閉じる
4. **Save Config File with Predefined Settings** を選択
5. 出力: Flex Configuration File + Predefined Settings (ZIP)

**方法2: Management Consoleで手動作成**:
1. DEM Management Console > Personalization > 対象Flex Config File
2. **Predefined Settings** タブ > **Create**
3. レジストリ値やファイルを手動指定

### 4.4 複数のPredefined Settings

1つのFlex Configuration Fileに対して複数のPredefined Settingsを定義可能。各Predefined SettingにConditionを設定して、ユーザー/環境に応じた設定を適用できる。

> **試験ポイント**: Predefined Settingsは「初回のみ」適用される。ユーザーが設定を変更した後は、変更後の設定がProfile Archiveに保存され、Predefined Settingsは上書きされない。ただし、管理者は「Predefined Settingsを強制適用」するオプションでリセットできる。

---

## 5. Profile Archive

### 5.1 Profile Archiveの仕組み

ユーザーのアプリケーション設定は、セッション終了時にProfile Archive Share（`\\fileserver\DEMProfiles\%username%\`）にZIPアーカイブとして保存される。次回ログイン時に、このアーカイブからユーザー設定が復元される。

### 5.2 バックアップ設定

DEM Management Console > Configure > Personalization Features > **Backups**:

| 設定 | 説明 |
|------|------|
| Number of backups to keep | 保持するバックアップ世代数（デフォルト: 3） |
| Backup frequency | バックアップ頻度 |
| Backup location | バックアップの保存先 |

### 5.3 Self-Support Tool

ユーザー自身が設定をリセット・復元できるツール:

- **Reset to Default**: アプリ設定をPredefined Settingsに戻す
- **Restore from Backup**: バックアップから設定を復元

---

## 6. Condition と Condition Set

### 6.1 Conditionの種類

DEMでは、設定の適用対象をConditionで制御する。

| Condition Type | 説明 | 例 |
|---------------|------|-----|
| Active Directory Group | ADグループメンバーシップ | `Sales` グループ |
| Computer Name | コンピュータ名のパターン | `VDI-*` |
| Environment Variable | 環境変数の値 | `%COMPUTERNAME%` |
| IP Address Range | IPアドレス範囲 | `10.0.1.0/24` |
| Operating System | OS種別/バージョン | Windows 11 |
| Horizon Client Property | Horizon接続プロパティ | Pool名、接続元IP等 |
| Registry Value | レジストリ値 | 特定のレジストリキー |
| File/Folder Exists | ファイル/フォルダの存在 | `C:\Program Files\App` |
| Process Running | プロセスの実行状態 | `app.exe` が実行中 |
| Date/Time | 日時条件 | 営業時間内 |
| WMI Query | WMIクエリの結果 | ハードウェア情報 |

### 6.2 Condition Set（モジュラーアプローチ）

Condition Setは、複数のConditionを再利用可能なグループとして定義する機能。

**作成手順**:
1. DEM Management Console > Conditions > **Condition Sets** タブ
2. **Create Condition Set** をクリック
3. 名前を入力（例: `CS-Internal-Sales-VDI`）
4. 複数のConditionを追加

**条件の組み合わせ**:

| 演算子 | 動作 |
|--------|------|
| AND | すべての条件を満たす場合に適用 |
| OR | いずれかの条件を満たす場合に適用 |
| NOT | 条件を満たさない場合に適用 |

**Condition Setの例**:
```
Condition Set: "CS-External-Users"
  - Horizon Client Property: Connection via Gateway = True    AND
  - Active Directory Group: NOT "VPN-Exempted-Users"
```

```
Condition Set: "CS-Office-Pool"
  - Horizon Client Property: Pool Name starts with "Office-"  AND
  - Operating System: Windows 11
```

> **試験ポイント**: Condition Setの「モジュラーアプローチ」とは、共通の条件セットを一度定義して複数の設定で再利用すること。条件変更が一箇所で済むため、管理の一貫性と効率性が向上する。

---

## 7. User Environment Settings

### 7.1 概要

User Environment Settingsは、ユーザーログオン時に自動適用される環境設定で、ドライブマッピング、プリンタマッピング、ショートカット作成などを管理する。GPOのログオンスクリプトの代替として使用でき、Conditionによる条件付き適用が可能。

### 7.2 設定可能な項目

| 設定カテゴリ | 説明 | 例 |
|------------|------|-----|
| Drive Mappings | ネットワークドライブの割り当て | `H:` → `\\fileserver\home\%username%` |
| Printer Mappings | プリンタの接続（デフォルトプリンタ指定可） | `\\printserver\Floor3-HP` |
| Shortcuts | デスクトップ/スタートメニューのショートカット作成 | アプリやURLへのショートカット |
| File/Folder Copy | ファイル/フォルダのコピー | 設定ファイルの配布 |
| Registry Settings | レジストリ値の設定 | ユーザー固有のレジストリ設定 |
| Environment Variables | 環境変数の設定 | `JAVA_HOME` 等 |
| Tasks | ログオン/ログオフ時のタスク実行 | スクリプト実行、アプリ起動 |

### 7.3 Conditionとの組み合わせ

User Environment Settingsに Conditionを設定することで、ユーザーの所属グループ、接続元IP、Pool名等に応じて異なる環境設定を動的に適用できる。

> **試験ポイント**: User Environment SettingsはGPOのログオンスクリプトやGroup Policy Preferencesの代替として使用でき、DEM Conditionによる動的な条件制御が可能。GPOでは実現しにくい「Pool名に応じたドライブマッピングの変更」などが容易に実装できる。

---

## 8. Computer Environment Settings

### 8.1 概要

Computer Environment Settings は、マシン起動時に適用される設定。User Environment Settingsとは異なり、ユーザーログオン前のコンピュータ単位で処理される。

### 8.2 設定可能な項目

| 設定カテゴリ | 説明 |
|------------|------|
| Registry Settings | コンピュータレベルのレジストリ設定（HKLM） |
| File/Folder Operations | システムファイルの配布・更新 |
| Services | サービスの起動/停止 |
| Tasks | コンピュータ起動時のタスク実行 |

> **試験ポイント**: Computer Environment SettingsはHKLMレジストリに書き込むため、管理者権限で実行される。Config Shareの `Computer\` フォルダに配置する。

---

## 9. ADMX-based Settings

### 9.1 概要

ADMX-based Settingsは、ADMXテンプレートを使用してGPOライクなポリシーをDEM経由で適用する機能。ADドメインのGPOインフラなしでポリシーを適用できる。

### 9.2 利点

| 利点 | 説明 |
|------|------|
| AD不要 | ドメインGPOなしでADMXポリシーを適用可能 |
| 条件付き適用 | DEM Conditionでポリシーの適用対象を制御 |
| 即時反映 | GPOの伝播待ちなし |
| VDI最適化 | 非永続VDI環境でのポリシー管理に最適 |

> **試験ポイント**: ADMX-based Settingsは、Non-domain joined VM（ドメイン未参加VM）や、Workgroup構成のVDI環境でGPOポリシーを適用する手段として出題される可能性がある。

---

## 10. Horizon Smart Policies

### 10.1 Horizon Smart Policiesとは

Horizon Smart Policiesは、DEMを通じてHorizon固有のポリシー（クリップボード、USB、CDR等）を動的に制御する機能。接続条件に応じてポリシーを変更できる。

### 10.2 設定可能なHorizon Smart Policy項目

| ポリシー | 説明 |
|---------|------|
| USB Redirection | USBリダイレクトの許可/拒否 |
| Clipboard Redirection | クリップボードリダイレクトの方向制御 |
| Client Drive Redirection (CDR) | クライアントドライブの共有許可/拒否 |
| Printing | 仮想印刷の許可/拒否 |
| Bandwidth Profile | 帯域幅プロファイルの選択 |
| Multimedia Redirection (MMR) | マルチメディアリダイレクトの許可/拒否 |
| Digital Watermark | デジタルウォーターマークの有効/無効 |

### 10.3 Horizon Smart Policyの作成

**設定場所**: DEM Management Console > User Environment > Horizon Smart Policies > **Create**

**手順**:
1. ポリシー名を入力
2. 制御するHorizon機能を選択・設定
3. **Condition** を追加して適用条件を定義
4. 保存

### 10.4 Conditionに使用できるHorizon Client Properties

| Property | 説明 |
|---------|------|
| `Horizon.VDI.Pool.Name` | 接続先Pool名 |
| `Horizon.VDI.Pool.Type` | Poolタイプ |
| `ViewClient.Broker.GatewayType` | Gateway経由かどうか |
| `ViewClient.Broker.GatewayLocation` | Gatewayの場所（Internal / External） |
| `ViewClient.Type` | クライアントタイプ |
| `ViewClient.Broker.Tunneled` | トンネル接続かどうか |

**Smart Policy設計例**:

| シナリオ | Condition | ポリシー |
|---------|-----------|---------|
| 外部接続時にクリップボードを無効化 | `GatewayLocation = External` | Clipboard: Disabled |
| 内部接続時にUSBを許可 | `GatewayLocation = Internal` | USB Redirection: Allow |
| 特定PoolでCDRを無効化 | `Pool.Name = "Secure-Pool"` | CDR: Disabled |
| Gateway経由でウォーターマーク表示 | `GatewayType = AP` | Digital Watermark: Enabled |

> **試験ポイント**: Horizon Smart Policiesは **DEMを通じて** Horizonの機能ポリシーを動的に制御する。GPOとは異なり、接続条件に応じてリアルタイムにポリシーを変更できる点が最大のメリット。Connection ServerのGateway Location設定と連携して「内部/外部」の判別を行う。

---

## 11. 処理順序

### 11.1 ログオン時の処理順序

1. Computer Environment Settings（マシン起動時 — レジストリ設定、サービス制御等）
2. User Environment Settings（ユーザーログオン時 — ドライブマッピング、プリンタ、ショートカット等）
3. ADMX-based Settings の適用（GPOライクなポリシー）
4. Flex Configuration Files のインポート（ログオン時処理分）
5. Predefined Settings の適用（初回のみ、またはリセット時）
6. Horizon Smart Policies の評価・適用
7. DirectFlex対象アプリ → アプリ起動時に個別インポート

### 11.2 ログオフ時の処理順序

1. DirectFlex対象アプリの設定をエクスポート（アプリ終了時）
2. Flex Configuration Files のエクスポート（ログオフ時処理分）
3. Profile Archive への保存

---

## 12. ベストプラクティスとアンチパターン

### ベストプラクティス

| # | プラクティス |
|---|------------|
| 1 | Condition Setをモジュラーに設計し再利用 |
| 2 | DirectFlexでログオン時間を最適化 |
| 3 | Predefined SettingsでApp Volumesアプリの初期設定を補完 |
| 4 | Horizon Smart Policiesで内部/外部アクセスのポリシーを分離 |
| 5 | Profile Archive Shareのバックアップを適切に設定 |
| 6 | Config ShareとProfile Archive Shareは別の共有・別のアクセス権 |
| 7 | Application Profilerでアプリ設定を自動検出 |

### アンチパターン

| # | アンチパターン | 問題点 |
|---|-------------|--------|
| 1 | 全アプリの設定をログオン時にインポート | ログオン時間の増大 |
| 2 | Condition Setを使わず各設定に条件を個別定義 | 管理の不整合 |
| 3 | Config ShareにユーザーWrite権限を付与 | セキュリティリスク |
| 4 | Profile Archiveのバックアップなし | ユーザー設定のロスト |
| 5 | DEMとGPOで同じ設定を二重管理 | 競合と混乱 |

---

## 13. トラブルシューティング

| 症状 | 原因候補 | 対処 |
|------|---------|------|
| アプリ設定が復元されない | Profile Archive Shareアクセス不可、Flex Config File未作成 | 共有権限確認、Config確認 |
| Predefined Settingsが適用されない | 既存のProfile Archiveが存在する | Profile Archive削除（またはリセット） |
| ログオン時間が長い | DirectFlex未使用、Flex Config File多すぎ | DirectFlex有効化、設定整理 |
| Smart Policyが機能しない | Gateway Location未設定、Condition不一致 | CS設定確認、Condition確認 |
| DirectFlexアプリで設定が保存されない | プロセス名の不一致 | プロセス名を正確に指定 |

**ログファイル**:

| ログ | パス | 内容 |
|------|------|------|
| FlexEngine Log | `%LocalAppData%\Omnissa\DEM\FlexEngine.log` | ログオン時の処理 |
| FlexEngine DirectFlex Log | `%LocalAppData%\Omnissa\DEM\FlexEngine-DirectFlex.log` | DirectFlexの処理 |
| FlexEngine Async Log | `%LocalAppData%\Omnissa\DEM\FlexEngine-Async.log` | 非同期処理 |

---

## 理解度チェックリスト

- [ ] DEMのConfig ShareとProfile Archive Shareの違い・アクセス権を説明できる
- [ ] Flex Configuration Fileの作成方法（Profiler / Template / Custom）を説明できる
- [ ] DirectFlexの動作（アプリ起動時インポート / 終了時エクスポート）を説明できる
- [ ] Predefined Settingsの用途と「初回のみ適用」の動作を説明できる
- [ ] Condition Setのモジュラーアプローチの意義を説明できる
- [ ] User Environment Settingsで設定可能な項目（ドライブマッピング、プリンタ等）を列挙できる
- [ ] Computer Environment SettingsとUser Environment Settingsの違いを説明できる
- [ ] ADMX-based Settingsの利点と使用場面を説明できる
- [ ] Horizon Smart Policiesで制御可能な項目を列挙できる
- [ ] Horizon Client Properties（GatewayLocation, Pool.Name等）をConditionに使用できる
- [ ] App Volumes + DEM連携パターン（パッケージ配信 + Predefined Settings + DirectFlex）を説明できる
- [ ] ログオン/ログオフ時の完全な処理順序を説明できる
- [ ] FlexEngine Logの場所と基本的な分析方法を説明できる
