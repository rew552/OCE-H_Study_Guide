# 2.3 Entitlementの設計

## 試験ガイド対応 (Section 4.2 — OCA知識前提)

- Local Entitlement vs Global Entitlement の設計判断
- Restricted Entitlement の設定
- Cloud Pod Architecture (CPA) におけるGlobal Entitlementの設計
- Home Site / Site Override の設定
- Desktop / Application Entitlement の管理

---

## 1. Entitlementの概要と分類

### 1.1 Entitlementとは

Entitlementは、ユーザーまたはグループにDesktop PoolやPublished Applicationへのアクセス権を付与する仕組みである。Horizonのアクセス制御の基本単位であり、適切なEntitlement設計はセキュリティと運用性の両立に不可欠。

### 1.2 Entitlementの分類

| 分類 | スコープ | 用途 |
|------|---------|------|
| Local Entitlement | 単一Pod内 | 単一サイトのDesktop Pool / Application |
| Global Entitlement | CPA Federation全体 | 複数サイトにまたがるDesktop Pool / Application |

| 対象リソース | 説明 |
|-------------|------|
| Desktop Entitlement | Desktop Pool（VDI / RDS Desktop）へのアクセス権 |
| Application Entitlement | Published Application へのアクセス権 |

---

## 2. Local Entitlement

### 2.1 Local Desktop Entitlement

**設定場所**: Horizon Console > Inventory > Desktop Pools > 対象Pool > Entitlements

**設定手順**:
1. Desktop Pool を選択
2. **Entitlements** タブ > **Add**
3. Active Directory からユーザーまたはグループを検索して追加
4. **OK** で保存

**設計原則**:
- 個別ユーザーではなく **ADグループ** でEntitlementを管理する
- ADグループ命名規則の例: `Horizon-Pool-<PoolName>-Users`
- Nested Group（グループのネスト）も有効

### 2.2 Local Application Entitlement

**設定場所**: Horizon Console > Inventory > Applications > 対象App > Entitlements

Published Application（RDSH Farm上のアプリケーション）にユーザーアクセス権を付与する。

### 2.3 Restricted Entitlement

Restricted Entitlementは、特定のタグが設定されたConnection Server経由の接続のみにアクセスを制限する機能。

**ユースケース**:
- 内部ネットワーク専用のDesktop Pool
- 特定のUAG経由のみアクセスを許可するPool
- テスト用PoolをテストConnection Server経由のみに制限

**設定手順**:

1. **Connection Serverにタグを設定**:
   - Horizon Console > Settings > Servers > Connection Servers
   - 対象Server > Edit > Tags
   - タグを追加（例: `Internal`, `External`, `TestOnly`）

2. **Desktop Poolでタグ制限を設定**:
   - Desktop Pool > Edit > Access
   - **Restrict entitlements to tag** > 対象タグを選択

**動作**:
- タグが設定されたConnection Serverにログインしたユーザーのみが、該当Poolを表示・接続できる
- タグなしのConnection Server経由ではPoolが非表示になる

> **試験ポイント**: Restricted Entitlementは、同一ADグループに属するユーザーでも接続元のConnection Serverによってアクセスを分離する。UAGに紐づくConnection Serverに`External`タグを設定し、内部専用PoolにはそのタグでRestricted Entitlementを掛けないことで、外部アクセスを遮断できる。

---

## 3. Global Entitlement (Cloud Pod Architecture)

### 3.1 Global Entitlementの概要

Global Entitlementは、CPA（Cloud Pod Architecture）Federation内の複数Podにまたがるリソースを単一のEntitlementとして管理する仕組み。

**前提条件**: CPA が初期化・構成されていること

### 3.2 Global Desktop Entitlement (GDE)

**設定場所**: Horizon Console > Inventory > Global Entitlements > Add

#### 作成パラメータ

| パラメータ | 説明 | 設計ポイント |
|-----------|------|------------|
| Name | GDE名 | `GDE-VDI-Standard` 等 |
| Display Name | ユーザー表示名 | 「標準VDI」等 |
| Scope | Any / Site / Pod | ユーザーの接続先制御 |
| Default Display Protocol | Blast / PCoIP | Blast推奨 |
| Allow Users to Choose Protocol | Yes / No | 運用ポリシーに依存 |
| Allow Users to Reset Machines | Yes / No | 通常No |
| Multiple Sessions per User | Allow / Deny | Floating: 通常Deny |
| Category Folder | カテゴリ分類 | ユーザー表示のグループ化 |

#### GDEへのPool追加

1. 作成したGDE > **Local Pools** タブ
2. **Add** > 各PodのDesktop Poolを選択して追加
3. 複数Podから複数Poolを追加可能

> **試験ポイント**: GDEに追加されたLocal Poolには、Local Entitlementも同時に設定可能。ただしGDEとLocal Entitlementが競合する場合、ユーザーはGDEとLocal Entitlementの**両方**のPoolにアクセスできる（どちらか一方ではなく加算）。

### 3.3 Global Application Entitlement (GAE)

GDE と同様の仕組みで、Published Application に対して複数Podにまたがるグローバルアクセス権を付与する。

### 3.4 Scope設定の意味

| Scope | 動作 |
|-------|------|
| Any | Federation内の任意のPodのリソースを使用可能 |
| Site | ユーザーのHome Siteのリソースのみ（フェイルオーバー時は他サイト） |
| Pod | ユーザーが接続したPodのリソースのみ |

---

## 4. Home Site と Site Override

### 4.1 Home Siteの概要

Home Siteは、CPA環境でユーザーが優先的に接続すべきサイトを定義する。

**設定場所**: Horizon Console > Users and Groups > Home Site

**設定方法**:
- ユーザーまたはADグループに対してHome Siteを割り当て
- Home Siteが設定されていないユーザーは、最も近い（レイテンシが低い）サイトに接続

### 4.2 Home Site Override

GDE/GAEレベルで、特定のEntitlementに対してユーザーのHome Siteを上書きできる。

**ユースケース**:
- あるユーザーの通常業務はSite AだがCPA対応プールBに対してはSite Bを使いたい場合
- 特定アプリケーションが特定サイトにのみ存在する場合

**設定方法**:
1. GDE/GAE > **Home Site Override** タブ
2. ユーザー/グループを追加
3. Override先のSiteを指定

### 4.3 Site Preference（接続先の優先順位）

GDEのScope設定と連携して、ユーザーの接続先が以下の順序で決定される:

1. **Home Site Override** のサイト（設定されている場合）
2. **Home Site** のサイト
3. **ユーザーが接続したPod** のサイト
4. **Federation内で利用可能な任意のPod**（Scope = Any の場合）

> **試験ポイント**: Home Site Override > Home Site > 接続Pod > Any の優先順位を問う問題が出題される。また、Home Siteが未設定のユーザーがScope = Siteの GDEにアクセスした場合、接続PodのサイトがHome Siteとして扱われる。

---

## 5. Unauthenticated Access（非認証アクセス）

### 5.1 概要

Unauthenticated Accessは、AD認証なしでPublished Applicationにアクセスできる機能。キオスク端末やパブリックアクセス端末向けに使用する。

### 5.2 設定手順

1. Horizon Console > Settings > Global Settings > **Client Restriction Settings**
2. **Allow HTML Access through a Horizon Connection Server** を有効化
3. Connection Server > Edit > Authentication > **Allow Unauthenticated Users** を有効化
4. Unauthenticated Access用のユーザーアカウントをローカルに作成
5. Published Application にUnauthenticated Access ユーザーを Entitlement

### 5.3 制限事項

| 制限 | 説明 |
|------|------|
| Desktop Poolは不可 | Published Applicationのみ |
| プロファイル管理不可 | ユーザー固有の設定は保持されない |
| セキュリティリスク | 認証なしのため、機密データへのアクセスに使用しない |

> **試験ポイント**: Unauthenticated AccessはPublished Applicationのみに対応し、Desktop Poolには使用できない。キオスクモードとの混同に注意（キオスクモードはHorizon Clientの自動起動機能であり、Unauthenticated AccessはConnection Server側の認証設定）。

---

## 6. Entitlement設計のベストプラクティス

### 6.1 ADグループ設計

**推奨グループ構造**:

```
OU=Horizon Groups
  ├── Horizon-Pool-VDI-Standard-Users     → 標準VDIプールのEntitlement
  ├── Horizon-Pool-VDI-Developer-Users    → 開発者VDIプールのEntitlement
  ├── Horizon-App-Office365-Users         → Office 365 Published AppのEntitlement
  ├── Horizon-App-SAP-Users              → SAP Published AppのEntitlement
  └── Horizon-GDE-Global-VDI-Users       → Global Desktop EntitlementのEntitlement
```

### 6.2 Entitlement管理のガイドライン

| # | ガイドライン |
|---|------------|
| 1 | 個別ユーザーではなくADグループでEntitlementを管理 |
| 2 | グループ名にPool名 / App名を含めて対応関係を明確化 |
| 3 | Nested Groupを活用して階層的な権限管理 |
| 4 | Restricted EntitlementでConnection Serverタグによるアクセス制御 |
| 5 | CPA環境ではLocal EntitlementよりGlobal Entitlementを優先使用 |
| 6 | Home Siteを適切に設定してレイテンシを最小化 |
| 7 | 定期的にEntitlementを棚卸しし、不要な権限を削除 |

---

## 7. lmvutil コマンドによるGlobal Entitlement管理

CPA環境のGlobal EntitlementはHorizon Console UIに加えて、`lmvutil` コマンドラインツールでも管理できる。

### 7.1 主要コマンド

**GDE一覧表示**:
```
lmvutil --authAs admin --authDomain CONTOSO --authPassword *** --listGlobalEntitlements
```

**GDE作成**:
```
lmvutil --authAs admin --authDomain CONTOSO --authPassword *** --createGlobalEntitlement --entitlementName "GDE-VDI-Standard" --scope ANY --isDedicated false
```

**GDEにユーザー追加**:
```
lmvutil --authAs admin --authDomain CONTOSO --authPassword *** --addGroupEntitlement --entitlementName "GDE-VDI-Standard" --groupName "Horizon-GDE-Users"
```

**GDEにLocal Pool追加**:
```
lmvutil --authAs admin --authDomain CONTOSO --authPassword *** --addPoolAssociation --entitlementName "GDE-VDI-Standard" --poolId "VDI-IC-Win11-Sales"
```

**Home Site設定**:
```
lmvutil --authAs admin --authDomain CONTOSO --authPassword *** --assignHomeSite --userName user1 --siteName "Site-Tokyo"
```

> **試験ポイント**: `lmvutil` はConnection Serverインストールディレクトリ内にあり、CPA管理の自動化やスクリプト化に使用される。UIで行える操作はほぼすべてlmvutilでも実行可能。

---

## 8. ベストプラクティスとアンチパターン

### ベストプラクティス

| # | プラクティス |
|---|------------|
| 1 | ADグループベースのEntitlement管理を徹底 |
| 2 | Restricted Entitlementで内部/外部のアクセス制御 |
| 3 | CPA環境ではGlobal Entitlement + Home Site設計 |
| 4 | Home Site Overrideはアプリ固有の例外に限定使用 |
| 5 | Entitlement変更は変更管理プロセスに従う |

### アンチパターン

| # | アンチパターン | 問題点 |
|---|-------------|--------|
| 1 | 個別ユーザーでEntitlementを設定 | 管理不能になる |
| 2 | 全ユーザーをDomain Usersで一括Entitlement | 最小権限原則に違反 |
| 3 | CPA環境でLocal Entitlementのみ使用 | サイト間フェイルオーバー不可 |
| 4 | Home Site未設定でScope = Site | 接続Podが毎回異なり一貫性がない |
| 5 | Restricted Entitlementのタグ管理がドキュメント化されていない | タグの意味が不明になる |

---

## 9. トラブルシューティング

| 症状 | 原因候補 | 対処 |
|------|---------|------|
| ユーザーにPoolが表示されない | Entitlement未設定、ADグループ未所属、Restricted Entitlement | Entitlement確認、ADメンバーシップ確認、タグ確認 |
| GDEでPoolに接続できない | CPA VIPA接続不良、Global LDAP同期エラー | `lmvutil --listPods`で状態確認、VIPA確認 |
| Home Siteが機能しない | Home Site未設定、Scope設定不一致 | Home Site設定確認、GDE Scope確認 |
| 外部ユーザーが内部Poolに接続できてしまう | Restricted Entitlement未設定、タグ設定漏れ | Connection ServerタグとPool制限設定を確認 |
| Entitlement変更が反映されない | ADキャッシュ、Connection Server同期遅延 | ユーザー再ログイン、AD同期待ち |

---

## 理解度チェックリスト

- [ ] Local Entitlement と Global Entitlement の違いと使い分けを説明できる
- [ ] Restricted Entitlementの仕組み（Connection Serverタグ）を説明できる
- [ ] GDE作成時のScopeオプション（Any / Site / Pod）の動作を説明できる
- [ ] Home Site / Home Site Override / Site Preferenceの優先順位を説明できる
- [ ] ADグループベースのEntitlement設計ができる
- [ ] `lmvutil` コマンドでGDEの作成・ユーザー追加・Pool追加ができる
- [ ] CPA環境でLocal EntitlementとGlobal Entitlementが共存する場合の動作を説明できる
- [ ] Restricted Entitlementを使って内部/外部アクセスを分離する設計ができる
