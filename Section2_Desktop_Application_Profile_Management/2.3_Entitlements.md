# 2.3 Entitlements

## 概要

エンタイトルメント（Entitlements）の管理は、ユーザーアクセス制御に重要です。OCE-Hレベルでは、Global Entitlements、エンタイトルメントの優先順位、Cloud Pod Architectureでの使用が求められます。

## 学習目標

このセクションを学習することで、以下のことができるようになります：

- ローカルエンタイトルメントとGlobal Entitlementsの違いを説明できる
- Global Entitlementsの作成と管理ができる
- エンタイトルメントの優先順位を設定できる
- Cloud Pod Architectureでのエンタイトルメントの使用方法を理解している

## 関連リソース

- [クイックリファレンス](../../00_Quick_Reference.md) - ポート番号、設定値、制限値
- [用語集](../../README.md#用語集) - 関連用語の定義
- [6.2 Cloud Pod Architecture](../../Section6_Scale_and_Recovery/6.2_Cloud_Pod_Architecture.md) - CPA設定
- [2.2 Desktop Pools](2.2_Desktop_Pools.md) - デスクトッププール
- [実環境シナリオ](../../00_Scenarios/Section2_Scenarios.md) - 実環境でのシナリオ例

## エンタイトルメントの種類

### ローカルエンタイトルメント

**概要**:
- 単一ポッド内でのエンタイトルメント
- プールまたはアプリケーションへの直接アクセス

**設定場所**:
- Horizon Console → Inventory → Desktop Pools → Entitlements
- Horizon Console → Inventory → Applications → Entitlements

### Global Entitlements

**概要**:
- Cloud Pod Architecture環境で使用
- 複数ポッドにまたがるエンタイトルメント
- グローバルなアクセス制御

**設定場所**:
- Horizon Console → Inventory → Global Entitlements

> [!IMPORTANT]

> Global Entitlementsは、Cloud Pod Architecture環境でのみ使用できます。

## エンタイトルメントの作成と管理

### デスクトッププールのエンタイトルメント

**追加手順**:

1. **Horizon Consoleでの操作**
   - Inventory → Desktop Pools
   - プールを選択
   - Entitlementsタブをクリック

2. **ユーザー/グループの追加**
   - Addをクリック
   - Active Directoryから検索
   - ユーザーまたはグループを選択

3. **権限の設定**
   - Use: デスクトップの使用権限
   - Remove: デスクトップの削除権限（管理者向け）

### アプリケーションのエンタイトルメント

**追加手順**:

1. **Horizon Consoleでの操作**
   - Inventory → Applications
   - アプリケーションを選択
   - Entitlementsタブをクリック

2. **ユーザー/グループの追加**
   - Addをクリック
   - Active Directoryから検索
   - ユーザーまたはグループを選択

## Global Entitlementsの設定

### Global Entitlementの作成

**手順**:

1. **Horizon Consoleでの操作**
   - Inventory → Global Entitlements
   - Addをクリック

2. **基本情報の入力**
   - Name: Global Entitlement名
   - Display Name: 表示名
   - Description: 説明

3. **プールの追加**
   - Add Poolをクリック
   - 複数ポッドからプールを選択

4. **エンタイトルメントの設定**
   - ユーザーまたはグループを追加
   - 権限を設定

### Global Entitlementへのプール追加

**手順**:

1. **Global Entitlementを選択**
   - Inventory → Global Entitlements
   - Global Entitlementを選択

2. **プールの追加**
   - Poolsタブをクリック
   - Add Poolをクリック
   - プールを選択

> [!TIP]

> Global Entitlementに複数のプールを追加することで、ユーザーは最適なプールに自動的に接続されます。

## エンタイトルメントの優先順位

### 優先順位のルール

**優先順位**:
1. **個別ユーザー**: グループより優先される場合がある
2. **グループ**: 推奨される管理方法
3. **複数のグループ**: すべてのグループのエンタイトルメントが適用される

### 競合の解決

**競合が発生した場合**:
- より具体的なエンタイトルメントが優先
- 個別ユーザーのエンタイトルメントがグループより優先

## Cloud Pod Architectureでの使用

### Home Site戦略との統合

**設定**:
- ユーザーのHome Siteを設定
- Global EntitlementでHome Siteのプールを優先

**利点**:
- レイテンシの最小化
- データの局所性
- ネットワーク帯域幅の最適化

### サイト設定オプション

**設定項目**:
- Preferred Site: 優先サイト
- Allowed Site: 許可されたサイト
- Blocked Site: ブロックされたサイト

## エンタイトルメントの管理

### 一括管理

**CSVインポート**:
```csv
Name,Type,Pool
CONTOSO\jsmith,User,VDI-Pool-Dev
CONTOSO\VDI-Users,Group,VDI-Pool-Standard
```

**PowerShellスクリプト**:
```powershell
# エンタイトルメントの一括追加
$users = Import-Csv "entitlements.csv"
foreach ($user in $users) {
    # APIを使用してエンタイトルメントを追加
}
```

### エンタイトルメントの監査

**監査項目**:
- エンタイトルメントの一覧
- ユーザーごとのエンタイトルメント
- プールごとのエンタイトルメント
- 変更履歴

## ベストプラクティス

1. **グループベースの管理**
   - Active Directoryグループの使用
   - 明確な命名規則
   - 階層的なグループ構造

2. **定期的な見直し**
   - エンタイトルメントの定期的な確認
   - 不要なエンタイトルメントの削除
   - アクセスログの確認

3. **ドキュメント**
   - エンタイトルメントのドキュメント化
   - 変更履歴の記録
   - 承認プロセスの確立

> [!CAUTION]

> エンタイトルメントの削除は、ユーザーのアクセスに即座に影響します。削除前に十分に確認してください。

## エンタイトルメントの一括管理

### PowerShellスクリプトによる一括管理

**一括追加スクリプト**:
```powershell
# エンタイトルメントの一括追加
param(
    [Parameter(Mandatory=$true)]
    [string]$ConnectionServer,
    
    [Parameter(Mandatory=$true)]
    [string]$Username,
    
    [Parameter(Mandatory=$true)]
    [string]$Password,
    
    [Parameter(Mandatory=$true)]
    [string]$PoolId,
    
    [Parameter(Mandatory=$true)]
    [string]$CsvFile
)

# 認証ヘッダーの作成
$base64AuthInfo = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${Username}:${Password}"))
$headers = @{
    "Authorization" = "Basic $base64AuthInfo"
    "Content-Type" = "application/json"
}

# CSVファイルからユーザー/グループを読み込み
$users = Import-Csv $CsvFile

foreach ($user in $users) {
    $entitlement = @{
        user = $user.Username
        type = $user.Type
    } | ConvertTo-Json
    
    $uri = "https://$ConnectionServer/rest/api/v1/pools/$PoolId/entitlements"
    try {
        Invoke-RestMethod -Uri $uri -Headers $headers -Method Post -Body $entitlement
        Write-Host "Added entitlement for $($user.Username)" -ForegroundColor Green
    } catch {
        Write-Host "Error adding entitlement for $($user.Username): $($_.Exception.Message)" -ForegroundColor Red
    }
}
```

### APIを使用した一括管理

**REST APIエンドポイント**:
- `GET /rest/api/v1/pools/{poolId}/entitlements`: エンタイトルメント一覧の取得
- `POST /rest/api/v1/pools/{poolId}/entitlements`: エンタイトルメントの追加
- `DELETE /rest/api/v1/pools/{poolId}/entitlements/{entitlementId}`: エンタイトルメントの削除

## エンタイトルメントの監査とレポート

### 監査レポートの生成

**レポート項目**:
- ユーザーごとのエンタイトルメント
- プールごとのエンタイトルメント
- エンタイトルメントの変更履歴

**PowerShellスクリプト例**:
```powershell
# エンタイトルメントレポートの生成
$pools = Invoke-RestMethod -Uri "https://horizon.contoso.com/rest/api/v1/pools" -Headers $headers

$report = @()
foreach ($pool in $pools) {
    $entitlements = Invoke-RestMethod -Uri "https://horizon.contoso.com/rest/api/v1/pools/$($pool.id)/entitlements" -Headers $headers
    foreach ($entitlement in $entitlements) {
        $report += [PSCustomObject]@{
            Pool = $pool.displayName
            User = $entitlement.user
            Type = $entitlement.type
            DateAdded = $entitlement.dateAdded
        }
    }
}

$report | Export-Csv "entitlements-report.csv" -NoTypeInformation
```

## エンタイトルメントの有効期限設定

### 有効期限の設定

**設定方法**:
- Horizon Console → Inventory → Desktop Pools
- プールを選択 → Entitlements
- エンタイトルメントを選択 → Edit
- Expiration Dateを設定

**有効期限の管理**:
```powershell
# 有効期限が近いエンタイトルメントの確認
$entitlements = Invoke-RestMethod -Uri "https://horizon.contoso.com/rest/api/v1/pools/$poolId/entitlements" -Headers $headers
$expiringSoon = $entitlements | Where-Object {
    $expirationDate = [DateTime]::Parse($_.expirationDate)
    ($expirationDate - (Get-Date)).Days -lt 30
}

foreach ($entitlement in $expiringSoon) {
    Write-Host "Warning: Entitlement for $($entitlement.user) expires on $($entitlement.expirationDate)"
}
```

## 条件付きエンタイトルメント

### 条件付きエンタイトルメントの設定

**設定項目**:
- 時間帯によるアクセス制御
- ネットワーク位置によるアクセス制御
- デバイスタイプによるアクセス制御

**設定例**:
- 営業時間のみアクセス可能
- 内部ネットワークからのみアクセス可能
- 管理デバイスからのみアクセス可能

## トラブルシューティング

### 一般的な問題

**ユーザーがアクセスできない**:
- エンタイトルメントの確認
- Active Directoryグループのメンバーシップ確認
- プールの状態確認
- エンタイトルメントの有効期限確認

**Global Entitlementが機能しない**:
- Cloud Pod Architectureの状態確認
- プールがGlobal Entitlementに追加されているか確認
- Home Site設定の確認
- レプリケーションの確認

## まとめ

エンタイトルメントの適切な管理は、セキュリティとアクセス制御に重要です。Global Entitlements、エンタイトルメントの優先順位、Cloud Pod Architectureでの使用、一括管理、監査とレポート、有効期限設定、条件付きエンタイトルメントにより、効率的でセキュアなアクセス制御環境を構築できます。
