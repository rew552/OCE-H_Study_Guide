# 2.2 Desktop Poolの設計と管理

## 試験ガイド対応 (Section 4.2 — OCA知識前提)

- Desktop Poolタイプの選択判断（Automated / Manual / RDS）
- Assignment Type の選択（Floating / Dedicated）
- Instant Clone Pool の設計パラメータとプロビジョニング
- Full Clone Pool の設計パラメータ
- プール更新（Push Image）と容量計画

---

## 1. Desktop Poolの分類体系

### 1.1 プールタイプの全体像

| 分類軸 | 選択肢 |
|--------|-------|
| ソース | Automated（自動プロビジョニング） / Manual（既存VM登録） / RDS Desktop |
| クローン方式 | Instant Clone / Full Clone |
| 割り当て方式 | Floating（フローティング） / Dedicated（専用） |

### 1.2 プールタイプ比較表

| プールタイプ | クローン方式 | 割り当て | 永続性 | 推奨ユースケース |
|------------|------------|---------|--------|----------------|
| Automated Instant Clone - Floating | Instant Clone | Floating | 非永続 | タスクワーカー、コールセンター |
| Automated Instant Clone - Dedicated | Instant Clone | Dedicated | 準永続（Persistent Disk対応） | 個人設定が必要だがリセット可能なユーザー |
| Automated Full Clone - Floating | Full Clone | Floating | 非永続（ただし手動リセット必要） | 稀なケース |
| Automated Full Clone - Dedicated | Full Clone | Dedicated | 永続 | 開発者、パワーユーザー |
| Manual Desktop Pool | N/A（既存VM） | Dedicated/Floating | VM依存 | 物理PC、既存VM |
| RDS Desktop Pool | Farm ベース | N/A（セッション） | 非永続 | 軽量ユーザー、アプリ配信 |

> **試験ポイント**: 「どのプールタイプを選択すべきか」という設計判断問題が頻出。判断基準は **永続性の必要性**、**コスト**、**管理の容易さ**、**ユーザーカスタマイズの要件** の4軸。

---

## 2. Instant Clone Desktop Pool

### 2.1 Instant Cloneの内部動作

#### Instant Clone Image Publishing Workflow

```
Golden Image VM + Snapshot
  ↓ (1) Image Publishing 開始
  ↓ (2) Internal Template 作成（スナップショットのクローン）
  ↓ (3) Replica Disk 作成（各Datastore上に1つ）
  ↓ (4) Parent VM 作成（各ESXiホスト上に1つ）
  ↓ (5) Parent VMの電源ON → メモリ状態を確立
  ↓ (6) vmFork により Instant Clone VM 作成
  ↓ (7) Clone VM = Parent VMのメモリ + 差分ディスク
  ↓ (8) ClonePrep によるカスタマイズ（SID変更、コンピュータ名変更、ドメイン参加）
```

**主要コンポーネント**:

| コンポーネント | 説明 |
|--------------|------|
| Internal Template | Golden Image Snapshotからフルクローンされる中間テンプレート。元のGolden Image VMのロックを防止 |
| Replica Disk | Internal Templateから作成される読み取り専用ディスク。Datastore単位で1つ |
| Parent VM | 各ESXiホスト上に1つ作成される中間VM。Replica Diskを参照して起動 |
| Instant Clone VM | Parent VMからvmForkで派生。差分ディスク + 共有メモリ |
| vmFork | VMwareのメモリクローン技術。Parent VMの実行中メモリ状態を共有 |
| ClonePrep | Instant Clone固有の軽量カスタマイズエンジン |

> **試験ポイント**: Internal Templateが最初に作成されるため、Push Image開始後もGolden Image VMの編集が可能。Replica Diskは**Datastore単位**、Parent VMは**ESXiホスト単位**で作成される。

#### vSphere VM暗号化とInstant Clone

| 項目 | 説明 |
|------|------|
| vTPM対応 | Pool設定の「Add virtual TPM」でCloneにvTPMを自動追加（Windows 11必須） |
| VM暗号化 | vSphere Native Key Provider (NKP) またはKMSサーバーが必要 |
| 暗号化ポリシー | vSphere Storage Policyで暗号化ポリシーを定義し、Poolに適用 |

> **試験ポイント**: vTPMを追加するとVM暗号化が有効化され、vSphere Key Providerの構成が前提となる。Windows 11のInstant Cloneプール作成時にはこの点を計画に含める必要がある。

### 2.2 Instant Clone Pool 作成パラメータ

#### General Settings

| パラメータ | 説明 | 推奨値 |
|-----------|------|-------|
| Pool ID | プール識別子（英数字、変更不可） | `VDI-IC-Win11-Sales` 等 |
| Display Name | ユーザー表示名 | 「営業部VDI」等 |
| Assignment | Floating / Dedicated | Floating（非永続VDI） |
| User Assignment | Automatic / Manual | Automatic |

#### Provisioning Settings

| パラメータ | 説明 | 設計ポイント |
|-----------|------|------------|
| Naming Pattern | VM命名パターン | `VDI-IC-{n:fixed=4}` → VDI-IC-0001 |
| Max Number of Machines | プール内最大VM数 | ピーク時CCU + バッファ |
| Min Number of Machines | 最小VM数（Spare） | 常時待機しておくVM数 |
| Number of Spare (Powered On) Machines | 電源ONの予備VM数 | ピーク前の待機数 |
| Provisioning Timing | プロビジョニングタイミング | Up-front / On-demand |

**Provisioning Timingの選択**:

| オプション | 動作 | 推奨場面 |
|-----------|------|---------|
| Provision all machines up-front | 起動時に最大数までプロビジョニング | ストレージに余裕がある場合 |
| Provision machines on demand | 需要に応じてプロビジョニング | ストレージ制約がある場合 |

#### Naming Pattern

| パターン要素 | 説明 | 例 |
|-------------|------|-----|
| `{n:fixed=N}` | N桁の連番 | `{n:fixed=4}` → 0001, 0002 |
| `{n:length=N}` | N桁の連番（fixed と同義） | `{n:length=3}` → 001, 002 |

**命名規則のベストプラクティス**:
- AD Computer Account名は15文字以内（NetBIOS制約）
- パターン例: `IC-{n:fixed=4}` （8文字、AD制約に余裕あり）

#### vCenter Settings

| パラメータ | 説明 |
|-----------|------|
| Golden Image VM | ベースとなるGolden Image VM |
| Snapshot | 使用するスナップショット |
| VM Folder Location | vCenter上のVM格納先フォルダ |
| Host or Cluster | 配置先のCluster |
| Resource Pool | Resource Pool（省略可） |
| Datastore | VM格納先のDatastore（複数選択可） |

#### Storage Settings

| パラメータ | 説明 | 推奨値 |
|-----------|------|-------|
| Datastores | Instant Clone配置先 | vSAN / 高IOPS Datastore |
| Storage Overcommit | ストレージオーバーコミット | Conservative / Moderate / Aggressive |
| Replica Disk Datastore | Replica Disk専用Datastore | 高速SSD/NVMe推奨 |
| Use Separate Datastore for Replica | Replicaを別Datastoreに配置 | 高IOPS要件時に有効 |
| Reclaim VM Disk Space | Space Reclamation | 有効化推奨 |

> **試験ポイント**: Space Reclamationを有効にすると、Guest OS内の削除済みブロックをvSphere側で回収し、差分ディスクの肥大化を抑制できる。vSAN環境ではTRIMがネイティブサポートされる。

#### Guest Customization

| パラメータ | 説明 |
|-----------|------|
| Domain | 参加するADドメイン |
| AD Container (OU) | コンピュータアカウントの配置先OU |
| Allow Reuse of Pre-existing Computer Accounts | 既存ADアカウントの再利用 |
| ClonePrep Post-Synchronization Script | Clone作成後に実行するスクリプト |

### 2.3 Dedicated Instant Clone と Persistent Disk

Instant CloneをDedicated割り当てで使用し、ユーザーデータをPersistent Diskに保持する構成:

| 項目 | 説明 |
|------|------|
| 用途 | ユーザーデータ（ドキュメント等）の永続保持 |
| サイズ | ユーザーデータ量に応じて設定 |
| Disk Letter | 通常 D: ドライブ |
| 永続性 | Push Image後もPersistent Diskは維持される |
| 制限 | Floating割り当てでは使用不可 |

---

## 3. Full Clone Desktop Pool

### 3.1 Full Clone Pool の特徴

| 特徴 | 説明 |
|------|------|
| 独立したVMDK | 各VMが独立したフルサイズのディスクを持つ |
| 永続データ | OS上のすべてのデータが永続 |
| パッチ適用 | 個別VMにWSUS / SCCM / Intune で適用可能 |
| ストレージ消費 | 大（VM数 × フルディスクサイズ） |
| プロビジョニング時間 | 長い（テンプレートからの完全クローン） |

### 3.2 Full Clone Pool 作成パラメータ

| パラメータ | 説明 |
|-----------|------|
| Template | VMテンプレート（Golden Imageから作成） |
| Customization Specification | Sysprep Customization Spec |
| Power Policy | Powered On / Suspended / Powered Off |
| Automatic Logoff | After Disconnect: Immediately / Never / After XX minutes |

### 3.3 Full Clone Pool の3D Rendering Options

| オプション | 説明 | 要件 |
|-----------|------|------|
| Software (Soft 3D) | ソフトウェアGPU | ESXi標準 |
| vSGA | Shared GPU（ハードウェアGPU共有） | 対応GPUカード |
| vDGA | Dedicated GPU（GPU専有） | 対応GPUカード |
| NVIDIA GRID vGPU | NVIDIA仮想GPU | NVIDIA GPUカード + VIBドライバ |
| AMD MxGPU | AMD仮想GPU | AMD GPUカード |

---

## 4. Manual Desktop Pool

### 4.1 用途と特徴

| 項目 | 説明 |
|------|------|
| 用途 | 既存のVM / 物理PC / 非vCenter管理VMの登録 |
| VM管理 | Horizonによるライフサイクル管理なし |
| プロビジョニング | 手動でVMを追加・削除 |
| ユースケース | 物理PC接続、特殊VM、レガシー環境 |

---

## 5. リソース設計と容量計画

### 5.1 VM リソース設計ガイドライン

| ワークロードタイプ | vCPU | vRAM | vDisk |
|-------------------|------|------|-------|
| Light（メール、Web、軽量Office） | 2 | 4 GB | 40 GB |
| Medium（Office全般、業務アプリ） | 2〜4 | 8 GB | 60 GB |
| Heavy（開発、CAD、データ分析） | 4〜8 | 16 GB | 100 GB |
| Power（3D/GPU、映像編集） | 4〜8 | 16〜32 GB | 100+ GB |

### 5.2 容量計画の公式

```
必要VM数 = 対象ユーザー数 × 同時接続率 + バッファ

例:
  ユーザー数: 1,000
  同時接続率: 60%
  バッファ: 10%
  必要VM数 = 1,000 × 0.6 × 1.1 = 660 VM
```

### 5.3 Provisioning パラメータの設計

| パラメータ | 設計指針 |
|-----------|---------|
| Max Machines | ピーク時CCU + 10%バッファ |
| Min Machines | オフピーク時のCCU |
| Spare (Powered On) | ログイン待ちなしの即座割り当て分。通常5〜10% |

> **試験ポイント**: Spare Machinesが0の場合、新規ユーザー接続時にプロビジョニングが発生し待ち時間が生じる。Spare数はユーザー体験とリソースコストのトレードオフで決定する。

---

## 6. プール更新と運用

### 6.1 Instant Clone プールの更新 (Push Image)

Push ImageはGolden Imageの更新をInstant Cloneプール全体に反映する操作。

**手順**:
1. Golden Image VMを更新（パッチ、Agent更新等）
2. 新しいスナップショットを取得
3. Horizon Console > Inventory > Desktop Pools > 対象Pool
4. **Push Image** をクリック
5. 新しいGolden Image + Snapshotを選択
6. Push Timingを選択（Immediately / At next logoff / Scheduled）

### 6.2 Selective Patching（選択的パッチ）

特定のVMのみを先行更新する機能:

1. Desktop Pool > Machines タブ
2. 対象VMを選択 > **Push Image**
3. 選択したVMのみが新イメージで再作成される

> **試験ポイント**: Selective Patchingは段階的なロールアウトに使用する。まずテスト用の少数VMに適用し、問題がなければプール全体にPush Imageを実行する。

### 6.3 メンテナンスモード

| 操作 | 効果 |
|------|------|
| Pool Disable | 新規接続を拒否、既存セッション継続 |
| Pool Delete (with VM delete) | VMごと削除 |
| Pool Delete (without VM delete) | Pool定義のみ削除、VM残存 |
| Machine Maintenance Mode | 個別VMへの新規接続を停止 |

---

## 7. ベストプラクティスとアンチパターン

### ベストプラクティス

| # | プラクティス |
|---|------------|
| 1 | Floating + Instant Cloneを標準構成とし、例外のみFull Clone |
| 2 | 命名パターンは15文字以内、組織統一のルールを策定 |
| 3 | Spare Machinesは5〜10%に設定し、ユーザー待機を防止 |
| 4 | Push Imageは「At next logoff」で段階的に適用 |
| 5 | Selective Patchingでテスト後に全体展開 |
| 6 | Dedicated Instant Clone + Persistent DiskよりもDEM / App Volumes WVを優先検討 |
| 7 | ストレージにはvSANを推奨（Space Reclamation / TRIM ネイティブ対応） |

### アンチパターン

| # | アンチパターン | 問題点 |
|---|-------------|--------|
| 1 | 全ユーザーにDedicated Full Clone | ストレージコスト爆発、管理負荷増大 |
| 2 | Spare Machines = 0 | 新規接続時に長い待ち時間 |
| 3 | 命名パターンが16文字以上 | NetBIOS制約違反でドメイン参加失敗 |
| 4 | Push Imageを「Immediately」で本番適用 | 全ユーザーが同時切断される |
| 5 | プール容量にバッファなし | ピーク時に接続拒否 |

---

## 8. Horizon 2412の主要な新機能

| 機能 | 説明 |
|------|------|
| Automated Keylogger Policy | キーロガー保護を有効化するポリシー。エンドユーザーにキーロガーブロック保護を促す |
| Display Insights | Helpdesk Toolにディスプレイスケーリングデータ、モニター数、スケーリングファクターの可視化を追加 |
| Scanner Redirection (Chrome) | Chrome Client経由でスキャナーリダイレクションをサポート |
| FIDO2 WebAuthN (Linux) | LinuxクライアントでFIDO2認証コンポーネントの使用をサポート |

---

## 9. トラブルシューティング

| 症状 | 原因候補 | 対処 |
|------|---------|------|
| VMがProvisioning Errorになる | vCenterリソース不足、Datastore容量不足、AD OU権限不足 | vCenter/Datastoreの容量確認、AD権限確認 |
| Push Image後にVMが起動しない | スナップショット不整合、Agent非互換 | スナップショット再作成、Agent確認 |
| プロビジョニングが遅い | Datastoreの高負荷、ネットワーク帯域不足 | IOPSモニタリング、Replica分離 |
| ユーザーがプールに接続できない | Entitlement未設定、Pool Disabled | Entitlement確認、Pool状態確認 |
| VMが「Already Used」状態 | Dedicated割り当てで前ユーザーが残存 | Machine割り当て解除 |

---

## 理解度チェックリスト

- [ ] Automated / Manual / RDS Desktop Poolの違いと選択基準を説明できる
- [ ] Instant CloneのImage Publishing Workflow（Replica → Parent → vmFork → Clone）を説明できる
- [ ] Floating vs Dedicated の選択判断基準を説明できる
- [ ] Naming Patternの設計ルール（15文字制約）を理解している
- [ ] Spare Machinesの設計意図とトレードオフを説明できる
- [ ] Push Imageの3つのTimingオプションと使い分けを説明できる
- [ ] Selective Patchingの用途と手順を説明できる
- [ ] Space ReclamationがInstant Cloneストレージに与える効果を説明できる
- [ ] Full Clone Poolの3D Rendering Optionsの選択基準を説明できる
- [ ] 容量計画の公式（ユーザー数 × 同時接続率 + バッファ）を適用できる
