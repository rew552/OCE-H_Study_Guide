# 2.4 RDSH Farms

## 概要

RDSH（Remote Desktop Session Host）ファームの管理は、アプリケーション配信に重要です。OCE-Hレベルでは、高度なロードバランシング、パフォーマンス最適化、セッション制限、ログイン性能向上が求められます。

## 学習目標

このセクションを学習することで、以下のことができるようになります：

- RDSHファームの作成と設定ができる
- ロードバランシングオプションを評価できる
- セッション制限の設定方法を理解している
- ログイン性能向上の評価方法を説明できる

## 関連リソース

- [クイックリファレンス](../../00_Quick_Reference.md) - ポート番号、設定値、制限値
- [用語集](../../README.md#用語集) - 関連用語の定義
- [1.6 Pod/Farm Architecture](../../Section1_Infrastructure_Planning_and_Management/1.6_Pod_Farm_Architecture.md) - Pod/Farmアーキテクチャ
- [実環境シナリオ](../../00_Scenarios/Section2_Scenarios.md) - 実環境でのシナリオ例

## RDSHファームの作成と設定

### 自動ファームの作成

**作成手順**:

1. **Horizon Consoleでの操作**
   - Inventory → Farms
   - Add → Automated Farm

2. **基本設定**
   - Farm ID: ファーム識別子
   - Display Name: 表示名
   - Description: 説明

3. **vCenter設定**
   - vCenter Serverの選択
   - Resource Poolの選択
   - Parent VMの選択（RDSH用ゴールデンイメージ）
   - Snapshotの選択

4. **ホスト設定**
   - Initial Number of Hosts: 初期ホスト数
   - Maximum Number of Hosts: 最大ホスト数
   - Minimum Number of Hosts: 最小ホスト数

5. **リソース設定**
   - CPU: CPUコア数
   - Memory: メモリ容量
   - Storage: ストレージ容量

## 高度なロードバランシング

### ロードバランシング方法

#### セッションベースのロードバランシング

**概要**:
- 各RDSHホストのセッション数を監視
- セッション数が少ないホストに接続

**設定**:
- Horizon Console → Farms → ファームを選択
- Settings → Load Balancing
- Session-basedを選択

**利点**:
- シンプルな実装
- 自動的な負荷分散

**欠点**:
- リソース使用率を考慮しない
- パフォーマンスが最適化されない可能性

#### リソースベースのロードバランシング

**概要**:
- CPU、メモリ、ディスク使用率を監視
- リソース使用率が低いホストに接続

**設定**:
- Horizon Console → Farms → ファームを選択
- Settings → Load Balancing
- Resource-basedを選択

**監視項目**:
- CPU使用率
- メモリ使用率
- ディスクIOPS

**利点**:
- より正確な負荷分散
- パフォーマンスの最適化
- リソースの効率的な利用

> [!TIP]

> リソースベースのロードバランシングは、パフォーマンスが重要な環境で推奨されます。

### ロードバランシングの最適化

**設定項目**:
- 負荷分散アルゴリズム
- セッション分散の閾値
- リソース監視の間隔

## パフォーマンス最適化

### セッション制限

#### RDSホストあたりのセッション数の制限

**考慮事項**:
- ホストのリソース（CPU、メモリ、ディスク）
- アプリケーションの要件
- ユーザーの使用パターン

**推奨値**:
| 用途 | セッション数 |
|------|------------|
| 標準的なオフィス作業 | 50-100セッション |
| 重いアプリケーション | 20-50セッション |
| 軽量アプリケーション | 100-150セッション |

**設定方法**:
- Horizon Console → Farms → ファームを選択
- Settings → Session Limits
- Maximum Sessions per Hostを設定

> [!IMPORTANT]

> セッション数の制限は、ホストのリソースとアプリケーションの要件に基づいて設定する必要があります。過剰なセッション数は、パフォーマンスの低下を引き起こします。

### リソース割り当て

**CPU割り当て**:
- セッションあたりのCPUコア数
- 推奨: 0.1-0.2コア/セッション

**メモリ割り当て**:
- セッションあたりのメモリ容量
- 推奨: 512MB-1GB/セッション

**計算例**:
```
ホスト: 8 vCPU, 32GB RAM
セッションあたり: 0.15 vCPU, 768MB RAM
最大セッション数: min(8/0.15, 32/0.768) = min(53, 41) = 41セッション
```

## RDSHベースセッションのログイン性能向上

### ホスト側の最適化

#### メモリ割り当ての最適化

**設定**:
- セッションあたりのメモリを適切に設定
- ページファイルの最適化
- メモリプールの最適化

**レジストリ設定**:
```powershell
# メモリ管理の最適化
New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" `
    -Name "LargeSystemCache" -Value 0 -PropertyType DWord -Force
```

#### CPU割り当ての最適化

**設定**:
- CPUリソースプールの設定
- CPUスケジューリングの最適化

#### ディスクIOPSの最適化

**設定**:
- 高速ストレージの使用
- キャッシングの有効化
- IOPSの監視

### ネットワーク最適化

**設定項目**:
- ネットワーク帯域幅の確保
- レイテンシの最小化
- QoS設定

**ネットワーク設定**:
```powershell
# TCP/IP設定の最適化
netsh int tcp set global autotuninglevel=normal
netsh int tcp set global chimney=enabled
netsh int tcp set global rss=enabled
```

### ログイン時間の最適化

**最適化方法**:
1. **プロファイルの最適化**
   - DEMを使用したプロファイル管理
   - プロファイルサイズの削減

2. **アプリケーションの最適化**
   - スタートアッププログラムの削減
   - アプリケーションの遅延起動

3. **ネットワークの最適化**
   - プロファイル共有への高速接続
   - ネットワーク帯域幅の確保

## Application on Demandの設定

### Application on Demandの概要

**機能**:
- アプリケーションをオンデマンドで配信
- VM起動時にアプリケーションを動的にアタッチ
- リソース効率の向上

### 前提条件設定

**Horizon UIでの設定**:

1. **Application on Demandの有効化**
   - View Configuration → Global Settings
   - Application on Demandを有効化

2. **前提条件の設定**
   - App Volumes Managerの統合
   - ストレージの設定
   - ネットワークの設定

3. **アプリケーションの設定**
   - Inventory → Applications
   - アプリケーションを選択
   - Application on Demandを有効化

**ユースケース**:
- たまに使用されるアプリケーション
- 大規模なアプリケーション
- 頻繁に更新されるアプリケーション

> [!NOTE]

> Application on Demandを使用するには、App Volumes Managerの統合が必要です。

## ベストプラクティス

1. **容量計画**
   - セッション数の計画
   - リソース要件の評価
   - 成長予測の考慮

2. **ロードバランシング**
   - リソースベースのロードバランシングを推奨
   - 定期的な監視と調整

3. **パフォーマンス最適化**
   - ホスト側の最適化
   - ネットワーク最適化
   - ログイン時間の最適化

4. **モニタリング**
   - セッション監視
   - パフォーマンス監視
   - リソース使用率の追跡

> [!CAUTION]

> RDSHファームの設定変更は、すべてのホストとセッションに影響を与える可能性があります。本番環境で変更する前に、テスト環境で十分に検証してください。

## RDSHホストの詳細な最適化

### OSOTによる最適化

**RDSH用OSOTテンプレート**:
- RDSH標準テンプレートを使用
- マルチセッション環境に最適化

**最適化項目**:
- 不要なサービスの無効化
- スケジュールタスクの最適化
- 視覚効果の無効化
- ネットワーク最適化

### レジストリ最適化

**RDSH固有のレジストリ設定**:
```powershell
# RDSHセッションの最適化
New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" `
    -Name "MaxInstanceCount" -Value 100 -PropertyType DWord -Force

# セッションタイムアウトの設定
New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
    -Name "MaxDisconnectionTime" -Value 600000 -PropertyType DWord -Force
```

## セッション管理の詳細

### セッションタイムアウトの設定

**設定項目**:
- **アクティブセッションタイムアウト**: アクティブなセッションのタイムアウト時間
- **アイドルセッションタイムアウト**: アイドルセッションのタイムアウト時間
- **切断セッションタイムアウト**: 切断されたセッションのタイムアウト時間

**GPOでの設定**:
```
Computer Configuration → Policies → Administrative Templates → 
Windows Components → Remote Desktop Services → Remote Desktop Session Host → Session Time Limits
```

**設定例**:
- アクティブセッションタイムアウト: 8時間
- アイドルセッションタイムアウト: 30分
- 切断セッションタイムアウト: 1時間

### アイドルタイムアウトの設定

**設定方法**:
- GPOまたはレジストリで設定
- ユーザーごとに異なる設定も可能

**レジストリ設定**:
```powershell
# アイドルセッションタイムアウト（30分）
New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
    -Name "MaxIdleTime" -Value 1800000 -PropertyType DWord -Force
```

## RDSHホストのメンテナンス

### メンテナンス手順

**手順**:

1. **ホストをドレイン状態にする**
   - Horizon Console → Inventory → Farms
   - ファームを選択 → Hosts
   - ホストを選択 → Drain

2. **既存セッションの終了待機**
   - ユーザーに通知
   - セッションの終了を待機

3. **メンテナンス作業**
   - 更新の適用
   - 設定の変更

4. **ドレイン状態の解除**
   - ホストを選択 → Undrain
   - 新しいセッションを受け入れ

## アプリケーションの公開設定の詳細

### アプリケーションの公開

**公開手順**:

1. **RDSHホストでアプリケーションをインストール**
   - アプリケーションを通常通りインストール

2. **Horizon Consoleでの公開**
   - Inventory → Applications
   - Add Application
   - RDSH Farmを選択
   - アプリケーションを選択

3. **エンタイトルメントの設定**
   - アプリケーションを選択 → Entitlements
   - ユーザーまたはグループを追加

**アプリケーション設定の詳細**:
- **表示名**: ユーザーに表示される名前
- **説明**: アプリケーションの説明
- **アイコン**: アプリケーションのアイコン
- **起動パラメータ**: アプリケーションの起動パラメータ

## トラブルシューティング

### 一般的な問題

**セッションが接続されない**:
- ロードバランシング設定を確認
- ホストの状態を確認
- リソース使用率を確認
- RDSライセンスの確認

**パフォーマンスの問題**:
- リソース使用率を確認
- セッション数を確認
- ネットワーク帯域幅を確認
- アプリケーションのリソース使用率を確認

**ログイン時間が長い**:
- プロファイルサイズを確認
- ネットワーク接続を確認
- アプリケーションの起動時間を確認
- DEM設定を確認

## まとめ

RDSHファームの適切な管理は、アプリケーション配信の効率性に重要です。高度なロードバランシング、パフォーマンス最適化、セッション制限、ログイン性能向上、RDSHホストの詳細な最適化、セッション管理の詳細、メンテナンス、アプリケーションの公開設定により、効率的でパフォーマンスの高いRDSH環境を構築できます。
