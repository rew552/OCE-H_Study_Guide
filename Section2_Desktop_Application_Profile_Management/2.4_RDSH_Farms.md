# 2.4 RDSH Farmの設計と管理

## 試験ガイド対応 (Section 4.2 — OCA知識前提)

- RDSH Farmの設計と構築（Automated / Manual）
- Published Desktop と Published Application の違い
- ロードバランシングの評価と設定
- セッション制限とログイン性能の最適化
- Application on Demand の設定と前提条件

---

## 1. RDSH Farmの概要

### 1.1 RDSH Farmとは

RDSH（Remote Desktop Session Host）Farmは、複数のWindows Server RDSHホストを束ねて、セッションベースのデスクトップおよびアプリケーション配信を行うリソースグループである。1つのRDSHホストが複数ユーザーのセッションを同時にホストする。

### 1.2 RDSH Farm vs VDI Desktop Pool

| 比較項目 | RDSH Farm | VDI Desktop Pool |
|---------|-----------|-----------------|
| ホスト | Windows Server (RDSH) | Windows Client / Server |
| セッション | マルチセッション（1ホストに複数ユーザー） | シングルセッション（1VMに1ユーザー） |
| 配信形態 | Published Desktop / Published Application | Full Desktop |
| ライセンス | RDS CAL 必要 | VDA / SA ライセンス |
| リソース効率 | 高い（ホスト共有） | 低い（VM専用） |
| カスタマイズ | 制限あり（マルチユーザー環境） | 高い（専用VM） |
| 推奨ユースケース | 軽量タスクワーカー、アプリ配信 | フルデスクトップ体験が必要なユーザー |

---

## 2. RDSH Farmの種類

### 2.1 Automated Farm（Instant Clone）

vCenterと連携し、Instant Cloneで自動的にRDSHホストをプロビジョニング・管理する。

| 特徴 | 説明 |
|------|------|
| プロビジョニング | Golden Image + Snapshotから自動作成 |
| ライフサイクル | Push Imageで一括更新 |
| スケーリング | Min / Max ホスト数で自動制御 |
| 永続性 | 非永続（ログオフ/再起動でリセット） |
| 推奨 | ✅ 標準構成 |

### 2.2 Manual Farm

既存のRDSHホスト（物理 / VM）を手動で登録するFarm。

| 特徴 | 説明 |
|------|------|
| プロビジョニング | 手動でVMを追加 |
| ライフサイクル | 個別管理（WSUS/SCCM等） |
| 永続性 | 永続（ホストは常に維持） |
| 推奨場面 | レガシー環境、物理サーバー |

---

## 3. Automated Farm（Instant Clone）の作成

### 3.1 作成パラメータ

**設定場所**: Horizon Console > Inventory > Farms > Add > Automated Farm (Instant Clone)

#### Identification

| パラメータ | 説明 |
|-----------|------|
| Farm ID | Farm識別子（英数字、変更不可） |
| Display Name | 表示名 |
| Description | 説明 |
| Access Group | アクセスグループ |

#### Provisioning Settings

| パラメータ | 説明 | 設計ポイント |
|-----------|------|------------|
| Naming Pattern | RDSHホスト命名 | `RDSH-{n:fixed=3}` → RDSH-001 |
| Max Number of Machines | 最大ホスト数 | ピーク時の必要ホスト数 |
| Min Number of Machines | 最小ホスト数 | 常時稼働ホスト数 |
| Number of Spare Machines | 予備ホスト数 | 新規セッションの即時受入用 |

#### vCenter Settings

| パラメータ | 説明 |
|-----------|------|
| Golden Image VM | RDSH用Golden Image（Server OS + RDSロール） |
| Snapshot | 使用するスナップショット |
| VM Folder | VM格納先 |
| Host or Cluster | 配置先Cluster |
| Resource Pool | Resource Pool |
| Datastores | ストレージ |

#### Guest Customization

| パラメータ | 説明 |
|-----------|------|
| Domain | ADドメイン |
| AD Container (OU) | RDSHホスト用OU |
| ClonePrep Script | カスタマイズスクリプト |

### 3.2 RDSH Golden Imageの準備

RDSH用のGolden Imageには、VDI用と異なる追加準備が必要:

1. **Windows Server OS**（2019 / 2022 / 2025）をインストール
2. **Desktop Experience** を有効化
3. **Remote Desktop Services** ロールをインストール
4. Horizon Agentをインストール（RDSH Agent オプション有効）
5. OSOT で **RDSH用テンプレート** を使用して最適化
6. 必要なアプリケーションをインストール（App Volumes非配信分）

> **試験ポイント**: Horizon Agentインストール時に**RDSH Agent**オプションを選択しないと、マルチセッション機能が有効化されない。Server OS上でAgentをインストールすると自動的にRDSH Agentが選択される場合もあるが、確認が必要。

---

## 4. Published Desktop と Published Application

### 4.1 Published Desktop

RDSH Farm上でフルデスクトップセッションを配信する形態。

**設定場所**: Horizon Console > Inventory > Desktops > Add > RDS Desktop Pool

| パラメータ | 説明 |
|-----------|------|
| Pool ID | RDS Desktop Pool識別子 |
| Display Name | ユーザー表示名 |
| Farm | 紐づけるRDSH Farm |
| Default Display Protocol | Blast / PCoIP |

### 4.2 Published Application

RDSH Farm上の個別アプリケーションをシームレスに配信する形態。ユーザーにはデスクトップではなくアプリケーションウィンドウのみが表示される。

**設定場所**: Horizon Console > Inventory > Applications > Add

**追加方法**:

| 方法 | 説明 |
|------|------|
| Add from Farm | Farm上のインストール済みアプリを自動検出して追加 |
| Add Manually | 実行パス、パラメータを手動指定 |

**Application設定パラメータ**:

| パラメータ | 説明 |
|-----------|------|
| Application ID | アプリ識別子 |
| Display Name | ユーザー表示名 |
| Application Path | 実行ファイルパス（例: `C:\Program Files\App\app.exe`） |
| Start Folder | 起動ディレクトリ |
| Parameters | コマンドライン引数 |
| Farm | 紐づけるFarm |
| Pre-launch | セッション事前起動（ログイン時にセッションを準備） |
| Category Folder | カテゴリフォルダ（Horizon Clientでのグループ化） |

### 4.3 Session-based vs App-based の選択

| 判断基準 | Published Desktop (Session) | Published Application (App) |
|---------|---------------------------|----------------------------|
| ユーザー体験 | フルデスクトップ操作 | アプリウィンドウのみ |
| 用途 | デスクトップ代替 | 特定アプリの配信 |
| リソース効率 | 中（デスクトップシェル分のリソース消費） | 高（アプリのみ） |
| マルチアプリ | デスクトップ内で複数アプリを操作 | 各アプリが個別セッション or 共有セッション |
| 推奨場面 | サーバーベースのデスクトップ代替 | 特定業務アプリの配信 |

---

## 5. ロードバランシング

### 5.1 ロードバランシング方式

Horizon Consoleで RDSH Farm のロードバランシング方式を選択できる。

**設定場所**: Horizon Console > Inventory > Farms > 対象Farm > Edit > Load Balancing Settings

| 方式 | 説明 | 設定 |
|------|------|------|
| **Use Horizon Connection Server broker** | Connection Serverがセッション数ベースで分散 | デフォルト |
| **Use server load index** | RDSHホスト上のAgentがCPU/メモリ負荷を報告し、負荷の低いホストに接続 | カスタム閾値設定可 |

### 5.2 Server Load Index設定

Server Load Index方式では、各RDSHホストのパフォーマンスカウンターに基づいて負荷をインデックス値（0〜100）で算出する。

**カスタム閾値設定**（レジストリ）:

| レジストリキー | 説明 | デフォルト |
|--------------|------|----------|
| `HKLM\SOFTWARE\VMware, Inc.\VMware VDM\Node Manager\PerformanceSLA\CPUThreshold` | CPU使用率閾値（%） | 90 |
| `HKLM\SOFTWARE\VMware, Inc.\VMware VDM\Node Manager\PerformanceSLA\MemThreshold` | メモリ使用率閾値（%） | 90 |
| `HKLM\SOFTWARE\VMware, Inc.\VMware VDM\Node Manager\PerformanceSLA\DiskQueueLengthThreshold` | ディスクキュー閾値 | 使用するディスクに依存 |

> **試験ポイント**: Server Load Index方式はリソースベースのインテリジェントなロードバランシングであり、ワークロードが不均一な環境で推奨される。Connection Server brokerはセッション数のみで分散するため、リソース消費の差異を考慮しない。

---

## 6. セッション制限

### 6.1 RDSホストあたりのセッション数制限

**設定場所**: Horizon Console > Inventory > Farms > 対象Farm > Edit

| パラメータ | 説明 |
|-----------|------|
| Max Sessions per RDS Host | 1ホストあたりの最大同時セッション数 |

**セッション数の設計ガイドライン**:

| ワークロード | 目安セッション数/ホスト | ホストスペック例 |
|------------|---------------------|----------------|
| Light (Web, Email) | 75〜150 | 8 vCPU / 32 GB RAM |
| Medium (Office) | 50〜75 | 8 vCPU / 32 GB RAM |
| Heavy (業務アプリ) | 25〜50 | 8 vCPU / 64 GB RAM |

**計算例**:
```
ホスト: 8 vCPU, 64 GB RAM
Medium ワークロード: セッションあたり 0.15 vCPU, 0.8 GB RAM
CPU制約: 8 / 0.15 ≈ 53 セッション
RAM制約: 64 / 0.8 = 80 セッション
→ Max Sessions = min(53, 80) = 53 セッション（CPU制約がボトルネック）
```

### 6.2 セッションタイムアウト

**設定場所**: GPO または Horizon Console

| タイムアウト種別 | 説明 | 推奨値 |
|---------------|------|-------|
| Empty Session Timeout | 空セッション（アプリなし）のタイムアウト | 1分 |
| When Timeout Occurs | タイムアウト時のアクション | Disconnect |
| Disconnected Session Logoff | 切断セッションのログオフ時間 | After 30 minutes |
| Pre-launch Session Timeout | 事前起動セッションのタイムアウト | 10分 |

---

## 7. ログイン性能の最適化

### 7.1 Pre-launch Session

Published Application環境で、ユーザーがアプリを起動する前にセッションを事前に準備しておく機能。

**効果**: アプリケーション起動時間を大幅に短縮（セッション確立の待ち時間を排除）

**設定**:
- Horizon Console > Inventory > Applications > 対象App > Edit
- **Pre-launch** を有効化
- Pre-launch Timeout を設定

### 7.2 Session Sharing

同一ユーザーが複数のPublished Applicationを起動する際に、既存のRDSHセッションを共有する機能。

| 設定 | 動作 |
|------|------|
| Enabled（デフォルト） | 2つ目以降のアプリは既存セッション内で起動 |
| Disabled | アプリごとに新しいセッションを作成 |

> **試験ポイント**: Session Sharingを有効にすると、ユーザー1人あたりのセッション数が削減されRDSHリソースを節約できる。ただし、アプリ間の互換性問題がある場合はDisabledにする必要がある。

### 7.3 ログイン時間最適化のチェックポイント

| 最適化項目 | 施策 |
|-----------|------|
| プロファイル管理 | DEMでプロファイルサイズを制御 |
| GPO処理 | 不要なGPOを整理、WMIフィルタリングで対象を限定 |
| ログオンスクリプト | スクリプトの最適化、非同期実行 |
| ネットワーク | Profile Share / Config Share への高速アクセス |
| アプリケーション | 起動時のアプリ数削減、App Volumesでの遅延アタッチ |
| OSOT | RDSH用テンプレートで最適化 |

---

## 8. メンテナンス管理

### 8.1 スケジュールメンテナンス

Automated Farm（Instant Clone）では、定期的なメンテナンスをスケジュールできる。

**設定場所**: Horizon Console > Inventory > Farms > 対象Farm > Edit > Maintenance

| パラメータ | 説明 |
|-----------|------|
| Recurring Maintenance | 定期メンテナンスの有効/無効 |
| Frequency | Daily / Weekly / Monthly |
| Start Time | メンテナンス開始時刻 |
| Operation | Push Image / Logoff and Delete |

### 8.2 Drain Mode（排出モード）

個別RDSHホストのメンテナンス時に使用する。

| モード | 動作 |
|--------|------|
| Drain | 新規セッションの受付を停止。既存セッションは継続 |
| Undrain | 通常動作に復帰。新規セッションを受け付ける |

**手順**:
1. Horizon Console > Inventory > Farms > 対象Farm > RDS Hosts
2. 対象ホストを選択 > **More Commands** > **Disable Provisioning** / **Put in Maintenance Mode**
3. 既存セッションの終了を待つ（または強制ログオフ）
4. メンテナンス作業を実施
5. **Enable Provisioning** / **Remove Maintenance Mode** で復帰

> **試験ポイント**: Drain Modeは個別ホストの計画メンテナンスに使用する。ホストの更新やトラブルシューティング時に、ユーザー影響を最小化しながら作業できる。

### 8.3 Multi-Session Host Performance Options

RDSHホストのパフォーマンスオプションで、セッション管理の動作を細かく制御する。

| 設定 | 説明 |
|------|------|
| Logoff Empty Sessions | 空セッション（アクティブなアプリケーションなし）のタイムアウトと自動ログオフ |
| End Disconnected Sessions | 切断セッションの自動ログオフ |
| Max Sessions Behavior | 最大セッション数到達時の動作（Reject / Queue） |

---

## 9. Application on Demand

### 9.1 概要

Application on Demandは、Published Applicationの配信においてApp Volumesパッケージをオンデマンドでアタッチする方式。ユーザーがアプリを起動した時点でApp Volumesパッケージがマウントされる。

### 9.2 前提条件

| 要件 | 説明 |
|------|------|
| App Volumes Manager | Horizon Connection Serverと統合済み |
| App Volumes Agent | RDSHホストのGolden Imageにインストール済み |
| App Volumes Package | 対象アプリがパッケージ化済み（Delivery Mode: On Demand） |
| Horizon Console設定 | Published ApplicationでApp Volumes連携を設定 |

### 9.3 設定手順

1. App Volumes ManagerでパッケージのDelivery Modeを **On Demand** に設定
2. Horizon Console > Settings > App Volumes でApp Volumes Managerを登録
3. Horizon Console > Inventory > Applications > Add from App Volumes

**Classic vs On-Demand Delivery Mode**:

| 方式 | 動作 | ユースケース |
|------|------|------------|
| Classic | ログイン時にパッケージをアタッチ | 常時使用するアプリ |
| On Demand | アプリ起動時にパッケージをアタッチ | たまに使用するアプリ、大規模アプリ |

> **試験ポイント**: On Demand配信はログイン時間を短縮するが、初回アプリ起動時にわずかな遅延が発生する。Classic配信はログイン時に全アプリをアタッチするため、ログイン時間が長くなるがアプリ起動は即座。

---

## 10. ベストプラクティスとアンチパターン

### ベストプラクティス

| # | プラクティス |
|---|------------|
| 1 | Automated Farm (Instant Clone) を標準構成とし、Push Imageで一括管理 |
| 2 | Server Load Indexベースのロードバランシングを使用 |
| 3 | Max Sessions/Host はパフォーマンステスト結果に基づいて設定 |
| 4 | Pre-launch Sessionで Published App の体感起動時間を改善 |
| 5 | Session Sharingを有効化してリソース効率向上 |
| 6 | RDSH用OSOTテンプレートでGolden Imageを最適化 |
| 7 | 切断セッションには適切なタイムアウト（30分〜1時間）を設定 |

### アンチパターン

| # | アンチパターン | 問題点 |
|---|-------------|--------|
| 1 | セッション数制限なし | リソース枯渇でホストがクラッシュ |
| 2 | 切断セッションのタイムアウトが「Never」 | セッションが蓄積しリソース圧迫 |
| 3 | Connection Serverブローカーのみでロードバランシング | リソース不均衡が発生 |
| 4 | RDSHホストに個別にアプリをインストール | イメージ不整合、管理不能 |
| 5 | テストなしでMax Sessions数を設定 | パフォーマンス問題発生 |

---

## 11. トラブルシューティング

| 症状 | 原因候補 | 対処 |
|------|---------|------|
| セッションが接続されない | RDS CALライセンス不足、ホスト障害、セッション上限到達 | RDS CAL確認、ホスト状態確認、Max Sessions確認 |
| パフォーマンス低下 | セッション過多、リソース不足 | セッション数確認、ホストリソース確認 |
| ログイン時間が長い | プロファイル肥大、GPO過多、ネットワーク遅延 | DEM / GPO最適化、Pre-launch有効化 |
| アプリが表示されない | Entitlement未設定、Farm未関連付け | Entitlement確認、Farm割り当て確認 |
| ホストがDrain状態 | メンテナンスモード設定済み | ホスト状態確認、Undrain実施 |
| Application on Demand失敗 | App Volumes Agent未インストール、Manager接続不良 | Agent確認、Manager接続テスト |

---

## 理解度チェックリスト

- [ ] RDSH FarmとVDI Desktop Poolの違い・使い分けを説明できる
- [ ] Automated Farm (Instant Clone) の作成パラメータを説明できる
- [ ] Published DesktopとPublished Applicationの違いを説明できる
- [ ] Session Sharingの効果と制約を説明できる
- [ ] Server Load Indexベースのロードバランシングの仕組みを説明できる
- [ ] Max Sessions/Hostの計算方法を説明できる
- [ ] Pre-launch Sessionの効果と設定を説明できる
- [ ] Application on DemandのClassic vs On-Demand Delivery Modeの違いを説明できる
- [ ] セッションタイムアウトの各種設定と推奨値を説明できる
- [ ] RDSH用Golden Imageの準備手順（Server OS + RDSロール + Agent）を説明できる
