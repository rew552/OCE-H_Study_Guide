# 2.7 GPOによるHorizon環境の制御

## 試験ガイド対応 (Section 4.2 — OCA知識前提)

- Horizon ADMXテンプレートのインポートと設定
- GPOの適用順序と優先順位（LSDOU）
- Loopback Processing の設計
- Horizon Agent / Client / Blast / PCoIP の主要GPO設定項目
- OU設計のベストプラクティス
- GPO vs DEM Smart Policies の使い分け

---

## 1. GPOの基礎とHorizon環境での役割

### 1.1 GPOの適用順序（LSDOU）

GPO（Group Policy Object）は以下の順序で処理され、後から処理されたものが優先される:

| 順序 | レベル | 説明 |
|------|--------|------|
| 1 | **L**ocal GPO | ローカルコンピュータのポリシー |
| 2 | **S**ite GPO | ADサイトにリンクされたGPO |
| 3 | **D**omain GPO | ドメインにリンクされたGPO |
| 4 | **O**U GPO | OUにリンクされたGPO（親OU → 子OU） |
| 5 | **U**ser GPO | ユーザーに適用されるGPO（Loopback処理後） |

> **重要**: GPOは「後から処理されたものが優先」（Last Writer Wins）。OU GPOはドメインGPOより優先される。同一レベルに複数GPOがリンクされている場合は、リンク順序の数値が小さいほど優先。

### 1.2 Horizon環境でのGPOの用途

| 用途 | 説明 |
|------|------|
| 表示プロトコル制御 | Blast / PCoIP の帯域幅、品質、コーデック設定 |
| 機能制御 | USB、クリップボード、CDR、印刷のリダイレクト制御 |
| セキュリティ制御 | SSLプロトコル、暗号化、TLS設定 |
| パフォーマンス | フレームレート、コーデック選択、帯域幅制限 |
| ユーザー体験 | マルチモニタ設定、解像度、ウォーターマーク |

---

## 2. Horizon ADMXテンプレート

### 2.1 ADMXテンプレートファイル一覧

Horizon AgentおよびClientのインストールメディアに含まれるADMXテンプレート:

| テンプレートファイル | 設定対象 | 適用先 |
|-------------------|---------|--------|
| `omnissa-vdm-agent.admx` | Horizon Agent全般 | Computer Configuration |
| `omnissa-vdm-client.admx` | Horizon Client | User / Computer Configuration |
| `vdm-blast.admx` | Blast Extreme プロトコル | Computer Configuration |
| `vdm-pcoip.admx` | PCoIP プロトコル | Computer Configuration |
| `vdm-agent-usb.admx` | USB リダイレクト | Computer / User Configuration |
| `vdm-agent-cdr.admx` | Client Drive Redirection | Computer Configuration |
| `vdm-agent-clipboard.admx` | クリップボードリダイレクト | Computer Configuration |
| `vdm-agent-rtav.admx` | Real-Time Audio-Video | Computer Configuration |
| `vdm-agent-printing.admx` | 仮想印刷 / 統合印刷 | Computer Configuration |
| `vdm-agent-scanner.admx` | スキャナリダイレクト | Computer Configuration |
| `vdm-agent-serialport.admx` | シリアルポートリダイレクト | Computer Configuration |
| `vdm-agent-html5mmr.admx` | HTML5マルチメディアリダイレクト | Computer Configuration |
| `vdm-agent-recording.admx` | セッション録画 | Computer Configuration |
| `vdm-agent-watermark.admx` | デジタルウォーターマーク | Computer Configuration |

### 2.2 ADMXテンプレートのインポート手順

#### Central Store方式（推奨）

1. ドメインコントローラ上にCentral Storeを作成:
   ```
   \\<domain>\SYSVOL\<domain>\Policies\PolicyDefinitions\
   ```

2. ADMXファイルをコピー:
   ```
   コピー元: Horizon Agent インストールディレクトリ\VMware\VMware View\Agent\ADMX\*.admx
   コピー先: \\<domain>\SYSVOL\<domain>\Policies\PolicyDefinitions\
   ```

3. ADML（言語ファイル）をコピー:
   ```
   コピー元: ...\ADMX\en-US\*.adml
   コピー先: \\<domain>\SYSVOL\<domain>\Policies\PolicyDefinitions\en-US\
   ```

4. Group Policy Management Console (GPMC) でGPOを編集 > Administrative Templates に Omnissa Horizon 項目が表示されることを確認

> **重要**: ADMXテンプレートはCentral Store（SYSVOL内のPolicyDefinitionsフォルダ）に配置するのがベストプラクティス。各管理端末のローカルストアに配置する方法もあるが、管理の一貫性が失われる。

---

## 3. 主要GPO設定項目

### 3.1 Blast Extreme プロトコル設定

**パス**: Computer Configuration > Policies > Administrative Templates > Omnissa Blast

| 設定項目 | 説明 | デフォルト | 重要 |
|---------|------|----------|---------|
| Max Session Bandwidth (Kbps) | セッション最大帯域幅 | 制限なし | ✅ |
| Min Session Bandwidth (Kbps) | セッション最小帯域幅 | — | |
| Max Frame Rate (FPS) | 最大フレームレート | 30 | ✅ |
| Audio Playback | 音声再生の有効/無効 | Enabled | |
| Clipboard Redirection | クリップボード方向制御 | Both directions | ✅ |
| H.264 | H.264コーデックの使用 | Enabled | ✅ |
| HEVC (H.265) | HEVCコーデックの使用 | Disabled | |
| Build-to-Lossless | ロスレス圧縮モード | Disabled | ✅ |
| UDP Protocol | UDPトランスポートの使用 | Enabled | |
| Screen Capture | スクリーンキャプチャの許可/拒否 | Allow | |

> **重要**: **Build-to-Lossless** は、初期表示を有損圧縮（高速）で行い、画面が静止した後にロスレス（無損失）に遷移するモード。CAD / 医療画像 / デザイン等の「最終的に完全な画質が必要」なユースケースで使用する。帯域幅消費が増加するため、通常オフィスワークでは不要。

### 3.2 USB リダイレクト設定

**パス**: Computer Configuration > Policies > Administrative Templates > Omnissa USB Configuration

| 設定項目 | 説明 |
|---------|------|
| Allow Auto Device Splitting | 複合USBデバイスの自動分割 |
| Exclude Device Family | 除外するデバイスファミリー（例: `o:smart-card`） |
| Include Device Family | 許可するデバイスファミリー |
| Include Vid/Pid Device | 特定Vendor/Product IDのデバイスを許可 |
| Exclude Vid/Pid Device | 特定Vendor/Product IDのデバイスを除外 |

**USBデバイスファミリー**:

| ファミリー | 説明 | デフォルト |
|-----------|------|----------|
| `audio` | オーディオデバイス | 除外（RTAV推奨） |
| `video` | ビデオデバイス | 除外（RTAV推奨） |
| `hid` | HID（キーボード、マウス） | 除外 |
| `smart-card` | スマートカード | 除外（仮想スマートカード推奨） |
| `storage` | ストレージデバイス | 許可 |
| `printer` | プリンター | 許可 |

### 3.3 クリップボードリダイレクト設定

**パス**: Computer Configuration > Policies > Administrative Templates > Omnissa Clipboard Redirection

| 設定項目 | 説明 |
|---------|------|
| Configure Clipboard Redirection | 有効/無効、方向制御 |
| Clipboard Redirection Direction | Client → Server / Server → Client / Both / Disabled |
| Clipboard Size Limit | 転送サイズ上限 |
| Clipboard Audit | クリップボード操作の監査 |
| Restrict Clipboard Formats | 許可するデータ形式（テキスト、画像、ファイル等） |

> **重要**: クリップボードリダイレクトの方向制御は、セキュリティ要件に応じて設定する。「Server → Client のみ許可」はデータ持ち出し防止に有効。GPO と DEM Smart Policies の両方で設定可能だが、GPOは静的、Smart Policiesは動的（接続条件に応じて変更可能）。

### 3.4 Session Recording設定

**パス**: Computer Configuration > Policies > Administrative Templates > Omnissa Session Recording

| 設定項目 | 説明 |
|---------|------|
| Enable Recording | セッション録画の有効/無効 |
| Recording Mode | All Sessions / Selected Sessions |
| Notification to User | 録画通知の表示有無 |

> **重要**: Session Recordingはコンプライアンス要件やセキュリティ監査で使用する。ユーザーへの録画通知はプライバシー法令に応じて設定する。

### 3.5 HTML5 Multimedia Redirection (HTML5 MMR)

**パス**: Computer Configuration > Policies > Administrative Templates > Omnissa HTML5 MMR

| 設定項目 | 説明 |
|---------|------|
| Enable HTML5 MMR | HTML5マルチメディアリダイレクトの有効/無効 |
| URL Allow List | リダイレクト対象のURLリスト |

HTML5 MMRは、YouTube等のWebブラウザ上の動画再生をクライアント側にオフロードし、帯域幅とサーバーCPUを節約する。

### 3.6 Client Drive Redirection (CDR) 設定

**パス**: Computer Configuration > Policies > Administrative Templates > Omnissa Client Drive Redirection

| 設定項目 | 説明 |
|---------|------|
| Disable Client Drive Redirection | CDR全体の無効化 |
| Drive Letter Behavior | ドライブレターの割り当て方法 |
| Read-only Access | 読み取り専用モード |

---

## 4. Loopback Processing

### 4.1 Loopback Processingとは

通常のGPO処理では、Computer Configurationはコンピュータが所属するOUのGPOから、User ConfigurationはユーザーのOUのGPOから適用される。これはVDI/RDSH環境では問題となる。VDI VMのOUに定義したUser Configuration設定が、そのVMにログインするユーザーに適用されないためである。

Loopback Processingを有効にすると、**コンピュータのOU**にリンクされたGPOのUser Configurationが、そのコンピュータにログインするユーザーに適用される。

### 4.2 Loopback Processingモード

| モード | 動作 | 推奨場面 |
|--------|------|---------|
| **Merge** | ユーザーOUのUser Configuration + コンピュータOUのUser Configurationを**両方**適用。競合時は**コンピュータOU側が優先** | VDI環境（ユーザー固有の設定を維持しつつVDI設定を上書き） |
| **Replace** | コンピュータOUのUser Configurationのみ適用。ユーザーOUのUser Configurationは**完全に無視** | キオスク環境、ロックダウンRDSH環境（ユーザー個別設定を排除） |

#### Merge処理の詳細フロー

```
(1) ユーザーOUのUser Configurationを収集
(2) コンピュータOUのUser Configurationを収集
(3) 両方をマージ（競合するポリシーはコンピュータOU側が勝つ）
(4) マージ結果をユーザーに適用
```

### 4.3 設定方法

**パス**: Computer Configuration > Policies > Administrative Templates > System > Group Policy

- **Configure user Group Policy loopback processing mode**: Enabled
- Mode: **Merge** or **Replace**

> **重要**: Horizon VDI / RDSH環境では **Loopback Processing** がほぼ必須。理由は、仮想デスクトップ/RDSHホストのOU（Computer OU）に適用するGPOで、ユーザー設定（User Configuration）も制御したいため。Merge モードが最も一般的で、ユーザー固有の設定を維持しつつVDI/RDSH固有の設定を上書きできる。

---

## 5. OU設計

### 5.1 Horizon環境の推奨OU構造

```
OU=Horizon
  ├── OU=Servers
  │   ├── OU=Connection Servers    ← CS専用GPO
  │   └── OU=UAG                   ← UAG専用GPO
  ├── OU=VDI Desktops
  │   ├── OU=Instant Clones        ← VDI GPO + Loopback Processing
  │   └── OU=Full Clones           ← Full Clone GPO
  ├── OU=RDSH Hosts                ← RDSH GPO + Loopback Processing (Replace)
  ├── OU=Service Accounts          ← Horizon サービスアカウント
  └── OU=Groups                    ← Entitlement用ADグループ
```

### 5.2 OU設計のポイント

| ポイント | 説明 |
|---------|------|
| VDIとRDSHを分離 | 異なるGPO（Loopbackモード含む）を適用するため |
| Instant CloneとFull Cloneを分離 | ライフサイクルが異なるため |
| Connection ServerのOUを分離 | サーバー固有のセキュリティGPOを適用するため |
| サービスアカウント専用OU | 最小権限原則でサービスアカウントを管理 |
| GPOのリンクを最小化 | 必要なOUにのみGPOをリンクし、処理オーバーヘッドを削減 |

---

## 6. GPO vs DEM Smart Policies の使い分け

### 6.1 比較表

| 比較項目 | GPO | DEM Smart Policies |
|---------|-----|-------------------|
| 適用タイミング | コンピュータ起動 / ユーザーログオン時 | ユーザーログオン時（動的） |
| 条件ベースの制御 | WMI Filter / Security Filter | Horizon Client Properties + 多様なCondition |
| 変更の反映 | gpupdate / 次回ログオン | 次回ログオン（即座） |
| 管理ツール | GPMC (Group Policy Management Console) | DEM Management Console |
| 動的変更 | 不可（接続方法変更時にポリシーは変わらない） | 可能（接続条件に応じてリアルタイム変更） |
| Horizon固有の条件 | 不可 | Pool名、Gateway Location等で条件設定可 |

### 6.2 使い分けガイドライン

| シナリオ | 推奨 |
|---------|------|
| ベースラインのセキュリティ設定（全環境共通） | GPO |
| OS標準のWindows設定制御 | GPO |
| 接続元（内部/外部）に応じたポリシー変更 | DEM Smart Policies |
| Pool単位でのポリシー制御 | DEM Smart Policies |
| Blast / PCoIP の詳細プロトコル設定 | GPO (ADMX) |
| USBフィルタリングルール | GPO (ADMX) |
| クリップボードの動的制御 | DEM Smart Policies |

> **重要**: GPOとDEM Smart Policiesは競合ではなく**補完関係**。GPOで静的なベースライン設定を行い、DEM Smart Policiesで動的な条件ベースの制御を追加するのがベストプラクティス。

---

## 7. GPOトラブルシューティング

### 7.1 診断ツール

| ツール | 用途 | コマンド/手順 |
|--------|------|------------|
| `gpresult` | 適用されたGPOの確認 | `gpresult /r /scope:computer` / `gpresult /r /scope:user` |
| `gpresult /h` | HTMLレポート生成 | `gpresult /h C:\GPOReport.html /f` |
| `gpupdate /force` | GPOの強制更新 | `gpupdate /force /target:computer` |
| RSOP (Resultant Set of Policy) | ポリシーの結果確認 | `rsop.msc` |
| Event Viewer | GPO適用ログ | Applications and Services Logs > Microsoft > Windows > GroupPolicy |

### 7.2 一般的な問題と対処

| 症状 | 原因候補 | 対処 |
|------|---------|------|
| GPOが適用されない | OUリンク漏れ、Security Filter不一致、WMI Filter誤り | `gpresult /r` で確認、リンク/フィルタ確認 |
| GPO設定が上書きされる | より高い優先順位のGPOが存在 | リンク順序確認、Enforced設定確認 |
| Loopback Processingが機能しない | Loopback GPO未設定、コンピュータOUにリンクされていない | Loopback設定確認 |
| ADMX設定が表示されない | ADMXファイル未インポート、Central Store未作成 | PolicyDefinitionsフォルダ確認 |
| Horizon GPO設定が反映されない | Agent再起動未実施、レジストリキーが競合 | `gpupdate /force` + Agent/VM再起動 |

---

## 8. ベストプラクティスとアンチパターン

### ベストプラクティス

| # | プラクティス |
|---|------------|
| 1 | ADMXテンプレートはCentral Store（SYSVOL）に配置 |
| 2 | VDI / RDSH OUにLoopback Processing（Merge）を設定 |
| 3 | GPOでベースライン、DEM Smart Policiesで動的制御 |
| 4 | GPO命名規則を統一（例: `HZN-VDI-Blast-Settings`） |
| 5 | テスト用OUで検証後に本番OUに適用 |
| 6 | GPOの数を最小限に保ち、処理時間を最適化 |
| 7 | `gpresult` で適用結果を定期的に検証 |
| 8 | ADMXテンプレートはHorizon Agent更新時に最新版に差し替え |

### アンチパターン

| # | アンチパターン | 問題点 |
|---|-------------|--------|
| 1 | ドメインルートにHorizon GPOをリンク | 全コンピュータに不要な設定が適用される |
| 2 | Loopback Processing未設定 | VDI/RDSH OUのUser Configurationが適用されない |
| 3 | GPOとDEM Smart Policiesで同一設定を二重管理 | 競合・混乱 |
| 4 | 旧バージョンのADMXテンプレートを使い続ける | 新機能の設定が不可 |
| 5 | WMI Filterの過剰使用 | ログオン時間の増加（WMIクエリのオーバーヘッド） |
| 6 | GPO数が多すぎる（50以上） | 処理時間増加、管理困難 |

---

## 理解度チェックリスト

- [ ] GPOの適用順序（LSDOU）を説明できる
- [ ] Horizon ADMXテンプレートのCentral Storeへのインポート手順を説明できる
- [ ] Loopback ProcessingのMerge / Replaceの違いと推奨場面を説明できる
- [ ] Merge処理の詳細フロー（ユーザーOU + コンピュータOUの両方を収集し、競合時はコンピュータOU優先）を説明できる
- [ ] Blast Extreme の Build-to-Lossless の用途と帯域幅への影響を説明できる
- [ ] クリップボードリダイレクトの方向制御オプションを説明できる
- [ ] USBリダイレクトのInclude/Excludeフィルタリングを説明できる
- [ ] Session Recording GPOの設定項目と使用場面を説明できる
- [ ] HTML5 MMRの仕組み（クライアントオフロード）を説明できる
- [ ] Horizon環境の推奨OU構造を設計できる
- [ ] GPO vs DEM Smart Policies の使い分けを説明できる
- [ ] `gpresult` を使用したGPO適用結果の確認方法を説明できる
