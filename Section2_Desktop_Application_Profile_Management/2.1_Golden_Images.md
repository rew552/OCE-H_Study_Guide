# 2.1 Golden Images

## 概要

ゴールデンイメージ（Golden Image）は、仮想デスクトップやRDSHホストのベースとなるマスターイメージです。OCE-Hレベルでは、高度な最適化、OSOTの使用、レジストリ最適化、バージョン管理が求められます。

## 学習目標

このセクションを学習することで、以下のことができるようになります：

- OSOTを使用したゴールデンイメージの最適化ができる
- レジストリ最適化の方法を理解し、適用できる
- ゴールデンイメージのバージョン管理ができる
- パッチ適用とプール更新の手順を実行できる
- ゴールデンイメージ関連の問題をトラブルシューティングできる

## 関連リソース

- [クイックリファレンス](../../00_Quick_Reference.md) - ポート番号、設定値、制限値
- [用語集](../../README.md#用語集) - 関連用語の定義
- [3.2 Advanced Golden Image Optimization](../../Section3_Monitoring_Optimization/3.2_Advanced_Golden_Image_Optimization.md) - 高度な最適化
- [2.2 Desktop Pools](2.2_Desktop_Pools.md) - デスクトッププール
- [実環境シナリオ](../../00_Scenarios/Section2_Scenarios.md) - 実環境でのシナリオ例

## ゴールデンイメージの準備

### OSのインストールと基本設定

#### OSバージョンの選択

**推奨OS**:
- Windows 10 Enterprise LTSC
- Windows 11 Enterprise
- Windows Server 2019/2022（RDSH用）

**考慮事項**:
- ライセンス要件
- アプリケーション互換性
- サポート期間

#### クリーンインストール

**手順**:
1. 新しいVMを作成
2. OSをクリーンインストール
3. 最新のWindows Updateを適用
4. ドライバーをインストール

> [!IMPORTANT]
> クリーンインストールから開始することで、不要なソフトウェアや設定を避けられます。

### Horizon Agentのインストール

**インストールファイル**:
- `VMware-Horizon-Agent-x.x.x-xxxxx.exe`

**インストールオプション**:
- Horizon Agent Core（必須）
- USBリダイレクト
- 仮想印刷
- リアルタイムオーディオビデオ
- vGPU（NVIDIA GRID使用時）

**インストール後の確認**:
```powershell
# Agentサービスの状態確認
Get-Service | Where-Object {$_.Name -like "*VMware*"}

# 主要なサービス
# - VMware Horizon View Agent
# - VMware USB Arbitration Service
```

## 高度な最適化

### OSOT (OS Optimization Tool) の使用

#### OSOTの概要

OSOTは、Windows OSをHorizon環境に最適化するためのツールです。

**機能**:
- ログオン時間の短縮（30-50%の短縮が可能）
- リソース使用量の削減
- パフォーマンスの最適化

#### OSOTのダウンロードと使用

**ダウンロード**:
- Omnissa公式サイトからダウンロード
- ファイル名: `VMwareOSOptimizationTool-x.x.x.exe`

**使用手順**:

1. **OSOTの起動**
   ```powershell
   # 管理者権限で実行
   .\VMwareOSOptimizationTool-x.x.x.exe
   ```

2. **テンプレートの選択**
   - VDI標準テンプレート
   - RDSH標準テンプレート
   - カスタムテンプレート

3. **最適化項目の確認**
   - Services: Windowsサービスの最適化
   - Scheduled Tasks: スケジュールタスクの最適化
   - Visual Effects: 視覚効果の最適化
   - Windows Features: Windows機能の最適化
   - Registry: レジストリ設定の最適化

4. **最適化の実行**
   - 「Analyze」で影響を分析
   - 「Optimize」で最適化を実行

#### 主要な最適化項目

**OneDriveの無効化**:
```reg
[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\OneDrive]
"DisableFileSyncNGSC"=dword:00000001
```

**Windows Updateの最適化**:
```reg
[HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU]
"NoAutoUpdate"=dword:00000000
"AUOptions"=dword:00000004
"ScheduledInstallDay"=dword:00000000
"ScheduledInstallTime"=dword:00000003
```

**視覚効果の無効化**:
```powershell
# パフォーマンス優先に設定
Set-ItemProperty -Path "HKCU:\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" `
    -Name "VisualFXSetting" -Value 2 -Type DWord
```

> [!TIP]
> OSOTを使用することで、ログオン時間を大幅に短縮できます。ただし、すべての最適化項目を有効化する前に、テスト環境で検証してください。

### レジストリ最適化

#### サービス最適化

**不要なサービスの無効化**:
```powershell
# 例: Windows Searchサービスの無効化
Set-Service -Name "WSearch" -StartupType Disabled

# 例: Windows Updateサービスの最適化
Set-Service -Name "wuauserv" -StartupType Automatic
```

#### スタートアップ最適化

**タスクスケジューラーの最適化**:
```powershell
# 不要なタスクの無効化
Get-ScheduledTask | Where-Object {$_.State -eq "Ready"} | 
    Where-Object {$_.TaskName -like "*Update*"} | 
    Disable-ScheduledTask
```

#### ネットワーク最適化

**TCP/IP設定の最適化**:
```powershell
# TCP/IP設定の最適化
netsh int tcp set global autotuninglevel=normal
netsh int tcp set global chimney=enabled
netsh int tcp set global rss=enabled
```

### パフォーマンス設定

#### 電源設定

**高性能モードに設定**:
```powershell
# 高性能モードに設定
powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c

# スリープと休止状態の無効化
powercfg /hibernate off
powercfg /change monitor-timeout-ac 0
powercfg /change disk-timeout-ac 0
```

#### ページファイルの最適化

**ページファイルサイズの設定**:
```powershell
# ページファイルの自動管理を無効化
$System = Get-WmiObject Win32_ComputerSystem -EnableAllPrivileges
$System.AutomaticManagedPagefile = $false
$System.Put()

# 固定サイズのページファイルを設定
$PageFile = Get-WmiObject Win32_PageFileSetting
$PageFile.InitialSize = 2048
$PageFile.MaximumSize = 2048
$PageFile.Put()
```

## バージョン管理

### スナップショットの管理

**スナップショット戦略**:
- 主要なマイルストーンでスナップショットを作成
- スナップショット名にバージョン番号を含める
- 古いスナップショットの定期的な削除

**スナップショットの作成**:
```powershell
# vSphere PowerCLIを使用
Connect-VIServer -Server vcenter.contoso.com
New-Snapshot -VM "Golden-Image-Win10" -Name "v1.0-Initial" -Description "Initial optimized image"
```

### バージョンタグの使用

**命名規則**:
- 形式: `v<major>.<minor>.<patch>-<description>`
- 例: `v1.0.0-Initial`, `v1.1.0-WindowsUpdate`, `v1.2.0-AppInstall`

**詳細なバージョン管理**:

#### バージョン管理システム

**推奨アプローチ**:
- スナップショットベースのバージョン管理
- 変更履歴の記録
- ロールバック機能

**バージョン管理テーブル例**:
| バージョン | 日付 | 変更内容 | スナップショット名 |
|----------|------|---------|------------------|
| v1.0.0 | 2024-01-01 | 初期イメージ | v1.0.0-Initial |
| v1.1.0 | 2024-02-01 | Windows Update | v1.1.0-WindowsUpdate |
| v1.2.0 | 2024-03-01 | アプリケーション追加 | v1.2.0-AppInstall |

## 複数のゴールデンイメージの管理戦略

### イメージ管理戦略

**複数イメージの必要性**:
- 異なるOSバージョン（Windows 10、Windows 11）
- 異なる用途（開発、テスト、本番）
- 異なるアプリケーションセット

**管理戦略**:

1. **命名規則の統一**
   ```
   形式: <OS>-<用途>-<バージョン>
   例: Win10-Dev-v1.0, Win11-Prod-v1.0
   ```

2. **カテゴリ別の管理**
   - OSバージョンごとにフォルダを分離
   - 用途ごとにフォルダを分離

3. **ライフサイクル管理**
   - アクティブなイメージの管理
   - 非推奨イメージのアーカイブ
   - 古いイメージの削除

## イメージ更新の自動化

### 自動更新プロセス

**更新プロセスの自動化**:

1. **Windows Updateの自動適用**
   ```powershell
   # Windows Updateの自動適用スクリプト
   Install-Module -Name PSWindowsUpdate -Force
   Get-WindowsUpdate -AcceptAll -Install -AutoReboot
   ```

2. **イメージの自動検証**
   - 更新後の動作確認
   - パフォーマンステスト
   - セキュリティスキャン

3. **スナップショットの自動作成**
   ```powershell
   # 更新後のスナップショット作成
   New-Snapshot -VM "Golden-Image-Win10" -Name "v1.1.0-WindowsUpdate-$(Get-Date -Format 'yyyyMMdd')" `
       -Description "Windows Update applied on $(Get-Date)"
   ```

**スケジュールされた更新**:
- 月次でWindows Updateを適用
- 四半期ごとにアプリケーションを更新
- 更新前にスナップショットを作成

## セキュリティパッチの適用プロセス

### パッチ適用のプロセス

**緊急パッチの適用**:

1. **パッチの評価**
   - パッチの重要度を評価
   - 影響範囲の確認
   - テスト環境での検証

2. **パッチの適用**
   - ゴールデンイメージでパッチを適用
   - 動作確認

3. **スナップショットの作成**
   - パッチ適用後のスナップショットを作成
   - バージョン番号を更新

4. **プールの更新**
   - 親VMを更新
   - プールの再プロビジョニング

**パッチ適用チェックリスト**:
- [ ] パッチの重要度を評価
- [ ] テスト環境での検証
- [ ] バックアップの取得
- [ ] パッチの適用
- [ ] 動作確認
- [ ] スナップショットの作成
- [ ] プールの更新

## ベストプラクティス

1. **定期的な更新**
   - 月次でWindows Updateを適用
   - 四半期ごとにアプリケーションを更新
   - 更新前にスナップショットを作成

2. **テスト**
   - 更新後は必ずテスト環境で検証
   - ログオン時間の測定
   - アプリケーションの動作確認

3. **ドキュメント**
   - 変更履歴の記録
   - 設定のドキュメント化
   - トラブルシューティング情報の記録

> [!CAUTION]
> ゴールデンイメージの変更は、すべてのVMに影響を与えます。本番環境に適用する前に、必ずテスト環境で検証してください。

## トラブルシューティング

### 一般的な問題

**ログオン時間が長い**:
- OSOTの最適化を確認
- スタートアッププログラムを確認
- ネットワーク設定を確認

**アプリケーションが動作しない**:
- 最適化項目を確認
- 必要なサービスが有効か確認
- レジストリ設定を確認

## 理解度チェックリスト

以下の項目について理解度を確認してください：

### ゴールデンイメージの準備
- [ ] OSのインストールと基本設定の手順を理解している
- [ ] Horizon Agentのインストールと設定を説明できる
- [ ] OSOTを使用した最適化の手順を理解している

### 最適化
- [ ] レジストリ最適化の方法を説明できる
- [ ] Windowsパフォーマンス設定の最適化方法を理解している
- [ ] サービスとスタートアッププログラムの最適化を説明できる

### バージョン管理
- [ ] スナップショットを使用したバージョン管理を理解している
- [ ] パッチ適用の手順を説明できる
- [ ] プールの更新手順を理解している

### トラブルシューティング
- [ ] ログオン時間の問題をトラブルシューティングできる
- [ ] アプリケーションの問題をトラブルシューティングできる

## まとめ

ゴールデンイメージの適切な管理と最適化は、Horizon環境のパフォーマンスと一貫性に重要です。OSOTの使用、レジストリ最適化、バージョン管理により、効率的で管理しやすいゴールデンイメージを維持できます。
