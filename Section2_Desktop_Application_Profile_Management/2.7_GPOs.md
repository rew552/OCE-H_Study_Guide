# 2.7 GPOs

## 概要

Group Policy Object (GPO)の管理は、Horizon環境の設定管理に重要です。OCE-Hレベルでは、ADMXテンプレートの使用、高度な設定、OU設計、GPOの階層化が求められます。

## 学習目標

このセクションを学習することで、以下のことができるようになります：

- ADMXテンプレートのインポートと使用ができる
- GPOの高度な設定方法を理解している
- OU設計とGPOの階層化を説明できる
- GPOの適用順序と競合解決方法を理解している

## 関連リソース

- [クイックリファレンス](../../00_Quick_Reference.md) - ポート番号、設定値、制限値
- [用語集](../../README.md#用語集) - 関連用語の定義
- [1.3 Active Directory Integration](../../Section1_Infrastructure_Planning_and_Management/1.3_Active_Directory_Integration.md) - Active Directory統合
- [実環境シナリオ](../../00_Scenarios/Section2_Scenarios.md) - 実環境でのシナリオ例

## GPOの概要

### GPOとは

**機能**:
- Active Directory環境でユーザーとコンピューターの設定を一元管理
- 設定の一貫性
- セキュリティ設定の適用
- 設定の自動適用

### GPOの種類

**Computer Configuration**:
- コンピューター全体に適用
- ログオン前にも適用可能

**User Configuration**:
- ユーザーに適用
- ログオン後に適用

## Horizon用ADMXテンプレート

### ADMXテンプレートの概要

**機能**:
- Group Policyを使用したHorizon設定の管理
- 一元管理
- 一貫性のある設定

**利用可能なADMXテンプレート**:
- Horizon Client設定
- Horizon Agent設定
- 表示プロトコル設定
- セキュリティ設定

### ADMXテンプレートのインポート

**手順**:

1. **ADMXテンプレートファイルの取得**
   - Horizonインストールメディアから取得
   - または、Horizon Consoleからダウンロード

2. **中央ストアへのコピー**
   ```
   コピー元: <Horizonインストールメディア>\ADMX Templates\*.admx
   コピー先: \\<ドメイン名>\SYSVOL\<ドメイン名>\Policies\PolicyDefinitions\
   ```

3. **ADMLファイルのコピー（言語ファイル）**
   ```
   コピー元: <Horizonインストールメディア>\ADMX Templates\<言語>\*.adml
   コピー先: \\<ドメイン名>\SYSVOL\<ドメイン名>\Policies\PolicyDefinitions\<言語>\
   ```

4. **Group Policy Management Consoleでの確認**
   - GPOを編集
   - Computer ConfigurationまたはUser Configuration
   - Policies → Administrative Templates → VMware

### Horizon Client設定のGPO適用

**設定手順**:

1. **GPOの作成**
   ```
   GPO名: Horizon Client Settings
   リンク先: Horizon Users OU
   ```

2. **User Configurationの設定**
   - Policies → Administrative Templates → VMware → VMware Horizon Client
   - 必要な設定を有効化:
     - 自動接続設定
     - セキュリティ設定
     - 表示プロトコル設定
     - リダイレクト設定

**主要な設定項目**:
- **Connection Server URL**: 接続サーバーのURL
- **Display Protocol**: 表示プロトコルの優先順位
- **USB Redirection**: USBリダイレクトの設定
- **Clipboard Redirection**: クリップボードリダイレクトの設定

### Horizon Agent設定のGPO適用

**設定手順**:

1. **GPOの作成**
   ```
   GPO名: Horizon Agent Settings
   リンク先: Virtual Desktops OU
   ```

2. **Computer Configurationの設定**
   - Policies → Administrative Templates → VMware → VMware Horizon Agent
   - 必要な設定を有効化:
     - セッション設定
     - セキュリティ設定
     - パフォーマンス設定
     - 表示プロトコル設定

**主要な設定項目**:
- **Display Protocol**: デフォルト表示プロトコル
- **Session Timeout**: セッションタイムアウト設定
- **USB Redirection**: USBリダイレクトの設定
- **Performance Settings**: パフォーマンス設定

> [!TIP]

> ADMXテンプレートを使用することで、Horizon設定を一元管理できます。個別の設定変更よりも、一貫性と管理性が向上します。

## 高度なGPO設定

### GPOの階層化

**階層構造**:
1. **ドメインレベル**: ドメイン全体に適用
2. **OUレベル**: 特定のOUに適用
3. **サイトレベル**: 特定のサイトに適用

**優先順位**:
- より具体的なレベル（OU）が、より一般的なレベル（ドメイン）より優先
- リンク順序も影響（数値が小さいほど優先）

### GPOのフィルタリング

**セキュリティフィルタリング**:
- 特定のユーザー/グループにのみ適用
- 特定のコンピューターにのみ適用

**WMIフィルタリング**:
- コンピューターの属性に基づくフィルタリング
- 例: OSバージョン、インストールされているソフトウェア

### GPOのループバック処理

**ループバックモード**:
- **Merge**: ユーザー設定とコンピューター設定をマージ
- **Replace**: コンピューター設定でユーザー設定を置き換え

**用途**:
- RDSH環境
- 共有コンピューター環境

## OU設計

### 推奨OU構造

**構造例**:
```
OU=Horizon
  ├── OU=Computers
  │   ├── OU=Connection Servers
  │   ├── OU=UAG
  │   ├── OU=Virtual Desktops
  │   └── OU=RDSH Hosts
  ├── OU=Users
  │   ├── OU=Service Accounts
  │   └── OU=Horizon Users
  └── OU=Groups
      ├── OU=Administrators
      └── OU=End Users
```

### GPO適用のためのOU設計

**設計原則**:
- コンピュータータイプごとにOUを分離
- ユーザータイプごとにOUを分離
- GPOの適用範囲を明確にする

**推奨構成**:
- Connection Server用OU: Connection Server専用のGPOを適用
- 仮想デスクトップ用OU: デスクトップ用のGPOを適用
- RDSHホスト用OU: RDSHホスト用のGPOを適用

## ベストプラクティス

1. **設計**
   - 適切なOU構造
   - GPOの階層化
   - 明確な命名規則

2. **管理**
   - 定期的な見直し
   - 変更管理プロセス
   - ドキュメント化

3. **テスト**
   - テスト環境での検証
   - 段階的な展開
   - ロールバック計画

> [!CAUTION]

> GPOの設定変更は、すべての対象ユーザー/コンピューターに影響を与える可能性があります。本番環境で変更する前に、テスト環境で十分に検証してください。

## GPOの適用順序と優先順位

### 適用順序の詳細

**優先順位（高い順）**:
1. **ローカルGPO**: コンピューターのローカルポリシー
2. **サイトGPO**: サイトにリンクされたGPO
3. **ドメインGPO**: ドメインにリンクされたGPO
4. **OU GPO**: OUにリンクされたGPO（親OUから子OUへ）

**リンク順序**:
- 同じレベルで複数のGPOがリンクされている場合
- リンク順序が低い（数値が小さい）ほど優先
- 例: リンク順序1がリンク順序2より優先

**競合の解決**:
- より具体的なレベル（OU）のGPOが優先
- リンク順序が低いGPOが優先
- 明示的に設定された値が優先（未設定は継承）

## GPOのフィルタリング

### セキュリティフィルタリング

**セキュリティフィルタリングの設定**:

1. **GPOのプロパティを開く**
   - Group Policy Management Console
   - GPOを右クリック → Properties → Security

2. **アクセス権限の設定**
   - **Apply Group Policy**: GPOを適用する権限
   - **Read**: GPOを読み取る権限

3. **フィルタリングの例**:
   ```
   GPO: Horizon-Desktop-Settings
   セキュリティフィルタ:
   - Domain Computers: Read, Apply Group Policy
   - Horizon-Desktop-Users: Read, Apply Group Policy
   - Domain Admins: Read, Apply Group Policy, Edit
   ```

### WMIフィルタリング

**WMIフィルタの作成**:

1. **WMIフィルタの作成**
   - Group Policy Management Console
   - WMI Filters → New

2. **WMIクエリの入力**
   ```wql
   SELECT * FROM Win32_OperatingSystem WHERE Version LIKE "10.0%"
   ```

3. **GPOへのリンク**
   - GPOのプロパティ → WMI Filter
   - 作成したWMIフィルタを選択

**WMIフィルタの例**:
- OSバージョンによるフィルタリング
- インストールされているソフトウェアによるフィルタリング
- ハードウェア仕様によるフィルタリング

## GPOのループバック処理

### ループバックモードの設定

**Mergeモード**:
- ユーザー設定とコンピューター設定をマージ
- コンピューター設定が優先

**Replaceモード**:
- コンピューター設定でユーザー設定を置き換え
- ユーザー設定は無視される

**設定方法**:
```
Computer Configuration → Policies → Administrative Templates → 
System → Group Policy → Configure user Group Policy loopback processing mode
```

**使用例**:
- RDSH環境
- 共有コンピューター環境
- キオスク環境

## GPOのトラブルシューティングツール

### トラブルシューティングツール

**Gpresult**:
```powershell
# GPOの適用結果を確認
gpresult /r /scope Computer
gpresult /r /scope User

# 詳細なレポートを生成
gpresult /h "C:\GPOReport.html" /f

# XML形式でエクスポート
gpresult /x "C:\GPOReport.xml"
```

**Gpupdate**:
```powershell
# GPOの強制更新
gpupdate /force

# コンピューター設定のみ更新
gpupdate /force /target:Computer

# ユーザー設定のみ更新
gpupdate /force /target:User
```

**Group Policy Results Wizard**:
- Group Policy Management Console
- Group Policy Results
- ユーザーとコンピューターを選択
- 適用されたGPOを確認

**Event Viewer**:
- Applications and Services Logs → Microsoft → Windows → GroupPolicy
- GPOの適用エラーを確認

## トラブルシューティング

### 一般的な問題

**GPOが適用されない**:
- GPOのリンクを確認
- セキュリティフィルタリングを確認
- WMIフィルタを確認
- ログファイルを確認
- OUの確認

**設定が競合する**:
- GPOの優先順位を確認
- リンク順序を確認
- ループバック処理を確認
- より具体的なGPOの確認

**パフォーマンスの問題**:
- GPOの数を確認
- WMIフィルタの複雑さを確認
- ネットワーク帯域幅を確認

### ログファイルの確認

**GPO適用ログ**:
- `gpupdate /force` を実行してログを確認
- イベントログ: `Applications and Services Logs\Microsoft\Windows\GroupPolicy`

**PowerShellでの確認**:
```powershell
# GPOの適用結果を確認
gpresult /r /scope Computer
gpresult /r /scope User

# 詳細なレポートを生成
gpresult /h "C:\GPOReport.html" /f

# イベントログの確認
Get-WinEvent -LogName "Microsoft-Windows-GroupPolicy/Operational" -MaxEvents 50
```

## まとめ

GPOの適切な管理は、Horizon環境の設定管理に重要です。ADMXテンプレートの使用、高度な設定、OU設計、GPOの階層化、適用順序と優先順位、フィルタリング、ループバック処理、トラブルシューティングツールにより、効率的で一貫性のある設定管理環境を構築できます。
